<!DOCTYPE html>
<html lang="en" style="background-color: #1e1b4b;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Charlie - Equity Analyzer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="AI-powered equity research analysis with Claude Sonnet 4. Analyze broker reports, generate investment theses, and track portfolio insights.">
    <meta name="theme-color" content="#14b8a6">
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Charlie">
    <link rel="apple-touch-icon" href="/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icon-167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">
    
    <!-- iOS Splash Screens -->
    <!-- iPhone 14 Pro Max, 15 Plus, 15 Pro Max -->
    <link rel="apple-touch-startup-image" href="/splash-1290x2796.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone 14 Pro, 15, 15 Pro -->
    <link rel="apple-touch-startup-image" href="/splash-1179x2556.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone 12 Pro Max, 13 Pro Max, 14 Plus -->
    <link rel="apple-touch-startup-image" href="/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone 12, 12 Pro, 13, 13 Pro, 14 -->
    <link rel="apple-touch-startup-image" href="/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone 12 mini, 13 mini -->
    <link rel="apple-touch-startup-image" href="/splash-1080x2340.png" media="(device-width: 360px) and (device-height: 780px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone XS Max, 11 Pro Max -->
    <link rel="apple-touch-startup-image" href="/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone X, XS, 11 Pro -->
    <link rel="apple-touch-startup-image" href="/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone XR, 11 -->
    <link rel="apple-touch-startup-image" href="/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPhone 8 Plus -->
    <link rel="apple-touch-startup-image" href="/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    <!-- iPhone 8, SE -->
    <link rel="apple-touch-startup-image" href="/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad Pro 12.9" -->
    <link rel="apple-touch-startup-image" href="/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad Pro 11" -->
    <link rel="apple-touch-startup-image" href="/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad Air, iPad 10th gen -->
    <link rel="apple-touch-startup-image" href="/splash-1640x2360.png" media="(device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad mini -->
    <link rel="apple-touch-startup-image" href="/splash-1488x2266.png" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2)">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icon-192.png">
    
    <!-- Critical CSS - prevents white flash, loads before scripts -->
    <style>
        html, body, #root {
            background-color: #1e1b4b !important;
            min-height: 100vh;
            margin: 0;
        }
    </style>
    
    <!-- React and dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.4/purify.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#e6f4f5',
                            100: '#ccecef',
                            200: '#99d9df',
                            300: '#66c5cf',
                            400: '#33b2bf',
                            500: '#0d9488',
                            600: '#0d5c63',
                            700: '#0a4a50',
                            800: '#07383c',
                            900: '#052628'
                        },
                        accent: {
                            orange: '#f97316',
                            amber: '#fbbf24',
                            rose: '#f43f5e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .document-item.dragging { opacity: 0.5; }
        .document-item { transition: all 0.2s; }
        .drag-over { border-color: #0d9488 !important; background-color: rgba(13, 148, 136, 0.1) !important; }
        /* Hide scrollbar for stock switcher */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        /* Thin scrollbar for filter areas */
        .scrollbar-thin::-webkit-scrollbar { height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.15) transparent; }
        /* Line clamp utilities */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Bottom nav safe area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 0px); }
        /* Mobile content bottom spacing */
        @media (max-width: 767px) {
            .mobile-content-padding {
                padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
            }
        }
        /* Summary content formatting for better readability */
        .summary-content {
            color: #cbd5e1;
            font-size: 0.9375rem;
            line-height: 1.75;
        }
        .summary-content h1,
        .summary-content h2,
        .summary-content h3,
        .summary-content h4 {
            color: #e2e8f0;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .summary-content h2 {
            font-size: 1.125rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
        }
        .summary-content h3 {
            font-size: 1rem;
        }
        .summary-content p {
            margin-bottom: 1rem;
        }
        /* Add bullet points to paragraphs that start with bold text (common webhook format) */
        .summary-content > p:has(> strong:first-child),
        .summary-content > p:has(> b:first-child) {
            display: flex;
            gap: 0.5rem;
        }
        .summary-content > p:has(> strong:first-child)::before,
        .summary-content > p:has(> b:first-child)::before {
            content: '‚Ä¢';
            color: #64748b;
            flex-shrink: 0;
        }
        .summary-content ul,
        .summary-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        .summary-content li {
            margin-bottom: 0.5rem;
            padding-left: 0.25rem;
        }
        .summary-content li::marker {
            color: #64748b;
        }
        .summary-content strong,
        .summary-content b {
            color: #f1f5f9;
            font-weight: 600;
        }
        .summary-content em,
        .summary-content i {
            color: #94a3b8;
        }
        .summary-content blockquote {
            border-left: 3px solid #0d9488;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #94a3b8;
        }
        /* Slide up animation for bottom sheets */
        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
        }

        @keyframes mesh-flow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .glass-bg-mesh {
            background: linear-gradient(135deg, #1e1b4b 0%, #4c1d95 20%, #0f766e 50%, #1e3a8a 80%, #1e1b4b 100%);
            background-size: 400% 400%;
            animation: mesh-flow 20s ease infinite;
        }

        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-strong { background: rgba(255,255,255,0.08); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.15); }
        .glass-subtle { background: rgba(255,255,255,0.03); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
        .glow-teal { box-shadow: 0 0 20px rgba(20,184,166,0.3); }
        .glow-purple { box-shadow: 0 0 20px rgba(168,85,247,0.3); }
    </style>
</head>
<body style="background-color: #1e1b4b; margin: 0;">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Safe string helper - prevents "Objects are not valid as React child" errors
        const safeStr = (value, fallback = '') => {
            if (value === null || value === undefined) return fallback;
            if (typeof value === 'string') return value;
            if (typeof value === 'number' || typeof value === 'boolean') return String(value);
            if (Array.isArray(value)) return value.map(v => safeStr(v)).join(', ');
            if (typeof value === 'object') {
                // Try to extract a meaningful string from common object shapes
                if (value.text) return safeStr(value.text, fallback);
                if (value.value) return safeStr(value.value, fallback);
                if (value.name) return safeStr(value.name, fallback);
                if (value.title) return safeStr(value.title, fallback);
                // Last resort - return JSON but truncated
                try {
                    const json = JSON.stringify(value);
                    return json.length > 100 ? json.slice(0, 97) + '...' : json;
                } catch {
                    return fallback || '[Object]';
                }
            }
            return String(value);
        };

        // Safe array helper - ensures we always have an array to map over
        const safeArray = (arr) => Array.isArray(arr) ? arr.filter(item => item != null) : [];

        // Global error handler to show errors instead of white screen
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            root.innerHTML = `<div style="padding: 20px; color: #ff6b6b; background: #1a1a2e; min-height: 100vh;">
                <h2>‚ö†Ô∏è App Error</h2>
                <p><strong>Message:</strong> ${msg}</p>
                <p><strong>Line:</strong> ${line}, Col: ${col}</p>
                <p><strong>Stack:</strong> <pre style="white-space: pre-wrap; font-size: 12px;">${error?.stack || 'N/A'}</pre></p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #4ecdc4; border: none; border-radius: 5px; cursor: pointer;">Reload App</button>
            </div>`;
            return true;
        };

        // Backend API URL ‚Äî use same-origin proxy in production, direct URL for local dev
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'https://equity-analyzer-backend.onrender.com'
            : '';

        // Helper function to format UTC timestamp to New York time
        const formatNYTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            // Ensure timestamp is treated as UTC by adding Z if missing
            const utcTimestamp = timestamp.endsWith('Z') || timestamp.includes('+') || timestamp.includes('-', 10) 
                ? timestamp 
                : timestamp + 'Z';
            return new Date(utcTimestamp).toLocaleString('en-US', {
                timeZone: 'America/New_York', 
                month: 'numeric', 
                day: 'numeric', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit'
            });
        };

        // Research Prompt Frameworks for deep analysis
        const RESEARCH_PROMPTS = [
            {
                id: 'executive-brief',
                name: 'Executive Brief',
                shortName: 'Brief',
                icon: 'üìä',
                description: 'High-impact synthesis for the PM - no fluff, just the actionable delta',
                prompt: `Act as a Senior Equity Analyst at a major long-only fund. I am forwarding you a sell-side research report. Your job is to synthesize it into a high-impact 'Executive Brief' for the Portfolio Manager.

Constraints:
‚Ä¢ No Fluff: Do not summarize what the company does. Do not use generic phrases like 'we remain positive.'
‚Ä¢ Quantify: Wherever possible, use specific numbers (basis points, EPS estimates, multiples) rather than qualitative adjectives.
‚Ä¢ Tone: Objective, critical, and direct.

Output Structure:
1. The Investment Conclusion (The 'So What?')
‚Ä¢ Summarize the core thesis in 3 sentences max. Why is this analyst bullish/bearish now? Is this a valuation call, a cycle call, or a structural growth call?

2. The 'Delta' (What Changed?)
‚Ä¢ Price Target: [Old] ‚Üí [New]
‚Ä¢ EPS/Revenue Estimates: Specifically, did they raise or cut estimates? By how much? (e.g., 'FY25 EPS raised 5% to $4.50').
‚Ä¢ Rating: [Upgrade/Downgrade/Reiteration]

3. Key Drivers & Proprietary Insights
‚Ä¢ Identify the 2-3 specific arguments driving their view.
‚Ä¢ Crucial: Highlight any proprietary data (channel checks, surveys, expert calls) they cite. If none, note 'Analysis relies on standard consensus data.'

4. Valuation & Logic
‚Ä¢ How is the Price Target derived? (e.g., '25x FY26 EPS' or 'DCF with 9% WACC').
‚Ä¢ Is this valuation multiple a premium or discount to peers/history?

5. Catalysts & Risks
‚Ä¢ Upcoming Catalyst: What is the next specific event to watch (earnings date, clinical read-out, analyst day)?
‚Ä¢ Key Downside Risk: What is the #1 specific risk cited that could break the thesis?`
            },
            {
                id: 'high-fidelity-digest',
                name: 'Deep Digest',
                shortName: 'Digest',
                icon: 'üìñ',
                description: 'Comprehensive digest that preserves narrative arc and data density',
                prompt: `Act as a detail-oriented Research Associate at an institutional fund.

Task: Create a comprehensive, "high-fidelity" digest of the attached research report. The goal is accurate information compression: I need to know exactly what is in this report without reading it.

Guidelines:
‚Ä¢ No Interpretation: Do not offer your own opinion. Reflect the analyst's view strictly.
‚Ä¢ Preserve the Narrative: Don't just list bullet points; capture the logical flow of their argument.
‚Ä¢ High Data Density: Include the specific numbers (EPS, multiples, growth rates) referenced in the text.

Output Format:

1. The Synopsis (The 'Answer First')
‚Ä¢ Write a single paragraph (3-4 sentences) that encapsulates the main purpose of the note, the investment conclusion, and the primary catalyst.

2. The Core Arguments (The Logic)
‚Ä¢ Identify the 3 distinct 'pillars' of their thesis. For each pillar, provide a bold header and a brief explanation.
   ‚Ä¢ Argument 1: [e.g., Margins are expanding faster than peers...]
   ‚Ä¢ Argument 2: [e.g., The cycle has bottomed...]
   ‚Ä¢ Argument 3: [e.g., Valuation provides a safety margin...]

3. By The Numbers (The Evidence)
‚Ä¢ Extract the key financial changes/estimates into a list:
   ‚Ä¢ Rating/Target: [Current vs Prior]
   ‚Ä¢ Estimates: [Changes to Revenue/EPS for FY1/FY2]
   ‚Ä¢ Valuation Basis: [e.g., 15x 2025E EBITDA]

4. The "Money Quote"
‚Ä¢ Extract the single most insightful or punchy sentence verbatim from the report that captures the analyst's conviction or the situation's gravity.`
            },
            {
                id: 'buy-side-synthesizer',
                name: 'Universal Synthesizer',
                shortName: 'Synthesizer',
                icon: 'üß†',
                description: 'Decision-grade executive summary that adapts to any report type',
                prompt: `Act as a Senior Analyst at a large-cap long-only fund. Your goal is to screen this sell-side research report and produce a "Decision-Grade Executive Summary" for your Portfolio Manager.

Step 1: Classification
Determine the type of report:
‚Ä¢ Type A: Single Stock Note (Earnings, upgrade/downgrade, initiation).
‚Ä¢ Type B: Sector/Thematic (Year-ahead outlook, industry deep dive, basket strategy).
‚Ä¢ Type C: Event Recap (Conference notes, management meetings, expert calls).

Step 2: Analysis & Extraction (Apply based on Type)
‚Ä¢ If Type A: Focus on the "Delta" (What changed in estimates/target?), the Valuation Logic, and the specific Catalyst.
‚Ä¢ If Type B: Focus on the "Pecking Order" (Top Picks vs. Avoids), the key structural debate, and relative valuation.
‚Ä¢ If Type C: Focus on "Tone/Sentiment," common themes across companies, and incremental new information.

Step 3: The Output Generation
Output the summary in the following strict format. Do not use fluff. Use bullet points.

1. The Executive Bottom Line (The "So What?")
‚Ä¢ One-Sentence Thesis: What is the core investment conclusion? (e.g., "Buy [Ticker] because AI monetization is accelerating faster than consensus," or "Overweight Semis due to inventory bottoming").
‚Ä¢ The Verdict: [Bullish / Bearish / Neutral / Consensus]
‚Ä¢ Key Ticker(s) Impacted: [List top 3-5 relevant tickers]

2. Critical Takeaways (The "Why?")
‚Ä¢ Provide 3-4 high-value bullet points. Quantify where possible (bps, $, %, multiples).
‚Ä¢ If Single Stock: Why is the analyst changing their view or sticking to it? What is the specific driver (margins, volume, pricing)?
‚Ä¢ If Sector/Theme: What is the dominant trend? Who are the clear winners and losers?
‚Ä¢ If Event: What was the surprise? Who sounded confident? Who sounded weak?

3. The "Alpha" & Proprietary Data
‚Ä¢ Did the analyst do real work? Highlight any proprietary evidence cited: Channel checks, survey data, expert calls, or unique datasets.
‚Ä¢ If none: State "Standard analysis based on consensus data."

4. Valuation & Estimates (The "Price")
‚Ä¢ For Stocks: What is the Target Price based on? (e.g., 25x FY26 EPS). Is this a premium/discount to history?
‚Ä¢ For Sectors: Which sub-sector is cheap vs. expensive?

5. Risks & Pushbacks (The "Pre-Mortem")
‚Ä¢ What is the single biggest risk to this thesis?
‚Ä¢ What is the "Bear Case" argument that the analyst is fighting against?`
            },
            {
                id: 'dashboard',
                name: 'Dashboard Extract',
                shortName: 'Dashboard',
                icon: 'üìã',
                description: 'Standardized extraction for side-by-side comparison',
                prompt: `Extract the following data points into a structured Markdown table. If the data is not in the report, write 'N/A'.

| Metric | Value / Insight |
|--------|-----------------|
| Ticker | |
| Analyst Rating / Target | |
| Key Catalyst (Next 3-6m) | [Specific event & date] |
| Change in Est (EPS) | [e.g., Raised FY25 EPS by 5%] |
| One-Paragraph Thesis | [Max 4 sentences] |
| Top Pushback | [What is the #1 question investors are asking management?] |
| Channel Checks | [Any proprietary data cited?] |`
            },
            {
                id: 'variant-perception',
                name: 'Edge Finder',
                shortName: 'Edge',
                icon: 'üéØ',
                description: 'Triage: Does this report say anything new or just regurgitate consensus?',
                prompt: `Act as a cynical Senior Portfolio Manager. I am pasting a sell-side equity research report below. Your job is to determine if this report contains a 'Variant Perception' (a view significantly different from the market consensus).

1. Identify the Consensus: Briefly state the current market consensus on this stock (e.g., 'Growth is slowing, valuation is full').

2. The Analyst's Edge: Does this analyst present a clear data point, proprietary survey, or channel check that contradicts that consensus?

3. The Verdict: If there is a variant perception, summarize it in one bullet point. If this is just a 'maintenance note' or 'earnings preview' with no new thesis change, output only: 'No new signal ‚Äì Maintenance Research.'`
            },
            {
                id: 'reverse-engineer',
                name: 'Reverse Engineering',
                shortName: 'Valuation',
                icon: 'üîç',
                description: 'Find the load-bearing assumption in their valuation model',
                prompt: `Analyze the valuation section of this report. I want you to reverse-engineer the analyst's Target Price to find the 'Load-Bearing Assumption.'

1. The Driver: What is the single most aggressive assumption in their model? (e.g., Is it 500bps of margin expansion in 2026? Is it a 25x exit multiple when peers trade at 18x?)

2. Sensitivity Check: If that one assumption fails (e.g., margins stay flat), roughly how much downside is there to their Price Target?

3. Implied Expectations: What does the current stock price imply vs. what the analyst is modeling?

Output as a table: [Critical Assumption] | [Analyst's Input] | [Historical Average] | [Risk to Target]`
            },
            {
                id: 'pre-mortem',
                name: 'Risk Radar',
                shortName: 'Risks',
                icon: '‚ö†Ô∏è',
                description: 'Surface buried risks and blind spots in the thesis',
                prompt: `Conduct a 'Pre-Mortem' on this Buy rating (or Sell rating). Imagine it is 12 months from now, and this trade has gone horribly wrong.

1. The Bear Case: Based only on the risks mentioned in the report (even the small print), construct the most lethal Bear Case narrative that the analyst is downplaying.

2. Blind Spots: What obvious macro or sector risk is the analyst ignoring or failing to mention entirely?

3. The 'Trust Me' Factor: Identify any claims the analyst makes that are purely qualitative (e.g., 'management tone was confident') and lack quantitative backing.`
            },
            {
                id: 'debate-partner',
                name: 'Debate Partner',
                shortName: 'Debate',
                icon: '‚öîÔ∏è',
                description: 'Stress-test a bullish report by acting as a short seller',
                prompt: `I am long this stock. This report supports my view. However, I want to avoid confirmation bias.

Act as a Short Seller. Read this bullish report and tear it apart.

1. Highlight the weakest link in their logic.

2. Point out where they are extrapolating short-term trends into perpetuity.

3. Give me 3 tough questions I should ask the analyst on the phone to test their conviction.`
            },
            {
                id: 'thesis-builder',
                name: 'Thesis Builder',
                shortName: 'Thesis',
                icon: 'üéØ',
                description: 'Generate Investment Thesis, Signposts & Threats from a single document',
                prompt: `Act as a Senior Buy-Side Analyst at a top-tier long-only fund. Analyze this document and extract a complete investment framework.

Your output must include exactly three sections:

## 1. INVESTMENT THESIS (Why Own This Stock?)

Provide 4-5 thesis pillars that answer "Why should we own this stock?"

For each pillar:
- **Title**: Clear, actionable statement (e.g., "Market Share Gains Accelerating")
- **Description**: 2-3 sentences explaining the thesis point with specific data
- **Confidence**: High / Medium / Low
- **Key Evidence**: Specific numbers, quotes, or data points from the document

Format as:
### Pillar 1: [Title]
[Description]
- Confidence: [Level]
- Evidence: [Specific data]

## 2. SIGNPOSTS (What Are We Watching?)

Provide 4-5 specific, measurable KPIs or events that will confirm or refute the thesis.

For each signpost:
- **Metric/Event**: Specific KPI name or catalyst (e.g., "Q4 Same-Store Sales Growth")
- **Current Value**: What it is now (if mentioned)
- **Target/Expectation**: What would validate the thesis
- **Monitoring Frequency**: Quarterly/Monthly/Event-driven
- **Why It Matters**: Brief explanation of significance

Format as:
### Signpost 1: [Metric/Event]
- Current: [Value]
- Target: [Expected value for thesis to work]
- Frequency: [How often to check]
- Significance: [Why this matters]

## 3. THESIS THREATS (Where Can We Be Wrong?)

Provide 4-5 specific risks that could break the investment thesis.

For each threat:
- **Risk**: Clear statement of what could go wrong
- **Likelihood**: High / Medium / Low
- **Impact**: High / Medium / Low (impact on stock if it happens)
- **Trigger Points**: Early warning signs to watch for
- **Mitigant**: What could offset this risk (if any)

Format as:
### Threat 1: [Risk Statement]
- Likelihood: [Level] | Impact: [Level]
- Triggers: [What to watch]
- Mitigant: [Offsetting factor, if any]

---

IMPORTANT GUIDELINES:
- Be specific with numbers, percentages, and timeframes
- Do NOT reference broker names or analyst names in the prose
- Write as independent analysis, not a summary of others' views
- Focus on forward-looking, actionable insights
- Prioritize proprietary data or unique insights if present in the document`
            },
            {
                id: 'simplify',
                name: 'Simplify',
                shortName: 'Simplify',
                icon: 'üéì',
                description: 'Translate complex business concepts into plain English for easy understanding',
                prompt: `Role: You are a world-class educator and expert translator of complex business concepts. Your student is a smart 13-year-old with no prior knowledge of finance, specific industry jargon, or corporate structures.

Task: Analyze the provided text/report and rewrite the key takeaways into a narrative that is easy to digest, using analogies, simple language, and clear logic.

Guidelines:
1. The "Grandma/Teenager" Test: If a sentence requires an MBA or industry experience to understand, rewrite it.
2. Analogies are King: Use real-world analogies (sports, school, traffic, shopping) to explain abstract concepts like "synergies," "operating leverage," or "regulatory moats."
3. Jargon Buster: If you must use a technical term (e.g., EBITDA, Intermodal, Margin), immediately explain it in plain English in parentheses or a dedicated "Vocabulary" section.

Structure your output as follows:

## The Big Headline
What is actually happening in one sentence?

## The Story (The "What" and "Why")
Explain the situation using a strong analogy. Make it relatable and memorable.

## The Jargon Decoder
A bulleted list translating the complex terms found in the text:
- **[Technical Term]**: [Plain English explanation]

## The Scoreboard (The Numbers)
Simplify the financial impacts:
- Money made or expected to be made
- Money saved or costs involved
- Use relatable comparisons (e.g., "That's like buying X iPhones" or "Enough to pay Y teachers for a year")

## The Referee (Risks/Regulation)
Who might stop this and why? Explain any regulatory, competitive, or other risks in simple terms.`
            },
            {
                id: 'generalist',
                name: 'Generalist',
                shortName: 'Generalist',
                icon: 'üëî',
                description: 'Executive briefing for financially literate non-specialists',
                prompt: `Role: You are a senior equity research analyst preparing a briefing for a generalist Portfolio Manager or a smart institutional client.

Audience: The reader is an intelligent, financially literate adult. They understand concepts like EBITDA, margins, and leverage, but they are not sector experts. They do not know industry-specific acronyms, regulatory nuance, or the detailed competitive landscape.

Task: Synthesize the provided report into an "Executive Briefing Note." Focus on the investment implications rather than just summarizing the text.

Guidelines:
1. Elevate the Conversation: Don't dumb down the finance, but explain the industry mechanics. (e.g., You can say "margin expansion," but you must explain how the specific operational change drives it).
2. Contextualize Jargon: If a specific industry term is crucial (like "Intermodal" or "Operating Ratio"), define it briefly in the context of the business model.
3. Focus on the "So What?": For every data point, ask: Does this matter for the stock price? Does it change the thesis?

Structure your output as follows:

## The Executive Summary
The 30-second elevator pitch of the situation. What's happening, why it matters, and what's the investment implication?

## Strategic Rationale
Why is this happening now? What is the business logic? Explain the industry dynamics that make this move sensible (or risky).

## The Numbers Case
Key financial drivers without getting lost in accounting minutiae:
- **Synergies/Cost Savings**: What operational improvements are expected?
- **EPS Impact**: How does this affect earnings and by when?
- **Return Profile**: ROIC, payback period, or other relevant return metrics
- **Valuation Context**: How does the market appear to be pricing this?

## Key Risks/Hurdles
Regulatory, execution, or macro risks that could derail the thesis:
- Rank by probability and impact
- Note any upcoming decision points or catalysts that could resolve uncertainty`
            }
        ];

        // Error Boundary component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true };
            }
            componentDidCatch(error, errorInfo) {
                this.setState({ error, errorInfo });
                console.error('ErrorBoundary caught:', error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '20px', color: '#ff6b6b', background: '#1a1a2e', minHeight: '100vh' }}>
                            <h2>‚ö†Ô∏è Something went wrong</h2>
                            <p><strong>Error:</strong> {this.state.error?.toString()}</p>
                            <pre style={{ whiteSpace: 'pre-wrap', fontSize: '12px', marginTop: '10px' }}>
                                {this.state.errorInfo?.componentStack}
                            </pre>
                            <button onClick={() => window.location.reload()} style={{ marginTop: '20px', padding: '10px 20px', background: '#4ecdc4', border: 'none', borderRadius: '5px', cursor: 'pointer' }}>
                                Reload App
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Icons
        const FileText = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>;
        const TrendingUp = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const AlertTriangle = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/></svg>;
        const Target = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
        const ChevronDown = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>;
        const ChevronLeft = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>;
        const ChevronRight = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>;
        const Upload = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const Download = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Send = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
        const Copy = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
        const Loader = ({className = "w-5 h-5"}) => <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><style>{`@keyframes spin { to { transform: rotate(360deg); }}`}</style><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/></svg>;
        const Key = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/></svg>;
        const GripVertical = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>;
        const Trash = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Plus = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Save = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const Database = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
        const Folder = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>;
        const RefreshCw = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>;
        const Edit = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const Edit2 = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const ExternalLink = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>;
        const X = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Check = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;
        const Mail = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>;
        const Menu = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
        const History = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const RotateCcw = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const Home = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const MessageCircle = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>;
        const BarChart2 = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>;
        const PieChart = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>;
        const Settings = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const ClipboardList = ({className = "w-6 h-6"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>;
        const Search = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const Mails = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><rect x="6" y="6" width="16" height="12" rx="2"/><polyline points="22,8 14,13 6,8"/><path d="M2 10a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12" opacity="0.5"/></svg>;
        const ChevronsDown = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg>;
        const ChevronsUp = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg>;
        const ChevronUp = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="18 15 12 9 6 15"/></svg>;
        const MoreHorizontal = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>;
        const Microscope = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></svg>;
        const FileUp = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 12v6"/><path d="m15 15-3-3-3 3"/></svg>;
        const Info = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;
        const Repeat2 = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="m2 9 3-3 3 3"/><path d="M13 18H7a2 2 0 0 1-2-2V6"/><path d="m22 15-3 3-3-3"/><path d="M11 6h6a2 2 0 0 1 2 2v10"/></svg>;
        const Mic = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>;
        const Layers = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>;
        const Wand = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="m15 4-1.17 2.83L11 8l2.83 1.17L15 12l1.17-2.83L19 8l-2.83-1.17L15 4z"/><path d="m3 21 9-9"/><path d="m12.5 6.5 5 5"/><path d="m6 15 2-2"/><path d="M4.5 12.5 3 14"/><path d="m10 20 2-1.5"/></svg>;
        const ImageIcon = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>;
        const GitBranch = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>;
        const CheckCircle2 = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const RotateCw = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>;

        // Helper to detect iOS/iPadOS (including iPadOS 13+ that reports as Mac)
        const isIOSDevice = () => {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.userAgent.includes('Mac') && navigator.maxTouchPoints > 1);
        };

        // Simple storage helpers - try multiple methods for iOS PWA
        const STORAGE_KEY = 'equity_analyzer_api_key';
        
        const saveApiKeyToStorage = (key) => {
            // Save to all available storage methods
            try { localStorage.setItem(STORAGE_KEY, key); } catch(e) { console.log('localStorage failed'); }
            try { sessionStorage.setItem(STORAGE_KEY, key); } catch(e) { console.log('sessionStorage failed'); }
            // Also save to IndexedDB
            try {
                const request = indexedDB.open('EquityAnalyzerDB', 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => {
                    const db = request.result;
                    const tx = db.transaction('settings', 'readwrite');
                    tx.objectStore('settings').put({ id: 'apiKey', value: key });
                };
            } catch(e) { console.log('IndexedDB failed'); }
        };

        const loadApiKeyFromStorage = () => {
            // Check localStorage first (sync)
            try { 
                const key = localStorage.getItem(STORAGE_KEY);
                if (key) return key;
            } catch(e) {}
            // Check sessionStorage (sync)
            try {
                const key = sessionStorage.getItem(STORAGE_KEY);
                if (key) return key;
            } catch(e) {}
            return '';
        };

        // Gemini API key storage helpers (for audio transcription)
        const GEMINI_STORAGE_KEY = 'equity_analyzer_gemini_key';

        const saveGeminiKeyToStorage = (key) => {
            try { localStorage.setItem(GEMINI_STORAGE_KEY, key); } catch(e) { console.log('localStorage failed'); }
            try { sessionStorage.setItem(GEMINI_STORAGE_KEY, key); } catch(e) { console.log('sessionStorage failed'); }
            try {
                const request = indexedDB.open('EquityAnalyzerDB', 1);
                request.onsuccess = () => {
                    const db = request.result;
                    const tx = db.transaction('settings', 'readwrite');
                    tx.objectStore('settings').put({ id: 'geminiApiKey', value: key });
                };
            } catch(e) { console.log('IndexedDB failed'); }
        };

        const loadGeminiKeyFromStorage = () => {
            try {
                const key = localStorage.getItem(GEMINI_STORAGE_KEY);
                if (key) return key;
            } catch(e) {}
            try {
                const key = sessionStorage.getItem(GEMINI_STORAGE_KEY);
                if (key) return key;
            } catch(e) {}
            return '';
        };

        // Simple markdown renderer
        const renderMarkdown = (text) => {
            if (!text) return '';
            // Safety: ensure text is a string
            if (typeof text !== 'string') {
                text = safeStr(text);
            }
            if (!text) return '';
            
            // Helper for inline formatting (bold, italic)
            function formatInline(str) {
                return str
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>');
            }
            
            // Process line by line to handle nested content
            const lines = text.split('\n');
            let result = [];
            let underHeaderBullet = false; // Track if we're under a header bullet
            let inTable = false;
            let tableRows = [];
            let tableHasHeader = false;
            
            // Helper to render collected table
            function flushTable() {
                if (tableRows.length === 0) return;
                
                let tableHtml = '<div class="overflow-x-auto my-3"><table class="w-full text-sm border-collapse">';
                
                tableRows.forEach((row, rowIndex) => {
                    // Parse cells from the row (split by | and filter empty)
                    const cells = row.split('|').map(c => c.trim()).filter(c => c && !c.match(/^[-:]+$/));
                    
                    if (cells.length === 0) return;
                    
                    // Skip separator rows (contain only dashes/colons)
                    if (cells.every(c => c.match(/^[-:]+$/))) return;
                    
                    const isHeader = rowIndex === 0 && tableHasHeader;
                    const tag = isHeader ? 'th' : 'td';
                    const cellClass = isHeader 
                        ? 'px-3 py-2 text-left font-semibold text-teal-400 bg-white/[0.07] backdrop-blur-lg border-b border-white/10' 
                        : 'px-3 py-2 text-left border-b border-white/10';
                    
                    tableHtml += '<tr>';
                    cells.forEach(cell => {
                        tableHtml += `<${tag} class="${cellClass}">${formatInline(cell)}</${tag}>`;
                    });
                    tableHtml += '</tr>';
                });
                
                tableHtml += '</table></div>';
                result.push(tableHtml);
                tableRows = [];
                inTable = false;
                tableHasHeader = false;
            }
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                const trimmedLine = line.trim();
                
                // Check if this line is a table row (starts and ends with | or contains multiple |)
                const isTableRow = trimmedLine.startsWith('|') || (trimmedLine.includes('|') && trimmedLine.split('|').length >= 3);
                const isSeparatorRow = /^\|?[\s\-:|\s]+\|?$/.test(trimmedLine) && trimmedLine.includes('-');
                
                if (isTableRow || isSeparatorRow) {
                    if (!inTable) {
                        inTable = true;
                        tableRows = [];
                    }
                    if (isSeparatorRow) {
                        tableHasHeader = true; // Previous row was header
                    } else {
                        tableRows.push(trimmedLine);
                    }
                    continue;
                } else if (inTable) {
                    // End of table, flush it
                    flushTable();
                }
                
                // Skip empty lines but track context
                if (!trimmedLine) {
                    underHeaderBullet = false;
                    continue;
                }
                
                // Check for sub-headers: lines that are ONLY bold text with colon (like "**Business Mix Breakdown:**")
                const subHeaderMatch = trimmedLine.match(/^\*\*([^*]+)\*\*:?\s*$/);
                if (subHeaderMatch) {
                    underHeaderBullet = false;
                    result.push(`<div class="font-semibold text-slate-200 mt-4 mb-2 pt-3 border-t border-white/10">${subHeaderMatch[1]}:</div>`);
                    continue;
                }
                
                // Check if this line is a bullet point
                const bulletMatch = trimmedLine.match(/^[-‚Ä¢\*]\s+(.*)$/) || trimmedLine.match(/^\d+\.\s+(.*)$/);
                
                if (bulletMatch) {
                    const bulletContent = bulletMatch[1];
                    
                    // Check if this bullet starts with bold text (header bullet)
                    // Pattern: **Bold Label:** followed by text
                    const isHeaderBullet = /^\*\*[^*]+\*\*:/.test(bulletContent);
                    
                    if (isHeaderBullet) {
                        // This is a header bullet - render at main level
                        underHeaderBullet = true;
                        result.push(`<div class="flex gap-2 mt-3"><span class="text-slate-500 flex-shrink-0">‚Ä¢</span><div>${formatInline(bulletContent)}</div></div>`);
                    } else if (underHeaderBullet) {
                        // This is a sub-bullet under a header bullet - indent it
                        result.push(`<div class="flex gap-2 mt-1 ml-5"><span class="text-slate-600 flex-shrink-0">‚ó¶</span><div class="text-slate-300">${formatInline(bulletContent)}</div></div>`);
                    } else {
                        // Regular bullet not under a header
                        result.push(`<div class="flex gap-2 mt-2"><span class="text-slate-500 flex-shrink-0">‚Ä¢</span><div>${formatInline(bulletContent)}</div></div>`);
                    }
                } else if (line.trim()) {
                    // Regular paragraph or header
                    underHeaderBullet = false;
                    if (/^###\s*(.+)$/.test(line)) {
                        result.push(line.replace(/^###\s*(.+)$/, '<div class="font-semibold mt-3 mb-1">$1</div>'));
                    } else if (/^##\s*(.+)$/.test(line)) {
                        result.push(line.replace(/^##\s*(.+)$/, '<div class="font-semibold text-base mt-3 mb-1">$1</div>'));
                    } else if (/^#\s*(.+)$/.test(line)) {
                        result.push(line.replace(/^#\s*(.+)$/, '<div class="font-bold text-lg mt-3 mb-1">$1</div>'));
                    } else {
                        result.push(`<p class="mt-2">${formatInline(line)}</p>`);
                    }
                }
            }
            
            // Flush any remaining table
            if (inTable) {
                flushTable();
            }
            
            const html = result.join('');
            return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;
        };

        // Chat Interface Component - built-in chat UI
        const ChatInterface = ({ chatUrl, messages, setMessages, sessionId, onSaveToOverview }) => {
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showExportDialog, setShowExportDialog] = useState(false);
            const [exportTicker, setExportTicker] = useState('');
            const [exportCompany, setExportCompany] = useState('');
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            useEffect(() => {
                // Focus input on mount
                inputRef.current?.focus();
            }, []);

            const sendMessage = async () => {
                if (!input.trim() || isLoading) return;
                
                const userMessage = input.trim();
                setInput('');
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setIsLoading(true);

                try {
                    const response = await fetch(chatUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'sendMessage',
                            sessionId: sessionId,
                            chatInput: userMessage
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Handle different response formats from n8n
                        let botResponse = data.output || data.response || data.text || data.message || 
                                          (Array.isArray(data) && data[0]?.output) ||
                                          (Array.isArray(data) && data[0]?.message) ||
                                          (Array.isArray(data) && data[0]?.text) ||
                                          (typeof data === 'string' ? data : null);
                        
                        if (!botResponse && typeof data === 'object') {
                            // Try to extract any string value
                            const values = Object.values(data).flat();
                            botResponse = values.find(v => typeof v === 'string') || JSON.stringify(data);
                        }
                        
                        setMessages(prev => [...prev, { role: 'assistant', content: botResponse }]);
                    } else {
                        throw new Error('Failed to get response');
                    }
                } catch (err) {
                    console.error('Chat error:', err);
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: 'Sorry, I encountered an error connecting to the assistant. Please try again or use the "Open" button to chat in a new window.' 
                    }]);
                } finally {
                    setIsLoading(false);
                    inputRef.current?.focus();
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };
            
            // Get the last assistant message for export
            const getLastBotMessage = () => {
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].role === 'assistant' && messages[i].content.length > 100) {
                        return messages[i].content;
                    }
                }
                return null;
            };
            
            const handleExport = () => {
                if (exportTicker.trim()) {
                    const content = getLastBotMessage();
                    if (content) {
                        onSaveToOverview(exportTicker.trim(), exportCompany.trim(), content);
                        setShowExportDialog(false);
                        setExportTicker('');
                        setExportCompany('');
                    }
                }
            };

            return (
                <div className="flex-1 flex flex-col overflow-hidden">
                    {/* Messages Area */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] sm:max-w-[75%] rounded-2xl px-4 py-3 ${
                                    msg.role === 'user'
                                        ? 'bg-gradient-to-br from-teal-500/90 to-cyan-500/90 border border-teal-400/30 shadow-lg shadow-teal-500/20 text-white rounded-br-sm'
                                        : 'bg-white/10 backdrop-blur-lg border border-white/10 text-slate-100 rounded-bl-sm'
                                }`}>
                                    <div 
                                        className="text-sm leading-relaxed"
                                        dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.content) }}
                                    />
                                    {msg.role === 'assistant' && (
                                        <div className="mt-2 flex justify-end opacity-40 hover:opacity-100 transition-opacity">
                                            <button 
                                                onClick={() => {
                                                    navigator.clipboard.writeText(msg.content);
                                                    alert('Copied to clipboard!');
                                                }}
                                                className="p-1 hover:bg-white/10 rounded transition"
                                                title="Copy"
                                            >
                                                <Copy className="w-3.5 h-3.5" />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="bg-white/10 backdrop-blur-lg border border-white/10 rounded-2xl rounded-bl-sm px-4 py-3">
                                    <div className="flex gap-1.5">
                                        <div className="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                        <div className="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                        <div className="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="p-4 border-t border-white/10 bg-white/5 backdrop-blur-xl">
                        <div className="flex gap-3">
                            <input
                                ref={inputRef}
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Type your message..."
                                className="flex-1 px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-xl text-base focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 placeholder-slate-500"
                                style={{ fontSize: '16px' }}
                                disabled={isLoading}
                            />
                            <button
                                onClick={sendMessage}
                                disabled={!input.trim() || isLoading}
                                className="px-4 py-3 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 disabled:bg-white/10 disabled:text-slate-500 rounded-xl transition-colors flex-shrink-0"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                            </button>
                        </div>
                        {/* Export button - show when there are bot responses */}
                        {messages.length > 1 && getLastBotMessage() && (
                            <button
                                onClick={() => setShowExportDialog(true)}
                                className="mt-3 text-sm text-teal-400 hover:text-teal-300 flex items-center gap-2"
                            >
                                <Download className="w-4 h-4" />
                                Save response to Overview
                            </button>
                        )}
                    </div>
                    
                    {/* Export Dialog */}
                    {showExportDialog && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-900/90 backdrop-blur-2xl border border-white/10 rounded-xl p-6 max-w-sm w-full">
                                <h3 className="text-lg font-semibold mb-4">Save to Overview</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-1">Ticker Symbol *</label>
                                        <input
                                            type="text"
                                            value={exportTicker}
                                            onChange={(e) => setExportTicker(e.target.value.toUpperCase())}
                                            placeholder="e.g., AAPL"
                                            className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-base"
                                            style={{ fontSize: '16px' }}
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-1">Company Name</label>
                                        <input
                                            type="text"
                                            value={exportCompany}
                                            onChange={(e) => setExportCompany(e.target.value)}
                                            placeholder="e.g., Apple Inc."
                                            className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-base"
                                            style={{ fontSize: '16px' }}
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => setShowExportDialog(false)}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleExport}
                                        disabled={!exportTicker.trim()}
                                        className="flex-1 px-4 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 disabled:bg-white/10 rounded-lg font-medium"
                                    >
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Stored Files Section Component for Research tab
        const StoredFilesSection = ({ docId, onDelete }) => {
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [expanded, setExpanded] = useState(false);
            
            useEffect(() => {
                const fetchFiles = async () => {
                    try {
                        const response = await fetch(`${API_URL}/api/research-document-files/${docId}`);
                        if (response.ok) {
                            setFiles(await response.json());
                        }
                    } catch (err) {
                        console.error('Error fetching stored files:', err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchFiles();
            }, [docId]);
            
            const viewFile = (file) => {
                try {
                    const base64Data = file.fileData;
                    if (!base64Data) {
                        alert('No file data available');
                        return;
                    }
                    const mimeType = file.fileType || 'application/pdf';
                    
                    // Convert base64 to blob
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });
                    
                    // Create URL
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // For iOS/iPadOS PWA, use a link click instead of window.open
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    // For PDFs on iOS/iPadOS, trigger download to open in Files/viewer
                    if (isIOSDevice()) {
                        link.download = file.filename || 'document.pdf';
                    }
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up URL after a delay
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                } catch (err) {
                    console.error('Error viewing file:', err);
                    alert('Failed to open file');
                }
            };
            
            const downloadFile = (file) => {
                try {
                    const base64Data = file.fileData;
                    const mimeType = file.fileType || 'application/pdf';
                    
                    // Convert base64 to blob
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });
                    
                    // Create download link
                    const blobUrl = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = file.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
                } catch (err) {
                    console.error('Error downloading file:', err);
                    alert('Failed to download file');
                }
            };
            
            const formatFileSize = (bytes) => {
                if (!bytes) return '';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            };
            
            if (loading) {
                return (
                    <div className="pt-3 mt-3 border-t border-white/10">
                        <div className="flex items-center gap-2 text-xs text-slate-500">
                            <Database className="w-3.5 h-3.5" />
                            <span>Loading stored files...</span>
                        </div>
                    </div>
                );
            }
            
            if (files.length === 0) return null;
            
            return (
                <div className="pt-3 mt-3 border-t border-white/10">
                    <div className="flex items-center justify-between mb-2">
                        <button
                            onClick={() => setExpanded(!expanded)}
                            className="flex items-center gap-2 text-xs text-slate-400 hover:text-slate-300"
                        >
                            <Database className="w-3.5 h-3.5 text-teal-500" />
                            <span>{files.length} stored file{files.length !== 1 ? 's' : ''}</span>
                            <ChevronDown className={`w-3 h-3 transition-transform ${expanded ? 'rotate-180' : ''}`} />
                        </button>
                        <button
                            onClick={onDelete}
                            className="text-xs text-red-400 hover:text-red-300 hover:bg-red-600/20 px-2 py-1 rounded"
                        >
                            Delete all
                        </button>
                    </div>
                    
                    {expanded && (
                        <div className="space-y-2">
                            {files.map(file => (
                                <div key={file.id} className="flex items-center justify-between bg-white/[0.04] backdrop-blur-lg rounded-lg px-3 py-2">
                                    <div className="flex items-center gap-2 min-w-0 flex-1">
                                        <FileText className="w-4 h-4 text-slate-500 flex-shrink-0" />
                                        <span className="text-xs text-slate-300 truncate">{file.filename}</span>
                                        {file.fileSize && (
                                            <span className="text-xs text-slate-500 flex-shrink-0">({formatFileSize(file.fileSize)})</span>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-1 flex-shrink-0">
                                        <button
                                            onClick={() => viewFile(file)}
                                            className="p-1.5 text-teal-400 hover:bg-teal-600/20 rounded"
                                            title="Open in new tab"
                                        >
                                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                                <polyline points="15 3 21 3 21 9"/>
                                                <line x1="10" y1="14" x2="21" y2="3"/>
                                            </svg>
                                        </button>
                                        <button
                                            onClick={() => downloadFile(file)}
                                            className="p-1.5 text-slate-400 hover:bg-white/10 rounded"
                                            title="Download"
                                        >
                                            <Download className="w-3.5 h-3.5" />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            // Separate states: apiKeyInput is what user types, apiKeySaved is what's confirmed saved
            const [apiKeyInput, setApiKeyInput] = useState('');
            const [apiKeySaved, setApiKeySaved] = useState(loadApiKeyFromStorage() || '');
            const [apiKeyChecked, setApiKeyChecked] = useState(false);
            const [savedAnalyses, setSavedAnalyses] = useState([]);
            const [currentTicker, setCurrentTicker] = useState(null);
            const [documents, setDocuments] = useState([]);
            const [documentGroups, setDocumentGroups] = useState([]); // Groups of documents treated as single unit
            const [selectedForGrouping, setSelectedForGrouping] = useState([]); // Doc IDs selected for grouping
            const [analysis, setAnalysis] = useState(null);
            const [changes, setChanges] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [expanded, setExpanded] = useState({ thesis: true, signposts: true, threats: true, changes: true });
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [showSaveDialog, setShowSaveDialog] = useState(false);
            const [showEmailDialog, setShowEmailDialog] = useState(false);
            const [weightingMode, setWeightingMode] = useState('simple'); // 'simple' or 'advanced'
            const [existingAnalysisWeight, setExistingAnalysisWeight] = useState(70); // % weight for existing analysis in simple mode
            const [emailData, setEmailData] = useState(() => {
                // Load saved credentials from localStorage
                const saved = localStorage.getItem('emailCredentials');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        return { email: '', useGmail: false, gmailUser: '', gmailPassword: '', customSubject: '' };
                    }
                }
                return { email: '', useGmail: false, gmailUser: '', gmailPassword: '', customSubject: '' };
            });
            const [editingItem, setEditingItem] = useState(null); // {type, index, field}
            const [editingDocName, setEditingDocName] = useState(null); // filename of doc being renamed
            const [editingDocNameValue, setEditingDocNameValue] = useState(''); // temp value for rename
            const [showSourcesPopup, setShowSourcesPopup] = useState(null); // {type: 'pillar'|'signpost'|'threat', index, sources}
            const [showDocumentManager, setShowDocumentManager] = useState(false); // Show doc manager for updates
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false); // Mobile sidebar toggle
            const [showHistory, setShowHistory] = useState(false); // Show version history panel
            const [selectedHistoryVersion, setSelectedHistoryVersion] = useState(null); // Currently viewed history version
            const [activeTab, setActiveTab] = useState('chat'); // Bottom nav: 'portfolio', 'overview', 'chat', 'summary', 'research', 'settings'
            const [showMoreMenu, setShowMoreMenu] = useState(false); // More menu bottom sheet
            const [showScrollTop, setShowScrollTop] = useState(false); // Show scroll to top button
            const scrollContainerRef = useRef(null);
            const [storedDocuments, setStoredDocuments] = useState([]); // Documents stored in database for current ticker
            const [storageStats, setStorageStats] = useState(null); // Storage usage statistics
            
            // Research tab state - hierarchical structure
            // Categories (tickers + topics)
            const [researchCategories, setResearchCategories] = useState([]); // [{id, name, type: 'ticker'|'topic'}]
            const [selectedResearchCategory, setSelectedResearchCategory] = useState(null);
            
            // Documents within categories
            const [researchDocuments, setResearchDocuments] = useState([]); // [{id, categoryId, name, content, fileNames, createdAt}]
            
            // Analyses for documents (multiple frameworks per document)
            const [researchAnalyses, setResearchAnalyses] = useState([]); // [{id, documentId, promptId, promptName, promptIcon, result, createdAt}]
            
            // UI state
            const [expandedResearchDocs, setExpandedResearchDocs] = useState(new Set());
            const [expandAllResearchDocs, setExpandAllResearchDocs] = useState(false);
            const [selectedFrameworks, setSelectedFrameworks] = useState([RESEARCH_PROMPTS[0].id]); // Multi-select frameworks
            const [showAddResearchDoc, setShowAddResearchDoc] = useState(false);
            const [showAddResearchCategory, setShowAddResearchCategory] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [newCategoryType, setNewCategoryType] = useState('ticker');
            const [currentResearchDoc, setCurrentResearchDoc] = useState(null); // Currently viewing/editing doc
            const [currentResearchAnalysis, setCurrentResearchAnalysis] = useState(null); // Currently viewing analysis detail
            const [newDocumentName, setNewDocumentName] = useState(''); // For naming documents
            const [newBrokerName, setNewBrokerName] = useState(''); // For optional broker name prefix
            const [storeResearchDocument, setStoreResearchDocument] = useState(false); // Whether to store uploaded files
            const [researchInput, setResearchInput] = useState('');
            const [researchFiles, setResearchFiles] = useState([]); // Array of {id, name, content, type, isImage}
            const researchFileInputRef = useRef(null);
            const [isResearchLoading, setIsResearchLoading] = useState(false);
            const [researchLoadingFrameworks, setResearchLoadingFrameworks] = useState([]); // Which frameworks are loading
            const [researchLoadingDocId, setResearchLoadingDocId] = useState(null); // Which document is currently being analyzed
            const [researchDataLoaded, setResearchDataLoaded] = useState(false);
            
            // Analysis view/edit state
            const [editingResearchAnalysis, setEditingResearchAnalysis] = useState(false);
            const [editedAnalysisContent, setEditedAnalysisContent] = useState('');
            const [showResearchEmailModal, setShowResearchEmailModal] = useState(false);
            const [researchEmailRecipient, setResearchEmailRecipient] = useState('');
            const [researchEmailSubject, setResearchEmailSubject] = useState('');
            const [runMoreFrameworksDocId, setRunMoreFrameworksDocId] = useState(null); // Doc ID when adding more analyses
            const [expandedDocTitle, setExpandedDocTitle] = useState(null); // For mobile: show full doc title
            const [showFrameworkInfo, setShowFrameworkInfo] = useState(null); // For mobile: show framework description
            const [showResearchSmartNames, setShowResearchSmartNames] = useState(true); // Toggle between smart names and original filenames
            const [editingResearchDocName, setEditingResearchDocName] = useState(null); // Doc ID being edited
            const [editingResearchDocNameValue, setEditingResearchDocNameValue] = useState(''); // Current edit value
            const [researchDocTypeFilter, setResearchDocTypeFilter] = useState([]); // Filter by doc types
            const [editingResearchDocType, setEditingResearchDocType] = useState(null); // Doc ID whose type is being edited
            const [newResearchDocType, setNewResearchDocType] = useState(''); // Doc type for new documents
            
            // Research Document Types
            const RESEARCH_DOC_TYPES = [
                { id: 'rating_change', label: 'Rating Change', icon: '‚¨ÜÔ∏è' },
                { id: 'earnings_preview', label: 'Earnings Preview', icon: 'üîÆ' },
                { id: 'earnings_recap', label: 'Earnings Recap', icon: 'üìä' },
                { id: 'target_change', label: 'Target Price Change', icon: 'üéØ' },
                { id: 'reiterate', label: 'Reiterate Rating', icon: 'üîÑ' },
                { id: 'initiation', label: 'Initiation', icon: 'üöÄ' },
                { id: 'meeting_notes', label: 'Meeting Notes', icon: 'üìù' },
                { id: 'conference_notes', label: 'Conference Notes', icon: 'üé§' },
                { id: 'catalyst_notes', label: 'Catalyst Notes', icon: '‚ö°' },
                { id: 'industry_outlook', label: 'Industry Outlook', icon: 'üè≠' },
                { id: 'deep_dive', label: 'Deep Dive', icon: 'üî¨' },
                { id: 'bull_bear', label: 'Bull/Bear', icon: 'üêÇ' },
                { id: 'flash_notes', label: 'Flash Notes', icon: 'üí°' },
                { id: 'other', label: 'Other', icon: 'üìÑ' }
            ];
            
            // Meeting Prep tab state
            const [mpMeetings, setMpMeetings] = useState([]);
            const [mpSelectedMeeting, setMpSelectedMeeting] = useState(null);
            const [mpDocuments, setMpDocuments] = useState([]);
            const [mpQuestionSet, setMpQuestionSet] = useState(null);
            const [mpFiles, setMpFiles] = useState([]);
            const mpFileInputRef = useRef(null);
            const [mpNewTicker, setMpNewTicker] = useState('');
            const [mpNewCompanyName, setMpNewCompanyName] = useState('');
            const [mpNewSector, setMpNewSector] = useState('');
            const [mpNewMeetingDate, setMpNewMeetingDate] = useState('');
            const [mpNewMeetingType, setMpNewMeetingType] = useState('earnings');
            const [showMpCreateForm, setShowMpCreateForm] = useState(false);
            const [mpPipelineRunning, setMpPipelineRunning] = useState(false);
            const [mpPipelineStep, setMpPipelineStep] = useState('');
            const [mpPipelineProgress, setMpPipelineProgress] = useState('');
            const [mpPipelineError, setMpPipelineError] = useState(null);
            const [mpExpandedTopics, setMpExpandedTopics] = useState(new Set());
            const [mpPriorityFilter, setMpPriorityFilter] = useState('all');
            const [mpShowContext, setMpShowContext] = useState(false);
            const [mpDataLoaded, setMpDataLoaded] = useState(false);
            const [mpPastQuestions, setMpPastQuestions] = useState([]);
            const [mpUploading, setMpUploading] = useState(false);

            // Slides tab state
            const [slideProjects, setSlideProjects] = useState([]);
            const [slideSelectedProject, setSlideSelectedProject] = useState(null);
            const [slideSelectedSlide, setSlideSelectedSlide] = useState(null);
            const [slideEditContent, setSlideEditContent] = useState('');
            const [slideEditTitle, setSlideEditTitle] = useState('');
            const [slideEditHints, setSlideEditHints] = useState('');
            const [slideEditNoHeader, setSlideEditNoHeader] = useState(false);
            const [slideThemes, setSlideThemes] = useState([]);
            const [slideNewTitle, setSlideNewTitle] = useState('');
            const [slideNewTicker, setSlideNewTicker] = useState('');
            const [slideNewTheme, setSlideNewTheme] = useState('sketchnote');
            const [showSlideCreateForm, setShowSlideCreateForm] = useState(false);
            const [slideGenerating, setSlideGenerating] = useState(false);
            const [slideGeneratingNum, setSlideGeneratingNum] = useState(null);
            const [slideDataLoaded, setSlideDataLoaded] = useState(false);
            const [slideOutlineGenerating, setSlideOutlineGenerating] = useState(false);
            const [slidePreviewImage, setSlidePreviewImage] = useState(null);
            const [slideSelectedSlides, setSlideSelectedSlides] = useState(new Set());
            const [slideGenProgress, setSlideGenProgress] = useState(null); // {current, total}
            const [showOutlineSourceModal, setShowOutlineSourceModal] = useState(false);
            const [outlineSourceType, setOutlineSourceType] = useState('ticker');
            const [outlineSourceItems, setOutlineSourceItems] = useState([]);
            const [outlineSelectedIds, setOutlineSelectedIds] = useState(new Set());
            const [outlineCustomText, setOutlineCustomText] = useState('');
            const [outlineSourceLoading, setOutlineSourceLoading] = useState(false);

            // Studio tab state
            const [studioOutputs, setStudioOutputs] = useState([]);
            const [studioSelectedOutput, setStudioSelectedOutput] = useState(null);
            const [studioThemes, setStudioThemes] = useState([]);
            const [studioDataLoaded, setStudioDataLoaded] = useState(false);
            const [studioView, setStudioView] = useState('grid');
            const [studioGenerating, setStudioGenerating] = useState(false);
            const [studioGenProgress, setStudioGenProgress] = useState(null);
            // Studio creation modal
            const [showStudioCreateModal, setShowStudioCreateModal] = useState(false);
            const [studioCreateType, setStudioCreateType] = useState('report');
            const [studioCreateTitle, setStudioCreateTitle] = useState('');
            const [studioCreateTheme, setStudioCreateTheme] = useState(null);
            const [studioSourceType, setStudioSourceType] = useState('none');
            const [studioSourceItems, setStudioSourceItems] = useState([]);
            const [studioSelectedSourceIds, setStudioSelectedSourceIds] = useState(new Set());
            const [studioCustomText, setStudioCustomText] = useState('');
            const [studioSourceLoading, setStudioSourceLoading] = useState(false);
            const [studioSourceSearch, setStudioSourceSearch] = useState('');
            // Studio type-specific options
            const [studioSlideCount, setStudioSlideCount] = useState(30);
            const [studioInfographicOrientation, setStudioInfographicOrientation] = useState('landscape');
            const [studioQuizCount, setStudioQuizCount] = useState(10);
            const [studioFlashcardCount, setStudioFlashcardCount] = useState(20);
            const [studioReportLength, setStudioReportLength] = useState('standard');
            const [studioStyleInstructions, setStudioStyleInstructions] = useState('');
            // Studio interactive viewers
            const [studioQuizAnswers, setStudioQuizAnswers] = useState({});
            const [studioQuizSubmitted, setStudioQuizSubmitted] = useState(false);
            const [studioQuizScore, setStudioQuizScore] = useState(null);
            const [studioFlashcardIndex, setStudioFlashcardIndex] = useState(0);
            const [studioFlashcardFlipped, setStudioFlashcardFlipped] = useState(false);
            const [studioSlidePreviewImage, setStudioSlidePreviewImage] = useState(null);
            const [studioSelectedSlideNum, setStudioSelectedSlideNum] = useState(null);
            const [studioEditSlideTitle, setStudioEditSlideTitle] = useState('');
            const [studioEditSlideContent, setStudioEditSlideContent] = useState('');
            const [studioEditSlideHints, setStudioEditSlideHints] = useState('');
            // Studio theme management
            const [showStudioThemeModal, setShowStudioThemeModal] = useState(false);
            const [studioThemeName, setStudioThemeName] = useState('');
            const [studioThemePrompt, setStudioThemePrompt] = useState('');
            const [editingStudioTheme, setEditingStudioTheme] = useState(null);

            // Google Drive state (shared across tabs)
            const [driveToken, setDriveToken] = useState(null);
            const [driveResults, setDriveResults] = useState([]);
            const [driveSearching, setDriveSearching] = useState(false);
            const [driveImporting, setDriveImporting] = useState(false);
            const [driveTimeRange, setDriveTimeRange] = useState('3months');
            const [driveKeyword, setDriveKeyword] = useState('');
            const [driveSelected, setDriveSelected] = useState(new Set());
            const [driveZipContents, setDriveZipContents] = useState({});
            const [driveZipLoading, setDriveZipLoading] = useState({});
            const [driveError, setDriveError] = useState(null);
            const [googleClientId, setGoogleClientId] = useState(() => {
                try { return localStorage.getItem('google_oauth_client_id') || ''; } catch(e) { return ''; }
            });

            // Stock search state
            const [stockSearch, setStockSearch] = useState('');
            const stockSearchRef = useRef(null);
            
            // Chat state with history support
            const [chatHistories, setChatHistories] = useState([]);
            const [chatHistoriesLoaded, setChatHistoriesLoaded] = useState(false);
            const [currentChatId, setCurrentChatId] = useState(() => 'chat-' + Date.now());
            const [chatMessages, setChatMessages] = useState([
                { role: 'assistant', content: "Hi, I am Charlie the AlphaMaker, an AI agent specializing in stocks. Which stock are you looking to analyze today?" }
            ]);
            const [showChatSidebar, setShowChatSidebar] = useState(false);
            
            // Load chat histories from database on startup
            const loadChatHistories = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/chats`);
                    if (response.ok) {
                        const dbChats = await response.json();
                        
                        // Check if localStorage has chats that aren't in database (migration)
                        const localSaved = localStorage.getItem('chatHistories');
                        const localChats = localSaved ? JSON.parse(localSaved) : [];
                        
                        if (localChats.length > 0 && dbChats.length === 0) {
                            // Migrate localStorage to database (parallel for speed)
                            console.log('Migrating localStorage chat histories to database...');
                            await Promise.all(localChats.map(chat =>
                                fetch(`${API_URL}/api/save-chat`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(chat)
                                }).catch(() => {})
                            ));
                            setChatHistories(localChats);
                        } else {
                            setChatHistories(dbChats);
                            localStorage.setItem('chatHistories', JSON.stringify(dbChats));
                        }
                    } else {
                        // Fallback to localStorage
                        const saved = localStorage.getItem('chatHistories');
                        if (saved) setChatHistories(JSON.parse(saved));
                    }
                } catch (err) {
                    console.error('Failed to load chat histories from API:', err);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('chatHistories');
                    if (saved) setChatHistories(JSON.parse(saved));
                } finally {
                    setChatHistoriesLoaded(true);
                }
            };
            
            // Save single chat to database
            const saveChatToDb = async (chat) => {
                try {
                    await fetch(`${API_URL}/api/save-chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(chat)
                    });
                } catch (err) {
                    console.error('Failed to save chat to DB:', err);
                }
            };
            
            // Delete chat from database
            const deleteChatFromDb = async (chatId) => {
                try {
                    await fetch(`${API_URL}/api/delete-chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: chatId })
                    });
                } catch (err) {
                    console.error('Failed to delete chat from DB:', err);
                }
            };
            
            // Load chat histories on mount
            useEffect(() => {
                loadChatHistories();
            }, []);
            
            // Summary Notes state
            const [savedSummaries, setSavedSummaries] = useState([]);
            const [summariesLoaded, setSummariesLoaded] = useState(false);
            const [summaryInput, setSummaryInput] = useState('');
            const [summaryLoading, setSummaryLoading] = useState(false);
            const [currentSummary, setCurrentSummary] = useState(null); // {id, title, summary, questions, createdAt}
            const [showSummaryHistory, setShowSummaryHistory] = useState(false);
            const [currentSummaryTopic, setCurrentSummaryTopic] = useState(null); // Selected topic filter
            const [takeawaysExpanded, setTakeawaysExpanded] = useState(true);
            const [questionsExpanded, setQuestionsExpanded] = useState(true);
            const [editingTakeaways, setEditingTakeaways] = useState(false);
            const [editingQuestions, setEditingQuestions] = useState(false);
            const [editTakeawaysValue, setEditTakeawaysValue] = useState('');
            const [editQuestionsValue, setEditQuestionsValue] = useState('');
            const [showSaveConfirmModal, setShowSaveConfirmModal] = useState(null); // 'takeaways' | 'questions' | null
            const [showAddTopicModal, setShowAddTopicModal] = useState(false);
            const [newTopicName, setNewTopicName] = useState('');
            const [newTopicType, setNewTopicType] = useState('ticker'); // 'ticker' | 'macro' | 'industry' | 'other'
            const [summaryViewMode, setSummaryViewMode] = useState('list'); // 'list' | 'detail' | 'input'
            const [summaryFiles, setSummaryFiles] = useState([]);
            const [summaryFileUploading, setSummaryFileUploading] = useState(false);
            const [summaryUploadProgress, setSummaryUploadProgress] = useState('');
            const [showSummaryInputModal, setShowSummaryInputModal] = useState(false);
            const [summaryInputType, setSummaryInputType] = useState('paste'); // 'paste' | 'upload'
            const [summaryTitleInput, setSummaryTitleInput] = useState(''); // Custom title for new summary
            const [editingSummaryTitle, setEditingSummaryTitle] = useState(false); // Is title being edited
            const [editingSummaryTitleValue, setEditingSummaryTitleValue] = useState(''); // Temp value while editing
            const [summarySearchQuery, setSummarySearchQuery] = useState(''); // Search query
            const [showSummarySearchResults, setShowSummarySearchResults] = useState(false); // Show autocomplete
            const [editingSummaryTopic, setEditingSummaryTopic] = useState(false); // Is topic being edited
            const [editingSummaryDocType, setEditingSummaryDocType] = useState(false); // Is doc type being edited
            const [showSummaryEmailModal, setShowSummaryEmailModal] = useState(false); // Email with options modal
            const [summaryEmailSection, setSummaryEmailSection] = useState(''); // 'takeaways' | 'questions' | 'full'
            const [summaryEmailSubject, setSummaryEmailSubject] = useState('');
            const [summaryEmailRecipient, setSummaryEmailRecipient] = useState('');
            const [summaryDocType, setSummaryDocType] = useState(''); // Document type for new summary
            const [summaryDocTypeFilter, setSummaryDocTypeFilter] = useState([]); // Filter by doc types (multi-select)
            const summaryFileInputRef = useRef(null);
            const summarySearchRef = useRef(null);
            const [geminiApiKey, setGeminiApiKey] = useState(loadGeminiKeyFromStorage() || '');
            const [transcriptExpanded, setTranscriptExpanded] = useState(false);
            
            // Document types for Summary tab
            const SUMMARY_DOC_TYPES = [
                { id: 'earnings_call', label: 'Earnings Call', icon: 'üìû' },
                { id: 'meeting_notes', label: 'Meeting Notes', icon: 'üìù' },
                { id: 'broker_research', label: 'Broker Research', icon: 'üìä' },
                { id: '10k_10q', label: '10K/10Q', icon: 'üìë' },
                { id: 'presentation', label: 'Presentation', icon: 'üìΩÔ∏è' },
                { id: 'email', label: 'Email', icon: '‚úâÔ∏è' },
                { id: 'screenshot', label: 'Screenshot', icon: 'üì∑' },
                { id: 'photo', label: 'Photo', icon: 'üñºÔ∏è' },
                { id: 'news_article', label: 'News Article', icon: 'üì∞' },
                { id: 'internal_note', label: 'Internal Note', icon: 'üîí' },
                { id: 'audio_recording', label: 'Audio Recording', icon: 'üéôÔ∏è' },
                { id: 'other', label: 'Other', icon: 'üìÑ' }
            ];
            
            const SUMMARY_WEBHOOK_URL = 'https://tdl36.app.n8n.cloud/webhook/summary-notes';
            
            // Load summaries from database
            const loadSummaries = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/summaries`);
                    if (response.ok) {
                        const dbSummaries = await response.json();
                        setSavedSummaries(dbSummaries);
                    }
                } catch (err) {
                    console.error('Failed to load summaries:', err);
                } finally {
                    setSummariesLoaded(true);
                }
            };
            
            // Save summary to database
            const saveSummaryToDb = async (summary) => {
                try {
                    const response = await fetch(`${API_URL}/api/save-summary`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(summary)
                    });
                    return response.ok;
                } catch (err) {
                    console.error('Failed to save summary:', err);
                    return false;
                }
            };
            
            // Delete summary from database
            const deleteSummaryFromDb = async (summaryId) => {
                try {
                    await fetch(`${API_URL}/api/delete-summary`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: summaryId })
                    });
                } catch (err) {
                    console.error('Failed to delete summary:', err);
                }
            };
            
            // Generate summary from notes
            const generateSummary = async () => {
                if (!summaryInput.trim()) return;
                
                setSummaryLoading(true);
                try {
                    const response = await fetch(SUMMARY_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes: summaryInput })
                    });
                    
                    if (!response.ok) throw new Error('Webhook request failed');
                    
                    const data = await response.json();
                    
                    // Create title from first line of notes
                    const firstLine = summaryInput.split('\n')[0].trim();
                    const title = firstLine.substring(0, 100) || 'Meeting Summary';
                    
                    // Create new summary object with topic
                    const newSummary = {
                        id: 'summary-' + Date.now(),
                        title: title,
                        rawNotes: summaryInput,
                        summary: data.summary,
                        questions: data.questions,
                        topic: newTopicName || currentSummaryTopic || 'General',
                        topicType: newTopicType || 'other',
                        createdAt: new Date().toISOString()
                    };
                    
                    // Save to database
                    await saveSummaryToDb(newSummary);
                    
                    // Update local state
                    setSavedSummaries(prev => [newSummary, ...prev]);
                    setCurrentSummary(newSummary);
                    setSummaryInput('');
                    setNewTopicName('');
                    
                } catch (err) {
                    console.error('Failed to generate summary:', err);
                    alert('Failed to generate summary. Please try again.');
                } finally {
                    setSummaryLoading(false);
                }
            };
            
            // Load summary from history
            const loadSummaryFromHistory = (summary) => {
                setCurrentSummary(summary);
                setShowSummaryHistory(false);
            };
            
            // Delete summary
            const deleteSummary = (summaryId, e) => {
                e?.stopPropagation();
                const summary = savedSummaries.find(s => s.id === summaryId);
                const summaryTitle = summary?.title || 'this note';
                if (!confirm(`Delete "${summaryTitle}"?`)) {
                    return;
                }
                deleteSummaryFromDb(summaryId);
                setSavedSummaries(prev => prev.filter(s => s.id !== summaryId));
                if (currentSummary?.id === summaryId) {
                    setCurrentSummary(null);
                }
            };
            
            // Start new summary
            const startNewSummary = () => {
                setCurrentSummary(null);
                setSummaryInput('');
                setShowSummaryHistory(false);
                setNewTopicName('');
            };
            
            // Get unique topics from saved summaries
            const getSummaryTopics = () => {
                const topicsMap = new Map();
                savedSummaries.forEach(s => {
                    const topic = s.topic || 'General';
                    const type = s.topicType || 'other';
                    if (!topicsMap.has(topic)) {
                        topicsMap.set(topic, { name: topic, type: type, count: 1 });
                    } else {
                        topicsMap.get(topic).count++;
                    }
                });
                return Array.from(topicsMap.values()).sort((a, b) => {
                    const typeOrder = { ticker: 0, macro: 1, industry: 2, other: 3 };
                    if (typeOrder[a.type] !== typeOrder[b.type]) {
                        return typeOrder[a.type] - typeOrder[b.type];
                    }
                    return a.name.localeCompare(b.name);
                });
            };
            
            // Get summaries for current topic
            const getSummariesForTopic = (topic) => {
                if (!topic) return savedSummaries;
                return savedSummaries.filter(s => (s.topic || 'General') === topic);
            };
            
            // Email Key Takeaways only
            const emailTakeaways = async () => {
                if (!currentSummary) return;
                
                // Get email credentials from localStorage (same as Portfolio/Overview tabs)
                const saved = localStorage.getItem('emailCredentials');
                if (!saved) {
                    alert('Please set your email credentials in Settings first');
                    return;
                }
                
                let creds;
                try {
                    creds = JSON.parse(saved);
                } catch (e) {
                    alert('Invalid email credentials. Please update in Settings.');
                    return;
                }
                
                if (!creds.email) {
                    alert('Please set your recipient email in Settings first');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/api/email-summary-section`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: creds.email,
                            subject: `Key Takeaways: ${currentSummary.title}`,
                            section: 'takeaways',
                            content: currentSummary.summary,
                            title: currentSummary.title,
                            topic: currentSummary.topic || 'General',
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser
                            }
                        })
                    });
                    if (response.ok) {
                        alert('Key Takeaways emailed successfully!');
                    } else {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to send');
                    }
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };
            
            // Email Follow-up Questions only
            const emailQuestions = async () => {
                if (!currentSummary) return;
                
                // Get email credentials from localStorage (same as Portfolio/Overview tabs)
                const saved = localStorage.getItem('emailCredentials');
                if (!saved) {
                    alert('Please set your email credentials in Settings first');
                    return;
                }
                
                let creds;
                try {
                    creds = JSON.parse(saved);
                } catch (e) {
                    alert('Invalid email credentials. Please update in Settings.');
                    return;
                }
                
                if (!creds.email) {
                    alert('Please set your recipient email in Settings first');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/api/email-summary-section`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: creds.email,
                            subject: `Follow-up Questions: ${currentSummary.title}`,
                            section: 'questions',
                            content: currentSummary.questions,
                            title: currentSummary.title,
                            topic: currentSummary.topic || 'General',
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser
                            }
                        })
                    });
                    if (response.ok) {
                        alert('Follow-up Questions emailed successfully!');
                    } else {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to send');
                    }
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };
            
            // Email Full Transcript only
            const emailTranscript = async () => {
                if (!currentSummary || !currentSummary.rawNotes) return;

                const saved = localStorage.getItem('emailCredentials');
                if (!saved) {
                    alert('Please set your email credentials in Settings first');
                    return;
                }

                let creds;
                try {
                    creds = JSON.parse(saved);
                } catch (e) {
                    alert('Invalid email credentials. Please update in Settings.');
                    return;
                }

                if (!creds.email) {
                    alert('Please set your recipient email in Settings first');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/email-summary-section`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: creds.email,
                            subject: `Full Transcript: ${currentSummary.title}`,
                            section: 'transcript',
                            content: '<pre style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; line-height: 1.6;">' + currentSummary.rawNotes + '</pre>',
                            title: currentSummary.title,
                            topic: currentSummary.topic || 'General',
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser
                            }
                        })
                    });
                    if (response.ok) {
                        alert('Full Transcript emailed successfully!');
                    } else {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to send');
                    }
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };

            // Copy Takeaways to clipboard
            const copyTakeaways = () => {
                if (!currentSummary) return;
                const text = currentSummary.summary.replace(/<[^>]*>/g, '');
                navigator.clipboard.writeText(text);
                alert('Key Takeaways copied!');
            };
            
            // Copy Questions to clipboard
            const copyQuestions = () => {
                if (!currentSummary) return;
                const text = currentSummary.questions.replace(/<[^>]*>/g, '');
                navigator.clipboard.writeText(text);
                alert('Follow-up Questions copied!');
            };
            
            // Start editing takeaways
            const startEditingTakeaways = () => {
                if (!currentSummary) return;
                // Convert HTML to markdown for editing, preserving formatting
                const markdown = currentSummary.summary
                    // Convert bold
                    .replace(/<strong>([^<]*)<\/strong>/gi, '**$1**')
                    .replace(/<b>([^<]*)<\/b>/gi, '**$1**')
                    // Convert italic
                    .replace(/<em>([^<]*)<\/em>/gi, '*$1*')
                    .replace(/<i>([^<]*)<\/i>/gi, '*$1*')
                    // Convert headers
                    .replace(/<h1[^>]*>([^<]*)<\/h1>/gi, '# $1\n')
                    .replace(/<h2[^>]*>([^<]*)<\/h2>/gi, '## $1\n')
                    .replace(/<h3[^>]*>([^<]*)<\/h3>/gi, '### $1\n')
                    // Convert line breaks and blocks
                    .replace(/<div[^>]*>/gi, '\n')
                    .replace(/<\/div>/gi, '')
                    .replace(/<p[^>]*>/gi, '\n')
                    .replace(/<\/p>/gi, '')
                    .replace(/<br\s*\/?>/gi, '\n')
                    // Convert list items
                    .replace(/<li[^>]*>/gi, '\n- ')
                    .replace(/<\/li>/gi, '')
                    .replace(/<\/?ul[^>]*>/gi, '')
                    .replace(/<\/?ol[^>]*>/gi, '')
                    // Remove remaining tags
                    .replace(/<[^>]*>/g, '')
                    // Clean up whitespace
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();
                setEditTakeawaysValue(markdown);
                setEditingTakeaways(true);
            };
            
            // Start editing questions
            const startEditingQuestions = () => {
                if (!currentSummary) return;
                const markdown = currentSummary.questions
                    // Convert bold
                    .replace(/<strong>([^<]*)<\/strong>/gi, '**$1**')
                    .replace(/<b>([^<]*)<\/b>/gi, '**$1**')
                    // Convert italic
                    .replace(/<em>([^<]*)<\/em>/gi, '*$1*')
                    .replace(/<i>([^<]*)<\/i>/gi, '*$1*')
                    // Convert headers
                    .replace(/<h1[^>]*>([^<]*)<\/h1>/gi, '# $1\n')
                    .replace(/<h2[^>]*>([^<]*)<\/h2>/gi, '## $1\n')
                    .replace(/<h3[^>]*>([^<]*)<\/h3>/gi, '### $1\n')
                    // Convert line breaks and blocks
                    .replace(/<div[^>]*>/gi, '\n')
                    .replace(/<\/div>/gi, '')
                    .replace(/<p[^>]*>/gi, '\n')
                    .replace(/<\/p>/gi, '')
                    .replace(/<br\s*\/?>/gi, '\n')
                    // Convert list items
                    .replace(/<li[^>]*>/gi, '\n- ')
                    .replace(/<\/li>/gi, '')
                    .replace(/<\/?ul[^>]*>/gi, '')
                    .replace(/<\/?ol[^>]*>/gi, '')
                    // Remove remaining tags
                    .replace(/<[^>]*>/g, '')
                    // Clean up whitespace
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();
                setEditQuestionsValue(markdown);
                setEditingQuestions(true);
            };
            
            // Save edited takeaways
            const saveEditedTakeaways = async () => {
                if (!currentSummary) return;
                const updatedSummary = {
                    ...currentSummary,
                    summary: renderMarkdown(editTakeawaysValue)
                };
                
                // Update in database
                await saveSummaryToDb(updatedSummary);
                
                // Update in state
                setSavedSummaries(prev => prev.map(s => 
                    s.id === currentSummary.id ? updatedSummary : s
                ));
                setCurrentSummary(updatedSummary);
                setEditingTakeaways(false);
                setShowSaveConfirmModal(null);
            };
            
            // Save edited questions
            const saveEditedQuestions = async () => {
                if (!currentSummary) return;
                const updatedSummary = {
                    ...currentSummary,
                    questions: renderMarkdown(editQuestionsValue)
                };
                
                // Update in database
                await saveSummaryToDb(updatedSummary);
                
                // Update in state
                setSavedSummaries(prev => prev.map(s => 
                    s.id === currentSummary.id ? updatedSummary : s
                ));
                setCurrentSummary(updatedSummary);
                setEditingQuestions(false);
                setShowSaveConfirmModal(null);
            };
            
            // Cancel editing
            const cancelEditingTakeaways = () => {
                setEditingTakeaways(false);
                setEditTakeawaysValue('');
            };
            
            const cancelEditingQuestions = () => {
                setEditingQuestions(false);
                setEditQuestionsValue('');
            };
            
            // Handle file selection for summary
            const handleSummaryFileSelect = (e) => {
                const files = Array.from(e.target.files || []);
                if (files.length > 0) {
                    if (summaryInputType === 'audio') {
                        setSummaryFiles(prev => [...prev, ...files]);
                    } else {
                        setSummaryFiles(files);
                    }
                }
                // Reset input so same file can be re-selected
                if (e.target) e.target.value = '';
            };

            // Handle drag and drop for summary files
            const handleSummaryDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const files = Array.from(e.dataTransfer.files || []);
                if (files.length > 0) {
                    if (summaryInputType === 'audio') {
                        setSummaryFiles(prev => [...prev, ...files]);
                    } else {
                        setSummaryFiles(files);
                    }
                }
            };
            
            // Process uploaded files and generate summary
            const processUploadedFiles = async () => {
                if (summaryFiles.length === 0) return;

                setSummaryFileUploading(true);
                setSummaryUploadProgress('Preparing files...');

                try {
                    // Read files as base64
                    setSummaryUploadProgress('Reading files...');
                    const filesBase64 = await Promise.all(summaryFiles.map(file => {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => {
                                resolve({
                                    filename: file.name,
                                    fileType: file.type || 'application/octet-stream',
                                    fileData: reader.result.split(',')[1],
                                    fileSize: file.size
                                });
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                    }));

                    const apiKey = loadApiKeyFromStorage();

                    // Process files in parallel batches of 4 for speed
                    const BATCH_SIZE = 4;
                    const allExtractedTexts = new Array(filesBase64.length).fill(null);
                    let firstError = null;
                    let completed = 0;

                    const extractOne = async (idx) => {
                        try {
                            const resp = await fetch(`${API_URL}/api/extract-summary-text`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    files: [filesBase64[idx]],
                                    topic: newTopicName || currentSummaryTopic || 'General',
                                    topicType: newTopicType || 'other',
                                    apiKey: apiKey || ''
                                })
                            });
                            if (resp.ok) {
                                const data = await resp.json();
                                allExtractedTexts[idx] = data.text || '';
                            } else {
                                let errMsg = '';
                                try { errMsg = (await resp.json()).error || ''; } catch(e) {}
                                if (!firstError) firstError = errMsg;
                                allExtractedTexts[idx] = `[Could not extract: ${filesBase64[idx].filename}]`;
                            }
                        } catch (err) {
                            allExtractedTexts[idx] = `[Failed to process: ${filesBase64[idx].filename}]`;
                        }
                        completed++;
                        setSummaryUploadProgress(`Extracting text (${completed}/${filesBase64.length})...`);
                    };

                    // Process in batches
                    for (let i = 0; i < filesBase64.length; i += BATCH_SIZE) {
                        const batch = [];
                        for (let j = i; j < Math.min(i + BATCH_SIZE, filesBase64.length); j++) {
                            batch.push(extractOne(j));
                        }
                        await Promise.all(batch);
                    }

                    const validTexts = allExtractedTexts.filter(t => t && !t.startsWith('['));
                    const extractedText = allExtractedTexts.filter(Boolean).join('\n\n');
                    const filename = summaryFiles[0].name;

                    if (!validTexts.length) {
                        throw new Error(firstError || 'Could not extract text from any files. Please ensure your API key is set in Settings for screenshot OCR.');
                    }

                    setSummaryUploadProgress('Generating summary...');

                    // Send combined extracted text to webhook
                    let webhookResponse;
                    try {
                        webhookResponse = await fetch(SUMMARY_WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ notes: extractedText })
                        });
                    } catch (webhookErr) {
                        console.error('Webhook fetch failed:', webhookErr);
                        throw new Error('Summary generation service is unavailable. Please try again later.');
                    }

                    if (!webhookResponse.ok) throw new Error('Webhook request failed');

                    const data = await webhookResponse.json();

                    // Use custom title if provided, otherwise use filename
                    let title = summaryTitleInput.trim();
                    if (!title) {
                        title = filename.replace(/\.[^/.]+$/, '').substring(0, 100) || 'Uploaded Document';
                    }

                    // Create new summary object
                    const newSummary = {
                        id: 'summary-' + Date.now(),
                        title: title,
                        rawNotes: extractedText.substring(0, 5000) + (extractedText.length > 5000 ? '...' : ''),
                        summary: data.summary,
                        questions: data.questions,
                        topic: newTopicName || currentSummaryTopic || 'General',
                        topicType: newTopicType || 'other',
                        docType: summaryDocType || 'other',
                        sourceType: 'upload',
                        sourceFiles: summaryFiles.map(f => f.name),
                        hasStoredFiles: false, // Will update after saving files
                        createdAt: new Date().toISOString()
                    };

                    // Save summary to database
                    await saveSummaryToDb(newSummary);

                    // Store files for View PDF (reuse filesBase64 already read above)
                    setSummaryUploadProgress('Storing files...');
                    try {
                        const saveFilesResponse = await fetch(`${API_URL}/api/summary-files/${newSummary.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: filesBase64 })
                        });

                        if (saveFilesResponse.ok) {
                            newSummary.hasStoredFiles = true;
                            console.log('Files stored successfully for summary');
                        } else {
                            console.warn('Failed to store files, but summary was created');
                        }
                    } catch (fileErr) {
                        console.warn('File storage error (summary still created):', fileErr);
                    }

                    // Update local state
                    setSavedSummaries(prev => [newSummary, ...prev]);
                    setCurrentSummary(newSummary);
                    setSummaryFiles([]);
                    setSummaryTitleInput('');
                    setNewTopicName('');
                    setSummaryDocType('');
                    setShowSummaryInputModal(false);
                    setSummaryViewMode('detail');

                    setSummaryUploadProgress('');
                    alert('Summary generated successfully!');

                } catch (err) {
                    console.error('Failed to process files:', err);
                    alert('Failed to process files: ' + err.message);
                } finally {
                    setSummaryFileUploading(false);
                    setSummaryUploadProgress('');
                }
            };
            
            // Open summary detail view
            const openSummaryDetail = (summary) => {
                setCurrentSummary(summary);
                setSummaryViewMode('detail');
                setTakeawaysExpanded(true);
                setQuestionsExpanded(true);
                setEditingSummaryTitle(false);
                setEditingSummaryTitleValue('');
            };
            
            // Back to list view
            const backToSummaryList = () => {
                setCurrentSummary(null);
                setSummaryViewMode('list');
                setEditingSummaryTitle(false);
                setEditingSummaryTitleValue('');
                setEditingSummaryTopic(false);
                setEditingSummaryDocType(false);
            };
            
            // Open input modal for new summary
            const openNewSummaryInput = () => {
                setCurrentSummary(null);
                setSummaryInput('');
                setSummaryFiles([]);
                setSummaryInputType('paste');
                setSummaryTitleInput(''); // Reset title input
                setShowSummaryInputModal(true);
            };
            
            // Update summary title
            const updateSummaryTitle = async (summaryId, newTitle) => {
                if (!newTitle.trim()) return;
                
                // Update in local state
                setSavedSummaries(prev => prev.map(s => 
                    s.id === summaryId ? { ...s, title: newTitle.trim() } : s
                ));
                
                // Update current summary if it's the one being edited
                if (currentSummary?.id === summaryId) {
                    setCurrentSummary(prev => ({ ...prev, title: newTitle.trim() }));
                }
                
                // Update in database
                const summary = savedSummaries.find(s => s.id === summaryId);
                if (summary) {
                    await saveSummaryToDb({ ...summary, title: newTitle.trim() });
                }
                
                setEditingSummaryTitle(false);
                setEditingSummaryTitleValue('');
            };
            
            // Start editing summary title
            const startEditingSummaryTitle = () => {
                if (currentSummary) {
                    setEditingSummaryTitleValue(currentSummary.title);
                    setEditingSummaryTitle(true);
                }
            };
            
            // Process audio file: transcribe via Gemini, then generate summary
            const processAudioFile = async () => {
                if (summaryFiles.length === 0) return;

                const geminiKey = loadGeminiKeyFromStorage();
                if (!geminiKey) {
                    alert('Please add your Gemini API key in Settings first.');
                    return;
                }

                setSummaryFileUploading(true);

                try {
                    // Step 1: Transcribe each audio file sequentially
                    const allTranscripts = [];
                    for (let i = 0; i < summaryFiles.length; i++) {
                        const audioFile = summaryFiles[i];
                        const label = summaryFiles.length > 1
                            ? `Transcribing file ${i + 1} of ${summaryFiles.length}: ${audioFile.name}...`
                            : 'Transcribing audio with Gemini (this may take a few minutes)...';
                        setSummaryUploadProgress(label);

                        const formData = new FormData();
                        formData.append('file', audioFile);
                        formData.append('geminiApiKey', geminiKey);

                        const transcribeResponse = await fetch(`${API_URL}/api/transcribe-audio`, {
                            method: 'POST',
                            body: formData
                        });

                        // Read as text first, then parse (avoids Safari .json() error on non-JSON responses)
                        const responseText = await transcribeResponse.text();
                        let transcribeData;
                        try {
                            transcribeData = JSON.parse(responseText);
                        } catch (parseErr) {
                            console.error('Transcribe response not JSON:', responseText.substring(0, 500));
                            throw new Error(`Failed to transcribe ${audioFile.name}: Server error (status ${transcribeResponse.status}). Please try again.`);
                        }

                        if (!transcribeResponse.ok) {
                            throw new Error(`Failed to transcribe ${audioFile.name}: ${transcribeData.error || 'Unknown error'}`);
                        }

                        allTranscripts.push({ filename: audioFile.name, text: transcribeData.text });
                    }

                    // Combine transcripts (add part headers only for multi-file)
                    const transcriptText = allTranscripts.length === 1
                        ? allTranscripts[0].text
                        : allTranscripts.map((t, i) => `--- Part ${i + 1}: ${t.filename} ---\n\n${t.text}`).join('\n\n\n');

                    setSummaryUploadProgress('Generating takeaways and questions...');

                    // Step 2: Send combined transcript to n8n webhook for takeaways/questions
                    const webhookResponse = await fetch(SUMMARY_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes: transcriptText })
                    });

                    const webhookText = await webhookResponse.text();
                    let data;
                    try {
                        data = JSON.parse(webhookText);
                    } catch (parseErr) {
                        console.error('Webhook response not JSON:', webhookText.substring(0, 500));
                        throw new Error('Summary generation failed: server returned an invalid response.');
                    }
                    if (!webhookResponse.ok) throw new Error('Summary generation failed');

                    // Step 3: Build title
                    let title = summaryTitleInput.trim();
                    if (!title) {
                        if (summaryFiles.length > 1) {
                            title = `Audio Transcription (${summaryFiles.length} files)`;
                        } else {
                            title = summaryFiles[0].name.replace(/\.[^/.]+$/, '').substring(0, 100) || 'Audio Transcription';
                        }
                    }

                    // Step 4: Create summary object with full transcript in rawNotes
                    const newSummary = {
                        id: 'summary-' + Date.now(),
                        title: title,
                        rawNotes: transcriptText,
                        summary: data.summary,
                        questions: data.questions,
                        topic: newTopicName || currentSummaryTopic || 'General',
                        topicType: newTopicType || 'other',
                        docType: summaryDocType || 'audio_recording',
                        sourceType: 'audio',
                        sourceFiles: summaryFiles.map(f => f.name),
                        hasStoredFiles: false,
                        createdAt: new Date().toISOString()
                    };

                    // Step 5: Save summary to database
                    await saveSummaryToDb(newSummary);

                    // Step 6: Save transcript as .docx file in summary_files
                    setSummaryUploadProgress('Saving transcript document...');
                    try {
                        const docxResponse = await fetch(`${API_URL}/api/text-to-docx`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: transcriptText,
                                title: newSummary.title || 'Transcript'
                            })
                        });

                        if (docxResponse.ok) {
                            const docxData = await docxResponse.json();
                            const transcriptFilename = (summaryFiles.length === 1
                                ? summaryFiles[0].name.replace(/\.[^/.]+$/, '')
                                : 'combined_audio') + '_transcript.docx';

                            const saveFilesResponse = await fetch(`${API_URL}/api/summary-files/${newSummary.id}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    files: [{
                                        filename: transcriptFilename,
                                        fileType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                        fileData: docxData.fileData,
                                        fileSize: docxData.fileSize
                                    }]
                                })
                            });

                            if (saveFilesResponse.ok) {
                                newSummary.hasStoredFiles = true;
                            }
                        } else {
                            console.warn('Could not generate docx, skipping file save');
                        }
                    } catch (fileErr) {
                        console.warn('Transcript file storage error (summary still created):', fileErr);
                    }

                    // Step 7: Update local state
                    setSavedSummaries(prev => [newSummary, ...prev]);
                    setCurrentSummary(newSummary);
                    setSummaryFiles([]);
                    setSummaryTitleInput('');
                    setNewTopicName('');
                    setSummaryDocType('');
                    setShowSummaryInputModal(false);
                    setSummaryViewMode('detail');
                    setSummaryUploadProgress('');

                } catch (err) {
                    console.error('Failed to process audio:', err);
                    alert('Failed to process audio: ' + err.message);
                } finally {
                    setSummaryFileUploading(false);
                    setSummaryUploadProgress('');
                }
            };

            // Generate summary from modal (handles paste, upload, and audio)
            const generateSummaryFromModal = async () => {
                if (summaryInputType === 'audio' && summaryFiles.length > 0) {
                    await processAudioFile();
                } else if (summaryInputType === 'upload' && summaryFiles.length > 0) {
                    await processUploadedFiles();
                } else if (summaryInputType === 'paste' && summaryInput.trim()) {
                    setSummaryLoading(true);
                    try {
                        const response = await fetch(SUMMARY_WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ notes: summaryInput })
                        });
                        
                        if (!response.ok) throw new Error('Webhook request failed');
                        
                        const data = await response.json();
                        
                        // Use custom title if provided, otherwise use first line of notes
                        let title = summaryTitleInput.trim();
                        if (!title) {
                            const firstLine = summaryInput.split('\n')[0].trim();
                            title = firstLine.substring(0, 100) || 'Meeting Summary';
                        }
                        
                        const newSummary = {
                            id: 'summary-' + Date.now(),
                            title: title,
                            rawNotes: summaryInput,
                            summary: data.summary,
                            questions: data.questions,
                            topic: newTopicName || currentSummaryTopic || 'General',
                            topicType: newTopicType || 'other',
                            docType: summaryDocType || 'other',
                            sourceType: 'paste',
                            createdAt: new Date().toISOString()
                        };
                        
                        await saveSummaryToDb(newSummary);
                        setSavedSummaries(prev => [newSummary, ...prev]);
                        setCurrentSummary(newSummary);
                        setSummaryInput('');
                        setSummaryTitleInput('');
                        setNewTopicName('');
                        setSummaryDocType('');
                        setShowSummaryInputModal(false);
                        setSummaryViewMode('detail');
                        
                    } catch (err) {
                        console.error('Failed to generate summary:', err);
                        alert('Failed to generate summary. Please try again.');
                    } finally {
                        setSummaryLoading(false);
                    }
                }
            };
            
            // Get preview snippet from summary content
            const getSummaryPreview = (summary) => {
                if (!summary.summary) return 'No content';
                const text = summary.summary.replace(/<[^>]*>/g, '').trim();
                return text.substring(0, 250) + (text.length > 250 ? '...' : '');
            };
            
            // Get filtered summaries based on topic and search query
            const getFilteredSummaries = () => {
                let results = currentSummaryTopic 
                    ? savedSummaries.filter(s => (s.topic || 'General') === currentSummaryTopic)
                    : savedSummaries;
                
                // Filter by document type if any types selected
                if (summaryDocTypeFilter.length > 0) {
                    results = results.filter(s => summaryDocTypeFilter.includes(s.docType || 'other'));
                }
                
                if (summarySearchQuery.trim()) {
                    const query = summarySearchQuery.toLowerCase();
                    results = results.filter(s => 
                        s.title?.toLowerCase().includes(query) ||
                        s.topic?.toLowerCase().includes(query) ||
                        s.summary?.toLowerCase().includes(query) ||
                        s.questions?.toLowerCase().includes(query)
                    );
                }
                return results;
            };
            
            // Get search suggestions for autocomplete
            const getSummarySearchSuggestions = () => {
                if (!summarySearchQuery.trim()) return [];
                const query = summarySearchQuery.toLowerCase();
                const suggestions = [];
                
                // Add matching titles
                savedSummaries.forEach(s => {
                    if (s.title?.toLowerCase().includes(query) && !suggestions.find(x => x.text === s.title)) {
                        suggestions.push({ type: 'title', text: s.title, summary: s });
                    }
                });
                
                // Add matching topics
                getSummaryTopics().forEach(t => {
                    if (t.name.toLowerCase().includes(query) && !suggestions.find(x => x.text === t.name)) {
                        suggestions.push({ type: 'topic', text: t.name, topicType: t.type });
                    }
                });
                
                return suggestions.slice(0, 8);
            };
            
            // Update summary topic
            const updateSummaryTopic = async (summaryId, newTopic, newTopicType) => {
                // Update in local state
                setSavedSummaries(prev => prev.map(s => 
                    s.id === summaryId ? { ...s, topic: newTopic, topicType: newTopicType || 'other' } : s
                ));
                
                // Update current summary if it's the one being edited
                if (currentSummary?.id === summaryId) {
                    setCurrentSummary(prev => ({ ...prev, topic: newTopic, topicType: newTopicType || 'other' }));
                }
                
                // Update in database
                const summary = savedSummaries.find(s => s.id === summaryId);
                if (summary) {
                    await saveSummaryToDb({ ...summary, topic: newTopic, topicType: newTopicType || 'other' });
                }
                
                setEditingSummaryTopic(false);
            };
            
            // Update summary document type
            const updateSummaryDocType = async (summaryId, newDocType) => {
                // Update in local state
                setSavedSummaries(prev => prev.map(s => 
                    s.id === summaryId ? { ...s, docType: newDocType } : s
                ));
                
                // Update current summary if it's the one being edited
                if (currentSummary?.id === summaryId) {
                    setCurrentSummary(prev => ({ ...prev, docType: newDocType }));
                }
                
                // Update in database
                const summary = savedSummaries.find(s => s.id === summaryId);
                if (summary) {
                    await saveSummaryToDb({ ...summary, docType: newDocType });
                }
                
                setEditingSummaryDocType(false);
            };
            
            // Open email modal with options
            const openSummaryEmailWithOptions = (section) => {
                const saved = localStorage.getItem('emailCredentials');
                let defaultEmail = '';
                if (saved) {
                    try {
                        const creds = JSON.parse(saved);
                        defaultEmail = creds.email || '';
                    } catch (e) {}
                }
                
                let defaultSubject = '';
                if (section === 'takeaways') {
                    defaultSubject = `Key Takeaways: ${currentSummary?.title || 'Summary'}`;
                } else if (section === 'questions') {
                    defaultSubject = `Follow-up Questions: ${currentSummary?.title || 'Summary'}`;
                } else if (section === 'transcript') {
                    defaultSubject = `Full Transcript: ${currentSummary?.title || 'Summary'}`;
                } else {
                    defaultSubject = `Summary: ${currentSummary?.title || 'Summary'}`;
                }
                
                setSummaryEmailSection(section);
                setSummaryEmailSubject(defaultSubject);
                setSummaryEmailRecipient(defaultEmail);
                setShowSummaryEmailModal(true);
            };
            
            // Send email with custom options
            const sendSummaryEmailWithOptions = async () => {
                if (!currentSummary || !summaryEmailRecipient) {
                    alert('Please enter a recipient email');
                    return;
                }
                
                const saved = localStorage.getItem('emailCredentials');
                let creds = { useGmail: false, gmailUser: '', gmailPassword: '' };
                if (saved) {
                    try {
                        creds = JSON.parse(saved);
                    } catch (e) {}
                }
                
                let content = '';
                let section = summaryEmailSection;
                if (section === 'takeaways') {
                    content = currentSummary.summary;
                } else if (section === 'questions') {
                    content = currentSummary.questions;
                } else if (section === 'transcript') {
                    content = '<pre style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; line-height: 1.6;">' + currentSummary.rawNotes + '</pre>';
                } else {
                    content = currentSummary.summary + '<hr style="margin: 20px 0; border-color: #374151;">' + currentSummary.questions;
                    section = 'full';
                }
                
                try {
                    const response = await fetch(`${API_URL}/api/email-summary-section`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: summaryEmailRecipient,
                            subject: summaryEmailSubject,
                            section: section,
                            content: content,
                            title: currentSummary.title,
                            topic: currentSummary.topic || 'General',
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser
                            }
                        })
                    });
                    if (response.ok) {
                        setShowSummaryEmailModal(false);
                        alert('Email sent successfully!');
                    } else {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to send');
                    }
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };
            
            // ========== RESEARCH TAB FUNCTIONS ==========
            
            // Handle research file upload
            const handleResearchFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                
                for (const file of files) {
                    try {
                        let content = '';
                        let rawFileData = null;
                        const fileType = file.type;
                        const fileName = file.name;
                        
                        // Read raw file as base64 for storage
                        rawFileData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data:... prefix
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        
                        if (fileType === 'application/pdf') {
                            const formData = new FormData();
                            formData.append('file', file);
                            const response = await fetch(`${API_URL}/api/extract-pdf`, {
                                method: 'POST',
                                body: formData
                            });
                            if (response.ok) {
                                const data = await response.json();
                                content = data.text || '';
                            } else {
                                throw new Error('Failed to extract PDF');
                            }
                        } else if (fileType.startsWith('image/')) {
                            content = 'data:' + fileType + ';base64,' + rawFileData;
                        } else {
                            content = await file.text();
                        }
                        
                        setResearchFiles(prev => [...prev, {
                            id: Date.now() + Math.random(),
                            name: fileName,
                            content: content,
                            type: fileType,
                            isImage: fileType.startsWith('image/'),
                            rawFileData: rawFileData,
                            fileSize: file.size
                        }]);
                        
                        // Auto-set document name from first file if empty
                        if (!newDocumentName) {
                            setNewDocumentName(fileName.replace(/\.[^/.]+$/, '')); // Remove extension
                        }
                    } catch (err) {
                        console.error('Error processing file:', err);
                        alert(`Failed to process ${file.name}: ${err.message}`);
                    }
                }
                
                if (researchFileInputRef.current) {
                    researchFileInputRef.current.value = '';
                }
            };
            
            // Remove a research file
            const removeResearchFile = (fileId) => {
                setResearchFiles(prev => prev.filter(f => f.id !== fileId));
            };
            
            // Toggle framework selection (multi-select)
            const toggleFrameworkSelection = (promptId) => {
                setSelectedFrameworks(prev => {
                    if (prev.includes(promptId)) {
                        return prev.filter(id => id !== promptId);
                    } else {
                        return [...prev, promptId];
                    }
                });
            };
            
            // Select all frameworks
            const selectAllFrameworks = () => {
                if (selectedFrameworks.length === RESEARCH_PROMPTS.length) {
                    setSelectedFrameworks([]);
                } else {
                    setSelectedFrameworks(RESEARCH_PROMPTS.map(p => p.id));
                }
            };
            
            // Add new research category
            const addResearchCategory = async () => {
                if (!newCategoryName.trim()) return;
                
                const newCategory = {
                    id: 'cat-' + Date.now(),
                    name: newCategoryType === 'ticker' ? newCategoryName.trim().toUpperCase() : newCategoryName.trim(),
                    type: newCategoryType
                };
                
                setResearchCategories(prev => [...prev, newCategory]);
                setSelectedResearchCategory(newCategory.id);
                setNewCategoryName('');
                setShowAddResearchCategory(false);
                
                // Save to database
                await saveResearchCategoryToDb(newCategory);
            };
            
            // Delete research category
            const deleteResearchCategory = async (categoryId) => {
                if (!confirm('Delete this category and all its documents?')) return;
                
                // Delete from state
                setResearchCategories(prev => prev.filter(c => c.id !== categoryId));
                setResearchDocuments(prev => prev.filter(d => d.categoryId !== categoryId));
                setResearchAnalyses(prev => {
                    const docIds = researchDocuments.filter(d => d.categoryId === categoryId).map(d => d.id);
                    return prev.filter(a => !docIds.includes(a.documentId));
                });
                
                if (selectedResearchCategory === categoryId) {
                    setSelectedResearchCategory(researchCategories.find(c => c.id !== categoryId)?.id || null);
                }
                
                // Delete from database
                await fetch(`${API_URL}/api/delete-research-category`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: categoryId })
                });
            };
            
            // Generate smart document name for Research tab (clean up filename)
            const generateResearchSmartName = (filename, content) => {
                if (!filename) return null;
                
                // Remove extension
                let name = filename.replace(/\.[^/.]+$/, '');
                
                // Remove hash/UUID suffixes
                name = name.replace(/[-_]?[a-f0-9]{24,}$/i, '');
                name = name.replace(/[-_]?SSRFS[-_]?\d*[-_]?[a-f0-9-]+$/i, '');
                name = name.replace(/[-_]?ASR[-_][A-Z]+[-_][a-f0-9]+$/i, '');
                name = name.replace(/[-_][a-f0-9]{12,}$/i, '');
                
                // Clean up dashes/underscores
                name = name
                    .replace(/[_-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                return name || null;
            };
            
            // Extract published date from document content
            const extractPublishedDate = (content) => {
                if (!content) return null;
                
                // Common date patterns in financial documents - ordered by specificity
                const patterns = [
                    // "16 December 2025" or "16 Dec 2025" (Goldman Sachs style)
                    /(\d{1,2})\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+(\d{4})/i,
                    // "December 16, 2025" or "Dec 16 2025"
                    /(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+(\d{1,2}),?\s+(\d{4})/i,
                    // With labels: "Published: 12/16/2025" etc
                    /(?:Published|Date|Dated|As of|Report Date)[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i,
                    /(?:Published|Date|Dated|As of|Report Date)[:\s]*(\w+ \d{1,2},? \d{4})/i,
                    // Near keywords: "12/16/2025 Report"
                    /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\s*(?:Report|Note|Update|EST|AM|PM)/i,
                    // ISO format YYYY-MM-DD
                    /(\d{4})-(\d{2})-(\d{2})/
                ];
                
                const monthMap = {
                    'january': 0, 'jan': 0, 'february': 1, 'feb': 1, 'march': 2, 'mar': 2,
                    'april': 3, 'apr': 3, 'may': 4, 'june': 5, 'jun': 5,
                    'july': 6, 'jul': 6, 'august': 7, 'aug': 7, 'september': 8, 'sep': 8,
                    'october': 9, 'oct': 9, 'november': 10, 'nov': 10, 'december': 11, 'dec': 11
                };
                
                // Only search first 2000 chars (header area)
                const headerContent = content.substring(0, 2000);
                
                for (const pattern of patterns) {
                    const match = headerContent.match(pattern);
                    if (match) {
                        try {
                            let d;
                            if (pattern.source.includes('January|February') && match[3]) {
                                // "16 December 2025" format
                                if (/^\d{1,2}$/.test(match[1])) {
                                    const month = monthMap[match[2].toLowerCase()];
                                    d = new Date(parseInt(match[3]), month, parseInt(match[1]));
                                } 
                                // "December 16, 2025" format
                                else {
                                    const month = monthMap[match[1].toLowerCase()];
                                    d = new Date(parseInt(match[3]), month, parseInt(match[2]));
                                }
                            } else if (match[1] && match[2] && match[3] && pattern.source.includes('\\d{4})-')) {
                                // ISO format
                                d = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                            } else if (match[1]) {
                                d = new Date(match[1]);
                            }
                            
                            if (d && !isNaN(d.getTime())) {
                                return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
                            }
                        } catch(e) {}
                    }
                }
                return null;
            };
            
            // Create new document and run analyses
            const createDocumentAndAnalyze = async () => {
                console.log('üöÄ Starting createDocumentAndAnalyze. storeResearchDocument:', storeResearchDocument, 'researchFiles:', researchFiles.length);
                
                if (!selectedResearchCategory) {
                    alert('Please select or create a category first');
                    return;
                }
                
                if (selectedFrameworks.length === 0) {
                    alert('Please select at least one analysis framework');
                    return;
                }
                
                // Combine all inputs
                let combinedContent = '';
                if (researchInput.trim()) {
                    combinedContent += researchInput.trim() + '\n\n';
                }
                for (const file of researchFiles) {
                    if (!file.isImage) {
                        combinedContent += `--- ${file.name} ---\n${file.content}\n\n`;
                    }
                }
                
                if (!combinedContent.trim()) {
                    alert('Please add some content to analyze');
                    return;
                }
                
                // Generate document name (for display)
                // If broker name provided, prepend it to the document name
                let baseName = newDocumentName.trim() || 
                    (researchFiles.length > 0 ? researchFiles[0].name.replace(/\.[^/.]+$/, '') : 
                    `Notes - ${new Date().toLocaleDateString()}`);
                const docName = newBrokerName.trim() 
                    ? `${newBrokerName.trim()} - ${baseName}`
                    : baseName;
                
                // Generate smart name (cleaned up version)
                const originalFilename = researchFiles.length > 0 ? researchFiles[0].name : null;
                const smartName = generateResearchSmartName(originalFilename, combinedContent) || docName;
                
                // Try to extract published date from content
                const publishedDate = extractPublishedDate(combinedContent);
                
                const docId = 'doc-' + Date.now();
                
                // Create document object first
                const newDoc = {
                    id: docId,
                    categoryId: selectedResearchCategory,
                    name: docName,
                    content: combinedContent,
                    fileNames: researchFiles.map(f => f.name),
                    smartName: smartName,
                    originalFilename: originalFilename,
                    publishedDate: publishedDate,
                    docType: newResearchDocType || 'other',
                    hasStoredFiles: false, // Will update after saving files
                    createdAt: new Date().toISOString()
                };
                
                // Save document to database FIRST (so foreign key constraint is satisfied)
                setResearchDocuments(prev => [...prev, newDoc]);
                try {
                    await saveResearchDocumentToDb(newDoc);
                } catch (docSaveErr) {
                    alert(`‚ùå Failed to save document to database: ${docSaveErr.message}`);
                    return; // Don't continue if document save failed
                }
                
                // Now store files if checkbox is checked (document exists now)
                let hasStoredFiles = false;
                if (storeResearchDocument && researchFiles.length > 0) {
                    console.log('üìÅ Attempting to store files:', researchFiles.map(f => ({ name: f.name, hasRawData: !!f.rawFileData, size: f.fileSize })));
                    try {
                        let savedCount = 0;
                        for (const file of researchFiles) {
                            if (file.rawFileData) {
                                console.log(`üì§ Saving file: ${file.name} (${file.fileSize} bytes)`);
                                try {
                                    const saveResponse = await fetch(`${API_URL}/api/save-research-file`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            documentId: docId,
                                            filename: file.name,
                                            fileType: file.type,
                                            fileData: file.rawFileData,
                                            fileSize: file.fileSize
                                        })
                                    });
                                    if (saveResponse.ok) {
                                        console.log(`‚úÖ File saved: ${file.name}`);
                                        savedCount++;
                                    } else {
                                        const errorText = await saveResponse.text();
                                        console.error(`‚ùå Failed to save file: ${file.name}`, saveResponse.status, errorText);
                                        alert(`‚ùå File save failed: ${saveResponse.status}\n${errorText.substring(0, 200)}`);
                                    }
                                } catch (fetchErr) {
                                    console.error(`‚ùå Fetch error for ${file.name}:`, fetchErr);
                                    alert(`‚ùå Network error saving file: ${fetchErr.message}`);
                                }
                            } else {
                                console.warn(`‚ö†Ô∏è No rawFileData for: ${file.name}`);
                                alert(`‚ö†Ô∏è No file data captured for: ${file.name}`);
                            }
                        }
                        hasStoredFiles = savedCount > 0;
                        console.log(`üìä Files saved: ${savedCount}/${researchFiles.length}, hasStoredFiles: ${hasStoredFiles}`);
                        
                        // Update document with hasStoredFiles flag
                        if (hasStoredFiles) {
                            const updatedDoc = { ...newDoc, hasStoredFiles: true };
                            setResearchDocuments(prev => prev.map(d => d.id === docId ? updatedDoc : d));
                            await saveResearchDocumentToDb(updatedDoc);
                        }
                    } catch (err) {
                        console.error('‚ùå Error storing files:', err);
                        alert(`‚ùå Error in file storage: ${err.message}`);
                    }
                }
                
                // Clear inputs
                setResearchInput('');
                setResearchFiles([]);
                setNewDocumentName('');
                setNewBrokerName('');
                setNewResearchDocType('');
                setStoreResearchDocument(false);
                setShowAddResearchDoc(false);
                
                // Run analyses for selected frameworks
                await runAnalysesForDocument(newDoc.id, combinedContent, selectedFrameworks);
                
                // Expand the new document
                setExpandedResearchDocs(prev => new Set([...prev, newDoc.id]));
            };
            
            // Run analyses for a document (can be multiple frameworks)
            const runAnalysesForDocument = async (documentId, content, frameworkIds) => {
                const savedApiKey = loadApiKeyFromStorage();
                if (!savedApiKey) {
                    alert('Please add your Claude API key in Settings first');
                    return;
                }
                
                setIsResearchLoading(true);
                setResearchLoadingDocId(documentId);
                setResearchLoadingFrameworks(frameworkIds);
                
                // Run analyses in parallel
                const analysisPromises = frameworkIds.map(async (promptId) => {
                    const promptConfig = RESEARCH_PROMPTS.find(p => p.id === promptId);
                    if (!promptConfig) return null;
                    
                    try {
                        const fullPrompt = `${promptConfig.prompt}\n\n--- DOCUMENT TO ANALYZE ---\n\n${content}`;
                        
                        const response = await fetch(`${API_URL}/api/research-analyze`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: fullPrompt,
                                promptId: promptConfig.id,
                                promptName: promptConfig.name,
                                apiKey: savedApiKey
                            })
                        });
                        
                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({}));
                            throw new Error(errData.error || 'Failed to generate analysis');
                        }
                        
                        const data = await response.json();
                        
                        const analysis = {
                            id: 'analysis-' + Date.now() + '-' + promptId,
                            documentId: documentId,
                            promptId: promptConfig.id,
                            promptName: promptConfig.name,
                            promptIcon: promptConfig.icon,
                            result: data.result || data.content || '',
                            usage: data.usage || null,
                            createdAt: new Date().toISOString()
                        };
                        
                        // Add to state immediately
                        setResearchAnalyses(prev => [...prev, analysis]);
                        
                        // Save to database
                        await saveResearchAnalysisToDb(analysis);
                        
                        // Remove from loading
                        setResearchLoadingFrameworks(prev => prev.filter(id => id !== promptId));
                        
                        return analysis;
                    } catch (err) {
                        console.error(`Error running ${promptConfig.name}:`, err);
                        setResearchLoadingFrameworks(prev => prev.filter(id => id !== promptId));
                        return null;
                    }
                });
                
                await Promise.all(analysisPromises);
                setIsResearchLoading(false);
                setResearchLoadingDocId(null);
                setResearchLoadingFrameworks([]);
            };
            
            // Run more frameworks on existing document
            const runMoreFrameworks = async (documentId) => {
                const doc = researchDocuments.find(d => d.id === documentId);
                if (!doc) return;
                
                // Filter out frameworks already run
                const existingPromptIds = researchAnalyses
                    .filter(a => a.documentId === documentId)
                    .map(a => a.promptId);
                
                const newFrameworkIds = selectedFrameworks.filter(id => !existingPromptIds.includes(id));
                
                if (newFrameworkIds.length === 0) {
                    alert('All selected frameworks have already been run on this document');
                    return;
                }
                
                await runAnalysesForDocument(documentId, doc.content, newFrameworkIds);
                setRunMoreFrameworksDocId(null);
                setSelectedFrameworks([]);
            };
            
            // Toggle document expansion
            const toggleDocExpansion = (docId) => {
                setExpandedResearchDocs(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(docId)) {
                        newSet.delete(docId);
                    } else {
                        newSet.add(docId);
                    }
                    return newSet;
                });
            };
            
            // Toggle expand all documents
            const toggleExpandAllDocs = () => {
                const categoryDocs = researchDocuments.filter(d => d.categoryId === selectedResearchCategory);
                if (expandAllResearchDocs) {
                    setExpandedResearchDocs(new Set());
                } else {
                    setExpandedResearchDocs(new Set(categoryDocs.map(d => d.id)));
                }
                setExpandAllResearchDocs(!expandAllResearchDocs);
            };
            
            // Delete document
            const deleteResearchDocument = async (docId) => {
                if (!confirm('Delete this document and all its analyses?')) return;
                
                setResearchDocuments(prev => prev.filter(d => d.id !== docId));
                setResearchAnalyses(prev => prev.filter(a => a.documentId !== docId));
                
                await fetch(`${API_URL}/api/delete-research-document`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: docId })
                });
            };
            
            // Update document name
            const updateDocumentName = async (docId, newName) => {
                if (!newName.trim()) return;
                
                setResearchDocuments(prev => prev.map(d => 
                    d.id === docId ? { ...d, name: newName.trim() } : d
                ));
                
                const doc = researchDocuments.find(d => d.id === docId);
                if (doc) {
                    await saveResearchDocumentToDb({ ...doc, name: newName.trim() });
                }
            };
            
            // Start editing research doc name
            const startEditingResearchDocName = (doc) => {
                setEditingResearchDocName(doc.id);
                setEditingResearchDocNameValue(doc.name);
                setExpandedDocTitle(doc.id); // Expand to show edit field
            };
            
            // Save research doc name edit
            const saveResearchDocNameEdit = async (docId) => {
                const newName = editingResearchDocNameValue.trim();
                if (newName) {
                    await updateDocumentName(docId, newName);
                }
                setEditingResearchDocName(null);
                setEditingResearchDocNameValue('');
            };
            
            // Cancel research doc name edit
            const cancelResearchDocNameEdit = () => {
                setEditingResearchDocName(null);
                setEditingResearchDocNameValue('');
            };
            
            // Delete stored files for a research document
            const deleteStoredFilesForDocument = async (docId) => {
                if (!confirm('Delete the stored document file? You will not be able to re-analyze this document without re-uploading.')) return;
                
                try {
                    // Get the files for this document
                    const response = await fetch(`${API_URL}/api/research-document-files/${docId}`);
                    if (response.ok) {
                        const files = await response.json();
                        // Delete each file
                        for (const file of files) {
                            await fetch(`${API_URL}/api/delete-research-file/${file.id}`, {
                                method: 'DELETE'
                            });
                        }
                    }
                    
                    // Update the document to remove hasStoredFiles flag
                    const doc = researchDocuments.find(d => d.id === docId);
                    if (doc) {
                        const updatedDoc = { ...doc, hasStoredFiles: false };
                        setResearchDocuments(prev => prev.map(d => d.id === docId ? updatedDoc : d));
                        await saveResearchDocumentToDb(updatedDoc);
                    }
                } catch (err) {
                    console.error('Error deleting stored files:', err);
                    alert('Failed to delete stored files');
                }
            };
            
            // Open stored PDF in new tab
            const openStoredPdf = async (docId) => {
                try {
                    const response = await fetch(`${API_URL}/api/research-document-files/${docId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch file');
                    }
                    
                    const files = await response.json();
                    if (files.length === 0) {
                        alert('No stored files found for this document');
                        return;
                    }
                    
                    const file = files[0];
                    const base64Data = file.fileData;
                    if (!base64Data) {
                        alert('File data is empty');
                        return;
                    }
                    const mimeType = file.fileType || 'application/pdf';
                    
                    // Convert base64 to blob
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });
                    
                    // Create URL
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // For iOS/iPadOS, use a link click instead of window.open
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    // For PDFs on iOS/iPadOS, trigger download
                    if (isIOSDevice()) {
                        link.download = file.filename || 'document.pdf';
                    }
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up URL after a delay
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                } catch (err) {
                    console.error('Error opening PDF:', err);
                    alert('Failed to open PDF');
                }
            };
            
            // Open stored PDF/DOCX for a summary
            const openStoredSummaryPdf = async (summaryId) => {
                try {
                    const response = await fetch(`${API_URL}/api/summary-files/${summaryId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch file');
                    }

                    const files = await response.json();
                    if (files.length === 0) {
                        alert('No stored files found for this summary');
                        return;
                    }

                    const file = files[0];
                    const base64Data = file.fileData;
                    if (!base64Data) {
                        alert('File data is empty');
                        return;
                    }
                    const mimeType = file.fileType || 'application/pdf';

                    // Convert base64 to blob
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });

                    // Create URL
                    const blobUrl = URL.createObjectURL(blob);

                    // Use a link click to open/download the file
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    // Always trigger download for docx files; for PDFs only on iOS
                    const isDocxFile = (file.filename || '').toLowerCase().endsWith('.docx') || mimeType.includes('wordprocessingml');
                    if (isIOSDevice() || isDocxFile) {
                        link.download = file.filename || 'document';
                    }
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Clean up URL after a delay
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                } catch (err) {
                    console.error('Error opening file:', err);
                    alert('Failed to open file');
                }
            };
            
            // Delete stored files for a summary
            const deleteStoredSummaryFiles = async (summaryId) => {
                if (!confirm('Delete stored files for this summary? You can still view the summary content, but won\'t be able to view the original PDF.')) return;
                
                try {
                    const response = await fetch(`${API_URL}/api/summary-files/${summaryId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) throw new Error('Failed to delete files');
                    
                    // Update local state
                    setSavedSummaries(prev => prev.map(s => 
                        s.id === summaryId ? { ...s, hasStoredFiles: false } : s
                    ));
                    if (currentSummary?.id === summaryId) {
                        setCurrentSummary(prev => ({ ...prev, hasStoredFiles: false }));
                    }
                    
                    alert('Files deleted successfully');
                } catch (err) {
                    console.error('Error deleting summary files:', err);
                    alert('Failed to delete files: ' + err.message);
                }
            };
            
            
            // Delete analysis
            const deleteResearchAnalysis = async (analysisId) => {
                if (!confirm('Delete this analysis?')) return;
                
                setResearchAnalyses(prev => prev.filter(a => a.id !== analysisId));
                if (currentResearchAnalysis?.id === analysisId) {
                    setCurrentResearchAnalysis(null);
                }
                
                await fetch(`${API_URL}/api/delete-research-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: analysisId })
                });
            };
            
            // Copy analysis result
            const copyAnalysisResult = (analysis) => {
                navigator.clipboard.writeText(analysis.result);
                alert('Copied to clipboard!');
            };
            
            // Start editing analysis
            const startEditingAnalysis = () => {
                setEditedAnalysisContent(currentResearchAnalysis.result);
                setEditingResearchAnalysis(true);
            };
            
            // Save edited analysis
            const saveEditedAnalysis = async () => {
                if (!currentResearchAnalysis) return;
                
                const updated = { ...currentResearchAnalysis, result: editedAnalysisContent };
                
                setResearchAnalyses(prev => prev.map(a => 
                    a.id === currentResearchAnalysis.id ? updated : a
                ));
                setCurrentResearchAnalysis(updated);
                setEditingResearchAnalysis(false);
                
                await saveResearchAnalysisToDb(updated);
            };
            
            // Email analysis
            const openAnalysisEmailModal = () => {
                const saved = localStorage.getItem('emailCredentials');
                let defaultEmail = '';
                if (saved) {
                    try {
                        const creds = JSON.parse(saved);
                        defaultEmail = creds.email || '';
                    } catch (e) {}
                }
                
                const category = researchCategories.find(c => c.id === selectedResearchCategory);
                const doc = researchDocuments.find(d => d.id === currentResearchAnalysis?.documentId);
                
                setResearchEmailSubject(`${category?.name || ''} - ${doc?.name || ''} - ${currentResearchAnalysis?.promptName || 'Analysis'}`);
                setResearchEmailRecipient(defaultEmail);
                setShowResearchEmailModal(true);
            };
            
            const sendResearchEmail = async () => {
                if (!currentResearchAnalysis || !researchEmailRecipient) {
                    alert('Please enter a recipient email');
                    return;
                }
                
                const saved = localStorage.getItem('emailCredentials');
                let creds = { useGmail: false, gmailUser: '', gmailPassword: '' };
                if (saved) {
                    try { creds = JSON.parse(saved); } catch (e) {}
                }
                
                const category = researchCategories.find(c => c.id === selectedResearchCategory);
                
                try {
                    const response = await fetch(`${API_URL}/api/email-research`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: researchEmailRecipient,
                            subject: researchEmailSubject,
                            content: currentResearchAnalysis.result,
                            promptName: currentResearchAnalysis.promptName,
                            ticker: category?.type === 'ticker' ? category.name : '',
                            topic: category?.type === 'topic' ? category.name : '',
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser
                            }
                        })
                    });
                    if (response.ok) {
                        setShowResearchEmailModal(false);
                        alert('Email sent successfully!');
                    } else {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to send');
                    }
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };
            
            const quickEmailAnalysis = async () => {
                const saved = localStorage.getItem('emailCredentials');
                if (!saved) {
                    alert('Please configure email in Settings first');
                    return;
                }
                let creds;
                try { creds = JSON.parse(saved); } catch (e) { return; }
                if (!creds.email) {
                    alert('Please set a default recipient email in Settings');
                    return;
                }
                
                const category = researchCategories.find(c => c.id === selectedResearchCategory);
                const doc = researchDocuments.find(d => d.id === currentResearchAnalysis?.documentId);
                
                try {
                    const response = await fetch(`${API_URL}/api/email-research`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: creds.email,
                            subject: `${category?.name || ''} - ${doc?.name || ''} - ${currentResearchAnalysis?.promptName || 'Analysis'}`,
                            content: currentResearchAnalysis.result,
                            promptName: currentResearchAnalysis.promptName,
                            ticker: category?.type === 'ticker' ? category.name : '',
                            topic: category?.type === 'topic' ? category.name : '',
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser
                            }
                        })
                    });
                    if (response.ok) {
                        alert('Email sent successfully!');
                    } else {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to send');
                    }
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };
            
            // Database operations
            const saveResearchCategoryToDb = async (category) => {
                try {
                    await fetch(`${API_URL}/api/save-research-category`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(category)
                    });
                } catch (err) {
                    console.error('Failed to save category:', err);
                }
            };
            
            const saveResearchDocumentToDb = async (doc) => {
                try {
                    const response = await fetch(`${API_URL}/api/save-research-document`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(doc)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Failed to save document:', response.status, errorText);
                        throw new Error(`Failed to save document: ${response.status}`);
                    }
                    const result = await response.json();
                    console.log('‚úÖ Document saved to DB:', doc.id);
                    return result;
                } catch (err) {
                    console.error('Failed to save document:', err);
                    throw err; // Re-throw so caller knows it failed
                }
            };
            
            const saveResearchAnalysisToDb = async (analysis) => {
                try {
                    await fetch(`${API_URL}/api/save-research-analysis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysis)
                    });
                } catch (err) {
                    console.error('Failed to save analysis:', err);
                }
            };
            
            // Load all research data
            const loadResearchData = async () => {
                try {
                    const [catRes, docRes, analysisRes] = await Promise.all([
                        fetch(`${API_URL}/api/research-categories`),
                        fetch(`${API_URL}/api/research-documents`),
                        fetch(`${API_URL}/api/research-analyses`)
                    ]);
                    
                    if (catRes.ok) {
                        const cats = await catRes.json();
                        setResearchCategories(cats);
                        if (cats.length > 0 && !selectedResearchCategory) {
                            setSelectedResearchCategory(cats[0].id);
                        }
                    }
                    if (docRes.ok) {
                        setResearchDocuments(await docRes.json());
                    }
                    if (analysisRes.ok) {
                        setResearchAnalyses(await analysisRes.json());
                    }
                } catch (err) {
                    console.error('Failed to load research data:', err);
                } finally {
                    setResearchDataLoaded(true);
                }
            };
            
            // Get documents for current category (or all if none selected) with doc type filter
            const getCurrentCategoryDocs = () => {
                let docs = selectedResearchCategory 
                    ? researchDocuments.filter(d => d.categoryId === selectedResearchCategory)
                    : researchDocuments;
                
                // Apply doc type filter if any selected
                if (researchDocTypeFilter.length > 0) {
                    docs = docs.filter(d => researchDocTypeFilter.includes(d.docType || 'other'));
                }
                
                return docs;
            };
            
            // Update research document doc type
            const updateResearchDocType = async (docId, newDocType) => {
                // Update local state
                setResearchDocuments(prev => prev.map(d => 
                    d.id === docId ? { ...d, docType: newDocType } : d
                ));
                
                // Update in database
                const doc = researchDocuments.find(d => d.id === docId);
                if (doc) {
                    await saveResearchDocumentToDb({ ...doc, docType: newDocType });
                }
                
                setEditingResearchDocType(null);
            };
            
            // Get analyses for a document
            const getDocAnalyses = (docId) => {
                return researchAnalyses.filter(a => a.documentId === docId);
            };
            
            // Load research data on mount
            useEffect(() => {
                loadResearchData();
            }, []);
            
            // ========== END RESEARCH FUNCTIONS ==========
            
            // Load summaries on mount
            useEffect(() => {
                loadSummaries();
            }, []);
            
            // Click outside handler for summary search
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (summarySearchRef.current && !summarySearchRef.current.contains(event.target)) {
                        setShowSummarySearchResults(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            
            // Splash screen state
            const [showSplash, setShowSplash] = useState(true);
            const [splashFading, setSplashFading] = useState(false);
            
            // Splash screen timer
            useEffect(() => {
                const fadeTimer = setTimeout(() => {
                    setSplashFading(true);
                }, 1500); // Start fade after 1.5s
                
                const hideTimer = setTimeout(() => {
                    setShowSplash(false);
                }, 2000); // Hide completely after 2s
                
                return () => {
                    clearTimeout(fadeTimer);
                    clearTimeout(hideTimer);
                };
            }, []);
            
            // Save chat histories to localStorage (as cache)
            useEffect(() => {
                if (chatHistoriesLoaded) {
                    localStorage.setItem('chatHistories', JSON.stringify(chatHistories));
                }
            }, [chatHistories, chatHistoriesLoaded]);
            
            // Save current chat to history when messages change (debounced)
            useEffect(() => {
                if (chatMessages.length > 1) {
                    const timer = setTimeout(() => {
                        // Extract title from first user message or first bot response about a stock
                        let title = 'New Chat';
                        const userMsg = chatMessages.find(m => m.role === 'user');
                        if (userMsg) {
                            title = userMsg.content.substring(0, 50) + (userMsg.content.length > 50 ? '...' : '');
                        }
                        
                        const chatData = {
                            id: currentChatId,
                            title,
                            messages: chatMessages,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Save to database
                        saveChatToDb(chatData);
                        
                        // Update local state
                        setChatHistories(prev => {
                            const existing = prev.findIndex(c => c.id === currentChatId);
                            
                            if (existing >= 0) {
                                const updated = [...prev];
                                updated[existing] = chatData;
                                return updated;
                            }
                            return [chatData, ...prev].slice(0, 50); // Keep last 50 chats
                        });
                    }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [chatMessages, currentChatId]);
            
            // Start new chat
            const startNewChat = () => {
                setCurrentChatId('chat-' + Date.now());
                setChatMessages([
                    { role: 'assistant', content: "Hi, I am Charlie the AlphaMaker, an AI agent specializing in stocks. Which stock are you looking to analyze today?" }
                ]);
                setShowChatSidebar(false);
            };
            
            // Load chat from history
            const loadChatFromHistory = (chat) => {
                setCurrentChatId(chat.id);
                setChatMessages(chat.messages);
                setShowChatSidebar(false);
            };
            
            // Delete chat from history
            const deleteChatFromHistory = (chatId, e) => {
                e.stopPropagation();
                deleteChatFromDb(chatId); // Delete from database
                setChatHistories(prev => prev.filter(c => c.id !== chatId));
                if (currentChatId === chatId) {
                    startNewChat();
                }
            };
            
            // Overview state - saved stock overviews
            const [savedOverviews, setSavedOverviews] = useState([]);
            const [overviewsLoaded, setOverviewsLoaded] = useState(false);
            const [currentOverviewTicker, setCurrentOverviewTicker] = useState(null);
            const [showOverviewEmailDialog, setShowOverviewEmailDialog] = useState(false);
            const [showOverviewHistory, setShowOverviewHistory] = useState(false);
            const [selectedOverviewHistoryVersion, setSelectedOverviewHistoryVersion] = useState(null);
            const [overviewExpanded, setOverviewExpanded] = useState({ companyOverview: true, businessModel: true, businessMix: true, opportunities: true, risks: true, conclusion: true });
            const [editingOverviewField, setEditingOverviewField] = useState(null); // {ticker, field}
            const [backupImportStatus, setBackupImportStatus] = useState(null); // {type: 'success'|'error', message: ''}
            
            const fileInputRef = useRef(null);
            const backupFileInputRef = useRef(null);
            
            // Load overviews from database on startup
            const loadOverviews = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/overviews`);
                    if (response.ok) {
                        const dbOverviews = await response.json();
                        
                        // Check if localStorage has overviews that aren't in database (migration)
                        const localSaved = localStorage.getItem('stockOverviews');
                        const localOverviews = localSaved ? JSON.parse(localSaved) : [];
                        
                        if (localOverviews.length > 0 && dbOverviews.length === 0) {
                            // Migrate localStorage to database
                            console.log('Migrating localStorage overviews to database...');
                            for (const overview of localOverviews) {
                                await fetch(`${API_URL}/api/save-overview`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(overview)
                                });
                            }
                            setSavedOverviews(localOverviews);
                        } else {
                            setSavedOverviews(dbOverviews);
                            localStorage.setItem('stockOverviews', JSON.stringify(dbOverviews));
                        }
                    } else {
                        // Fallback to localStorage
                        const saved = localStorage.getItem('stockOverviews');
                        if (saved) setSavedOverviews(JSON.parse(saved));
                    }
                } catch (err) {
                    console.error('Failed to load overviews from API:', err);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('stockOverviews');
                    if (saved) setSavedOverviews(JSON.parse(saved));
                } finally {
                    setOverviewsLoaded(true);
                }
            };
            
            // Save single overview to database
            const saveOverviewToDb = async (overview) => {
                try {
                    await fetch(`${API_URL}/api/save-overview`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(overview)
                    });
                } catch (err) {
                    console.error('Failed to save overview to DB:', err);
                }
            };
            
            // Delete overview from database
            const deleteOverviewFromDb = async (ticker) => {
                try {
                    await fetch(`${API_URL}/api/delete-overview`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker })
                    });
                } catch (err) {
                    console.error('Failed to delete overview from DB:', err);
                }
            };
            
            // Load overviews on mount
            useEffect(() => {
                loadOverviews();
            }, []);
            
            // Save overviews to localStorage whenever they change (as cache)
            useEffect(() => {
                if (overviewsLoaded) {
                    localStorage.setItem('stockOverviews', JSON.stringify(savedOverviews));
                }
            }, [savedOverviews, overviewsLoaded]);
            
            // Improved parsing function with better cue word detection
            const parseOverviewContent = (text) => {
                const sections = {
                    companyOverview: '',
                    businessModel: '',
                    businessMix: '',
                    opportunities: '',
                    risks: '',
                    conclusion: ''
                };
                
                // Normalize text
                let normalizedText = text
                    .replace(/\r\n/g, '\n')
                    .replace(/\n{3,}/g, '\n\n');
                
                // Helper to clean captured content
                const cleanContent = (content) => {
                    if (!content) return '';
                    return content
                        .replace(/^[\s\-‚Ä¢:]+/, '')
                        .replace(/\n{3,}/g, '\n\n')
                        .trim();
                };
                
                // Determine which section a header line belongs to
                const getSectionFromHeader = (line) => {
                    const lower = line.toLowerCase();
                    if (lower.includes('what') && lower.includes('does')) return 'companyOverview';
                    if (lower.includes('core business')) return 'companyOverview';
                    if (lower.includes('company overview')) return 'companyOverview';
                    // Business Mix detection - must come before Business Model
                    if (lower.includes('business mix')) return 'businessMix';
                    if (lower.includes('revenue mix')) return 'businessMix';
                    if (lower.includes('where') && lower.includes('revenue')) return 'businessMix';
                    if (lower.includes('revenue breakdown')) return 'businessMix';
                    if (lower.includes('segment breakdown')) return 'businessMix';
                    // Business Model detection
                    if (lower.includes('business model')) return 'businessModel';
                    if (lower.includes('how') && lower.includes('make') && lower.includes('money')) return 'businessModel';
                    if (lower.includes('key opportunities')) return 'opportunities';
                    if (lower.includes('opportunities for')) return 'opportunities';
                    if (lower.includes('key risks')) return 'risks';
                    if (lower.includes('risks for')) return 'risks';
                    if (lower.includes('in summary')) return 'conclusion';
                    if (lower.includes('conclusion')) return 'conclusion';
                    if (lower.includes('investment outlook')) return 'conclusion';
                    if (lower.includes('investment thesis')) return 'conclusion';
                    if (lower.includes('bottom line')) return 'conclusion';
                    if (lower.includes('final thoughts')) return 'conclusion';
                    if (lower.includes('summary')) return 'conclusion';
                    return null;
                };
                
                // Check if a line is a section header
                const isHeader = (line) => {
                    // Markdown headers: ### Header or ## Header
                    if (/^#{1,4}\s+/.test(line)) return true;
                    // Standalone dividers
                    if (/^-{3,}$/.test(line.trim())) return true;
                    // Lines that start with bold markers like **The Bottom Line**
                    if (/^\*\*[^*]+\*\*:?\s*$/.test(line.trim())) return true;
                    // Lines that are section keywords (reasonably short lines, under 80 chars)
                    const trimmed = line.trim();
                    if (trimmed.length < 80 && getSectionFromHeader(line)) return true;
                    // Also check for "Title:" format at start of line
                    if (/^[A-Z][^:]{5,40}:\s*$/.test(trimmed) && getSectionFromHeader(line)) return true;
                    return false;
                };
                
                // Process line by line
                const lines = normalizedText.split('\n');
                let currentSection = null;
                let buffer = [];
                
                const saveBuffer = () => {
                    if (currentSection && buffer.length > 0) {
                        const content = cleanContent(buffer.join('\n'));
                        if (content) {
                            // Append if already has content, otherwise set
                            sections[currentSection] = sections[currentSection] 
                                ? sections[currentSection] + '\n\n' + content 
                                : content;
                        }
                    }
                    buffer = [];
                };
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmedLine = line.trim();
                    
                    // Skip empty lines but preserve them in buffer for formatting
                    if (!trimmedLine) {
                        if (buffer.length > 0) buffer.push('');
                        continue;
                    }
                    
                    // Skip standalone dividers
                    if (/^-{3,}$/.test(trimmedLine)) {
                        continue;
                    }
                    
                    // Check if this line is a header
                    const sectionFromThisLine = getSectionFromHeader(line);
                    
                    if (sectionFromThisLine && isHeader(line)) {
                        // This is a section header - save previous buffer and start new section
                        saveBuffer();
                        currentSection = sectionFromThisLine;
                        // Don't add the header line itself to the buffer
                        continue;
                    }
                    
                    // If we have a current section, add to buffer
                    if (currentSection) {
                        buffer.push(line);
                    } else {
                        // Content before any recognized header - goes to overview
                        // But skip intro text like "Alright, let's break down..."
                        const lower = trimmedLine.toLowerCase();
                        if (!lower.startsWith('alright') && !lower.startsWith('let me') && !lower.startsWith('here\'s')) {
                            if (!currentSection) currentSection = 'companyOverview';
                            buffer.push(line);
                        }
                    }
                }
                
                // Don't forget the last buffer
                saveBuffer();
                
                // Post-processing: Detect conclusion buried at end of Risks section
                // Look for prose paragraph after the bullet list (separated by empty line)
                if (sections.risks && !sections.conclusion) {
                    const risksContent = sections.risks;
                    const lines = risksContent.split('\n');
                    
                    // Find groups of content separated by empty lines
                    // The last group that is prose (not bullets) is likely the conclusion
                    let groups = [];
                    let currentGroup = [];
                    
                    for (const line of lines) {
                        if (line.trim() === '') {
                            if (currentGroup.length > 0) {
                                groups.push(currentGroup);
                                currentGroup = [];
                            }
                        } else {
                            currentGroup.push(line);
                        }
                    }
                    if (currentGroup.length > 0) {
                        groups.push(currentGroup);
                    }
                    
                    // Check if last group is prose (doesn't start with bullet)
                    if (groups.length > 1) {
                        const lastGroup = groups[groups.length - 1];
                        const firstLineOfLastGroup = lastGroup[0].trim();
                        const lastGroupText = lastGroup.join('\n');
                        
                        // If last group doesn't start with bullet and has substantial content
                        // and the previous groups had bullets, move it to conclusion
                        const startsWithBullet = /^[‚Ä¢\-\*]\s/.test(firstLineOfLastGroup) || /^\d+[\.\)]\s/.test(firstLineOfLastGroup);
                        const hasSubstantialContent = lastGroupText.length > 80;
                        
                        // Check if earlier groups have bullet points
                        const earlierGroups = groups.slice(0, -1);
                        const earlierHasBullets = earlierGroups.some(g => 
                            g.some(line => /^[‚Ä¢\-\*]\s/.test(line.trim()) || /^\d+[\.\)]\s/.test(line.trim()))
                        );
                        
                        if (!startsWithBullet && hasSubstantialContent && earlierHasBullets) {
                            sections.risks = earlierGroups.map(g => g.join('\n')).join('\n\n').trim();
                            sections.conclusion = lastGroupText;
                        }
                    }
                }
                
                // Also check opportunities section for the same pattern
                if (sections.opportunities && !sections.conclusion) {
                    const content = sections.opportunities;
                    const lines = content.split('\n');
                    
                    let groups = [];
                    let currentGroup = [];
                    
                    for (const line of lines) {
                        if (line.trim() === '') {
                            if (currentGroup.length > 0) {
                                groups.push(currentGroup);
                                currentGroup = [];
                            }
                        } else {
                            currentGroup.push(line);
                        }
                    }
                    if (currentGroup.length > 0) {
                        groups.push(currentGroup);
                    }
                    
                    if (groups.length > 1) {
                        const lastGroup = groups[groups.length - 1];
                        const firstLineOfLastGroup = lastGroup[0].trim();
                        const lastGroupText = lastGroup.join('\n');
                        
                        const startsWithBullet = /^[‚Ä¢\-\*]\s/.test(firstLineOfLastGroup) || /^\d+[\.\)]\s/.test(firstLineOfLastGroup);
                        const hasSubstantialContent = lastGroupText.length > 80;
                        
                        const earlierGroups = groups.slice(0, -1);
                        const earlierHasBullets = earlierGroups.some(g => 
                            g.some(line => /^[‚Ä¢\-\*]\s/.test(line.trim()) || /^\d+[\.\)]\s/.test(line.trim()))
                        );
                        
                        if (!startsWithBullet && hasSubstantialContent && earlierHasBullets) {
                            sections.opportunities = earlierGroups.map(g => g.join('\n')).join('\n\n').trim();
                            sections.conclusion = lastGroupText;
                        }
                    }
                }
                
                // Final fallback - if nothing parsed, put everything in overview
                if (!sections.companyOverview && !sections.businessModel && !sections.businessMix && !sections.opportunities && !sections.risks && !sections.conclusion) {
                    sections.companyOverview = cleanContent(text);
                }
                
                return sections;
            };
            
            // Function to save chat response as overview
            const saveToOverview = (ticker, companyName, content) => {
                const sections = parseOverviewContent(content);
                
                setSavedOverviews(prev => {
                    const existingIdx = prev.findIndex(o => o.ticker === ticker.toUpperCase());
                    
                    if (existingIdx >= 0) {
                        // Update existing - save current version to history first
                        const existing = prev[existingIdx];
                        const history = existing.history || [];
                        
                        // Add current version to history
                        if (existing.companyOverview || existing.businessModel || existing.businessMix || existing.rawContent) {
                            history.push({
                                timestamp: existing.updatedAt || new Date().toISOString(),
                                companyOverview: existing.companyOverview,
                                businessModel: existing.businessModel,
                                businessMix: existing.businessMix,
                                opportunities: existing.opportunities,
                                risks: existing.risks,
                                conclusion: existing.conclusion,
                                rawContent: existing.rawContent
                            });
                        }
                        
                        // Keep only last 20 versions
                        const trimmedHistory = history.slice(-20);
                        
                        const updated = [...prev];
                        updated[existingIdx] = {
                            ticker: ticker.toUpperCase(),
                            companyName: companyName || existing.companyName || ticker.toUpperCase(),
                            ...sections,
                            updatedAt: new Date().toISOString(),
                            rawContent: content,
                            history: trimmedHistory
                        };
                        // Save to database
                        saveOverviewToDb(updated[existingIdx]);
                        return updated;
                    } else {
                        // Create new
                        const newOverview = {
                            ticker: ticker.toUpperCase(),
                            companyName: companyName || ticker.toUpperCase(),
                            ...sections,
                            updatedAt: new Date().toISOString(),
                            rawContent: content,
                            history: []
                        };
                        // Save to database
                        saveOverviewToDb(newOverview);
                        return [...prev, newOverview];
                    }
                });
                
                setCurrentOverviewTicker(ticker.toUpperCase());
                setActiveTab('overview');
            };
            
            // Delete overview
            const deleteOverview = (ticker) => {
                if (!confirm(`Delete overview for ${ticker}?`)) return;
                setSavedOverviews(prev => prev.filter(o => o.ticker !== ticker));
                deleteOverviewFromDb(ticker);
                if (currentOverviewTicker === ticker) {
                    setCurrentOverviewTicker(null);
                }
            };
            
            // ============================================
            // BACKUP & RESTORE FUNCTIONS
            // ============================================
            
            // Export all data to JSON file
            const exportAllData = () => {
                const data = {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    savedAnalyses: savedAnalyses,
                    savedOverviews: savedOverviews,
                    chatHistories: chatHistories,
                    emailSettings: {
                        email: emailData.email,
                        gmailUser: emailData.gmailUser,
                        useGmail: emailData.useGmail
                        // Note: passwords not exported for security
                    }
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tdl-equity-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Backup exported successfully!');
            };
            
            // Import data from JSON file
            const importBackupData = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate structure
                        if (!data.savedAnalyses && !data.savedOverviews) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        let importedCounts = { analyses: 0, overviews: 0 };
                        
                        // Import portfolio analyses to database
                        if (data.savedAnalyses && Array.isArray(data.savedAnalyses)) {
                            for (const item of data.savedAnalyses) {
                                try {
                                    await fetch(`${API_URL}/api/save-analysis`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            ticker: item.ticker,
                                            companyName: item.company,
                                            analysis: item.analysis
                                        })
                                    });
                                    importedCounts.analyses++;
                                } catch (err) {
                                    console.error('Failed to import analysis:', item.ticker, err);
                                }
                            }
                            // Reload from database
                            await loadSavedAnalyses();
                        }
                        
                        // Import overviews to database
                        if (data.savedOverviews && Array.isArray(data.savedOverviews)) {
                            for (const item of data.savedOverviews) {
                                try {
                                    await fetch(`${API_URL}/api/save-overview`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(item)
                                    });
                                    importedCounts.overviews++;
                                } catch (err) {
                                    console.error('Failed to import overview:', item.ticker, err);
                                }
                            }
                            // Reload overviews from database
                            try {
                                const response = await fetch(`${API_URL}/api/overviews`);
                                if (response.ok) {
                                    const overviews = await response.json();
                                    setSavedOverviews(overviews);
                                }
                            } catch (err) {
                                console.error('Failed to reload overviews:', err);
                            }
                        }
                        
                        // Import email settings locally (not to database)
                        if (data.emailSettings) {
                            const newEmailData = {
                                ...emailData,
                                email: data.emailSettings.email || emailData.email,
                                gmailUser: data.emailSettings.gmailUser || emailData.gmailUser,
                                useGmail: data.emailSettings.useGmail ?? emailData.useGmail
                            };
                            setEmailData(newEmailData);
                        }
                        
                        setBackupImportStatus({ 
                            type: 'success', 
                            message: `Imported ${importedCounts.analyses} portfolio stocks, ${importedCounts.overviews} overviews to database` 
                        });
                        setTimeout(() => setBackupImportStatus(null), 5000);
                        
                    } catch (error) {
                        setBackupImportStatus({ type: 'error', message: 'Failed to import: ' + error.message });
                        setTimeout(() => setBackupImportStatus(null), 5000);
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            };
            
            // Send overview email
            const sendOverviewEmail = async () => {
                const overview = savedOverviews.find(o => o.ticker === currentOverviewTicker);
                if (!overview || !emailData.email) {
                    setError('Enter email address');
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    // Helper to convert markdown to HTML and clean up
                    const formatContent = (text) => {
                        if (!text) return '';
                        if (typeof text !== 'string') text = safeStr(text);
                        if (!text) return '';
                        return text
                            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')  // **bold** to <strong>
                            .replace(/\*([^*]+)\*/g, '<em>$1</em>')  // *italic* to <em>
                            .replace(/^[-‚Ä¢]\s*/gm, '')  // Remove bullet markers
                            .replace(/\n/g, '<br>');
                    };
                    
                    // Helper to format bullet lists
                    const formatBullets = (text) => {
                        if (!text) return '';
                        if (typeof text !== 'string') text = safeStr(text);
                        if (!text) return '';
                        const lines = text.split('\n').filter(l => l.trim());
                        let html = '<ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">';
                        for (const line of lines) {
                            const cleanLine = line.replace(/^[-‚Ä¢*]\s*/, '').replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
                            if (cleanLine.trim()) {
                                html += `<li style="font-size: 14px; color: #000000; margin-bottom: 10px;">${cleanLine}</li>`;
                            }
                        }
                        html += '</ul>';
                        return html;
                    };
                    
                    // Build properly formatted HTML email - all black text, consistent sizing
                    let emailBody = `
<html>
<body style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #000000; max-width: 700px; margin: 0 auto;">
    <p style="font-size: 14px; color: #000000; margin-bottom: 5px;"><strong>${overview.ticker} - ${overview.companyName}</strong></p>
    <hr style="border: none; border-top: 1px solid #000000; margin: 10px 0 20px 0;">
`;
                    
                    if (overview.companyOverview) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Company Overview</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.companyOverview)}</p>`;
                    }
                    if (overview.businessModel) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Business Model</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.businessModel)}</p>`;
                    }
                    if (overview.businessMix) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Business Mix</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.businessMix)}</p>`;
                    }
                    if (overview.opportunities) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Key Opportunities</strong></p>`;
                        emailBody += formatBullets(overview.opportunities);
                    }
                    if (overview.risks) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Key Risks</strong></p>`;
                        emailBody += formatBullets(overview.risks);
                    }
                    if (overview.conclusion) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Conclusion</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.conclusion)}</p>`;
                    }
                    
                    emailBody += `</body></html>`;
                    
                    const response = await fetch(`${API_URL}/api/email-overview`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticker: overview.ticker,
                            companyName: overview.companyName,
                            htmlBody: emailBody,
                            email: emailData.email,
                            customSubject: emailData.customSubject || `${overview.ticker} - Stock Overview`,
                            smtpConfig: {
                                use_gmail: emailData.useGmail,
                                gmail_user: emailData.gmailUser,
                                gmail_app_password: emailData.gmailPassword,
                                from_email: emailData.gmailUser || emailData.email
                            }
                        })
                    });

                    if (!response.ok) {
                        // Fallback to analysis endpoint with proper format
                        const overviewAsAnalysis = {
                            ticker: overview.ticker,
                            company: overview.companyName,
                            thesis: {
                                summary: overview.companyOverview || '',
                                pillars: overview.businessModel ? [{ pillar: 'Business Model', detail: overview.businessModel }] : []
                            },
                            signposts: overview.opportunities ? overview.opportunities.split(/\n(?=[-‚Ä¢\d])/).filter(s => s.trim()).map(s => ({ signpost: s.trim(), target: '' })) : [],
                            threats: overview.risks ? overview.risks.split(/\n(?=[-‚Ä¢\d])/).filter(s => s.trim()).map(s => ({ threat: s.trim(), mitigation: '' })) : [],
                            conclusion: overview.conclusion || ''
                        };
                        
                        const fallbackResponse = await fetch(`${API_URL}/api/email-analysis`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                analysis: overviewAsAnalysis,
                                email: emailData.email,
                                customSubject: emailData.customSubject || `${overview.ticker} - Stock Overview`,
                                smtpConfig: {
                                    use_gmail: emailData.useGmail,
                                    gmail_user: emailData.gmailUser,
                                    gmail_app_password: emailData.gmailPassword,
                                    from_email: emailData.gmailUser || emailData.email
                                }
                            })
                        });
                        
                        if (!fallbackResponse.ok) {
                            const err = await fallbackResponse.json();
                            throw new Error(err.error || 'Email failed');
                        }
                    }

                    localStorage.setItem('emailCredentials', JSON.stringify(emailData));
                    setShowOverviewEmailDialog(false);
                    alert(`Overview sent to ${emailData.email}!`);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            // Toggle all overview sections expand/collapse
            const toggleAllOverviewSections = () => {
                const allExpanded = Object.values(overviewExpanded).every(v => v === true);
                const newState = !allExpanded;
                setOverviewExpanded({
                    companyOverview: newState,
                    businessModel: newState,
                    businessMix: newState,
                    opportunities: newState,
                    risks: newState,
                    conclusion: newState
                });
            };
            
            // Check if all sections are expanded
            const allOverviewSectionsExpanded = Object.values(overviewExpanded).every(v => v === true);
            
            // Toggle all portfolio sections expand/collapse
            const toggleAllPortfolioSections = () => {
                const allExpanded = Object.values(expanded).every(v => v === true);
                const newState = !allExpanded;
                setExpanded({
                    thesis: newState,
                    signposts: newState,
                    threats: newState,
                    changes: newState
                });
            };
            
            // Check if all portfolio sections are expanded
            const allPortfolioSectionsExpanded = Object.values(expanded).every(v => v === true);
            
            // Quick send overview email (no dialog)
            const quickSendOverviewEmail = async () => {
                const overview = savedOverviews.find(o => o.ticker === currentOverviewTicker);
                if (!overview) {
                    alert('No overview to email');
                    return;
                }
                
                const saved = localStorage.getItem('emailCredentials');
                if (!saved) {
                    alert('Please set up email credentials first using the Email Options button');
                    setShowOverviewEmailDialog(true);
                    return;
                }
                
                let creds;
                try {
                    creds = JSON.parse(saved);
                } catch (e) {
                    alert('Invalid email credentials. Please update using Email Options.');
                    setShowOverviewEmailDialog(true);
                    return;
                }
                
                if (!creds.email) {
                    alert('No recipient email saved. Please set up using Email Options.');
                    setShowOverviewEmailDialog(true);
                    return;
                }
                
                try {
                    // Helper to convert markdown to HTML and clean up
                    const formatContent = (text) => {
                        if (!text) return '';
                        if (typeof text !== 'string') text = safeStr(text);
                        if (!text) return '';
                        return text
                            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                            .replace(/^[-‚Ä¢]\s*/gm, '')
                            .replace(/\n/g, '<br>');
                    };
                    
                    const formatBullets = (text) => {
                        if (!text) return '';
                        if (typeof text !== 'string') text = safeStr(text);
                        if (!text) return '';
                        const lines = text.split('\n').filter(l => l.trim());
                        let html = '<ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">';
                        for (const line of lines) {
                            const cleanLine = line.replace(/^[-‚Ä¢*]\s*/, '').replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
                            if (cleanLine.trim()) {
                                html += `<li style="font-size: 14px; color: #000000; margin-bottom: 10px;">${cleanLine}</li>`;
                            }
                        }
                        html += '</ul>';
                        return html;
                    };
                    
                    let emailBody = `
<html>
<body style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #000000; max-width: 700px; margin: 0 auto;">
    <p style="font-size: 14px; color: #000000; margin-bottom: 5px;"><strong>${overview.ticker} - ${overview.companyName}</strong></p>
    <hr style="border: none; border-top: 1px solid #000000; margin: 10px 0 20px 0;">
`;
                    
                    if (overview.companyOverview) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Company Overview</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.companyOverview)}</p>`;
                    }
                    if (overview.businessModel) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Business Model</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.businessModel)}</p>`;
                    }
                    if (overview.businessMix) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Business Mix</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.businessMix)}</p>`;
                    }
                    if (overview.opportunities) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Key Opportunities</strong></p>`;
                        emailBody += formatBullets(overview.opportunities);
                    }
                    if (overview.risks) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Key Risks</strong></p>`;
                        emailBody += formatBullets(overview.risks);
                    }
                    if (overview.conclusion) {
                        emailBody += `<p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>Conclusion</strong></p>`;
                        emailBody += `<p style="font-size: 14px; color: #000000; margin: 0 0 20px 0;">${formatContent(overview.conclusion)}</p>`;
                    }
                    
                    emailBody += `</body></html>`;
                    
                    const response = await fetch(`${API_URL}/api/email-overview`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticker: overview.ticker,
                            companyName: overview.companyName,
                            htmlBody: emailBody,
                            email: creds.email,
                            customSubject: `${overview.ticker} - Stock Overview`,
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser || creds.email
                            }
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Email failed');
                    }

                    alert(`Overview sent to ${creds.email}!`);
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };
            
            // Update overview field
            const updateOverviewField = (ticker, field, value) => {
                setSavedOverviews(prev => {
                    const updated = prev.map(o => 
                        o.ticker === ticker ? { ...o, [field]: value, updatedAt: new Date().toISOString() } : o
                    );
                    // Save to database
                    const overview = updated.find(o => o.ticker === ticker);
                    if (overview) saveOverviewToDb(overview);
                    return updated;
                });
                setEditingOverviewField(null);
            };
            
            // Update overview ticker or company name
            const updateOverviewMeta = (oldTicker, newTicker, newCompanyName) => {
                setSavedOverviews(prev => {
                    const updated = prev.map(o => {
                        if (o.ticker === oldTicker) {
                            const newOverview = { 
                                ...o, 
                                ticker: newTicker?.toUpperCase() || o.ticker,
                                companyName: newCompanyName || o.companyName,
                                updatedAt: new Date().toISOString()
                            };
                            // Save to database
                            saveOverviewToDb(newOverview);
                            // If ticker changed, delete old one
                            if (newTicker && newTicker.toUpperCase() !== oldTicker) {
                                deleteOverviewFromDb(oldTicker);
                            }
                            return newOverview;
                        }
                        return o;
                    });
                    return updated;
                });
                if (currentOverviewTicker === oldTicker && newTicker) {
                    setCurrentOverviewTicker(newTicker.toUpperCase());
                }
            };
            
            // Restore overview history version
            const restoreOverviewHistoryVersion = (version) => {
                if (!confirm(`Restore this version from ${formatNYTime(version.timestamp)}?`)) return;
                
                setSavedOverviews(prev => {
                    const idx = prev.findIndex(o => o.ticker === currentOverviewTicker);
                    if (idx < 0) return prev;
                    
                    const current = prev[idx];
                    const history = current.history || [];
                    
                    // Save current to history before restoring
                    history.push({
                        timestamp: current.updatedAt || new Date().toISOString(),
                        companyOverview: current.companyOverview,
                        businessModel: current.businessModel,
                        businessMix: current.businessMix,
                        opportunities: current.opportunities,
                        risks: current.risks,
                        conclusion: current.conclusion,
                        rawContent: current.rawContent
                    });
                    
                    const updated = [...prev];
                    updated[idx] = {
                        ...current,
                        companyOverview: version.companyOverview,
                        businessModel: version.businessModel,
                        businessMix: version.businessMix,
                        opportunities: version.opportunities,
                        risks: version.risks,
                        conclusion: version.conclusion,
                        rawContent: version.rawContent,
                        updatedAt: new Date().toISOString(),
                        history: history.slice(-20)
                    };
                    // Save to database
                    saveOverviewToDb(updated[idx]);
                    return updated;
                });
                
                setSelectedOverviewHistoryVersion(null);
                setShowOverviewHistory(false);
            };
            
            // Chat URL for n8n chatbot
            const CHAT_URL = 'https://tdl36.app.n8n.cloud/webhook/5f8231fa-9c2d-4db7-8303-2088260bf1bb/chat';

            useEffect(() => {
                loadSavedAnalyses();
                
                // Check if we already have a saved key
                const existingKey = loadApiKeyFromStorage();
                if (existingKey) {
                    setApiKeySaved(existingKey);
                    setApiKeyChecked(true);
                    return;
                }
                
                // Load API key from IndexedDB (async, for iOS PWA)
                try {
                    const request = indexedDB.open('EquityAnalyzerDB', 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = () => {
                        const db = request.result;
                        if (db.objectStoreNames.contains('settings')) {
                            const tx = db.transaction('settings', 'readonly');
                            const getReq = tx.objectStore('settings').get('apiKey');
                            getReq.onsuccess = () => {
                                const idbKey = getReq.result?.value;
                                if (idbKey && !apiKeySaved) {
                                    console.log('Loaded API key from IndexedDB');
                                    setApiKeySaved(idbKey);
                                    // Sync to other storage
                                    try { localStorage.setItem(STORAGE_KEY, idbKey); } catch(e) {}
                                    try { sessionStorage.setItem(STORAGE_KEY, idbKey); } catch(e) {}
                                }
                                setApiKeyChecked(true);
                            };
                        } else {
                            setApiKeyChecked(true);
                        }
                    };
                    request.onerror = () => {
                        setApiKeyChecked(true);
                    };
                } catch(e) {
                    setApiKeyChecked(true);
                }
            }, []);
            
            // Scroll detection for scroll-to-top button
            useEffect(() => {
                const handleGlobalScroll = (e) => {
                    const target = e.target;
                    // Check if target is an element with overflow-y-auto class
                    if (target && target.className && typeof target.className === 'string' && target.className.includes('overflow-y-auto')) {
                        setShowScrollTop(target.scrollTop > 300);
                        scrollContainerRef.current = target;
                    }
                };
                
                document.addEventListener('scroll', handleGlobalScroll, true);
                return () => document.removeEventListener('scroll', handleGlobalScroll, true);
            }, []);

            const loadSavedAnalyses = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/analyses`);
                    if (response.ok) {
                        const data = await response.json();
                        setSavedAnalyses(data);
                    }
                } catch (err) {
                    console.error('Failed to load analyses:', err);
                }
            };

            // Scroll handling for scroll-to-top button
            const handleScroll = (e) => {
                const scrollTop = e.target.scrollTop;
                setShowScrollTop(scrollTop > 300);
            };
            
            const scrollToTop = () => {
                if (scrollContainerRef.current) {
                    scrollContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            // Cross-tab navigation - sync ticker when switching between Portfolio and Overview
            const switchTab = (newTab) => {
                const prevTab = activeTab;
                setActiveTab(newTab);
                setShowScrollTop(false); // Reset scroll button when switching tabs

                // Clear Drive search state on tab switch
                setDriveResults([]);
                setDriveSelected(new Set());
                setDriveZipContents({});
                setDriveError(null);

                // If switching between Portfolio and Overview, try to navigate to same ticker
                if (prevTab === 'portfolio' && newTab === 'overview' && currentTicker) {
                    const matchingOverview = savedOverviews.find(o => o.ticker === currentTicker);
                    if (matchingOverview) {
                        setCurrentOverviewTicker(currentTicker);
                    }
                } else if (prevTab === 'overview' && newTab === 'portfolio' && currentOverviewTicker) {
                    const matchingAnalysis = savedAnalyses.find(a => a.ticker === currentOverviewTicker);
                    if (matchingAnalysis) {
                        loadAnalysis(currentOverviewTicker);
                    }
                }
                // Lazy load Meeting Prep data
                if (newTab === 'meetingprep' && !mpDataLoaded) {
                    loadMpMeetings();
                    setMpDataLoaded(true);
                }
                // Lazy load Slides data
                if (newTab === 'slides' && !slideDataLoaded) {
                    loadSlideProjects();
                    loadSlideThemes();
                    setSlideDataLoaded(true);
                }
                // Lazy load Studio data
                if (newTab === 'studio' && !studioDataLoaded) {
                    loadStudioOutputs();
                    loadStudioThemes();
                    setStudioDataLoaded(true);
                }
            };

            // ============================================
            // MEETING PREP FUNCTIONS
            // ============================================

            // ============================================
            // SLIDE GENERATOR FUNCTIONS
            // ============================================

            const loadSlideProjects = async () => {
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects`);
                    if (res.ok) setSlideProjects(await res.json());
                } catch (err) { console.error('Failed to load slide projects:', err); }
            };

            const loadSlideThemes = async () => {
                try {
                    const res = await fetch(`${API_URL}/api/slides/themes`);
                    if (res.ok) setSlideThemes(await res.json());
                } catch (err) { console.error('Failed to load themes:', err); }
            };

            const loadSlideProject = async (projectId) => {
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects/${projectId}`);
                    if (res.ok) {
                        const data = await res.json();
                        setSlideSelectedProject(data);
                        if (data.slides && data.slides.length > 0 && !slideSelectedSlide) {
                            selectSlide(data.slides[0]);
                        }
                    }
                } catch (err) { console.error('Failed to load slide project:', err); }
            };

            const selectSlide = (slide) => {
                setSlideSelectedSlide(slide);
                setSlideEditContent(slide.content || '');
                setSlideEditTitle(slide.title || '');
                setSlideEditHints((slide.illustration_hints || []).join(', '));
                setSlideEditNoHeader(slide.no_header || false);
                setSlidePreviewImage(null);
                // Load image if available
                if (slide.has_image) {
                    loadSlideImage(slide.slide_number);
                }
            };

            const loadSlideImage = async (slideNum) => {
                if (!slideSelectedProject) return;
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/slides/${slideNum}/image`);
                    if (res.ok) {
                        const data = await res.json();
                        setSlidePreviewImage(data.image_data);
                    }
                } catch (err) { console.error('Failed to load slide image:', err); }
            };

            const createSlideProject = async () => {
                if (!slideNewTitle.trim()) return;
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: slideNewTitle,
                            ticker: slideNewTicker.toUpperCase() || null,
                            theme: slideNewTheme,
                        }),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setSlideNewTitle('');
                        setSlideNewTicker('');
                        setSlideNewTheme('sketchnote');
                        setShowSlideCreateForm(false);
                        loadSlideProjects();
                        loadSlideProject(data.id);
                    }
                } catch (err) { console.error('Failed to create slide project:', err); }
            };

            const deleteSlideProject = async (projectId) => {
                if (!confirm('Delete this slide project and all its slides?')) return;
                try {
                    await fetch(`${API_URL}/api/slides/projects/${projectId}`, { method: 'DELETE' });
                    setSlideSelectedProject(null);
                    setSlideSelectedSlide(null);
                    loadSlideProjects();
                } catch (err) { console.error('Failed to delete project:', err); }
            };

            const saveSlideEdit = async () => {
                if (!slideSelectedProject || !slideSelectedSlide) return;
                const hints = slideEditHints.split(',').map(h => h.trim()).filter(Boolean);
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/slides/${slideSelectedSlide.slide_number}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: slideEditTitle,
                            content: slideEditContent,
                            illustration_hints: hints,
                            no_header: slideEditNoHeader,
                            type: slideSelectedSlide.type,
                        }),
                    });
                    if (res.ok) {
                        loadSlideProject(slideSelectedProject.id);
                    }
                } catch (err) { console.error('Failed to save slide:', err); }
            };

            const addSlide = async (afterNum) => {
                if (!slideSelectedProject) return;
                const title = prompt('Slide title:');
                if (!title) return;
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/slides`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, after: afterNum }),
                    });
                    if (res.ok) loadSlideProject(slideSelectedProject.id);
                } catch (err) { console.error('Failed to add slide:', err); }
            };

            const deleteSlide = async (slideNum) => {
                if (!slideSelectedProject) return;
                if (!confirm(`Delete slide ${slideNum}?`)) return;
                try {
                    await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/slides/${slideNum}`, { method: 'DELETE' });
                    if (slideSelectedSlide && slideSelectedSlide.slide_number === slideNum) {
                        setSlideSelectedSlide(null);
                    }
                    loadSlideProject(slideSelectedProject.id);
                } catch (err) { console.error('Failed to delete slide:', err); }
            };

            const generateOneSlide = async (slideNum) => {
                if (!slideSelectedProject) return;
                setSlideGeneratingNum(slideNum);
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/generate/${slideNum}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ geminiApiKey: loadGeminiKeyFromStorage() || '' }),
                    });
                    if (res.ok) {
                        loadSlideProject(slideSelectedProject.id);
                        if (slideSelectedSlide && slideSelectedSlide.slide_number === slideNum) {
                            loadSlideImage(slideNum);
                        }
                    } else {
                        const err = await res.json();
                        alert(`Generation failed: ${err.error || 'Unknown error'}`);
                    }
                } catch (err) { console.error('Failed to generate slide:', err); alert('Generation failed'); }
                setSlideGeneratingNum(null);
            };

            const generateAllSlides = async (changedOnly = true, slideNumbers = null) => {
                if (!slideSelectedProject) return;
                setSlideGenerating(true);
                setSlideGenProgress(null);
                try {
                    const body = { geminiApiKey: loadGeminiKeyFromStorage() || '' };
                    if (slideNumbers) {
                        body.slide_numbers = slideNumbers;
                        body.changed_only = false;
                    } else {
                        body.changed_only = changedOnly;
                    }
                    const res = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    if (res.ok) {
                        // Poll for completion with progress tracking
                        const pollInterval = setInterval(async () => {
                            const projRes = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}`);
                            if (projRes.ok) {
                                const projData = await projRes.json();
                                setSlideSelectedProject(projData);
                                // Parse progress from status like "generating:3:10"
                                if (projData.status && projData.status.startsWith('generating:')) {
                                    const parts = projData.status.split(':');
                                    setSlideGenProgress({ current: parseInt(parts[1]), total: parseInt(parts[2]) });
                                } else if (projData.status !== 'generating' && !projData.status.startsWith('generating:')) {
                                    clearInterval(pollInterval);
                                    setSlideGenerating(false);
                                    setSlideGenProgress(null);
                                    setSlideSelectedSlides(new Set());
                                    loadSlideProjects();
                                }
                            }
                        }, 3000);
                    }
                } catch (err) { console.error('Failed to start generation:', err); setSlideGenerating(false); setSlideGenProgress(null); }
            };

            const generateSelectedSlides = async () => {
                if (slideSelectedSlides.size === 0) return;
                await generateAllSlides(false, Array.from(slideSelectedSlides));
            };

            const toggleSlideSelect = (slideNum) => {
                setSlideSelectedSlides(prev => {
                    const next = new Set(prev);
                    if (next.has(slideNum)) next.delete(slideNum);
                    else next.add(slideNum);
                    return next;
                });
            };

            const selectAllSlides = () => {
                if (!slideSelectedProject || !slideSelectedProject.slides) return;
                const allNums = slideSelectedProject.slides.map(s => s.slide_number);
                setSlideSelectedSlides(prev => prev.size === allNums.length ? new Set() : new Set(allNums));
            };

            const exportSlidePdf = async () => {
                if (!slideSelectedProject) return;
                try {
                    const res = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/export/pdf`, { method: 'POST' });
                    if (res.ok) {
                        const data = await res.json();
                        // Download PDF
                        const link = document.createElement('a');
                        link.href = `data:application/pdf;base64,${data.pdf_data}`;
                        link.download = data.filename;
                        link.click();
                    } else {
                        const err = await res.json();
                        alert(`Export failed: ${err.error || 'Unknown error'}`);
                    }
                } catch (err) { console.error('Failed to export PDF:', err); }
            };

            const generateSlideOutline = async () => {
                if (!slideSelectedProject || !slideSelectedProject.ticker) {
                    alert('Project must have a ticker to generate outline from existing data.');
                    return;
                }
                setSlideOutlineGenerating(true);
                try {
                    const res = await fetch(`${API_URL}/api/slides/generate-outline`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker: slideSelectedProject.ticker, source_type: 'ticker', apiKey: loadApiKeyFromStorage() || '' }),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const popRes = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/populate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slides: data.slides }),
                        });
                        if (popRes.ok) {
                            loadSlideProject(slideSelectedProject.id);
                            loadSlideProjects();
                        }
                    } else {
                        const err = await res.json();
                        alert(`Outline generation failed: ${err.error || 'Unknown error'}`);
                    }
                } catch (err) { console.error('Failed to generate outline:', err); alert('Outline generation failed'); }
                setSlideOutlineGenerating(false);
            };

            const openOutlineSourceModal = () => {
                if (!slideSelectedProject) return;
                setOutlineSourceType(slideSelectedProject.ticker ? 'ticker' : 'custom');
                setOutlineSelectedIds(new Set());
                setOutlineSourceItems([]);
                setOutlineCustomText('');
                setShowOutlineSourceModal(true);
            };

            const loadOutlineSources = async (sourceType) => {
                setOutlineSourceLoading(true);
                setOutlineSourceItems([]);
                setOutlineSelectedIds(new Set());
                try {
                    let url = '';
                    if (sourceType === 'research') url = `${API_URL}/api/slides/sources/research`;
                    else if (sourceType === 'summary') url = `${API_URL}/api/slides/sources/summaries`;
                    else if (sourceType === 'meetingprep') url = `${API_URL}/api/slides/sources/meetingprep`;
                    if (url) {
                        const res = await fetch(url);
                        if (res.ok) setOutlineSourceItems(await res.json());
                    }
                } catch (err) { console.error('Failed to load sources:', err); }
                setOutlineSourceLoading(false);
            };

            const toggleOutlineSource = (id) => {
                setOutlineSelectedIds(prev => {
                    const next = new Set(prev);
                    if (next.has(id)) next.delete(id);
                    else next.add(id);
                    return next;
                });
            };

            const generateOutlineFromSources = async () => {
                if (!slideSelectedProject) return;
                setSlideOutlineGenerating(true);
                setShowOutlineSourceModal(false);
                try {
                    const body = { apiKey: loadApiKeyFromStorage() || '', source_type: outlineSourceType };
                    if (outlineSourceType === 'ticker') {
                        body.ticker = slideSelectedProject.ticker;
                    } else if (outlineSourceType === 'custom') {
                        body.custom_text = outlineCustomText;
                    } else {
                        body.source_ids = Array.from(outlineSelectedIds);
                    }
                    const res = await fetch(`${API_URL}/api/slides/generate-outline`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        // Update theme if returned
                        if (data.theme && data.theme !== slideSelectedProject.theme) {
                            // Theme auto-detected from source
                        }
                        const popRes = await fetch(`${API_URL}/api/slides/projects/${slideSelectedProject.id}/populate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slides: data.slides }),
                        });
                        if (popRes.ok) {
                            loadSlideProject(slideSelectedProject.id);
                            loadSlideProjects();
                        }
                    } else {
                        const err = await res.json();
                        alert(`Outline generation failed: ${err.error || 'Unknown error'}`);
                    }
                } catch (err) { console.error('Failed to generate outline:', err); alert('Outline generation failed'); }
                setSlideOutlineGenerating(false);
            };

            // ============================================
            // STUDIO FUNCTIONS
            // ============================================

            const loadStudioOutputs = async () => {
                try {
                    const res = await fetch(`${API_URL}/api/studio/outputs`);
                    if (res.ok) setStudioOutputs(await res.json());
                } catch (err) { console.error('Failed to load studio outputs:', err); }
            };

            const loadStudioOutput = async (id) => {
                try {
                    const res = await fetch(`${API_URL}/api/studio/outputs/${id}`);
                    if (res.ok) {
                        const data = await res.json();
                        setStudioSelectedOutput(data);
                        setStudioView('detail');
                        // Reset viewer state
                        setStudioQuizAnswers({});
                        setStudioQuizSubmitted(false);
                        setStudioQuizScore(null);
                        setStudioFlashcardIndex(0);
                        setStudioFlashcardFlipped(false);
                        setStudioSlidePreviewImage(null);
                        setStudioSelectedSlideNum(null);
                    }
                } catch (err) { console.error('Failed to load studio output:', err); }
            };

            const loadStudioThemes = async () => {
                try {
                    const res = await fetch(`${API_URL}/api/studio/themes`);
                    if (res.ok) setStudioThemes(await res.json());
                } catch (err) { console.error('Failed to load studio themes:', err); }
            };

            const loadStudioSources = async (sourceType) => {
                setStudioSourceLoading(true);
                setStudioSourceItems([]);
                setStudioSelectedSourceIds(new Set());
                setStudioSourceSearch('');
                try {
                    let url = '';
                    if (sourceType === 'research') url = `${API_URL}/api/slides/sources/research`;
                    else if (sourceType === 'summary') url = `${API_URL}/api/slides/sources/summaries`;
                    else if (sourceType === 'meetingprep') url = `${API_URL}/api/slides/sources/meetingprep`;
                    if (url) {
                        const res = await fetch(url);
                        if (res.ok) setStudioSourceItems(await res.json());
                    }
                } catch (err) { console.error('Failed to load studio sources:', err); }
                setStudioSourceLoading(false);
            };

            const toggleStudioSource = (id) => {
                setStudioSelectedSourceIds(prev => {
                    const next = new Set(prev);
                    if (next.has(id)) next.delete(id); else next.add(id);
                    return next;
                });
            };

            const createAndGenerateStudioOutput = async () => {
                if (!studioCreateTitle.trim()) { alert('Please enter a title'); return; }
                const sourceConfig = { source_type: studioSourceType };
                if (studioSourceType === 'custom') {
                    if (!studioCustomText.trim()) { alert('Please enter some text content'); return; }
                    sourceConfig.custom_text = studioCustomText;
                } else if (studioSourceType === 'none') {
                    // Auto-generate from title alone - no source content needed
                } else {
                    const ids = Array.from(studioSelectedSourceIds);
                    if (ids.length > 0) sourceConfig.source_ids = ids;
                }
                const settings = {};
                if (studioStyleInstructions.trim()) settings.style_instructions = studioStyleInstructions.trim();
                if (studioCreateType === 'slides') { settings.slide_count = studioSlideCount; settings.theme_name = 'sketchnote'; }
                if (studioCreateType === 'infographic') { settings.orientation = studioInfographicOrientation; }
                if (studioCreateType === 'quiz') { settings.question_count = studioQuizCount; settings.difficulty = 'medium'; }
                if (studioCreateType === 'flashcard') { settings.card_count = studioFlashcardCount; }
                if (studioCreateType === 'report') { settings.length = studioReportLength; }

                setStudioGenerating(true);
                try {
                    const createRes = await fetch(`${API_URL}/api/studio/outputs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: studioCreateTitle, type: studioCreateType, source_config: sourceConfig, settings, theme_id: studioCreateTheme }),
                    });
                    if (!createRes.ok) { const e = await createRes.json(); alert(e.error || 'Failed to create'); setStudioGenerating(false); return; }
                    const { id } = await createRes.json();
                    setShowStudioCreateModal(false);

                    // Start generation
                    const apiKey = loadApiKeyFromStorage() || '';
                    const geminiApiKey = loadGeminiKeyFromStorage() || '';
                    await fetch(`${API_URL}/api/studio/outputs/${id}/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey, geminiApiKey }),
                    });

                    // Poll for completion
                    pollStudioProgress(id);
                } catch (err) { console.error('Studio creation error:', err); alert('Failed to create output'); setStudioGenerating(false); }
            };

            const pollStudioProgress = (id) => {
                setStudioGenerating(true);
                const interval = setInterval(async () => {
                    try {
                        const res = await fetch(`${API_URL}/api/studio/outputs/${id}`);
                        if (!res.ok) { clearInterval(interval); setStudioGenerating(false); return; }
                        const data = await res.json();
                        // Parse progress from status like "generating:3:10"
                        if (data.status && data.status.startsWith('generating:')) {
                            const parts = data.status.split(':');
                            setStudioGenProgress({ current: parseInt(parts[1]), total: parseInt(parts[2]) });
                        } else if (data.status === 'generating') {
                            setStudioGenProgress({ current: 0, total: 0 });
                        }
                        if (data.status === 'ready' || data.status === 'error') {
                            clearInterval(interval);
                            setStudioGenerating(false);
                            setStudioGenProgress(null);
                            loadStudioOutputs();
                            loadStudioOutput(id);
                        }
                    } catch (err) { console.error('Poll error:', err); }
                }, 3000);
            };

            const deleteStudioOutput = async (id) => {
                if (!confirm('Delete this output?')) return;
                try {
                    await fetch(`${API_URL}/api/studio/outputs/${id}`, { method: 'DELETE' });
                    loadStudioOutputs();
                    if (studioSelectedOutput && studioSelectedOutput.id === id) {
                        setStudioSelectedOutput(null);
                        setStudioView('grid');
                    }
                } catch (err) { console.error('Delete error:', err); }
            };

            const loadStudioImage = async (outputId, slideNum) => {
                try {
                    const url = slideNum != null
                        ? `${API_URL}/api/studio/outputs/${outputId}/image?slide=${slideNum}`
                        : `${API_URL}/api/studio/outputs/${outputId}/image`;
                    const res = await fetch(url);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.image_data) {
                            setStudioSlidePreviewImage(data.image_data);
                        }
                    }
                } catch (err) { console.error('Failed to load image:', err); }
            };

            const saveStudioSlide = async (outputId, slideNum) => {
                try {
                    const hints = studioEditSlideHints.split(',').map(h => h.trim()).filter(Boolean);
                    const res = await fetch(`${API_URL}/api/studio/outputs/${outputId}/update-slide/${slideNum}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: studioEditSlideTitle, content: studioEditSlideContent, illustration_hints: hints }),
                    });
                    if (res.ok) {
                        loadStudioOutput(outputId);
                    } else {
                        const err = await res.json();
                        alert(err.error || 'Save failed');
                    }
                } catch (err) { console.error('Save slide error:', err); }
            };

            const regenerateStudioSlide = async (outputId, slideNum, editPrompt) => {
                setStudioGenerating(true);
                try {
                    const geminiApiKey = loadGeminiKeyFromStorage() || '';
                    const res = await fetch(`${API_URL}/api/studio/outputs/${outputId}/regenerate-slide/${slideNum}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ geminiApiKey, edit_prompt: editPrompt }),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setStudioSlidePreviewImage(data.image_data);
                        loadStudioOutput(outputId);
                    }
                } catch (err) { console.error('Regenerate slide error:', err); }
                setStudioGenerating(false);
            };

            const exportStudioOutput = async (id, format) => {
                try {
                    const res = await fetch(`${API_URL}/api/studio/outputs/${id}/export`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ format }),
                    });
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'pdf' ? 'pdf' : (studioSelectedOutput?.type === 'report' ? 'md' : 'png');
                        a.download = `${studioSelectedOutput?.title || 'export'}.${ext}`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                } catch (err) { console.error('Export error:', err); }
            };

            // Quiz interactivity
            const selectQuizAnswer = (questionId, optionIndex) => {
                if (studioQuizSubmitted) return;
                setStudioQuizAnswers(prev => ({ ...prev, [questionId]: optionIndex }));
            };
            const submitQuiz = () => {
                const questions = studioSelectedOutput?.content?.questions || [];
                let correct = 0;
                questions.forEach(q => {
                    if (studioQuizAnswers[q.id] === q.correct) correct++;
                });
                setStudioQuizScore({ correct, total: questions.length });
                setStudioQuizSubmitted(true);
            };
            const resetQuiz = () => {
                setStudioQuizAnswers({});
                setStudioQuizSubmitted(false);
                setStudioQuizScore(null);
            };

            // Flashcard interactivity
            const nextFlashcard = () => {
                const cards = studioSelectedOutput?.content?.cards || [];
                setStudioFlashcardFlipped(false);
                setStudioFlashcardIndex(prev => Math.min(prev + 1, cards.length - 1));
            };
            const prevFlashcard = () => {
                setStudioFlashcardFlipped(false);
                setStudioFlashcardIndex(prev => Math.max(prev - 1, 0));
            };
            const flipFlashcard = () => setStudioFlashcardFlipped(prev => !prev);

            // Studio theme management
            const createStudioTheme = async () => {
                if (!studioThemeName.trim() || !studioThemePrompt.trim()) { alert('Name and style prompt required'); return; }
                try {
                    const res = await fetch(`${API_URL}/api/studio/themes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: studioThemeName, description: '', style_prompt: studioThemePrompt }),
                    });
                    if (res.ok) {
                        loadStudioThemes();
                        setShowStudioThemeModal(false);
                        setStudioThemeName('');
                        setStudioThemePrompt('');
                    }
                } catch (err) { console.error('Create theme error:', err); }
            };

            const deleteStudioTheme = async (id) => {
                if (!confirm('Delete this theme?')) return;
                try {
                    const res = await fetch(`${API_URL}/api/studio/themes/${id}`, { method: 'DELETE' });
                    if (res.ok) loadStudioThemes();
                    else { const e = await res.json(); alert(e.error || 'Cannot delete'); }
                } catch (err) { console.error('Delete theme error:', err); }
            };

            // ============================================
            // MEETING PREP FUNCTIONS
            // ============================================

            const loadMpMeetings = async () => {
                try {
                    const res = await fetch(`${API_URL}/api/mp/meetings`);
                    if (res.ok) setMpMeetings(await res.json());
                } catch (err) { console.error('Failed to load meetings:', err); }
            };

            const loadMpMeeting = async (meetingId) => {
                try {
                    const res = await fetch(`${API_URL}/api/mp/meetings/${meetingId}`);
                    if (!res.ok) throw new Error('Meeting not found');
                    const data = await res.json();
                    setMpSelectedMeeting(data.meeting);
                    setMpDocuments(data.documents);
                    setMpQuestionSet(data.questionSet);
                    setMpExpandedTopics(new Set());
                    setMpPipelineError(null);
                    // Load past questions
                    if (data.meeting.ticker) {
                        try {
                            const pqRes = await fetch(`${API_URL}/api/mp/companies/${data.meeting.ticker}/past-questions`);
                            if (pqRes.ok) {
                                const pqData = await pqRes.json();
                                setMpPastQuestions(pqData.pastQuestions || []);
                            }
                        } catch (e) { console.error('Failed to load past questions:', e); }
                    }
                } catch (err) { console.error('Failed to load meeting:', err); }
            };

            const createMpMeeting = async () => {
                if (!mpNewTicker.trim()) return;
                try {
                    const res = await fetch(`${API_URL}/api/mp/meetings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticker: mpNewTicker.toUpperCase().trim(),
                            companyName: mpNewCompanyName.trim() || null,
                            sector: mpNewSector || null,
                            meetingDate: mpNewMeetingDate || null,
                            meetingType: mpNewMeetingType,
                        })
                    });
                    if (!res.ok) throw new Error((await res.json()).error || 'Create failed');
                    const meeting = await res.json();
                    setShowMpCreateForm(false);
                    setMpNewTicker(''); setMpNewCompanyName(''); setMpNewSector(''); setMpNewMeetingDate(''); setMpNewMeetingType('earnings');
                    await loadMpMeetings();
                    await loadMpMeeting(meeting.id);
                } catch (err) { alert('Error: ' + err.message); }
            };

            const deleteMpMeeting = async (meetingId) => {
                if (!confirm('Delete this meeting and all its documents?')) return;
                try {
                    await fetch(`${API_URL}/api/mp/meetings/${meetingId}`, { method: 'DELETE' });
                    setMpSelectedMeeting(null);
                    setMpDocuments([]);
                    setMpQuestionSet(null);
                    await loadMpMeetings();
                } catch (err) { alert('Delete failed: ' + err.message); }
            };

            const handleMpFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length || !mpSelectedMeeting) return;
                setMpUploading(true);
                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        setMpPipelineStep(`Uploading ${i + 1} of ${files.length}: ${file.name}`);

                        // Extract text via existing endpoint
                        let extractedText = '';
                        let pageCount = null;
                        try {
                            const formData = new FormData();
                            formData.append('file', file);
                            const pdfRes = await fetch(`${API_URL}/api/extract-pdf`, { method: 'POST', body: formData });
                            if (pdfRes.ok) {
                                const pdfData = await pdfRes.json();
                                extractedText = pdfData.text || '';
                                pageCount = pdfData.pages || null;
                            } else {
                                console.error('PDF extract failed:', pdfRes.status, await pdfRes.text().catch(() => ''));
                            }
                        } catch (ex) { console.error('PDF extract error:', ex); }

                        // Upload one doc at a time (text + metadata only)
                        const payload = { documents: [{
                            filename: file.name,
                            fileData: '',
                            extractedText,
                            pageCount,
                        }] };
                        console.log('Uploading doc:', file.name, 'text length:', extractedText.length);
                        const res = await fetch(`${API_URL}/api/mp/meetings/${mpSelectedMeeting.id}/documents`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) {
                            const errText = await res.text().catch(() => '');
                            throw new Error(`Upload failed (${res.status}): ${errText}`);
                        }
                    }

                    setMpPipelineStep('');
                    await loadMpMeeting(mpSelectedMeeting.id);
                } catch (err) { alert('Upload error: ' + err.message); }
                finally {
                    setMpUploading(false);
                    setMpPipelineStep('');
                    if (mpFileInputRef.current) mpFileInputRef.current.value = '';
                }
            };

            const deleteMpDocument = async (docId) => {
                if (!mpSelectedMeeting) return;
                try {
                    await fetch(`${API_URL}/api/mp/meetings/${mpSelectedMeeting.id}/documents/${docId}`, { method: 'DELETE' });
                    await loadMpMeeting(mpSelectedMeeting.id);
                } catch (err) { alert('Delete failed: ' + err.message); }
            };

            const runMpPipeline = async () => {
                const apiKey = loadApiKeyFromStorage();
                if (!apiKey) { alert('Please add your API key in Settings first.'); return; }
                if (!mpSelectedMeeting || !mpDocuments.length) return;

                setMpPipelineRunning(true);
                setMpPipelineError(null);

                try {
                    const meeting = mpSelectedMeeting;
                    const meetingId = meeting.id;

                    // Fetch extracted text for each document
                    const docsWithText = [];
                    for (const doc of mpDocuments) {
                        const textRes = await fetch(`${API_URL}/api/mp/meetings/${meetingId}/documents/${doc.id}/text`);
                        if (textRes.ok) {
                            const textData = await textRes.json();
                            if (textData.extractedText) docsWithText.push(textData);
                        }
                    }
                    if (!docsWithText.length) throw new Error('No documents have extracted text');

                    // Step 1: Analyze each document
                    const analyses = [];
                    let totalTokens = 0;
                    // Helper to parse streaming response (spaces as keepalive, JSON on last line)
                    const parseStreamResponse = async (resp, stepName) => {
                        const text = await resp.text();
                        const trimmed = text.trim();
                        const lastNewline = trimmed.lastIndexOf('\n');
                        const jsonStr = lastNewline >= 0 ? trimmed.substring(lastNewline + 1) : trimmed;
                        const data = JSON.parse(jsonStr);
                        if (data.error) throw new Error(`${stepName}: ${data.error}`);
                        return data;
                    };

                    for (let i = 0; i < docsWithText.length; i++) {
                        const d = docsWithText[i];
                        setMpPipelineStep('analyzing');
                        setMpPipelineProgress(`Analyzing document ${i + 1} of ${docsWithText.length}: ${d.filename}`);

                        const resp = await fetch(`${API_URL}/api/mp/analyze-document`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                apiKey, ticker: meeting.ticker, companyName: meeting.company_name,
                                docId: d.id, extractedText: d.extractedText, docType: d.docType, filename: d.filename
                            })
                        });
                        if (!resp.ok) {
                            const errText = await resp.text().catch(() => '');
                            throw new Error(`Analysis failed for ${d.filename}: ${errText}`);
                        }
                        const data = await parseStreamResponse(resp, `Analysis of ${d.filename}`);
                        analyses.push({ ...data.analysis, _source_filename: d.filename, _source_id: d.id });
                        totalTokens += data.tokensUsed || 0;
                    }

                    // Step 2: Synthesize
                    setMpPipelineStep('synthesizing');
                    setMpPipelineProgress('Synthesizing insights across all documents...');
                    const docDates = mpDocuments.map(d => d.doc_date).filter(Boolean).sort();
                    const timeframe = docDates.length >= 2 ? `${docDates[0]} to ${docDates[docDates.length - 1]}` : docDates.length === 1 ? `around ${docDates[0]}` : 'recent';

                    const synthResp = await fetch(`${API_URL}/api/mp/synthesize`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey, ticker: meeting.ticker, companyName: meeting.company_name,
                            sector: meeting.sector || '', analyses, pastQuestions: mpPastQuestions, timeframe
                        })
                    });
                    if (!synthResp.ok) {
                        const errText = await synthResp.text().catch(() => '');
                        throw new Error(`Synthesis failed: ${errText}`);
                    }
                    const synthData = await parseStreamResponse(synthResp, 'Synthesis');
                    totalTokens += synthData.tokensUsed || 0;

                    // Step 3: Generate questions
                    setMpPipelineStep('generating');
                    setMpPipelineProgress('Generating meeting questions...');
                    const unresolved = mpPastQuestions.filter(pq => ['asked', 'unresolved', 'follow_up'].includes(pq.status));

                    const qResp = await fetch(`${API_URL}/api/mp/generate-questions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey, ticker: meeting.ticker, companyName: meeting.company_name,
                            sector: meeting.sector || '', synthesis: synthData.synthesis, unresolvedQuestions: unresolved
                        })
                    });
                    if (!qResp.ok) {
                        const errText = await qResp.text().catch(() => '');
                        throw new Error(`Question generation failed: ${errText}`);
                    }
                    const qData = await parseStreamResponse(qResp, 'Question generation');
                    totalTokens += qData.tokensUsed || 0;

                    // Step 4: Save
                    setMpPipelineStep('saving');
                    setMpPipelineProgress('Saving results...');
                    await fetch(`${API_URL}/api/mp/save-results`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            meetingId, topics: qData.topics, synthesisJson: synthData.synthesis, totalTokens, model: 'claude-sonnet-4-20250514'
                        })
                    });

                    await loadMpMeeting(meetingId);
                    await loadMpMeetings();

                } catch (err) {
                    console.error('Pipeline error:', err);
                    setMpPipelineError(err.message);
                } finally {
                    setMpPipelineRunning(false);
                    setMpPipelineStep('');
                    setMpPipelineProgress('');
                }
            };

            const toggleMpTopic = (index) => {
                setMpExpandedTopics(prev => {
                    const next = new Set(prev);
                    if (next.has(index)) next.delete(index); else next.add(index);
                    return next;
                });
            };

            const quickEmailMpQuestions = async (mode = 'clean') => {
                const saved = localStorage.getItem('emailCredentials');
                if (!saved) { alert('Please configure email in Settings first'); return; }
                let creds;
                try { creds = JSON.parse(saved); } catch (e) { return; }
                if (!creds.email) { alert('Please set a default recipient email in Settings'); return; }

                if (!mpQuestionSet || !mpQuestionSet.topics || !mpQuestionSet.topics.length) {
                    alert('No questions to email. Generate questions first.'); return;
                }

                const ticker = mpSelectedMeeting?.ticker || '';
                const company = mpSelectedMeeting?.company_name || ticker;
                const isDetailed = mode === 'detailed';

                let md = `# ${ticker} ‚Äî Meeting Prep Questions\n\n`;
                if (company !== ticker) md += `**${company}**\n\n`;

                for (const topic of mpQuestionSet.topics) {
                    md += `## ${topic.topic}\n\n`;
                    const allQuestions = topic.questions || [];
                    if (isDetailed) {
                        for (const q of allQuestions) {
                            md += `**${q.question}**\n\n`;
                            if (q.context) md += `*Context:* ${q.context}\n\n`;
                            if (q.source) md += `*Source:* ${q.source}\n\n`;
                            if (q.follow_up_angle) md += `*Follow-up:* ${q.follow_up_angle}\n\n`;
                            md += `---\n\n`;
                        }
                    } else {
                        for (const q of allQuestions) {
                            md += `- ${q.question}\n`;
                        }
                        md += '\n';
                    }
                }

                try {
                    const label = isDetailed ? 'Detailed' : 'Questions';
                    const response = await fetch(`${API_URL}/api/email-research`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: creds.email,
                            subject: `${ticker} - Meeting Prep ${label}`,
                            content: md,
                            minimal: true,
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser
                            }
                        })
                    });
                    if (response.ok) {
                        alert(`${label} emailed successfully!`);
                    } else {
                        let errMsg = `Failed to send (${response.status})`;
                        try { const err = await response.json(); errMsg = err.error || errMsg; } catch(e) {}
                        throw new Error(errMsg);
                    }
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };

            // Google Drive functions (shared across tabs)
            const authGoogle = () => {
                return new Promise((resolve, reject) => {
                    const clientId = googleClientId || localStorage.getItem('google_oauth_client_id') || '';
                    if (!clientId) {
                        reject(new Error('Please add your Google OAuth Client ID in Settings first'));
                        return;
                    }
                    if (driveToken) { resolve(driveToken); return; }
                    try {
                        const tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: clientId,
                            scope: 'https://www.googleapis.com/auth/drive.readonly',
                            callback: (response) => {
                                if (response.error) { reject(new Error(response.error)); return; }
                                setDriveToken(response.access_token);
                                resolve(response.access_token);
                            },
                            error_callback: (err) => reject(new Error(err.message || 'Google auth failed')),
                        });
                        tokenClient.requestAccessToken();
                    } catch (e) {
                        reject(new Error('Google Identity Services not loaded. Try refreshing the page.'));
                    }
                });
            };

            const searchDrive = async (ticker) => {
                setDriveSearching(true);
                setDriveError(null);
                setDriveResults([]);
                setDriveSelected(new Set());
                setDriveZipContents({});
                setDriveZipLoading({});
                try {
                    const token = driveToken || await authGoogle();
                    const res = await fetch(`${API_URL}/api/mp/search-drive`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessToken: token, ticker: ticker || '', timeRange: driveTimeRange, keyword: driveKeyword.trim() || undefined })
                    });
                    if (res.status === 401) {
                        setDriveToken(null);
                        throw new Error('Google authentication expired. Please try again.');
                    }
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'Search failed');
                    }
                    const data = await res.json();
                    setDriveResults(data.files || []);
                    if (!data.files || data.files.length === 0) {
                        const searchTerms = driveKeyword.trim() ? (ticker ? `"${ticker}" + "${driveKeyword.trim()}"` : `"${driveKeyword.trim()}"`) : `"${ticker || 'all'}"`;
                        setDriveError(`No files matching ${searchTerms} found in the selected time range.`);
                    }
                } catch (err) {
                    setDriveError(err.message);
                } finally {
                    setDriveSearching(false);
                }
            };

            const previewZip = async (fileId) => {
                if (driveZipContents[fileId]) {
                    // Already loaded ‚Äî toggle collapse
                    setDriveZipContents(prev => { const n = {...prev}; delete n[fileId]; return n; });
                    // Remove sub-selections
                    setDriveSelected(prev => {
                        const next = new Set(prev);
                        next.forEach(k => { if (k.startsWith(fileId + '::')) next.delete(k); });
                        return next;
                    });
                    return;
                }
                setDriveZipLoading(prev => ({...prev, [fileId]: true}));
                try {
                    const token = driveToken || await authGoogle();
                    const res = await fetch(`${API_URL}/api/mp/preview-zip`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessToken: token, fileId })
                    });
                    if (res.status === 401) { setDriveToken(null); throw new Error('Auth expired'); }
                    if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Preview failed'); }
                    const data = await res.json();
                    setDriveZipContents(prev => ({...prev, [fileId]: data.pdfs || []}));
                } catch (err) {
                    setDriveError(err.message);
                } finally {
                    setDriveZipLoading(prev => ({...prev, [fileId]: false}));
                }
            };

            // Build import file list from current selections (shared helper)
            const buildDriveImportList = () => {
                const filesToImport = [];
                const zipSelections = {};
                driveSelected.forEach(key => {
                    if (key.includes('::')) {
                        const [zipId, zipPath] = key.split('::', 2);
                        if (!zipSelections[zipId]) zipSelections[zipId] = [];
                        zipSelections[zipId].push(zipPath);
                    } else {
                        const f = driveResults.find(r => r.id === key);
                        if (f) {
                            const isZip = f.name.toLowerCase().endsWith('.zip') || f.mimeType === 'application/zip';
                            if (!isZip) filesToImport.push(f);
                        }
                    }
                });
                for (const [zipId, paths] of Object.entries(zipSelections)) {
                    const f = driveResults.find(r => r.id === zipId);
                    if (f) filesToImport.push({...f, selectedPdfs: paths});
                }
                return filesToImport;
            };

            // Generic download from Drive (returns extracted text, no DB storage)
            const downloadDriveFiles = async () => {
                const token = driveToken || await authGoogle();
                const filesToImport = buildDriveImportList();
                if (!filesToImport.length) throw new Error('No files selected for import');
                const res = await fetch(`${API_URL}/api/drive/download-files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, files: filesToImport })
                });
                if (res.status === 401) { setDriveToken(null); throw new Error('Auth expired'); }
                if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Download failed'); }
                const data = await res.json();
                return data.files || [];
            };

            const clearDriveState = () => {
                setDriveResults([]);
                setDriveSelected(new Set());
                setDriveZipContents({});
                setDriveError(null);
                setDriveKeyword('');
            };

            // Meeting Prep: import via existing MP endpoint (stores in mp_documents)
            const handleDriveImportMp = async () => {
                if (!driveSelected.size || !mpSelectedMeeting) return;
                setDriveImporting(true);
                setDriveError(null);
                try {
                    const token = driveToken || await authGoogle();
                    const filesToImport = buildDriveImportList();
                    if (!filesToImport.length) { setDriveError('No files selected for import'); setDriveImporting(false); return; }
                    const res = await fetch(`${API_URL}/api/mp/import-drive-files`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessToken: token, meetingId: mpSelectedMeeting.id, files: filesToImport })
                    });
                    if (res.status === 401) { setDriveToken(null); throw new Error('Auth expired'); }
                    if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Import failed'); }
                    clearDriveState();
                    await loadMpMeeting(mpSelectedMeeting.id);
                } catch (err) {
                    setDriveError(err.message);
                } finally {
                    setDriveImporting(false);
                }
            };

            // Research tab: download files and add to researchFiles state
            const handleDriveImportResearch = async () => {
                if (!driveSelected.size) return;
                setDriveImporting(true);
                setDriveError(null);
                try {
                    const downloaded = await downloadDriveFiles();
                    const newFiles = downloaded.filter(f => !f.error).map(f => ({
                        id: Date.now() + Math.random(),
                        name: f.filename,
                        content: f.extractedText || '',
                        type: 'application/pdf',
                        isImage: false,
                        rawFileData: f.fileData,
                        fileSize: f.fileSize
                    }));
                    if (newFiles.length > 0) {
                        setResearchFiles(prev => [...prev, ...newFiles]);
                        if (!newDocumentName && newFiles[0]) {
                            setNewDocumentName(newFiles[0].name.replace(/\.[^/.]+$/, ''));
                        }
                        setShowAddResearchDoc(true);
                    }
                    clearDriveState();
                    alert(`${newFiles.length} file(s) imported from Drive. Configure analysis settings and click "Create & Analyze".`);
                } catch (err) {
                    setDriveError(err.message);
                } finally {
                    setDriveImporting(false);
                }
            };

            // Summary tab: download files, extract text, generate summary
            const handleDriveImportSummary = async () => {
                if (!driveSelected.size) return;
                setDriveImporting(true);
                setDriveError(null);
                try {
                    const downloaded = await downloadDriveFiles();
                    const validFiles = downloaded.filter(f => !f.error && f.extractedText);
                    if (!validFiles.length) { setDriveError('No text could be extracted from selected files'); setDriveImporting(false); return; }

                    const combinedText = validFiles.map(f => `--- ${f.filename} ---\n${f.extractedText}`).join('\n\n');
                    const filenames = validFiles.map(f => f.filename);

                    // Generate summary via webhook
                    setSummaryFileUploading(true);
                    setSummaryUploadProgress('Generating summary from Drive files...');

                    const webhookResponse = await fetch(SUMMARY_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes: combinedText })
                    });
                    if (!webhookResponse.ok) throw new Error('Summary generation failed');
                    const data = await webhookResponse.json();

                    const title = summaryTitleInput.trim() || filenames[0].replace(/\.[^/.]+$/, '').substring(0, 100) || 'Drive Import';
                    const newSummary = {
                        id: 'summary-' + Date.now(),
                        title: title,
                        rawNotes: combinedText.substring(0, 5000) + (combinedText.length > 5000 ? '...' : ''),
                        summary: data.summary,
                        questions: data.questions,
                        topic: newTopicName || currentSummaryTopic || 'General',
                        topicType: newTopicType || 'other',
                        docType: summaryDocType || 'other',
                        sourceType: 'drive',
                        sourceFiles: filenames,
                        hasStoredFiles: false,
                        createdAt: new Date().toISOString()
                    };

                    await saveSummaryToDb(newSummary);

                    // Store file data
                    const fileDataArray = validFiles.map(f => ({
                        filename: f.filename,
                        fileType: 'application/pdf',
                        fileData: f.fileData,
                        fileSize: f.fileSize
                    }));
                    try {
                        const saveResp = await fetch(`${API_URL}/api/summary-files/${newSummary.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: fileDataArray })
                        });
                        if (saveResp.ok) newSummary.hasStoredFiles = true;
                    } catch (e) { console.warn('File storage failed:', e); }

                    setSavedSummaries(prev => [newSummary, ...prev]);
                    setCurrentSummary(newSummary);
                    setSummaryTitleInput('');
                    setNewTopicName('');
                    setSummaryDocType('');
                    setShowSummaryInputModal(false);
                    setSummaryViewMode('detail');
                    clearDriveState();
                    alert('Summary generated from Drive files!');
                } catch (err) {
                    setDriveError(err.message);
                } finally {
                    setDriveImporting(false);
                    setSummaryFileUploading(false);
                    setSummaryUploadProgress('');
                }
            };

            // Portfolio/Thesis tab: download files and add to documents state
            const handleDriveImportPortfolio = async () => {
                if (!driveSelected.size) return;
                setDriveImporting(true);
                setDriveError(null);
                try {
                    const downloaded = await downloadDriveFiles();
                    const newDocs = downloaded.filter(f => !f.error).map(f => ({
                        id: Date.now() + Math.random(),
                        filename: f.filename,
                        fileData: f.fileData,
                        fileType: 'pdf',
                        mimeType: 'application/pdf',
                        enabled: true,
                        weight: 1.0,
                        metadata: {
                            filename: f.filename,
                            type: 'broker_report',
                            analyst: '',
                            date: new Date().toISOString().split('T')[0]
                        }
                    }));
                    if (newDocs.length > 0) {
                        setDocuments(prev => [...prev, ...newDocs]);
                    }
                    clearDriveState();
                    alert(`${newDocs.length} document(s) imported from Drive.`);
                } catch (err) {
                    setDriveError(err.message);
                } finally {
                    setDriveImporting(false);
                }
            };

            const toggleDriveSelect = (key) => {
                setDriveSelected(prev => {
                    const next = new Set(prev);
                    if (next.has(key)) next.delete(key); else next.add(key);
                    return next;
                });
            };

            const toggleZipSelectAll = (fileId) => {
                const pdfs = driveZipContents[fileId] || [];
                setDriveSelected(prev => {
                    const next = new Set(prev);
                    const allSelected = pdfs.every(p => next.has(fileId + '::' + p.zipPath));
                    pdfs.forEach(p => {
                        const k = fileId + '::' + p.zipPath;
                        if (allSelected) next.delete(k); else next.add(k);
                    });
                    return next;
                });
            };

            // Reusable Drive search UI component
            const renderDriveSearch = (ticker, onImport) => {
                return React.createElement('div', { className: 'mb-3' },
                    React.createElement('div', { className: 'flex items-center gap-2 mb-2' },
                        React.createElement('div', { className: 'flex-1 h-px bg-white/10' }),
                        React.createElement('span', { className: 'text-xs text-slate-400' }, 'or search Google Drive'),
                        React.createElement('div', { className: 'flex-1 h-px bg-white/10' })
                    ),
                    React.createElement('input', {
                        type: 'text', value: driveKeyword,
                        onChange: e => setDriveKeyword(e.target.value),
                        onKeyDown: e => e.key === 'Enter' && searchDrive(ticker),
                        placeholder: 'Search keyword (e.g. CI, Cigna, earnings...)',
                        className: 'w-full mb-2 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:border-indigo-500/50'
                    }),
                    React.createElement('div', { className: 'flex items-center gap-2' },
                        React.createElement('select', {
                            value: driveTimeRange, onChange: e => setDriveTimeRange(e.target.value),
                            className: 'px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-300'
                        },
                            React.createElement('option', { value: 'day' }, 'Past Day'),
                            React.createElement('option', { value: 'week' }, 'Past Week'),
                            React.createElement('option', { value: 'month' }, 'Past Month'),
                            React.createElement('option', { value: '3months' }, 'Past 3 Months'),
                            React.createElement('option', { value: '6months' }, 'Past 6 Months'),
                            React.createElement('option', { value: 'year' }, 'Past Year'),
                            React.createElement('option', { value: '3years' }, 'Past 3 Years')
                        ),
                        React.createElement('button', {
                            onClick: () => searchDrive(ticker), disabled: driveSearching,
                            className: 'flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2'
                        },
                            driveSearching
                                ? React.createElement(React.Fragment, null,
                                    React.createElement('div', { className: 'w-4 h-4 border-2 border-white/40 border-t-white rounded-full animate-spin' }),
                                    ' Searching...')
                                : React.createElement(React.Fragment, null,
                                    React.createElement(Search, { className: 'w-4 h-4' }),
                                    ' Search Drive')
                        )
                    ),
                    driveError && React.createElement('p', { className: 'text-xs text-amber-400 mt-2' }, driveError),
                    driveResults.length > 0 && React.createElement('div', { className: 'mt-2 border border-white/10 rounded-lg overflow-hidden' },
                        React.createElement('div', { className: 'max-h-64 overflow-y-auto' },
                            driveResults.map(f => {
                                const isZip = f.name.toLowerCase().endsWith('.zip') || f.mimeType === 'application/zip';
                                const zipPdfs = driveZipContents[f.id];
                                const zipLoading = driveZipLoading[f.id];
                                return React.createElement('div', { key: f.id, className: 'border-b border-white/5 last:border-0' },
                                    isZip
                                        ? React.createElement('div', {
                                            className: 'flex items-center gap-3 p-2 hover:bg-white/5 cursor-pointer',
                                            onClick: () => previewZip(f.id)
                                        },
                                            React.createElement('div', { className: 'w-4 h-4 flex items-center justify-center text-purple-400 text-xs' },
                                                zipLoading ? React.createElement('div', { className: 'w-3 h-3 border-2 border-purple-400/40 border-t-purple-400 rounded-full animate-spin' })
                                                    : zipPdfs ? '\u25BC' : '\u25B6'),
                                            React.createElement('div', { className: 'min-w-0 flex-1' },
                                                React.createElement('div', { className: 'flex items-center gap-2' },
                                                    React.createElement('p', { className: 'text-sm text-slate-200 truncate' }, f.name),
                                                    React.createElement('span', { className: 'shrink-0 px-1.5 py-0.5 bg-purple-500/20 text-purple-300 text-[10px] font-bold rounded' }, 'ZIP')
                                                ),
                                                React.createElement('p', { className: 'text-xs text-slate-400' },
                                                    (f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString() : '') +
                                                    (f.size ? ` \u00B7 ${(parseInt(f.size) / 1024 / 1024).toFixed(1)}MB` : '') +
                                                    (zipPdfs ? ` \u00B7 ${zipPdfs.length} PDFs` : ' \u00B7 tap to expand')
                                                )
                                            )
                                        )
                                        : React.createElement('label', { className: 'flex items-center gap-3 p-2 hover:bg-white/5 cursor-pointer' },
                                            React.createElement('input', {
                                                type: 'checkbox', checked: driveSelected.has(f.id),
                                                onChange: () => toggleDriveSelect(f.id),
                                                className: 'rounded accent-teal-500'
                                            }),
                                            React.createElement('div', { className: 'min-w-0 flex-1' },
                                                React.createElement('p', { className: 'text-sm text-slate-200 truncate' }, f.name),
                                                React.createElement('p', { className: 'text-xs text-slate-400' },
                                                    (f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString() : '') +
                                                    (f.size ? ` \u00B7 ${(parseInt(f.size) / 1024 / 1024).toFixed(1)}MB` : '')
                                                )
                                            )
                                        ),
                                    isZip && zipPdfs && React.createElement('div', { className: 'bg-white/[0.02] border-t border-white/5' },
                                        React.createElement('div', { className: 'px-2 py-1 flex items-center justify-between border-b border-white/5' },
                                            React.createElement('span', { className: 'text-[10px] text-purple-300 pl-7' }, `${zipPdfs.length} PDFs in zip`),
                                            React.createElement('button', {
                                                onClick: () => toggleZipSelectAll(f.id),
                                                className: 'text-[10px] text-purple-300 hover:text-purple-200 px-1'
                                            }, zipPdfs.every(p => driveSelected.has(f.id + '::' + p.zipPath)) ? 'Deselect all' : 'Select all')
                                        ),
                                        zipPdfs.map(p => React.createElement('label', {
                                            key: p.zipPath,
                                            className: 'flex items-center gap-3 pl-7 pr-2 py-1.5 hover:bg-white/5 cursor-pointer'
                                        },
                                            React.createElement('input', {
                                                type: 'checkbox', checked: driveSelected.has(f.id + '::' + p.zipPath),
                                                onChange: () => toggleDriveSelect(f.id + '::' + p.zipPath),
                                                className: 'rounded accent-purple-500'
                                            }),
                                            React.createElement('div', { className: 'min-w-0 flex-1' },
                                                React.createElement('p', { className: 'text-xs text-slate-300 truncate' }, p.name),
                                                p.size > 0 && React.createElement('p', { className: 'text-[10px] text-slate-500' }, `${(p.size / 1024 / 1024).toFixed(1)}MB`)
                                            )
                                        ))
                                    )
                                );
                            })
                        ),
                        React.createElement('div', { className: 'p-2 border-t border-white/10 flex items-center justify-between bg-white/[0.03]' },
                            React.createElement('span', { className: 'text-xs text-slate-400' }, `${driveSelected.size} selected`),
                            React.createElement('button', {
                                onClick: onImport, disabled: !driveSelected.size || driveImporting,
                                className: 'px-3 py-1.5 bg-teal-600 hover:bg-teal-500 disabled:opacity-50 rounded-lg text-xs font-medium transition-all'
                            }, driveImporting ? 'Importing...' : `Import Selected (${driveSelected.size})`)
                        )
                    )
                );
            };

            const loadAnalysis = async (ticker) => {
                console.log('Loading analysis for:', ticker);
                setError(null);
                try {
                    const response = await fetch(`${API_URL}/api/analysis/${ticker}`);
                    console.log('Response status:', response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Loaded data:', data);
                        
                        // Load stored documents first so we can sync status
                        let storedDocs = [];
                        try {
                            const storedResponse = await fetch(`${API_URL}/api/documents/${ticker}`);
                            if (storedResponse.ok) {
                                const storedData = await storedResponse.json();
                                storedDocs = storedData.documents || [];
                                setStoredDocuments(storedDocs);
                            }
                        } catch (err) {
                            console.log('Could not load stored documents');
                        }
                        
                        // Merge stored status into documentHistory
                        const storedFilenames = new Set(storedDocs.map(d => d.filename));
                        const updatedDocHistory = (data.analysis?.documentHistory || []).map(doc => ({
                            ...doc,
                            stored: doc.stored || storedFilenames.has(doc.filename)
                        }));
                        
                        // Merge the updated timestamp and synced documentHistory into the analysis object
                        setAnalysis({
                            ...data.analysis,
                            documentHistory: updatedDocHistory,
                            updatedAt: data.updated || data.analysis?.updatedAt
                        });
                        setCurrentTicker(ticker);
                        setDocuments([]);
                        setChanges([]);
                        setExpanded({ thesis: true, signposts: true, threats: true, changes: true });
                        setShowDocumentManager(false);
                        setMobileMenuOpen(false);
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to load:', errorText);
                        setError(`Failed to load ${ticker}: ${response.status}`);
                    }
                } catch (err) {
                    console.error('Error loading analysis:', err);
                    setError(`Failed to load ${ticker}: ${err.message}`);
                }
            };

            const saveCurrentAnalysis = async () => {
                if (!analysis || !analysis.ticker) {
                    setError('No analysis to save');
                    return;
                }
                
                // Immediately close dialog to prevent multiple clicks
                setShowSaveDialog(false);

                try {
                    const response = await fetch(`${API_URL}/api/save-analysis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticker: analysis.ticker,
                            companyName: analysis.company,
                            analysis: analysis
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        setCurrentTicker(result.ticker);
                        await loadSavedAnalyses();
                        setError(null);
                        console.log('Analysis saved successfully:', result.ticker);
                    } else {
                        const err = await response.json();
                        setError('Failed to save: ' + (err.error || 'Unknown error'));
                    }
                } catch (err) {
                    console.error('Save error:', err);
                    setError('Failed to save - please try again');
                }
            };

            const restoreHistoryVersion = (version) => {
                if (!confirm(`Restore this version from ${formatNYTime(version.timestamp)}? Your current version will be added to history.`)) return;
                
                // Save current version to history before restoring
                setAnalysis(prev => {
                    const currentHistory = prev.history || [];
                    
                    // Add current version to history
                    const updatedHistory = [
                        ...currentHistory,
                        {
                            timestamp: prev.updatedAt || new Date().toISOString(),
                            thesis: prev.thesis,
                            signposts: prev.signposts,
                            threats: prev.threats
                        }
                    ].slice(-20); // Keep last 20
                    
                    return {
                        ...prev,
                        thesis: version.thesis,
                        signposts: version.signposts,
                        threats: version.threats,
                        history: updatedHistory
                    };
                });
                setSelectedHistoryVersion(null);
                setShowHistory(false);
                setShowSaveDialog(true); // Prompt to save the restored version
            };

            const deleteAnalysis = async (ticker, e) => {
                e.stopPropagation();
                if (!confirm(`Delete analysis for ${ticker}?`)) return;

                try {
                    const response = await fetch(`${API_URL}/api/delete-analysis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker })
                    });
                    
                    if (response.ok) {
                        await loadSavedAnalyses();
                        if (currentTicker === ticker) {
                            startNewAnalysis();
                        }
                    } else {
                        setError('Delete failed');
                    }
                } catch (err) {
                    setError('Delete failed');
                }
            };

            const startNewAnalysis = () => {
                setAnalysis(null);
                setCurrentTicker(null);
                setDocuments([]);
                setDocumentGroups([]); // Clear document groups
                setSelectedForGrouping([]); // Clear selection
                setChanges([]);
                setError(null);
                setShowDocumentManager(false);
                setStoredDocuments([]); // Clear stored documents for new analysis
            };

            const saveKey = () => {
                if (!apiKeyInput.trim()) { setError('Enter API key'); return; }
                if (!apiKeyInput.startsWith('sk-ant-')) { setError('Key must start with sk-ant-'); return; }
                const key = apiKeyInput.trim();
                // Save to all storage methods
                saveApiKeyToStorage(key);
                // Update saved state - this is what triggers the transition
                setApiKeySaved(key);
                setError(null);
                alert('API key saved! You can now upload documents.');
            };

            // Supported file types
            const SUPPORTED_TYPES = {
                'application/pdf': 'pdf',
                'application/msword': 'doc',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
                'image/png': 'image',
                'image/jpeg': 'image',
                'image/jpg': 'image',
                'image/gif': 'image',
                'image/webp': 'image',
                'message/rfc822': 'email',
                'application/vnd.ms-outlook': 'email',
                'text/plain': 'text',
                'text/html': 'html'
            };

            const getFileType = (file) => {
                // Check MIME type first
                if (SUPPORTED_TYPES[file.type]) return SUPPORTED_TYPES[file.type];
                
                // Fallback to extension
                const ext = file.name.split('.').pop().toLowerCase();
                const extMap = {
                    'pdf': 'pdf',
                    'doc': 'doc',
                    'docx': 'docx',
                    'png': 'image',
                    'jpg': 'image',
                    'jpeg': 'image',
                    'gif': 'image',
                    'webp': 'image',
                    'eml': 'email',
                    'msg': 'email',
                    'txt': 'text',
                    'html': 'html',
                    'htm': 'html'
                };
                return extMap[ext] || 'unknown';
            };

            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    const fileType = getFileType(file);
                    
                    if (fileType === 'unknown') {
                        setError(`Unsupported file type: ${file.name}`);
                        continue;
                    }
                    
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    
                    // Determine default source type based on file
                    let defaultSourceType = 'broker_report';
                    if (fileType === 'email' || file.name.toLowerCase().includes('email')) {
                        defaultSourceType = 'email';
                    } else if (fileType === 'image') {
                        defaultSourceType = 'screenshot';
                    }
                    
                    setDocuments(prev => [...prev, {
                        id: Date.now() + Math.random(),
                        filename: file.name,
                        fileData: base64,
                        fileType: fileType,  // pdf, docx, image, email, text, html
                        mimeType: file.type,
                        enabled: true,
                        weight: 1.0,
                        metadata: {
                            filename: file.name,
                            type: defaultSourceType,
                            analyst: '',
                            date: new Date().toISOString().split('T')[0]
                        }
                    }]);
                }
                e.target.value = '';
            };

            const updateDocument = (id, updates) => {
                setDocuments(prev => prev.map(doc => doc.id === id ? { ...doc, ...updates } : doc));
            };

            const updateMetadata = (id, field, value) => {
                setDocuments(prev => prev.map(doc => 
                    doc.id === id ? { ...doc, metadata: { ...doc.metadata, [field]: value } } : doc
                ));
            };

            const deleteDocument = (id) => {
                setDocuments(prev => prev.filter(doc => doc.id !== id));
                // Also remove from any groups
                setDocumentGroups(prev => prev.map(g => ({
                    ...g,
                    documentIds: g.documentIds.filter(did => did !== id)
                })).filter(g => g.documentIds.length > 0));
                setSelectedForGrouping(prev => prev.filter(did => did !== id));
            };

            // ============================================
            // DOCUMENT GROUPING FUNCTIONS
            // ============================================
            
            // Toggle document selection for grouping
            const toggleDocumentSelection = (docId) => {
                setSelectedForGrouping(prev => 
                    prev.includes(docId) 
                        ? prev.filter(id => id !== docId)
                        : [...prev, docId]
                );
            };
            
            // Create a group from selected documents
            const createDocumentGroup = (groupName) => {
                if (selectedForGrouping.length < 2) return;
                
                const newGroup = {
                    id: 'group-' + Date.now(),
                    name: groupName || `Group (${selectedForGrouping.length} files)`,
                    documentIds: [...selectedForGrouping],
                    weight: 1,
                    enabled: true,
                    createdAt: new Date().toISOString()
                };
                
                setDocumentGroups(prev => [...prev, newGroup]);
                setSelectedForGrouping([]);
            };
            
            // Ungroup a document group
            const ungroupDocuments = (groupId) => {
                setDocumentGroups(prev => prev.filter(g => g.id !== groupId));
            };
            
            // Update group weight
            const updateGroupWeight = (groupId, newWeight) => {
                setDocumentGroups(prev => prev.map(g => 
                    g.id === groupId ? { ...g, weight: newWeight } : g
                ));
            };
            
            // Toggle group enabled
            const toggleGroupEnabled = (groupId) => {
                setDocumentGroups(prev => prev.map(g => 
                    g.id === groupId ? { ...g, enabled: !g.enabled } : g
                ));
            };
            
            // Get documents that are NOT in any group
            const getUngroupedDocuments = () => {
                const groupedIds = documentGroups.flatMap(g => g.documentIds);
                return documents.filter(d => !groupedIds.includes(d.id));
            };
            
            // Get documents in a specific group
            const getGroupDocuments = (groupId) => {
                const group = documentGroups.find(g => g.id === groupId);
                if (!group) return [];
                return documents.filter(d => group.documentIds.includes(d.id));
            };

            // ============================================
            // DOCUMENT STORAGE FUNCTIONS
            // ============================================
            
            // Load stored documents for a ticker
            const loadStoredDocuments = async (ticker) => {
                if (!ticker) return;
                try {
                    const response = await fetch(`${API_URL}/api/documents/${ticker}`);
                    if (response.ok) {
                        const data = await response.json();
                        setStoredDocuments(data.documents || []);
                    } else {
                        // Endpoint might not exist yet - gracefully handle
                        setStoredDocuments([]);
                    }
                } catch (err) {
                    // Backend not updated yet - gracefully handle
                    console.log('Document storage not available yet');
                    setStoredDocuments([]);
                }
            };
            
            // Save documents to database
            const saveDocumentsToStorage = async (ticker, docs) => {
                try {
                    const response = await fetch(`${API_URL}/api/documents/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker, documents: docs })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        // Refresh stored documents list
                        await loadStoredDocuments(ticker);
                        return data.savedCount;
                    }
                    return 0;
                } catch (err) {
                    console.error('Error saving documents:', err);
                    return 0;
                }
            };
            
            // Delete a stored document
            const deleteStoredDocument = async (ticker, filename) => {
                try {
                    const response = await fetch(`${API_URL}/api/documents/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker, filename })
                    });
                    if (response.ok) {
                        // Update local state
                        setStoredDocuments(prev => prev.filter(d => d.filename !== filename));
                        // Also update document history
                        setAnalysis(prev => {
                            if (!prev?.documentHistory) return prev;
                            return {
                                ...prev,
                                documentHistory: prev.documentHistory.map(d => 
                                    d.filename === filename ? { ...d, stored: false } : d
                                )
                            };
                        });
                        return true;
                    }
                    return false;
                } catch (err) {
                    console.error('Error deleting document:', err);
                    return false;
                }
            };
            
            // Delete all stored documents for a ticker
            const deleteAllStoredDocuments = async (ticker) => {
                try {
                    const response = await fetch(`${API_URL}/api/documents/delete-all`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker })
                    });
                    if (response.ok) {
                        setStoredDocuments([]);
                        // Update document history
                        setAnalysis(prev => {
                            if (!prev?.documentHistory) return prev;
                            return {
                                ...prev,
                                documentHistory: prev.documentHistory.map(d => ({ ...d, stored: false }))
                            };
                        });
                        return true;
                    }
                    return false;
                } catch (err) {
                    console.error('Error deleting all documents:', err);
                    return false;
                }
            };
            
            // Load stored documents with full content for re-analysis
            const loadStoredDocumentsWithContent = async (ticker) => {
                try {
                    const response = await fetch(`${API_URL}/api/documents/${ticker}/content`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.documents || [];
                    }
                    return [];
                } catch (err) {
                    console.error('Error loading document content:', err);
                    return [];
                }
            };
            
            // View stored ticker file (PDF) in new tab
            const viewStoredTickerFile = async (ticker, filename) => {
                try {
                    console.log('üìÑ Opening stored file:', ticker, filename);
                    const response = await fetch(`${API_URL}/api/documents/${ticker}/content`);
                    if (!response.ok) throw new Error('Failed to fetch files');
                    
                    const data = await response.json();
                    const file = data.documents?.find(d => d.filename === filename);
                    
                    if (!file || !file.fileData) {
                        alert('File content not found. The file may not be stored in the database.');
                        return;
                    }
                    
                    const base64Data = file.fileData;
                    const mimeType = file.mimeType || file.fileType || 'application/pdf';
                    
                    // Convert base64 to blob
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });
                    
                    // Create URL
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // For iOS/iPadOS Safari, use a link click instead of window.open
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    // For PDFs on iOS/iPadOS, trigger download
                    if (isIOSDevice()) {
                        link.download = filename || 'document.pdf';
                    }
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up URL after a delay
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                } catch (err) {
                    console.error('Error viewing file:', err);
                    alert('Failed to open file: ' + err.message);
                }
            };
            
            // Get storage statistics
            const loadStorageStats = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/documents/storage-stats`);
                    if (response.ok) {
                        const data = await response.json();
                        setStorageStats(data);
                    }
                } catch (err) {
                    console.error('Error loading storage stats:', err);
                }
            };
            
            // Format bytes to human readable
            const formatBytes = (bytes) => {
                if (!bytes) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            };
            
            // Generate smart display name from filename and metadata
            const getSmartDocumentName = (doc) => {
                try {
                    // Safety check - always return a string
                    if (!doc) return 'Unknown Document';
                    
                    // If displayName is already set, use it
                    if (doc.displayName && typeof doc.displayName === 'string') return doc.displayName;
                    
                    const filename = String(doc.filename || '');
                    const ticker = String(analysis?.ticker || currentTicker || '').toUpperCase();
                    
                    // Map tickers to their company/broker names to avoid false matches
                    const tickerToBrokerMap = {
                        'GS': ['Goldman Sachs', 'Goldman'],
                        'MS': ['Morgan Stanley'],
                        'JPM': ['JPMorgan', 'JP Morgan'],
                        'BAC': ['BofA', 'Bank of America', 'BAML'],
                        'C': ['Citi', 'Citigroup'],
                        'UBS': ['UBS'],
                        'RBC': ['RBC'],
                        'DB': ['Deutsche Bank'],
                        'HSBC': ['HSBC'],
                        'BCS': ['Barclays'],
                        'EVR': ['Evercore'],
                        'JEF': ['Jefferies'],
                        'SF': ['Stifel'],
                        'PIPR': ['Piper', 'Piper Sandler'],
                        'MIZ': ['Mizuho'],
                        'TFC': ['Truist'],
                        'KEY': ['KeyBanc'],
                        'WFC': ['Wells Fargo'],
                        'RJF': ['Raymond James']
                    };
                    
                    // Get broker names to exclude if analyzing that stock
                    const excludedBrokers = tickerToBrokerMap[ticker] || [];
                    
                    // Get metadata from extracted content (preferred) or fallbacks
                    const docType = doc.docType || doc.type || 'broker_report';
                    let source = doc.source || null;  // Broker, company, publication, sender, etc.
                    
                    // Check if source matches the stock being analyzed - if so, don't use it as broker
                    if (source && excludedBrokers.some(eb => eb.toLowerCase() === source.toLowerCase())) {
                        source = null;
                    }
                    
                    const publishDate = doc.publishDate || doc.date || doc.metadata?.date || '';
                    const title = doc.title || null;
                    const quarter = doc.quarter || null;
                    const filingType = doc.filingType || null;
                    
                    // If no filename, return fallback
                    if (!filename) return 'Untitled Document';
                    
                    // ===== FORMAT DATE =====
                    let dateStr = '';
                    if (publishDate) {
                        try {
                            const d = new Date(publishDate);
                            if (!isNaN(d.getTime())) {
                                dateStr = `${(d.getMonth()+1)}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
                            }
                        } catch(e) {}
                    }
                    
                    // ===== BUILD DISPLAY NAME BASED ON DOC TYPE =====
                    let displayName = '';
                    let suffix = '';
                    
                    // If we have a clean title from metadata, use it
                    if (title && title.length > 5 && title.length < 80) {
                        displayName = title;
                    } else {
                        // Fall back to cleaning up the filename
                        displayName = filename.replace(/\.(pdf|docx?|xlsx?|png|jpe?g|gif|webp|eml|msg|txt|html)$/i, '');
                        
                        // Remove hash/UUID suffixes
                        displayName = displayName.replace(/[-_]?[a-f0-9]{24,}$/i, '');
                        displayName = displayName.replace(/[-_]?SSRFS[-_]?\d*[-_]?[a-f0-9-]+$/i, '');
                        displayName = displayName.replace(/[-_]?ASR[-_][A-Z]+[-_][a-f0-9]+$/i, '');
                        displayName = displayName.replace(/[-_][a-f0-9]{12,}$/i, '');
                        
                        // Clean up ticker prefix patterns
                        if (ticker) {
                            displayName = displayName.replace(new RegExp(`\\s*\\(${ticker}(?:\\.[A-Z])?\\)\\s*[-‚Äì]\\s*`, 'i'), ' - ');
                            displayName = displayName.replace(new RegExp(`^${ticker}\\s*[-‚Äì]\\s*`, 'i'), '');
                        }
                        
                        // Clean up dashes/spaces
                        displayName = displayName
                            .replace(/\s*[-‚Äì]+\s*/g, ' - ')
                            .replace(/\s+/g, ' ')
                            .replace(/^[\s-]+|[\s-]+$/g, '')
                            .trim();
                        
                        // Take first 2 segments
                        const segments = displayName.split(' - ').filter(s => s.trim().length > 0);
                        if (segments.length > 2) {
                            displayName = segments.slice(0, 2).join(' - ');
                        }
                    }
                    
                    // Build suffix based on document type
                    switch (docType) {
                        case 'broker_report':
                            if (source && dateStr) suffix = ` (${source}, ${dateStr})`;
                            else if (source) suffix = ` (${source})`;
                            else if (dateStr) suffix = ` (${dateStr})`;
                            break;
                            
                        case 'earnings_call':
                            if (quarter && source) suffix = ` (${source} ${quarter})`;
                            else if (quarter) suffix = ` (${quarter})`;
                            else if (source && dateStr) suffix = ` (${source}, ${dateStr})`;
                            else if (dateStr) suffix = ` (${dateStr})`;
                            break;
                            
                        case 'sec_filing':
                            if (filingType && dateStr) suffix = ` (${filingType}, ${dateStr})`;
                            else if (filingType) suffix = ` (${filingType})`;
                            else if (dateStr) suffix = ` (${dateStr})`;
                            break;
                            
                        case 'email':
                            if (source && dateStr) suffix = ` (from ${source}, ${dateStr})`;
                            else if (source) suffix = ` (from ${source})`;
                            else if (dateStr) suffix = ` (${dateStr})`;
                            break;
                            
                        case 'presentation':
                            if (source && dateStr) suffix = ` (${source}, ${dateStr})`;
                            else if (source) suffix = ` (${source})`;
                            else if (dateStr) suffix = ` (${dateStr})`;
                            break;
                            
                        case 'news':
                            if (source && dateStr) suffix = ` (${source}, ${dateStr})`;
                            else if (source) suffix = ` (${source})`;
                            else if (dateStr) suffix = ` (${dateStr})`;
                            break;
                            
                        case 'screenshot':
                        case 'internal_note':
                        default:
                            if (source && dateStr) suffix = ` (${source}, ${dateStr})`;
                            else if (source) suffix = ` (${source})`;
                            else if (dateStr) suffix = ` (${dateStr})`;
                            break;
                    }
                    
                    // Truncate display name if too long (accounting for suffix)
                    const maxLen = 80 - Math.min(suffix.length, 30);
                    if (displayName.length > maxLen) {
                        const cutPoint = displayName.lastIndexOf(' ', maxLen - 3);
                        if (cutPoint > 20) {
                            displayName = displayName.substring(0, cutPoint) + '...';
                        } else {
                            displayName = displayName.substring(0, maxLen - 3) + '...';
                        }
                    }
                    
                    return String(displayName + suffix);
                } catch(e) {
                    console.error('Error in getSmartDocumentName:', e);
                    return String(doc?.filename || 'Document');
                }
            };

            const toggleDocumentHistory = (filename) => {
                setAnalysis(prev => ({
                    ...prev,
                    documentHistory: prev.documentHistory?.map(doc => 
                        doc.filename === filename 
                            ? { ...doc, includeInContext: doc.includeInContext === false ? true : false }
                            : doc
                    )
                }));
            };

            // Update historical document weight
            const updateHistoricalDocWeight = (filename, newWeight) => {
                setAnalysis(prev => ({
                    ...prev,
                    documentHistory: prev.documentHistory?.map(doc => 
                        doc.filename === filename 
                            ? { ...doc, weight: newWeight }
                            : doc
                    )
                }));
            };

            // Update document display name (custom name override)
            const updateDocumentDisplayName = (filename, newDisplayName) => {
                setAnalysis(prev => ({
                    ...prev,
                    documentHistory: prev.documentHistory?.map(doc => 
                        doc.filename === filename 
                            ? { ...doc, displayName: newDisplayName || null }
                            : doc
                    )
                }));
                setEditingDocName(null);
                setEditingDocNameValue('');
            };

            // Start editing a document name
            const startEditingDocName = (doc) => {
                setEditingDocName(doc.filename);
                // Use existing displayName or generate smart name as starting point
                setEditingDocNameValue(doc.displayName || getSmartDocumentName(doc));
            };

            // Cancel editing
            const cancelEditingDocName = () => {
                setEditingDocName(null);
                setEditingDocNameValue('');
            };

            // Get all enabled "weight items" (groups, ungrouped docs, historical) for combined percentage calculation
            const getAllEnabledDocs = () => {
                const groupedDocIds = documentGroups.flatMap(g => g.documentIds);
                
                // Ungrouped new documents only
                const ungroupedNewDocs = documents
                    .filter(d => d.enabled && !groupedDocIds.includes(d.id))
                    .map(d => ({
                        id: d.id,
                        type: 'new',
                        weight: d.weight || 1,
                        filename: d.filename
                    }));
                
                // Groups as single items
                const groupItems = documentGroups
                    .filter(g => g.enabled)
                    .map(g => ({
                        id: g.id,
                        type: 'group',
                        weight: g.weight || 1,
                        filename: g.name,
                        documentIds: g.documentIds
                    }));
                
                // Historical documents
                const histDocs = (analysis?.documentHistory || [])
                    .filter(d => d.includeInContext !== false)
                    .map(d => ({
                        id: d.filename,
                        type: 'historical',
                        weight: d.weight || 1,
                        filename: d.filename
                    }));
                
                return [...groupItems, ...ungroupedNewDocs, ...histDocs];
            };

            // Calculate combined percentages across all weight items
            const getCombinedPercentages = () => {
                const allDocs = getAllEnabledDocs();
                if (allDocs.length === 0) return { new: {}, historical: {}, groups: {} };
                const totalWeight = allDocs.reduce((sum, d) => sum + d.weight, 0);
                if (totalWeight === 0) return { new: {}, historical: {}, groups: {} };
                const newPercentages = {};
                const histPercentages = {};
                const groupPercentages = {};
                allDocs.forEach(doc => {
                    const pct = Math.round((doc.weight / totalWeight) * 100);
                    if (doc.type === 'new') {
                        newPercentages[doc.id] = pct;
                    } else if (doc.type === 'group') {
                        groupPercentages[doc.id] = pct;
                    } else {
                        histPercentages[doc.id] = pct;
                    }
                });
                return { new: newPercentages, historical: histPercentages, groups: groupPercentages };
            };

            // Update percentage for any item (new doc, group, or historical), redistributing to others
            const updateCombinedPercentage = (docId, docType, newPercentage) => {
                const allDocs = getAllEnabledDocs();
                const otherDocs = allDocs.filter(d => !(d.id === docId && d.type === docType));
                
                if (otherDocs.length === 0) return;
                
                const clampedPercentage = Math.max(5, Math.min(95, newPercentage));
                const remainingPercentage = 100 - clampedPercentage;
                
                const otherTotalWeight = otherDocs.reduce((sum, d) => sum + d.weight, 0);
                if (otherTotalWeight === 0) return;
                
                const targetNewWeight = clampedPercentage;
                
                // Calculate all new weights first
                const newWeights = {};
                otherDocs.forEach(doc => {
                    const docShare = doc.weight / otherTotalWeight;
                    newWeights[doc.id] = Math.max(1, docShare * remainingPercentage);
                });
                
                // Batch update ungrouped new documents
                setDocuments(prev => prev.map(doc => {
                    if (docType === 'new' && doc.id === docId) {
                        return { ...doc, weight: targetNewWeight };
                    } else if (newWeights[doc.id] !== undefined) {
                        return { ...doc, weight: newWeights[doc.id] };
                    }
                    return doc;
                }));
                
                // Batch update groups
                setDocumentGroups(prev => prev.map(group => {
                    if (docType === 'group' && group.id === docId) {
                        return { ...group, weight: targetNewWeight };
                    } else if (newWeights[group.id] !== undefined) {
                        return { ...group, weight: newWeights[group.id] };
                    }
                    return group;
                }));
                
                // Batch update historical documents
                setAnalysis(prev => {
                    if (!prev?.documentHistory) return prev;
                    return {
                        ...prev,
                        documentHistory: prev.documentHistory.map(doc => {
                            if (docType === 'historical' && doc.filename === docId) {
                                return { ...doc, weight: targetNewWeight };
                            } else if (newWeights[doc.filename] !== undefined) {
                                return { ...doc, weight: newWeights[doc.filename] };
                            }
                            return doc;
                        })
                    };
                });
            };

            const combinedPercentages = getCombinedPercentages();

            const editAnalysisField = (type, index, field, value) => {
                setAnalysis(prev => {
                    const updated = { ...prev };
                    if (type === 'thesis-summary') {
                        updated.thesis.summary = value;
                    } else if (type === 'thesis-pillar') {
                        updated.thesis.pillars[index][field] = value;
                    } else if (type === 'signpost') {
                        updated.signposts[index][field] = value;
                    } else if (type === 'threat') {
                        updated.threats[index][field] = value;
                    }
                    return updated;
                });
                setEditingItem(null);
            };

            const deleteAnalysisItem = (type, index) => {
                if (!confirm('Delete this item?')) return;
                setAnalysis(prev => {
                    const updated = { ...prev };
                    if (type === 'pillar') {
                        updated.thesis.pillars.splice(index, 1);
                    } else if (type === 'signpost') {
                        updated.signposts.splice(index, 1);
                    } else if (type === 'threat') {
                        updated.threats.splice(index, 1);
                    }
                    return updated;
                });
            };

            const handleDragStart = (e, index) => { setDraggedIndex(index); };
            const handleDragOver = (e) => { e.preventDefault(); };
            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === dropIndex) return;
                const newDocs = [...documents];
                const [draggedDoc] = newDocs.splice(draggedIndex, 1);
                newDocs.splice(dropIndex, 0, draggedDoc);
                setDocuments(newDocs);
                setDraggedIndex(null);
            };

            // Robust retry helper with exponential backoff and longer timeouts
            const fetchWithRetry = async (url, options, maxRetries = 5) => {
                let lastError;
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        if (attempt > 1) {
                            setError(`Processing... Attempt ${attempt}/${maxRetries}`);
                        }
                        
                        const controller = new AbortController();
                        // Longer timeout: 3 minutes for first attempt, 4 min for subsequent
                        const timeout = attempt === 1 ? 180000 : 240000;
                        const timeoutId = setTimeout(() => controller.abort(), timeout);
                        
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            const errorMsg = errorData.error?.message || `Server error: ${response.status}`;
                            // If it's a 502/503/504, retry automatically
                            if ([502, 503, 504].includes(response.status) && attempt < maxRetries) {
                                throw new Error(`Server busy (${response.status})`);
                            }
                            throw new Error(errorMsg);
                        }
                        setError(null);
                        return response;
                    } catch (err) {
                        lastError = err;
                        console.log(`Attempt ${attempt} failed:`, err.message);
                        
                        if (err.name === 'AbortError') {
                            lastError = new Error('Request timed out - server may be processing a large document');
                        }
                        
                        if (attempt < maxRetries) {
                            // Exponential backoff: 3s, 6s, 12s, 24s...
                            const delay = Math.pow(2, attempt) * 1500;
                            setError(`Processing large documents... Retrying in ${Math.round(delay/1000)}s (${attempt}/${maxRetries})`);
                            await new Promise(r => setTimeout(r, delay));
                        }
                    }
                }
                throw lastError;
            };

            const analyze = async () => {
                if (!apiKeySaved) { setError('Set API key'); return; }
                const enabled = documents.filter(d => d.enabled);
                if (!enabled.length && documentGroups.filter(g => g.enabled).length === 0) { 
                    setError('Enable documents'); 
                    return; 
                }
                
                setLoading(true);
                setError(null);

                try {
                    // Load stored documents with full content if updating existing analysis
                    let storedDocsWithContent = [];
                    if (currentTicker && analysis?.documentHistory) {
                        storedDocsWithContent = await loadStoredDocumentsWithContent(currentTicker);
                    }
                    
                    // Combine stored docs with their weights from documentHistory
                    const storedDocsForAnalysis = storedDocsWithContent.map(sd => {
                        const histDoc = analysis?.documentHistory?.find(h => h.filename === sd.filename);
                        return {
                            ...sd,
                            weight: histDoc?.weight || 1,
                            enabled: histDoc?.includeInContext !== false
                        };
                    }).filter(d => d.enabled);
                    
                    // Get grouped document IDs
                    const groupedDocIds = documentGroups.flatMap(g => g.documentIds);
                    
                    // Prepare documents with proper weights
                    // For grouped docs: all docs in group share the group weight
                    // For ungrouped docs: use individual weight
                    const preparedDocs = enabled.map(d => {
                        const group = documentGroups.find(g => g.enabled && g.documentIds.includes(d.id));
                        if (group) {
                            // Document is in an enabled group - use group weight divided among group members
                            const groupDocs = documents.filter(doc => group.documentIds.includes(doc.id) && doc.enabled);
                            return {
                                ...d,
                                weight: group.weight / groupDocs.length,
                                groupName: group.name,
                                isNew: true
                            };
                        } else if (!groupedDocIds.includes(d.id)) {
                            // Ungrouped document
                            return { ...d, isNew: true };
                        }
                        return null; // In a disabled group
                    }).filter(Boolean);
                    
                    // Combine new documents with stored documents
                    const allDocuments = [
                        ...preparedDocs,
                        ...storedDocsForAnalysis.map(d => ({ ...d, isNew: false, enabled: true }))
                    ];
                    
                    // Historical weights for documents we DON'T have stored content for
                    const historicalWeights = (analysis?.documentHistory || [])
                        .filter(d => d.includeInContext !== false)
                        .filter(d => !storedDocsWithContent.find(sd => sd.filename === d.filename))
                        .map(d => ({
                            filename: d.filename,
                            weight: d.weight || 1,
                            type: d.type,
                            date: d.date
                        }));
                    
                    // Prepare weighting configuration
                    const weightingConfig = {
                        mode: weightingMode, // 'simple' or 'advanced'
                        existingAnalysisWeight: weightingMode === 'simple' ? existingAnalysisWeight : null,
                        newDocsWeight: weightingMode === 'simple' ? (100 - existingAnalysisWeight) : null
                    };
                    
                    const response = await fetchWithRetry(`${API_URL}/api/analyze-multi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            apiKey: apiKeySaved, 
                            documents: allDocuments,
                            existingAnalysis: analysis?.documentHistory?.length > 0 ? analysis : null,
                            historicalWeights,
                            weightingConfig
                        })
                    }, 5); // 5 retry attempts for more resilience

                    const data = await response.json();
                    
                    // Get extracted document metadata from Claude
                    const extractedMetadata = data.documentMetadata || [];
                    
                    // Add document metadata to analysis for tracking
                    const docHistory = enabled.map(d => {
                        // Find extracted metadata for this document
                        const extracted = extractedMetadata.find(m => m.filename === d.filename) || {};
                        
                        return {
                            filename: d.filename,
                            type: d.metadata?.type || 'broker_report',
                            date: d.metadata?.date || new Date().toISOString().split('T')[0],
                            weight: d.weight || 1,
                            stored: false, // Will be updated if user saves
                            addedAt: new Date().toISOString(),
                            // Extracted metadata from document content
                            docType: extracted.docType || null,
                            source: extracted.source || null,
                            publishDate: extracted.publishDate || null,
                            authors: extracted.authors || [],
                            title: extracted.title || null,
                            quarter: extracted.quarter || null,
                            filingType: extracted.filingType || null
                        };
                    });
                    
                    // Merge with existing documentHistory if updating
                    const existingDocs = analysis?.documentHistory || [];
                    const mergedDocs = [...existingDocs];
                    
                    // Update existing docs with any newly extracted metadata
                    for (const existingDoc of mergedDocs) {
                        const extracted = extractedMetadata.find(m => m.filename === existingDoc.filename);
                        if (extracted) {
                            existingDoc.docType = extracted.docType || existingDoc.docType;
                            existingDoc.source = extracted.source || existingDoc.source;
                            existingDoc.publishDate = extracted.publishDate || existingDoc.publishDate;
                            existingDoc.authors = extracted.authors || existingDoc.authors || [];
                            existingDoc.title = extracted.title || existingDoc.title;
                            existingDoc.quarter = extracted.quarter || existingDoc.quarter;
                            existingDoc.filingType = extracted.filingType || existingDoc.filingType;
                        }
                    }
                    
                    // Add new docs that aren't already in history (by filename)
                    for (const newDoc of docHistory) {
                        const existingIdx = mergedDocs.findIndex(d => d.filename === newDoc.filename);
                        if (existingIdx >= 0) {
                            // Update existing doc's weight and metadata but keep stored status
                            mergedDocs[existingIdx] = { 
                                ...mergedDocs[existingIdx], 
                                weight: newDoc.weight,
                                docType: newDoc.docType || mergedDocs[existingIdx].docType,
                                source: newDoc.source || mergedDocs[existingIdx].source,
                                publishDate: newDoc.publishDate || mergedDocs[existingIdx].publishDate,
                                authors: newDoc.authors?.length ? newDoc.authors : mergedDocs[existingIdx].authors,
                                title: newDoc.title || mergedDocs[existingIdx].title,
                                quarter: newDoc.quarter || mergedDocs[existingIdx].quarter,
                                filingType: newDoc.filingType || mergedDocs[existingIdx].filingType
                            };
                        } else {
                            mergedDocs.push(newDoc);
                        }
                    }
                    
                    // Mark stored docs
                    const storedFilenames = storedDocuments.map(d => d.filename);
                    const finalDocs = mergedDocs.map(d => ({
                        ...d,
                        stored: storedFilenames.includes(d.filename)
                    }));
                    
                    // Preserve existing history and add current version to it
                    const existingHistory = analysis?.history || [];
                    let updatedHistory = [...existingHistory];
                    
                    // If updating existing analysis, save current version to history
                    if (analysis?.thesis || analysis?.signposts || analysis?.threats) {
                        updatedHistory.push({
                            timestamp: analysis.updatedAt || new Date().toISOString(),
                            thesis: analysis.thesis,
                            signposts: analysis.signposts,
                            threats: analysis.threats
                        });
                        // Keep only last 20 versions
                        updatedHistory = updatedHistory.slice(-20);
                    }
                    
                    setAnalysis({
                        ...data.analysis,
                        documentHistory: finalDocs,
                        history: updatedHistory
                    });
                    setChanges(data.changes || []);
                    setExpanded({ thesis: true, signposts: true, threats: true, changes: true });
                    setShowSaveDialog(true);
                    setShowDocumentManager(false);
                    setError(null);
                    
                    // Auto-save new documents to storage if we have a ticker
                    if (data.analysis?.ticker && enabled.length > 0) {
                        const docsToSave = enabled.map(d => ({
                            filename: d.filename,
                            fileData: d.fileData,
                            fileType: d.fileType,
                            mimeType: d.mimeType,
                            metadata: d.metadata
                        }));
                        const savedCount = await saveDocumentsToStorage(data.analysis.ticker, docsToSave);
                        if (savedCount > 0) {
                            console.log(`Saved ${savedCount} documents to storage`);
                            // Update stored status in document history
                            setAnalysis(prev => ({
                                ...prev,
                                documentHistory: prev.documentHistory?.map(d => ({
                                    ...d,
                                    stored: enabled.some(e => e.filename === d.filename) || d.stored
                                }))
                            }));
                        }
                    }
                } catch (err) {
                    setError(`Analysis failed: ${err.message}. Try with fewer or smaller documents.`);
                } finally {
                    setLoading(false);
                }
            };

            const exportMD = () => {
                if (!analysis) return;
                const md = `# ${analysis.company} (${analysis.ticker})\n\n## Investment Thesis\n${analysis.thesis?.summary}\n\n${analysis.thesis?.pillars?.map((p,i) => `### ${i+1}. ${p.title}\n${p.description}`).join('\n\n')}`;
                const blob = new Blob([md], { type: 'text/markdown' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${analysis.ticker}_analysis.md`;
                a.click();
            };

            const sendEmail = async () => {
                if (!analysis || !emailData.email) {
                    setError('Enter email address');
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    // Generate clean HTML email with consistent black text and sizing
                    const cleanText = (text) => {
                        if (!text) return '';
                        if (typeof text !== 'string') return safeStr(text);
                        return text
                            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                            .replace(/\n/g, '<br>');
                    };
                    
                    let emailBody = `
<html>
<body style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #000000; max-width: 700px; margin: 0 auto;">
    <p style="font-size: 14px; color: #000000; margin-bottom: 5px;"><strong>${analysis.ticker} - ${analysis.company}</strong></p>
    <hr style="border: none; border-top: 1px solid #000000; margin: 10px 0 20px 0;">
    
    <p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>1. Investment Thesis</strong></p>
    <p style="font-size: 14px; color: #000000; margin: 0 0 15px 0;">${cleanText(analysis.thesis?.summary || '')}</p>
    
    <ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">
`;
                    // Add thesis pillars
                    safeArray(analysis.thesis?.pillars).forEach(p => {
                        emailBody += `<li style="font-size: 14px; color: #000000; margin-bottom: 12px;"><strong>${safeStr(p.title, '')}:</strong> ${cleanText(safeStr(p.description, ''))}</li>\n`;
                    });
                    
                    emailBody += `</ul>
    
    <p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>2. Signposts</strong></p>
    <ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">
`;
                    // Add signposts
                    safeArray(analysis.signposts).forEach(s => {
                        const metric = safeStr(s.metric || s.signpost, '');
                        const target = safeStr(s.target || s.target_value, '');
                        const timeframe = safeStr(s.timeframe, '');
                        let signpostText = `<strong>${metric}</strong>`;
                        if (target) signpostText += ` - Target: ${target}`;
                        if (timeframe) signpostText += ` (${timeframe})`;
                        if (s.rationale) signpostText += `<br><span style="color: #000000;">${cleanText(safeStr(s.rationale, ''))}</span>`;
                        emailBody += `<li style="font-size: 14px; color: #000000; margin-bottom: 12px;">${signpostText}</li>\n`;
                    });
                    
                    emailBody += `</ul>
    
    <p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>3. Thesis Threats</strong></p>
    <ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">
`;
                    // Add thesis threats with full details
                    safeArray(analysis.threats).forEach(t => {
                        const threat = safeStr(t.threat, '');
                        const likelihood = safeStr(t.likelihood, '');
                        const impact = safeStr(t.impact, '');
                        const watchFor = safeStr(t.triggerPoints || t.watch_for || '', '');
                        const mitigation = safeStr(t.mitigation, '');
                        
                        let threatText = `<strong>${threat}</strong>`;
                        
                        // Add likelihood and impact on same line if available
                        if (likelihood || impact) {
                            let metrics = [];
                            if (likelihood) metrics.push(`Likelihood: ${likelihood}`);
                            if (impact) metrics.push(`Impact: ${impact}`);
                            threatText += `<br><span style="color: #000000;">${metrics.join(' &nbsp;|&nbsp; ')}</span>`;
                        }
                        
                        // Add watch for (trigger points)
                        if (watchFor) {
                            threatText += `<br><span style="color: #000000;">Watch for: ${cleanText(watchFor)}</span>`;
                        }
                        
                        // Add mitigation if different from watchFor
                        if (mitigation && mitigation !== watchFor) {
                            threatText += `<br><span style="color: #000000;">Mitigation: ${cleanText(mitigation)}</span>`;
                        }
                        
                        emailBody += `<li style="font-size: 14px; color: #000000; margin-bottom: 15px;">${threatText}</li>\n`;
                    });
                    
                    emailBody += `</ul>
</body>
</html>`;

                    const response = await fetch(`${API_URL}/api/email-overview`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticker: analysis.ticker,
                            companyName: analysis.company,
                            htmlBody: emailBody,
                            email: emailData.email,
                            customSubject: emailData.customSubject || `Investment Summary: ${analysis.ticker} - ${analysis.company}`,
                            smtpConfig: {
                                use_gmail: emailData.useGmail,
                                gmail_user: emailData.gmailUser,
                                gmail_app_password: emailData.gmailPassword,
                                from_email: emailData.gmailUser || emailData.email
                            }
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Email failed');
                    }

                    // Save credentials to localStorage for next time
                    localStorage.setItem('emailCredentials', JSON.stringify(emailData));

                    setShowEmailDialog(false);
                    alert(`Email sent to ${emailData.email}!`);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            // Quick send email for Portfolio (no dialog)
            const quickSendPortfolioEmail = async () => {
                if (!analysis) {
                    alert('No analysis to email');
                    return;
                }
                
                const saved = localStorage.getItem('emailCredentials');
                if (!saved) {
                    alert('Please set up email credentials first using the Email Options button');
                    setShowEmailDialog(true);
                    return;
                }
                
                let creds;
                try {
                    creds = JSON.parse(saved);
                } catch (e) {
                    alert('Invalid email credentials. Please update using Email Options.');
                    setShowEmailDialog(true);
                    return;
                }
                
                if (!creds.email) {
                    alert('No recipient email saved. Please set up using Email Options.');
                    setShowEmailDialog(true);
                    return;
                }
                
                // Generate email body
                const cleanText = (text) => {
                    if (!text) return '';
                    if (typeof text !== 'string') return safeStr(text);
                    return text
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>');
                };
                
                let emailBody = `
<html>
<body style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #000000; max-width: 700px; margin: 0 auto;">
    <p style="font-size: 14px; color: #000000; margin-bottom: 5px;"><strong>${analysis.ticker} - ${analysis.company}</strong></p>
    <hr style="border: none; border-top: 1px solid #000000; margin: 10px 0 20px 0;">
    
    <p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>1. Investment Thesis</strong></p>
    <p style="font-size: 14px; color: #000000; margin: 0 0 15px 0;">${cleanText(analysis.thesis?.summary || '')}</p>
    
    <ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">
`;
                safeArray(analysis.thesis?.pillars).forEach(p => {
                    emailBody += `<li style="font-size: 14px; color: #000000; margin-bottom: 12px;"><strong>${safeStr(p.title, '')}:</strong> ${cleanText(safeStr(p.description, ''))}</li>\n`;
                });
                
                emailBody += `</ul>
    
    <p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>2. Signposts</strong></p>
    <ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">
`;
                safeArray(analysis.signposts).forEach(s => {
                    const metric = safeStr(s.metric || s.signpost, '');
                    const target = safeStr(s.target || s.target_value, '');
                    const timeframe = safeStr(s.timeframe, '');
                    let signpostText = `<strong>${metric}</strong>`;
                    if (target) signpostText += ` - Target: ${target}`;
                    if (timeframe) signpostText += ` (${timeframe})`;
                    if (s.rationale) signpostText += `<br><span style="color: #000000;">${cleanText(safeStr(s.rationale, ''))}</span>`;
                    emailBody += `<li style="font-size: 14px; color: #000000; margin-bottom: 12px;">${signpostText}</li>\n`;
                });
                
                emailBody += `</ul>
    
    <p style="font-size: 14px; color: #000000; margin-bottom: 15px;"><strong>3. Thesis Threats</strong></p>
    <ul style="margin: 0 0 20px 20px; padding: 0; color: #000000;">
`;
                safeArray(analysis.threats).forEach(t => {
                    const threat = safeStr(t.threat, '');
                    const likelihood = safeStr(t.likelihood, '');
                    const impact = safeStr(t.impact, '');
                    const watchFor = safeStr(t.triggerPoints || t.watch_for || '', '');
                    const mitigation = safeStr(t.mitigation, '');
                    
                    let threatText = `<strong>${threat}</strong>`;
                    if (likelihood || impact) {
                        let metrics = [];
                        if (likelihood) metrics.push(`Likelihood: ${likelihood}`);
                        if (impact) metrics.push(`Impact: ${impact}`);
                        threatText += `<br><span style="color: #000000;">${metrics.join(' &nbsp;|&nbsp; ')}</span>`;
                    }
                    if (watchFor) {
                        threatText += `<br><span style="color: #000000;">Watch for: ${cleanText(watchFor)}</span>`;
                    }
                    if (mitigation && mitigation !== watchFor) {
                        threatText += `<br><span style="color: #000000;">Mitigation: ${cleanText(mitigation)}</span>`;
                    }
                    emailBody += `<li style="font-size: 14px; color: #000000; margin-bottom: 15px;">${threatText}</li>\n`;
                });
                
                emailBody += `</ul>
</body>
</html>`;

                try {
                    const response = await fetch(`${API_URL}/api/email-overview`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticker: analysis.ticker,
                            companyName: analysis.company,
                            htmlBody: emailBody,
                            email: creds.email,
                            customSubject: `Investment Summary: ${analysis.ticker} - ${analysis.company}`,
                            smtpConfig: {
                                use_gmail: creds.useGmail,
                                gmail_user: creds.gmailUser,
                                gmail_app_password: creds.gmailPassword,
                                from_email: creds.gmailUser || creds.email
                            }
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Email failed');
                    }

                    alert(`Email sent to ${creds.email}!`);
                } catch (err) {
                    alert('Failed to send email: ' + err.message);
                }
            };

            // Get filtered stocks based on search input
            const getFilteredStocks = (searchTerm, stockList) => {
                if (!searchTerm || searchTerm.length === 0) return [];
                const term = searchTerm.toUpperCase();
                return stockList.filter(s => {
                    const ticker = safeStr(s.ticker).toUpperCase();
                    const company = safeStr(s.company || s.companyName || '').toUpperCase();
                    return ticker.includes(term) || company.includes(term);
                }).slice(0, 8); // Limit to 8 suggestions
            };

            // Handle stock search selection
            const handleStockSearchSelect = (ticker, isOverview = false) => {
                if (isOverview) {
                    setCurrentOverviewTicker(ticker);
                } else {
                    loadAnalysis(ticker);
                }
                setStockSearch('');
            };

            const enabled = documents.filter(d => d.enabled).length;

            return (
                <>
                    {/* Splash Screen */}
                    {showSplash && (
                        <div 
                            className={`fixed inset-0 z-[100] flex items-center justify-center bg-[#111c2f] transition-opacity duration-500 ${splashFading ? 'opacity-0' : 'opacity-100'}`}
                        >
                            <div className="flex flex-col items-center">
                                <img 
                                    src="data:image/webp;base64,UklGRlAnAABXRUJQVlA4WAoAAAAgAAAA/wEA/wEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggYiUAABCxAJ0BKgACAAI+USiSRqOioaEjFOhocAoJZW78Y9bhqrLNyS8VRbooNnR9H/XvTMr7+L/sX9//6n959t3o15F/d/2M9V3yH9F/6n9l/y/vl/vP6l+53zAv199dPoH/7HoA/bP90vdP/3f7P+7P9vfYL/l3+c//PY7ehl+7/q3f9n93fiY/cH0o///rYDGP8D/Yu879W/ifzC50/W3mj/GvuR+i/sH7s/HDs34Av4//Sd2VAB/Fft94QX+N6EfYj/p+4B/Mv69/0PWL/jeFP+A/6XsAf0P+8fsf7CX1X5/fpb9sPgX/Y304fX1+8vs5h+Pa/ICqi7ZkIrAtfkBVRdsyEVgWvyAqou2ZCKwLX2MOT4qUkSffYahfppPuOainxffVWRWU84uhzTNDtEtQFIiK4R5VcSKY8QBHD+iQC//sm+CmAL0u4xRpXCnaGUpVVDTLz7xhouXQDcRhC9N6RwU/AO/8eQjUh54wMWYCt8HaUs2+Sj1AYCMw1AAOyAkaNdJiWusBDnin5ONXYMHqJvF69mpvoL2q8zsIIvgpCn6AW5Y7MlqdY/7ade0d4w9hksYyIfdfoj+46Fr4GEhbldqmi/+swoPyllMo4UPgg9pO1eDi23KFOn8Tb9ROHG7sGNYZGnMo+sKKZIRMyYYicDsFAI4sS0ROfIvjP/dJEztmXSadyIutC+IUZup8X7CkfnMa7i0uGaAAwJy6vKdYjRCIhA5AfZv4DaZ+XagfWzXbSXzARqJXIv0hXw5SObjjFu9NbFI3ML7172qE4qHqBxBnOoc1BaXPuyLeVHFVbn9TF7ORlRCP43JFGCg4QOM1vemfNuhgSfOvSEyAgM+LDdbO5CFqVe3kEGr1BDCk7sP9wkojJUTr/vopmBWb5zueTTOIUmv/fF6D9kBns+pH/5Eh0ucPFjp5weWYTZTfGrprKGfcgSCqp+wSJt7MP6qb9TObfNM9mEXDnXgpREiO9z4PaLglRChGlIhPM1tU8ljfIGRr4dUkTNHj0J692YPp6CUMEgrFJf+j0xE8XmLrz/+DAUUIjMZd3ZFd3DsRqIF2GSZKbbVIIfhzoVeKF/ohTqamBf12TLOeTVlEN7PMXZWVKov/oAGNswmNqSEDcqxZF5BcbsyWfupfpNJxpuNKIvqzz1oFBdzpuFGhbl+Gq+oKuxChtbGWkdpb6cQVYdIJF260XaQbELt8vBLS28bln0J7qKhu4CXpk0sMxygDzUTvFigLPPTgRz80wk9dG8Al9Nt8xIe+q7KnRIuivdqFLBtxDT1oA0bs3kb+yKPXvuow75kTC75yHYY19neW0wuJjry70/CRzPQLzwwbwPkdgGygDc552sQvIoU/lNBoTW2D9xs/QQmCWcNCK13OOWVGtWAFOvchRLf6Fwxemk9N//agTCpmbFoZgYu8DXhiXqPagtoJJIW54qNtm0S2/IozFmaf5WGA7dPycqR1n52prt1ssBuDfN0QGnKYz9qnY0hrMYx9+cBoIg6a+KCUmZhXzSMmF8Y3kdk01SY3A2LL5Z0pLaftDGqAj7w3T1mI8OH9fB30ihDRlnR4RaS/jo3ByjjW9r30M/pitL/2ehHZWxFJs39bQMz5PNqJ+ZoaJJ8iC3FG/p0UyywSF01UGot5WQPTeXdWyB4uTxp0yCcsnxoR2V6fIzncvP2raUzVSID1EatMo6eiwdjZ9QHu3xNiu4jaPFF1CcmOD26YNiu+ktwrBJcglP0JW7llhWmwARSUxJ38SZDRr7ogIaKRVpr5VFmJQpZeuBGpzQZxztcHYRYHuzRh/uF08R0Zh4sNW6oBxMxMI8GgEnxtk5iIMiyeFbFudSXZnpAiOvy0iQfcdJEySwLX5AVUXbMhFYFr8gKqLtmQisC1+QFVF2zIRWBZAAD+/cbPmuO7J2vkNJmzwAAAAAAAAAAAAAABBaKXZoN22QlKdAatlgXwGsvBbDBh54M8GcEXMbPJePzdd9ev+77levb3Yo8oguoAgUR9O+1dLCRBEtk6GINvHzeFdO/OJfTEiUizEe03n1dZz4uqDwcaJK5zTKQYLPsaWGEmrQyFpB9WUus9ROfiQq+BbzC54tkq7Qh1Tt/PhzpsPit6bf5852gM/35/9RwOaJi3r0YPJbgGfahwI6fMeNl9etR0viKhkcdfil63cxH5w0ZScHEmUJw/kDX4GmVUlfpMGSoS+NTrK+KlwD8S2HkSmp8RUvMxrdARwgdrCJJ+t6i32kRPjMg32xuzj2BulDTaKC7YPEG2GImd/hZACvIgQrNX+cC9Q8upBVvhTlZsOrvH4nrkwNrGuvch0xnY5ATvfNCx3CH5dLymhK3rwBtdqXHyXm3Q2eQ+lX/j5L0YZtkCFFIs5Ffbh6dOtLn1akms+pDlVpGvCu5hP7iuGrgy1SnZieuxJGxkEuKi0Eq6BFXMgO0PhmkACNDfxO+bjShTbnwsKkz00RZudd+ak8t/nPi7MvrljCFjZaqEaVP/40sNFM9P/k5fo3hho1jqtK9tCd1lp+p85uS1RSHrmD8qJRYZHXBCULr4f/6LrFbIlVzXLbi63P0GOUnXSoOHvF4iT+cDRXeX4f6Emp5KCD8TTyAb8F+nH5nFnkXh98BQ0mGgxSyPoXqkNdZwpkBZb1/37h1nLIen+jsflx+n8HUNMdD/tLA1EYw9xLjKNuZpRR4hm9DcnsDFmLhh+QtPgxb8C+JLCFh++x8Y3HU6RQviP8heyY5wZCQCdQ4+nVHPQELtxOI6dtA6Ed5Li2HrJ4GlheOQq93+NQUiVhgK2B5v9A+uS/p8dD+/v6Nmgx/O2Rfciz9qsXRHVev5HUqhVJM+L76DkkpBbfuBHJQ+5sLJbVptNvaZ8aEoRnytpn8zqsGebmuFEk/0wqG6rCB+eYAckmLIPWRmY9llRf0SIY4Tp3OJRIV3M7wobJS49TiwOoPcfSH06Dmy49xKxoHRR1VjCG5cS/s1kgiBkv39shILlmXi3Ab7WCIkFiawuhaNMBiABuvGMKbZMRc52rkXhfoADIJTMrtyP7oVbD/HCNoyix4KqrdHpiAhHwB0UzY+lEm2IlrI/TI8hdBs4MSNUE8RdfN3t+lBrNux9iR2p8tFUUGJUDkv9+bptRtmFtX6dRp3RbtgiJkadHJ6o2Ne7gxDk3cqik1JaX8kUKd6nDpzBfnSN/uM+gLPDPTuD9xzuBQhDYT6ok7M2ngqdgeBPwRwWgGf/wmG6qq1Q1oyWqLD4C+VbTpbSusJQbJmnmWm8foB2QagbMs6kBwlXH7WluTMqcb32C2puCigMENH9vdHyCK55dXyEOxBHQTDkxtI2Ve2t5yZ0LaxXyBi//lFe/20fJbeAcXjJiydPlM4jUOZH5LpRiDiyj6++msgU/XFK7hQ+6JcL56yRw3I6qNve7QP401YrL0yIxc3ryMyoKfOzcXFjFCTtZnpIvC3LyNDC8jcx0qezpHpXmv6WBnqx4+V3zFQZKcRIVI952QG2OgkFRAkqeCGYyLa5I4EJhihtPRp4UteXllF+4Syx99StIUg5bHz+eg7ZnIFf3IqfQkl3INKBRPYf3LiInyqcxNd5FBj9WDzCKLea0TlKs28w7VrUWVrg1oy2To1+xnnwAuIgo44A3Z8lUb8xAW/ytPS383qyNNiF/orJp09n7H4DR88A/Wpjo39KIOZfZreEy7BCEnAMdRo4NbozEGKrgtZP2jq+KHnw0nLrvwwku3/dScDkyID4Ho+FaQstWVLZmRycW5/z8zYjX5J7MDcSBLY61JQDFX3ykYL3tt18TEi5GwEWwU8ZDd2z5dfxJtG3HbhnHZhv9qBRfLtmpuAsxYsKFqr1fL5AFHll83vVT+E5d/HPHUn5QQaYQfPezNThJ3S1S7AIqP7zsAEE6D8Z1v2N4lCS11/ClXEYgMz51rdv5tGt6IcCYaRIB7lLrR2DQ/UKMECrlt/Ne4X6Ha8VwxAm6IzFpDt19y8W6/Q1/YoypoKk189ot5OdK9O0jggZGFzLu4pF1zBdHoN5dOhP1rWE7yRI0qU3MFqaRUuiEtkvRqAFS/ytSWXB43ZUs7mz2s7HiDZW4VNzkj/Vl1U2foynEzu5EpRkX+HWCvg79obqHOHefQ4jdMlN0puqwsJquot4k08gTmIF4ZtDglEPznbvPZBfJiEwGBAjHzRjEUZTfSLD82NbPSGGHUz0qJFN2vDMeD9cMvyI3szYVgOr/rg4GOevmexKqFfvjItGmZEW1pIyIUwdtB8XlDGq7rBDXxLPOCZjDC9ywU8Hzwd3oHmI4CBeU+AXnaPk8xIvM32w2mzmI/gWF6LmH3AxHeCg7Ml05iI8ic3BqOARoLv6Cf0qyPXmtvZ/xdOzdrVSehRBxBJYYW7gAGGr/Rkh/8bEjL6FVJsiAWR9Ya95gpPVH5v9R5erxlQoE3xRNdjuWg+ZTIZoww/eV6cfEJ6236hXD2ujBL5a/Sg97APcrWWHWGpWK8NcDfy68A+kSsj0eykjy1hxzX3LxZ7ap1KPm0PpCHVZi+xcDLvUce3K/QMIlS1Lnv0OlY1Npzt8rio/k5VPcZFHQQzpKbMZEOfJB+W6ttLOIlg40HXiH7oZf/yof6VbmYOumSsspIg1XShj/SnDLGJuE+I35c+kOpaTMvTz2fHkJT8dirG6viEf7D1MRX9RHkiKyyV0xuakUKd18qpSZiwcF/6IUTytAPGEe33HUr4I+qTqfkcevEPLWpHtXk7gyIexfgqywOTNJSE1OxSLOM3pqD++S1qN1u58ZOqaUuYbRtMBguGS7L6jHV+1Uyb7reWOiWHloVsL6Ie0wCSrYGz6ZO2qIIYJENxCswnWuX/rTRtJMQRj/Dw8GOdi2PqIhDvuBx+Mz2kFb/RgGirLRgFp/kpeHMU0N+9o8LCz7uW8mjo9//BVFHQeL4UE32dBCEfb2xU3TYxTp9hRQW5wkxpX/jKijW+M8+YpSsGf4lC5HlRcVC3OZn6y2UxWLS+u+3+zqhBl+J2DWFWTFvINAMF5GMtvUoJA9DYZw84422dVSgwdbLAJAe8CWKxiY4gXUv8dr3jkYrXrtNNuH3xl+voFJP848DzpTL6ODvq8SOfmOdnyG94V5TXAcrVRh+4shQEV3mDMgm3oKyPh8eHVDDHNulZf/PnlyHmYgzkEDGV4iBkgdz03nlAvDyiuc+b5VhR9l2JXPK+6zmt+bwOdjrhcm55u/+uHRmznDUd0mSQvhhxSHngWSuxnalmvPNMqjRDBTiLVyAKCfmDaLrm0k0sY0hvuG2fYFWuuD9RZBdhtqHNeOhegiZczj+wSkU3vju6xM/ZJS+Lx2GfZPiGGRBKvfjWtV2j3csZh26p4olTwLoyjYcjdHpQA8ZccLApIcJ1CFaczA6bqUH9hodThd9HsWzXPrCMnL8hGsRaUkFTYBphmp+FPhgTf7vLxFoY/Tf+OmzWmIv2riDiIDpvP0CAYLtSY/JKHNaJC/nnBX+h7Vv/ZUBPm71++32emfF3JlNLdB9kThVS9wtjJl7bUdazRBKDE5Sph43UYBmSreqMwqEXZQxLCnD1fThYt3SsonPmstRj4OpmE8X/fhfhiGSlI334zEiR5qwihTjeG1MVy7DbiHmyhnNfIXrsRzRL6/d460A5ug0/+ujV5IZ1n3+SfzOBTv/z5lSMeL6bDAnA98eJV3GvOo8b9x6blx83lquzzgfhhtaa2QPa3SgO+PuACmBZ/wce1gZo18yxJ5I0wfCyFeGBfWlzU48+XpXWkZOcjESch2AzkW1X9p8RwxuxCB/QubD9V2auVsQ/9r/dodf+fA87lOLKqAaLzlSJTHK/lj3sTsmFQVGGw3GBAQvTWmT0Ev20O480KFa38esrAhWbfFgWL9ORdC8Po41HwKmCraqzkKWoHY//4NzzgwGwOiQd1fdDaaCojByB/KxzMLQcyPpF6oyoDhhVHfuXCcuh2vr07L3zDW/m+qxwEMlmyCKmjGTpJfSLIQjD1AIlVBxmc58Kk7xMlc5ke0Wlnr5YGoJz3VuuNWf/g/1VIDRBS5gT5QvtDsyEh7Zzgyp7tkFe9/FhYDDFU2nahe9Q3QUydzPJ95BB+2diK4WA9oPpNlVhqjkyusSi/kXbvfRJNwwt+kXsKvQMD3xWiLXoNT1ZmjxJ2B46A7yMKTwDuL+hG33K39bFaGExeCZzgXi5sQ6uK4aYAKe7VeViQEqLGVPeiqIrPlVSnA/4VD+urravLys2rO9l2vtL2yJ5WS7UgErIPi63Oc7gjW6sduQa17XnAUcu/xd7Y2W5Nz8WNSxRzPXtSiVS0lcmIOowlT79DTv1Pxq3pWq6DEQP12bwZDa/h2+SUCvOaTqxVWzOF0PF3dLl9OpiKp5DLBqAg0MOZv++vDk7onb43MrNP65j31C+2Ntbw+vty5cjS39Oz1o2W8NQDg0/37rd0oDM9+Xb9ANhk4Whbqrt9x5TWlIV9zrQxJETZX5qy2pV90i/mKYbn/ZeBYBxG9+NBVWc5rI/pb6H0CDKxHwia4SA850rcsw3mmwdnHEKqbng5IPLDT240AhtztXLfvmZSJmBYLnxlxInGniK4TPGflQKhjOnt35dKRQ6MOf1wmcPs7JQaljsQa1StYFqN6bezhFavz2Rm4st1jmifPaellHAmm5o4w2hfbj8KEyExSl4jUh4jmsO1Umk5Fwzyjb31CAFGIJiM5KJTl324VKIj0TmfR1yE27Otr5DMEu4YJKjmm1daIAn5AdLYoaGJKub3SHCW6QLfcrT1b9g5pc/mioO1TgeE1LUwt836DVubG7pK/4LfhtpgwrY3/pVgdbmDKxNjxNMjbAv30s89YiyaOElyPyqci8kxBd0InNvWSBV5FskmkogH3JpIZFlkJHcyUY9Lx1rgk9kaaKlGB7zXmORY/zNikbldJ2w8WsenhrDPtXTPeEWQPftnjWqLxNV2XMw6AtUC1mnrQ0N3S2qabm04hdfmiSlEl7L8IP+3loP7aPpNJ/SBtPiqBX4oFsNjnrkeD/p5LviLaleNEfhslijlFzqytLjtXPCSpk5kjqujs7G4TysHMKD+Ot8DqBbHyorwiEIiNvLgSTXxY9yaa8kEU08Y35wYQDHy/8p00qh1qY0g5PSt8ze7RzRsO8m7pTr4K1DPzjB5pv0gnuKJHAETgBk7HgmoNCudmmMff5M7K6ylA5nnhOg2RfR3k3MiTpJoWJf8KhD1KuY85hDju7qWgYfcrtBzjnwFbuuCrodkmfvn92Iu6j9I4DuW2oa4nEc0xZmcQ3eIdkjlSp+ta291twWofgPXUicGYpXxNh0B/ih6LhLSbMi0VC3S8DQ6NfFTohPnAHIHHYgzOX7mCFn8mQMCAsR1opaxsPzTQD5lJ9T40kU3mQCpvkI7YrfeNljnZ/MFGBkN5lSKnJjeyvW6xP3XbfAuO6kQeLyKE1/51Fw09JmVvEROVt19ErTTXM9L9Gf3u+gWneBhsermnFk8KkABHjC5TtifQs0nPKewhgnAsijCILuDjcAzk4M2Ca7ihyTqiSWJXweExEb6nCXbF+s1TDAaBL1tabnQZWxwoeInDNrItIG8NwyHlOZnq3ZHr+QEgZf8W2So/83xfWtpOIijALLemidDTp+N6G/I9rGHOP4AcMmf6jnbQrGFpb9d/skwYkHNzWWaTYRQZ1bg4/G0NiZ0U2P6/GGUVP9QxTb4TjRxUgZ9GSBTbz1XRrDDD9vlr+5q42/0RBTrhPM7tV7SIH10GLCeQ5k/0Dy45zdnVcBePhdDffaCCKEIafNN6K6Y/0xqvv/ZRiE7J8blROWYuxQ+Jk+TbS3Tp1r+YD6XyW0I+V8tguCYAN3yQg1nvzhsszrVQf/wSbRuMfTpJqTtyShpTjuMvouUEzf2S3yBL0z/TY1iGJWJdtgxRfzC5CSnhfY/cb1SMcjhsSUzUVxL2/pg5hAHyA3WyKmesYWZYlbW0w0WiB1uYvS5Bx0QadCs0uyoE0uc45Tjj+ceZaW81xArEiFYTwhro+Lk1uxnnIwDK66PbeqY7kEOTffGrTyWyB0an76Z14pEOlK8h55KldLmIoBbMFMCUsI4+DJh1fi+t+rBTr9KdLDnlANUvHmoojUO5kVPpqABQaVt/j4vH5KShfgFVXXJIsmjlHLuc01VoQKcNlKtQ2yMziur1jnFiHliLvqWdIj26bHG709Bq8P8uhDmi+I+FRWS3Mt26bRbya0+liNN9MSTD13ty97LbTyGtu37svstXWlTID3DHNXMl8yQYsR+wtdh8ipYs91ygCdAQ18skwCXj7IIiSfz7vzoaDgKrtO4SQHgwvRIZk6y2AraLgGCEAJAC4QM9PE41NjT83qraEbPFKtfzknCiE85QYnTv5fFXKMfvG0KdF3LIARvIprKzos6dUDZ5ivjo6OYPh+GwxVOM4EA/ZEqCs1GXULFiOkYMa623Kx1Pvko2h66wFsM4ryrfBVuZ3XdD5aNT1gysCaxa87yrOgDIWFbabBpu9bkB0IqYgJQC9fhVeUY/b2X4m93+BHSEGsA/2xccV0bW3Bu1A0X9z7EAgp7/y8i/vK4Rjmhdr2sc+wJhyX53Snst/RJkWzUWx9x1WQi1NzrXgIqDwX4oyiMPCw9sNA2lXZcKqu8n47KG9r4kWMz5lFdW+13VRHbuZ90aIU6n+wRV6J6RUyTs9B1k0yljvZ0bI6hyQ7ICS1tDlRGAJROM/Sioy5LaKQvHDZfeed0MJZ3DcgXN6vzQdcU5jf+Emtij7+rokz0THtTqXbPMuc6uaiKoB3lv+lzFuSogimV5qH1+h1wlgKxe3t3WEmO03NGUI7ZOjeQ4GqpgHM5UmkKs4rqNZSzb20ig+0pb6Cqdt8dA01/kD1r+VxaLNjw5ZjomSEthZMsGATQ29COGcOzEZCJ1cQz59T7fqn0K8WaUYkSUMx5oCz5cFMGFW+jI1fOJKAGS1NZGq0TslHo/7UE9Fxwlzz8SyLdA03yIBFqaDI7l6JiAJyd7m6ROjFuUWU5dxAYyOER+nVjQdX9nCtHgN4q31b8eK5j9p/7cmwF0ZZeBIpidrkYwm02KVD88gIW79l3ktgqcJLwIA2ocdY4NpRkeurh05JVcOu4p9ZZMQJ6BXQhCelZkW2qt6uTMA7JA9HPNJAG9SFMaVSKERl5Gx8S2tlHhMlKfFMZexmVqKoS7J6OOD2AdnaQiJRaq8Cn2bUx8nBv/agDVs8slcm167l/+WB2iVVN9FKQYMLkAmuufqcU5RgCZ7YtUVhrpD5YuZDjo8cud7Q4Ud9Gc8eqWyEZrjaFOkTxo7i2by74AqDgSsLVVhYfFUAF9vGhbV0dFpUhLv6nDEt0sDpagMwtNz62v3DDfgGXtwAy2dNEYcUYnaOkSJm70XVMEzea7exVTOqeFZwse/1wlmTGeShgh5bBCdxpFIsqT1PxxryVd97DAe+2kPq3QrxNJiR0KRvoQIruNls0I3NoPIDPxIz3GAwJXBWgReIg99ZHP42anNL0jhlironU6nODnrNHLUo8yoqe/wVuDOEKruBij48hRg/6fhv8lI4im93LbTKQHeWPT8m8FuMLNtiY6BDAkoxLPP18WlFVK/p1qNkfvoRdsaVzQi3s9kGhSKh+bUCJ1B7l2ge4xqf93eZwviRMuUqtFt3REQeVqbPeIMcjdRDSBZXJGndMbRWAlmk+RPmbGW2iVL/AXfIG6ZoKGDGFD4wX+RwRVv2cq4VIGHnx3fzfKZ6tL34Y/R+wBHjGDmiCXBoEA+XIPH9eCpT4X9VwCvZTTOHbJxaS6t3MfJSg1WGzo84iTF/ie4b6eyFRIjYSGlVmhYqNew+JTH9GthV5B73iu56hA4232zfxOCsuXPSkGqUaokFf96qktWgZLEouOOZBVrPtSDAvKCF+ikSG2SBmrxavfuWrNmBRgonODMPdDvoR5aouTUSJgCQgxuVYVTeqBiwm5LY9Z1mxJ53Xp7QAzriJ7CeXMv8FGdqsRN6sWjhqrQuKNfJSTUZC8URjULlENq00tIfv69DzHiR0eT7yY4K5aII21dM6DeL3dh1V5lh5mJrrdaSYywlm8NzbH/d4cMYDn9Zot9uMpbIiHW/nGWf1f3j+bHP4ZPUaRnQjZ3fNno+O9pwzewFK0ZNwIkmtTXCc6Qk/TYu5mG4Lss+WJfVrqstBga78Na9qYUqryL9Pt6Tw4VEvF1OcBFNFZ2WQjmt2WFTIfqi4d9vC8S8Y4UOYBJDPK8MUyBwz/N1ox9HRBQQzqObJZbE5PB0ZBLffNU4NO/55NXZALD2edzI0kU0k0N7wSBmZVXJLdyOuCyjrINQSPLVk+FwUz/LflH7UYnpIW9zqV1/4ZPbEmPBqOS6QWLSRuPIwGzpesU9apoH7/rnJhGIZQkZ9IbkFB8NKNGv2V3N1kcEps/jckHiyeGw4Mx+QHrqRKy25OTy1fCgCQLvS9y+TJdlkPPxnas7H8iAyKhmxGG9FAPlr+fEeqP7bZKIri+nM1Zqr/2N7rsRBXUOkTsvm7vi470W69YnC9jxzjj4UZNmis1I5jim3CO15CdjkLiqInETZ7FsDJdx11eqlxtmNFnoPyFJXLNB7yEZqEKkp3WNxkcumNH5k+Q/fxg23GtyNq7aPL1vzwj46swQqhtRHh8JNtL4WmBfgeDTvWpxNWweBoLMVM0I0zOq9SXDEQhDPniGN5TZnrcjryFRTSSZnMM+fXWOkhlXV08YbYbni53Ysxbbj7780eJRSYR1AhIKjXUHSHk2Ojs7GJdKFTfBEbugCSlUpLg+iqoOvBPLSwDBfl+vRW2TPRtx6rkMyPeFgLQ638hwPWLyLt05HuwVaQCkhrA/egzAX2q+BcpE3/AhrSY0d6f2zHtoo2dXys2NeJdxd8eyCzSejQxjUmT81hPudSPeFMSYP2tsE2VeOS+JNnGloRChvIOcqrfvMsw8EJ2GiIE+LVtENce2t6/IMe8D2ax07vIsruHqnoG/0kJcpi6I6KIuBE9aZFOPmiikgfO0xJloTK534F6jKPP8BE8oyGBlMB2bFKAg85trotP2VK6bkGiR9xQauH0gxj/FteJWvoQyE6I/tdLpcmv3MNvw395VmAv2b8y0Ad/ebLHp+hIriObGxSqCh9C48tywFBvC3RZpfdwtJyAt3d6FzmCLtr9EKnS4UA/IByROZuj0uBkAq54SvYYrrNiW8KUUG6arEVNVE4S01BhhZvobPo33JIjDIsWJCKQ6GQTENT7HtSi2TaA1jcI98RxsUKmfBn52M16GSfkd4deXr7g8vb8MPhrX1RU2PYULaKXDSxpco6H6LE5rGhPgShCXX3q3+EytvPqfLmJO2THozKB0gSTy3Vw/KaUwGP+l72M0O71DOkJootAwoPmily5A+43r6N6y0sP9k4ykn9fVbH8H+aYeRjkBIwrTNrPAwg3lvNHn4U5yrS9WtBuxEBSlmTGbeKY5qZ4Z0NzuFASIT0LETBjnVVLZPf+4siLtYsnUNHxkar0mfWb/TBWSEc4B2RNtSsgIP7i1tMKJDsNgTaopVUSBq6W6ZfNSUdJLve7Ow8Ag4Mk5SeNjvIjr6nzcsZe2f1j+R7PX6hzoogbD4HMoAB+p08f0Do+4m/lh2W8J4y0bXVvN855eY4dxjPDYu/vN3MEc8A0xL1BCmG8+fnWT+FHuTOU/3NGpJ4ce3Z7n5hT9zDsQasv19do5WUz/b/U/XeFtOXj9j0OETrevQZN6JSNBQZp8c5K95BzZ3sGrzVBXbhWld/RebrV49QbLYfDkweh4midJEv/eUj14ZFHsJWMOjvbdvvGNapwLeIphhZUT5YMSo41k9Di9dqYHOBq69RX2XXQ33ie05p33J+kaMN2URPwfifAZ+du0uB90d1rkyqwkhXSxvN+gVZjWT0Szbvqqf0ZUT5/HetB2wDz6OgKieB7gKyAD4WPz5G8ise8hygS6whNk509eZRBK7ub8N8C+SqjxipD0CHApDQnUWDuBQ06QRvxozDMyPMx2thQDtMBHhV3MN/wTBoZgfkmhqoQbuJv0aL0r5wkPHQuglw0HzssAFo3szxyQ7s2TtQWt8uDawkWU3+quyJBneIhHpq8UP0lGRKNflFhesQjyIAMvMxaHwTGZFlTor9og1d1jH+uUDBR6aLSk6wms+HI4eY02mUkj8Rsl3t92TDbUQlre65/nQnxtET8sKXHKNcZ4i4K4rsDcrMqaq6sJzX8UYhtxy7ZPPIRoqiKNXzmuXv8ZFLUwn3zTvg32e6RYpqZIeU61od4Fj/z5jsXSCzQ38UjhRn/yhKsoOqySe4c9eMc2UYIaDhkbhMOFC2yDky1pBSMfJsWc6IzUxXdTNOVxlAXB00ND2Hp5A9xipWDBfEDtxe/Kuf8vT41wDzVLuKLSKw68kgv0QOk60lZmdeTAg0RfcfG4Tc3zlG+FZi5yjIpJETza7/r7cQLZoG/wzYyebEtF4w9qGlvMC5BeMtO5bEGd7NY7Xt8DD6CRaXq0tVNMZa0RoNJeocEaWdtxpk097YUqVumMjDwxsI491c6Nfb8yId9ZrldnFEBO4CkWdNfpVE4IiNrHiA/scHChqMhMNa6m1Ter6AwBQJY69PfCxIfJ2zjKpqx0dEewLgG8SKZpzOpr8b2p32zUl5ne/L1PpoIF4RrK7IrkExIGNozQVimbq9BLGk/1eNDThi4qGq1+1OSOZpZ2GB1B92KfHb2AQUFx9ewuMa0k3TQMj9aAgDK8MEAAAAAAAAAAAAAAAAAAAAAAAA=="
                                    alt="Charlie"
                                    className="w-72 h-72"
                                />
                            </div>
                        </div>
                    )}
                    
                <div className="flex flex-col h-screen glass-bg-mesh text-slate-100">
                    {/* DESKTOP TOP NAVIGATION - Hidden on mobile */}
                    <nav className="hidden md:flex items-center justify-between px-6 py-3 bg-white/5 backdrop-blur-xl border-b border-white/10">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 rounded-lg flex items-center justify-center overflow-hidden shadow-lg">
                                <img 
                                    src="data:image/webp;base64,UklGRvQIAABXRUJQVlA4WAoAAAAgAAAAfwAAfwAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggBgcAANAhAJ0BKoAAgAA+USaPRiOiISEkG/m4cAoJQBnNCsXngSDbdnU4DbEeYDzdP8P6iPQA/YDrAPQA/bP01vY0/dfKpFw/2joefGmJLtFPtJ974UdrHdnssf63jJ+s39V9Sv8r/0/oh3wlAD8xf9j+y+sj/uf4f8sfZ98+f9f3Df5X/Wv99/bvax9d3opDviBngxaP0szCIP6VhzhMxEhrrZrdQnFIKVxP4Y2bZ3uJxuuyYwP+cKb/znWAEevnx0y6r5hLtJrjLobvesVayarNPtqoXXDbeQHQYq9NKxupvX+jaF/rJBQ930U5GL6JrQYaJTMd/JlhXPobhyN+etsncCFfpRFC4i5CWcnKRQm1ASO9gybWerhYAAD+/M9Esyi+lNosMo30/K/KVr5sRa0WIV8w05TiIqeB0D3qD50ho2ZCsZqQAAHU8lcfBQRf51sGEb3sfR2Q6LjDk6rJZjtbjP5XzakprFrve/d2zxPjbnY2Nod0KwS81cvix5DA+5L/6b4RJNiIEXtiPniRJCCWmz56jE/eSlqrwmOf8XQlUVlb4RB7pjEJiHzPdPeoGSHbOOkvAm6a/3UG99p1NUqY2M3arYdUrFRH+fM+oypJc/U1/34DFp7H3Oul78r0AK2hid6xd8IypehYEY/qvkpTrZWfgaFFI73mZ2tqwWLAp0Fuem+RnKx++44g0hGdMGVNHE/qy/+RXygtGgfgTLhQOqnJ0Fp7gGRxeRKjpP30jQy2bdkU7rxtH2Uo9vr5byZVUCRbk/2bt2TfzoWFj+ksujTW18N8/SvZH/QJXz1ywAq7SVueR8vziFn+3VOA7LS75uONfgq2uNEiA2Ta53RdGZhOIrmyUDq0RtcYqeFhiCCjGFfkvsDoy5W8YEpnCMipixSC2MK3Qras+7U9yWS1dnp4zjP+RO/gEDaF/xKLnyR1XNFW5ZjCyrpmKHQ5Z6ImUC+/iexAXJizJv9G0D+DMJFY06I7jsy3tcm4RnyoggBZBZZmM3dxv69TJDF9YL43rqbaJcQoxVA30tilQGYlmeSHs+ZSfDcjP+yGqddhLdt9heE96Axxde7Hs9jW5sBcXmfu7rb9HmRjPQZEZLxyPBsSc7/H5R37/vxix9O0LlcNZEHRYwyoXFuiR1Tdgy+wMrVdz3WylvgxXW4xaq2p542Dfx2IAYiWmO66s1C0gdv2fqQM8w5iBpIP5wMmcrNw3kIo8pLrvMlblxGPiW0fBAgalbrs1bqIjitQWqf/EQBsyh+8nfr3fZL8vpGOzrR1F0k9+foaLfu2v01FdxbX2H1Ls/+WK9IHQyQy5G+K9KzibC/x22xUf8wpOmnwltd8XbdZP7fj+55Q5FiOGmS11GRnVmoxiabQyAps8R5WA2vYNrNg2HAXstsGFr/6uf5umUIHst/wav9LkXtoyKlLoLHGpyY3EFzMWpn9Eld2nexl8+Bf3URf/BeJW0JxcT5+6GdHjLhYSPStL9EALjey163OR/QBCJXKQQ12hy0+/f7mkDP4YbQrI6idIsIbg12gEuKl/Tf2rN6uHElhS3S4WGBFxGf/oy4VityLoxanlbn8e9/J9DtMq3nwIZDa4nslw5hSbayFGmeS49sim21cH9fvxtvlhgMGAlEzj7GX/A+tw5r8T+Np3QR4CIS61r5o+2++VdUaRcAtvJFsHMXtxmL/NBsVOCRuutSIGN2IGplPbkq5gNNSkaWpqf40SpVRb8wqPOVR9aXlVVJn6++nTWKNaIh9AR8BD/xqvT/kfXp4MaxV6HYbVLe96uddxp6W3+GJDvsq4FJPXyjXyqW2qB4P/5bCOJrrkfSZc/ETrP3Zw354euJzR75iql81TswtsTsKte+qa9zVTvWqx7iC5yrgsNH89WOsodIgnNWIQv3pcd//Zfiq0CMRBZRPPKHsMD6tQxvTHMgn/SW3/zrRYV3q5TlcUvtsWuJ+UMtCvHHV+RN9Jp7RkyUlkq0uU+vu2SsuVX/+DrAT0LZD6R4jDM/QXbOwlbfb95KTSV0q+5h8S3GD0pVkew5OepHhhxoQg7LkFVYRAVSHfZSIBTsns75Poagz65ee0lxcgxFNOJ1VHgGgojxc+34xWIwlvXFjr67qeGUxLMFcE8AD3Jml3qrznvmWe0sIJy5rf8GMeGiDtBy0Vl6wY39pIcspSqDHNM5QPdueZO/Co6Kbn0gqTAj6rxi8ljloGgjTPNnGy1Lu1nF56vovMtzQW3lf6mcv5iR2A3U/6x5tqFgI7VmoJgC6SK2c0c4/6QgmI2ee1DWdr+c3p7lsA8EVzDixFLX0OgfULNvAkJK0RM07PlrgnMwzdQTLUV4xD2pl2MmYLHlNuvVfQCqN/KfgTVsF7T7TFEJNQQYAcsj5i8H2tTzV8vNtYabCYAA"
                                    alt="Charlie"
                                    className="w-full h-full object-cover"
                                />
                            </div>
                            <span className="font-bold text-lg">Charlie</span>
                        </div>
                        <div className="flex items-center gap-1 bg-white/10 backdrop-blur-lg rounded-lg p-1 border border-white/10">
                            <button 
                                onClick={() => switchTab('portfolio')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'portfolio' 
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <BarChart2 className="w-4 h-4" />
                                    Thesis
                                </span>
                            </button>
                            <button 
                                onClick={() => switchTab('overview')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'overview' 
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <FileText className="w-4 h-4" />
                                    Overview
                                </span>
                            </button>
                            <button 
                                onClick={() => switchTab('chat')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'chat' 
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <MessageCircle className="w-4 h-4" />
                                    Chat
                                </span>
                            </button>
                            <button 
                                onClick={() => switchTab('summary')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'summary' 
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <ClipboardList className="w-4 h-4" />
                                    Summary
                                </span>
                            </button>
                            <button 
                                onClick={() => switchTab('research')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'research' 
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <Microscope className="w-4 h-4" />
                                    Research
                                </span>
                            </button>
                            <button
                                onClick={() => switchTab('meetingprep')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'meetingprep'
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <Target className="w-4 h-4" />
                                    Meeting Prep
                                </span>
                            </button>
                            <button
                                onClick={() => switchTab('slides')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'slides'
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <Layers className="w-4 h-4" />
                                    Slides
                                </span>
                            </button>
                            <button
                                onClick={() => switchTab('settings')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'settings'
                                        ? 'bg-teal-600 text-white shadow-lg glow-teal'
                                        : 'text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                            >
                                <span className="flex items-center gap-2">
                                    <Settings className="w-4 h-4" />
                                    Settings
                                </span>
                            </button>
                        </div>
                        <div className="w-32"></div> {/* Spacer for balance */}
                    </nav>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 flex overflow-hidden">
                        
                        {/* PORTFOLIO TAB */}
                        {activeTab === 'portfolio' && (
                            <div className="flex-1 flex flex-col md:flex-row overflow-hidden pb-24 md:pb-0">
                            {/* SIDEBAR - Hidden on mobile, overlay when menu open */}
                            {mobileMenuOpen && (
                                <div 
                                    className="md:hidden fixed inset-0 bg-black/50 z-40" 
                                    onClick={() => setMobileMenuOpen(false)}
                                />
                            )}
                            <div className={`${mobileMenuOpen ? 'fixed left-0 top-0 bottom-0 z-50' : 'hidden'} md:flex md:relative md:z-auto w-72 md:w-64 bg-white/5 backdrop-blur-xl border-r border-white/10 flex-col flex-shrink-0`}>
                                {/* Sidebar content */}
                                <div className="flex flex-col h-full pb-20 md:pb-0">
                                    <div className="p-4 border-b border-white/[0.08]">
                                        <div className="flex items-center gap-2 mb-3">
                                            {/* Close button for mobile */}
                                            <button 
                                                onClick={() => setMobileMenuOpen(false)}
                                                className="md:hidden p-2 hover:bg-white/10 rounded"
                                            >
                                                <X className="w-5 h-5 text-slate-400" />
                                            </button>
                                            <Folder className="w-5 h-5 text-teal-400" />
                                            <span className="font-semibold text-lg">Thesis</span>
                                            <button onClick={() => { loadSavedAnalyses(); }} className="ml-auto p-2 hover:bg-white/10 rounded">
                                                <RefreshCw className="w-4 h-4 text-slate-400" />
                                            </button>
                                        </div>
                                    </div>

                        <div className="flex-1 overflow-y-auto p-3">
                            {savedAnalyses.length === 0 ? (
                                <div className="text-sm text-slate-500 text-center py-8">No saved analyses</div>
                            ) : (
                                [...savedAnalyses].sort((a, b) => safeStr(a.ticker).localeCompare(safeStr(b.ticker))).map(s => (
                                    <div
                                        key={safeStr(s.ticker, `stock-${Math.random()}`)}
                                        onClick={() => {
                                            loadAnalysis(s.ticker);
                                            setMobileMenuOpen(false);
                                        }}
                                        className={`group p-4 rounded-xl cursor-pointer mb-2 transition-all active:scale-95 ${
                                            currentTicker === s.ticker 
                                                ? 'bg-teal-600 shadow-lg shadow-teal-500/30' 
                                                : 'bg-white/5 hover:bg-white/10 active:bg-white/15'
                                        }`}
                                    >
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="font-mono font-bold text-base">{safeStr(s.ticker)}</span>
                                            <button 
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    deleteAnalysis(s.ticker, e);
                                                }} 
                                                className="p-2 hover:bg-red-500/20 rounded opacity-50 hover:opacity-100"
                                            >
                                                <Trash className="w-4 h-4" />
                                            </button>
                                        </div>
                                        <div className="text-sm opacity-80 truncate">{safeStr(s.company)}</div>
                                        <div className="text-xs opacity-50 mt-1">{s.updated ? formatNYTime(s.updated) : ''}</div>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="p-4 border-t border-white/[0.08]">
                            <button 
                                onClick={() => {
                                    startNewAnalysis();
                                    setMobileMenuOpen(false);
                                }} 
                                className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 active:bg-teal-800 rounded-xl text-base font-medium transition-all active:scale-95"
                            >
                                <Plus className="w-5 h-5" />New Analysis
                            </button>
                        </div>
                        </div>
                    </div>

                    {/* MAIN */}
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <div className="border-b border-white/[0.08] bg-white/[0.04] backdrop-blur-lg px-3 sm:px-6 py-3 sm:py-4 flex justify-between items-center flex-shrink-0 gap-2">
                            <div className="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                                {/* Hamburger menu for mobile */}
                                <button 
                                    onClick={() => setMobileMenuOpen(true)}
                                    className="md:hidden p-2 hover:bg-white/10 rounded-lg flex-shrink-0"
                                >
                                    <Menu className="w-6 h-6" />
                                </button>
                                <div className="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0 overflow-hidden shadow-lg">
                                    {/* Charlie logo */}
                                    <img 
                                        src="data:image/webp;base64,UklGRvQIAABXRUJQVlA4WAoAAAAgAAAAfwAAfwAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggBgcAANAhAJ0BKoAAgAA+USaPRiOiISEkG/m4cAoJQBnNCsXngSDbdnU4DbEeYDzdP8P6iPQA/YDrAPQA/bP01vY0/dfKpFw/2joefGmJLtFPtJ974UdrHdnssf63jJ+s39V9Sv8r/0/oh3wlAD8xf9j+y+sj/uf4f8sfZ98+f9f3Df5X/Wv99/bvax9d3opDviBngxaP0szCIP6VhzhMxEhrrZrdQnFIKVxP4Y2bZ3uJxuuyYwP+cKb/znWAEevnx0y6r5hLtJrjLobvesVayarNPtqoXXDbeQHQYq9NKxupvX+jaF/rJBQ930U5GL6JrQYaJTMd/JlhXPobhyN+etsncCFfpRFC4i5CWcnKRQm1ASO9gybWerhYAAD+/M9Esyi+lNosMo30/K/KVr5sRa0WIV8w05TiIqeB0D3qD50ho2ZCsZqQAAHU8lcfBQRf51sGEb3sfR2Q6LjDk6rJZjtbjP5XzakprFrve/d2zxPjbnY2Nod0KwS81cvix5DA+5L/6b4RJNiIEXtiPniRJCCWmz56jE/eSlqrwmOf8XQlUVlb4RB7pjEJiHzPdPeoGSHbOOkvAm6a/3UG99p1NUqY2M3arYdUrFRH+fM+oypJc/U1/34DFp7H3Oul78r0AK2hid6xd8IypehYEY/qvkpTrZWfgaFFI73mZ2tqwWLAp0Fuem+RnKx++44g0hGdMGVNHE/qy/+RXygtGgfgTLhQOqnJ0Fp7gGRxeRKjpP30jQy2bdkU7rxtH2Uo9vr5byZVUCRbk/2bt2TfzoWFj+ksujTW18N8/SvZH/QJXz1ywAq7SVueR8vziFn+3VOA7LS75uONfgq2uNEiA2Ta53RdGZhOIrmyUDq0RtcYqeFhiCCjGFfkvsDoy5W8YEpnCMipixSC2MK3Qras+7U9yWS1dnp4zjP+RO/gEDaF/xKLnyR1XNFW5ZjCyrpmKHQ5Z6ImUC+/iexAXJizJv9G0D+DMJFY06I7jsy3tcm4RnyoggBZBZZmM3dxv69TJDF9YL43rqbaJcQoxVA30tilQGYlmeSHs+ZSfDcjP+yGqddhLdt9heE96Axxde7Hs9jW5sBcXmfu7rb9HmRjPQZEZLxyPBsSc7/H5R37/vxix9O0LlcNZEHRYwyoXFuiR1Tdgy+wMrVdz3WylvgxXW4xaq2p542Dfx2IAYiWmO66s1C0gdv2fqQM8w5iBpIP5wMmcrNw3kIo8pLrvMlblxGPiW0fBAgalbrs1bqIjitQWqf/EQBsyh+8nfr3fZL8vpGOzrR1F0k9+foaLfu2v01FdxbX2H1Ls/+WK9IHQyQy5G+K9KzibC/x22xUf8wpOmnwltd8XbdZP7fj+55Q5FiOGmS11GRnVmoxiabQyAps8R5WA2vYNrNg2HAXstsGFr/6uf5umUIHst/wav9LkXtoyKlLoLHGpyY3EFzMWpn9Eld2nexl8+Bf3URf/BeJW0JxcT5+6GdHjLhYSPStL9EALjey163OR/QBCJXKQQ12hy0+/f7mkDP4YbQrI6idIsIbg12gEuKl/Tf2rN6uHElhS3S4WGBFxGf/oy4VityLoxanlbn8e9/J9DtMq3nwIZDa4nslw5hSbayFGmeS49sim21cH9fvxtvlhgMGAlEzj7GX/A+tw5r8T+Np3QR4CIS61r5o+2++VdUaRcAtvJFsHMXtxmL/NBsVOCRuutSIGN2IGplPbkq5gNNSkaWpqf40SpVRb8wqPOVR9aXlVVJn6++nTWKNaIh9AR8BD/xqvT/kfXp4MaxV6HYbVLe96uddxp6W3+GJDvsq4FJPXyjXyqW2qB4P/5bCOJrrkfSZc/ETrP3Zw354euJzR75iql81TswtsTsKte+qa9zVTvWqx7iC5yrgsNH89WOsodIgnNWIQv3pcd//Zfiq0CMRBZRPPKHsMD6tQxvTHMgn/SW3/zrRYV3q5TlcUvtsWuJ+UMtCvHHV+RN9Jp7RkyUlkq0uU+vu2SsuVX/+DrAT0LZD6R4jDM/QXbOwlbfb95KTSV0q+5h8S3GD0pVkew5OepHhhxoQg7LkFVYRAVSHfZSIBTsns75Poagz65ee0lxcgxFNOJ1VHgGgojxc+34xWIwlvXFjr67qeGUxLMFcE8AD3Jml3qrznvmWe0sIJy5rf8GMeGiDtBy0Vl6wY39pIcspSqDHNM5QPdueZO/Co6Kbn0gqTAj6rxi8ljloGgjTPNnGy1Lu1nF56vovMtzQW3lf6mcv5iR2A3U/6x5tqFgI7VmoJgC6SK2c0c4/6QgmI2ee1DWdr+c3p7lsA8EVzDixFLX0OgfULNvAkJK0RM07PlrgnMwzdQTLUV4xD2pl2MmYLHlNuvVfQCqN/KfgTVsF7T7TFEJNQQYAcsj5i8H2tTzV8vNtYabCYAA"
                                        alt="Charlie"
                                        className="w-full h-full object-cover"
                                    />
                                </div>
                                <div className="min-w-0 flex-1">
                                    <h1 className="text-sm sm:text-xl font-bold">
                                        <span className="hidden sm:inline">Charlie</span>
                                        <span className="sm:hidden">{currentTicker || 'Charlie'}</span>
                                    </h1>
                                    <p className="text-xs text-slate-400 truncate">{currentTicker ? `Viewing: ${currentTicker}` : 'Thesis analysis'}</p>
                                </div>
                            </div>
                            <div className="flex gap-1 sm:gap-2 flex-shrink-0">
                                {documents.length > 0 && !analysis && (
                                    <div className="text-xs text-slate-400 hidden md:block">{enabled}/{documents.length} docs ‚Ä¢ 100% weight</div>
                                )}
                                {analysis && (
                                    <>
                                        {!showDocumentManager && (
                                            <button 
                                                onClick={() => setShowDocumentManager(true)} 
                                                className="flex items-center gap-1 px-2 sm:px-3 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm font-medium"
                                                title="Add Documents"
                                            >
                                                <Plus className="w-4 h-4" />
                                                <span className="hidden md:inline">Add Docs</span>
                                            </button>
                                        )}
                                        <button 
                                            onClick={() => setShowSaveDialog(true)} 
                                            className="flex items-center gap-1 px-2 sm:px-3 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 rounded-lg text-sm font-medium shadow-lg shadow-emerald-500/20"
                                            title="Save"
                                        >
                                            <Save />
                                            <span className="hidden md:inline">Save</span>
                                        </button>
                                        <button 
                                            onClick={quickSendPortfolioEmail} 
                                            className="flex items-center gap-1 px-2 sm:px-3 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg text-sm font-medium shadow-lg shadow-amber-500/20"
                                            title="Quick Email"
                                        >
                                            <Mail />
                                            <span className="hidden md:inline">Email</span>
                                        </button>
                                        <button 
                                            onClick={() => setShowEmailDialog(true)} 
                                            className="flex items-center gap-1 px-2 sm:px-3 py-2 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg text-sm font-medium shadow-lg shadow-yellow-500/20"
                                            title="Email Options"
                                        >
                                            <Mails />
                                        </button>
                                        <button 
                                            onClick={exportMD} 
                                            className="flex items-center gap-1 px-2 sm:px-3 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm"
                                            title="Export MD"
                                        >
                                            <Download />
                                            <span className="hidden lg:inline">Export</span>
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>

                        {/* MOBILE STOCK SWITCHER BAR - Always visible on mobile */}
                        <div className="md:hidden border-b border-white/[0.08] bg-white/5 backdrop-blur-xl px-3 py-2 space-y-2">
                            {/* Search Box */}
                            {savedAnalyses.length > 5 && (
                                <div className="relative">
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={stockSearch}
                                            onChange={(e) => setStockSearch(e.target.value)}
                                            placeholder="Search portfolio..."
                                            className="w-full pl-9 pr-8 py-2 bg-white/[0.07] border border-white/10 rounded-xl text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500/50 focus:border-teal-500"
                                            style={{ fontSize: '16px' }}
                                        />
                                        <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                                            <circle cx="11" cy="11" r="8"/>
                                            <path d="m21 21-4.35-4.35"/>
                                        </svg>
                                        {stockSearch && (
                                            <button
                                                onMouseDown={(e) => {
                                                    e.preventDefault();
                                                    setStockSearch('');
                                                }}
                                                className="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-white/10 rounded"
                                            >
                                                <X className="w-3 h-3 text-slate-500" />
                                            </button>
                                        )}
                                    </div>
                                    
                                    {/* Dropdown - show when there's search text */}
                                    {stockSearch.length > 0 && getFilteredStocks(stockSearch, savedAnalyses).length > 0 && (
                                        <div className="absolute top-full left-0 right-0 mt-1 bg-white/5 border border-white/10 backdrop-blur-md rounded-xl shadow-xl z-50 overflow-hidden">
                                            {getFilteredStocks(stockSearch, savedAnalyses).map((s, idx) => (
                                                <button
                                                    key={safeStr(s.ticker, idx)}
                                                    onMouseDown={(e) => {
                                                        e.preventDefault();
                                                        handleStockSearchSelect(s.ticker, false);
                                                    }}
                                                    className="w-full px-4 py-2.5 text-left hover:bg-white/10 flex items-center gap-3 transition-colors"
                                                >
                                                    <span className="font-mono font-bold text-teal-400">{safeStr(s.ticker)}</span>
                                                    <span className="text-sm text-slate-400 truncate">{safeStr(s.company || s.companyName, '')}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* No results message */}
                                    {stockSearch.length > 0 && getFilteredStocks(stockSearch, savedAnalyses).length === 0 && (
                                        <div className="absolute top-full left-0 right-0 mt-1 bg-white/5 border border-white/10 backdrop-blur-md rounded-xl shadow-xl z-50 p-3 text-center text-sm text-slate-500">
                                            No matching stocks
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide" style={{scrollbarWidth: 'none', msOverflowStyle: 'none', WebkitOverflowScrolling: 'touch'}}>
                                {/* New Analysis Button */}
                                <button
                                    onClick={() => {
                                        startNewAnalysis();
                                    }}
                                    className="flex-shrink-0 px-4 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 active:bg-teal-800 rounded-full text-sm font-medium flex items-center gap-1 transition-all active:scale-95"
                                >
                                    <Plus className="w-4 h-4" />
                                    New
                                </button>
                                
                                {/* Stock Pills - sorted alphabetically */}
                                {[...savedAnalyses].sort((a, b) => safeStr(a.ticker).localeCompare(safeStr(b.ticker))).map(s => (
                                    <button
                                        key={safeStr(s.ticker, `btn-${Math.random()}`)}
                                        onClick={() => {
                                            loadAnalysis(s.ticker);
                                        }}
                                        className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-mono font-bold transition-all active:scale-95 ${
                                            currentTicker === s.ticker 
                                                ? 'bg-teal-600 text-white shadow-lg shadow-teal-600/30' 
                                                : 'bg-white/10 text-slate-300 hover:bg-white/10 active:bg-white/20'
                                        }`}
                                    >
                                        {safeStr(s.ticker)}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
                                {/* Show loading while checking for API key */}
                                {!apiKeyChecked && (
                                    <div className="flex items-center justify-center py-12">
                                        <Loader className="w-8 h-8 text-blue-500" />
                                        <span className="ml-3 text-slate-400">Loading...</span>
                                    </div>
                                )}
                                
                                {/* Show API key prompt only after checking storage */}
                                {apiKeyChecked && !apiKeySaved && (
                                    <div className="mb-6 bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
                                        <div className="text-center mb-6">
                                            <div className="w-16 h-16 bg-teal-600/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                                <Key className="w-8 h-8 text-teal-400" />
                                            </div>
                                            <h3 className="font-bold text-xl mb-2">API Key Required</h3>
                                            <p className="text-slate-400 text-sm">Enter your Anthropic API key to analyze documents</p>
                                        </div>
                                        <div className="space-y-4">
                                            <input 
                                                type="password" 
                                                value={apiKeyInput} 
                                                onChange={e => setApiKeyInput(e.target.value)} 
                                                onKeyPress={e => e.key === 'Enter' && saveKey()} 
                                                placeholder="sk-ant-api03-..." 
                                                className="w-full px-4 py-4 bg-white/5 border border-white/10 backdrop-blur-md rounded-xl text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none text-base placeholder-slate-500" 
                                            />
                                            <button 
                                                onClick={saveKey} 
                                                className="w-full px-6 py-4 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 active:bg-teal-800 rounded-xl font-semibold text-lg transition-all active:scale-[0.98]"
                                            >
                                                Save API Key
                                            </button>
                                        </div>
                                        <p className="text-xs text-slate-500 text-center mt-4">Your key is stored locally on this device only</p>
                                    </div>
                                )}

                                {apiKeyChecked && !analysis && documents.length === 0 && !showDocumentManager && apiKeySaved && (
                                    <div className="text-center py-12 sm:py-16">
                                        <div className="text-slate-400 mb-6 text-base">{savedAnalyses.length > 0 ? 'Tap a stock above or start new' : 'Upload documents to begin'}</div>
                                        <button onClick={() => fileInputRef.current?.click()} className="px-8 py-4 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 active:bg-teal-800 rounded-xl font-medium inline-flex items-center gap-2 text-base transition-all active:scale-95">
                                            <Plus />Upload Documents
                                        </button>
                                        <div className="text-xs text-slate-500 mt-3">PDF, Word, Images, Emails, Text files</div>
                                        <input ref={fileInputRef} type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.gif,.webp,.eml,.msg,.txt,.html" multiple onChange={handleFileUpload} className="hidden" />
                                    </div>
                                )}

                                {((!analysis && documents.length > 0) || showDocumentManager) && (
                                    <div className="bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-xl p-6">
                                        {currentTicker && (
                                            <div className="mb-4 p-3 bg-teal-950/30 border border-teal-800 rounded-lg flex items-center gap-3">
                                                <RefreshCw className="w-5 h-5 text-teal-400 flex-shrink-0" />
                                                <div>
                                                    <span className="font-semibold text-teal-400">Update Mode</span>
                                                    <span className="text-sm text-slate-300 ml-2">‚Äî Adding to {currentTicker}</span>
                                                </div>
                                            </div>
                                        )}

                                        {analysis?.documentHistory && analysis.documentHistory.length > 0 && (
                                            <div className="mb-6 bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-lg p-4">
                                                {/* Header row */}
                                                <h3 className="font-semibold flex items-center gap-2 mb-3">
                                                    <FileText className="w-4 h-4 text-slate-400" />
                                                    Existing Analysis Weight
                                                </h3>
                                                {/* Mode toggle row */}
                                                <div className="flex items-center gap-2 mb-4">
                                                    <div className="flex items-center gap-2 bg-white/5 backdrop-blur-lg rounded-lg p-1">
                                                        <button
                                                            onClick={() => setWeightingMode('simple')}
                                                            className={`px-3 py-1 text-xs rounded-md transition-colors ${
                                                                weightingMode === 'simple' 
                                                                    ? 'bg-teal-600 text-white' 
                                                                    : 'text-slate-400 hover:text-white'
                                                            }`}
                                                        >
                                                            Simple
                                                        </button>
                                                        <button
                                                            onClick={() => setWeightingMode('advanced')}
                                                            className={`px-3 py-1 text-xs rounded-md transition-colors ${
                                                                weightingMode === 'advanced' 
                                                                    ? 'bg-teal-600 text-white' 
                                                                    : 'text-slate-400 hover:text-white'
                                                            }`}
                                                        >
                                                            Advanced
                                                        </button>
                                                    </div>
                                                    <span className="text-xs text-slate-500">
                                                        {weightingMode === 'simple' ? 'One slider for all existing docs' : 'Per-document control'}
                                                    </span>
                                                </div>

                                                {/* Simple Mode - One slider for existing analysis */}
                                                {weightingMode === 'simple' && (
                                                    <div className="space-y-4">
                                                        <div className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-4 border border-white/10">
                                                            <div className="flex items-center justify-between mb-3">
                                                                <div>
                                                                    <div className="font-medium text-slate-200">Keep Existing Analysis</div>
                                                                    <div className="text-xs text-slate-500">
                                                                        {analysis.documentHistory.length} document{analysis.documentHistory.length > 1 ? 's' : ''} previously analyzed
                                                                    </div>
                                                                </div>
                                                                <span className="text-2xl font-mono font-bold text-teal-400">
                                                                    {existingAnalysisWeight}%
                                                                </span>
                                                            </div>
                                                            <input 
                                                                type="range" 
                                                                min="0" 
                                                                max="95" 
                                                                step="5" 
                                                                value={existingAnalysisWeight} 
                                                                onChange={e => setExistingAnalysisWeight(parseInt(e.target.value))} 
                                                                className="w-full h-3 bg-white/10 rounded-lg appearance-none cursor-pointer accent-teal-500" 
                                                            />
                                                            <div className="flex justify-between text-xs text-slate-500 mt-2">
                                                                <span>0% (Replace entirely)</span>
                                                                <span>95% (Minor updates only)</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="bg-blue-950/30 rounded-lg p-3 border border-blue-800/50">
                                                            <div className="flex items-center gap-2 text-blue-300 text-sm">
                                                                <span>üìä</span>
                                                                <span>
                                                                    New documents will share <strong>{100 - existingAnalysisWeight}%</strong> weight
                                                                </span>
                                                            </div>
                                                        </div>
                                                        
                                                        <details className="text-xs text-slate-500">
                                                            <summary className="cursor-pointer hover:text-slate-300">
                                                                View {analysis.documentHistory?.length || 0} documents in existing analysis
                                                            </summary>
                                                            <div className="mt-2 pl-4 border-l border-white/10 space-y-3">
                                                                {safeArray(analysis.documentHistory).map((doc, idx) => (
                                                                    <div key={idx} className="py-1">
                                                                        {/* Document name - full width */}
                                                                        <div className="text-slate-300 text-sm mb-1">
                                                                            üìÑ {getSmartDocumentName(doc)}
                                                                        </div>
                                                                        {/* Metadata and action button row */}
                                                                        <div className="flex items-center gap-2 text-slate-500">
                                                                            <span>{safeStr(doc.type, 'doc')} ‚Ä¢ {safeStr(doc.date, '')}</span>
                                                                            {(doc.stored || storedDocuments.some(sd => sd.filename === doc.filename)) && (
                                                                                <button
                                                                                    onClick={(e) => { e.stopPropagation(); e.preventDefault(); viewStoredTickerFile(currentTicker, doc.filename); }}
                                                                                    className="p-1 text-teal-400 hover:bg-teal-600/20 rounded"
                                                                                    title="View PDF"
                                                                                >
                                                                                    <ExternalLink className="w-3.5 h-3.5" />
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </details>
                                                    </div>
                                                )}

                                                {/* Advanced Mode - Per-document weights */}
                                                {weightingMode === 'advanced' && (
                                                    <>
                                                        <p className="text-xs text-slate-500 mb-3">
                                                            Adjust individual document weights or exclude stale data
                                                        </p>
                                                        <div className="space-y-3">
                                                            {safeArray(analysis.documentHistory).map((doc, idx) => (
                                                                <div key={idx} className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-3 border border-white/[0.08]">
                                                                    {/* Main content row with checkbox */}
                                                                    <div className="flex items-start gap-3">
                                                                        <input 
                                                                            type="checkbox" 
                                                                            checked={doc.includeInContext !== false}
                                                                            onChange={() => toggleDocumentHistory(doc.filename)}
                                                                            className="w-4 h-4 mt-1 flex-shrink-0"
                                                                        />
                                                                        <div className="flex-1 min-w-0">
                                                                            {/* Document name - full width */}
                                                                            {editingDocName === doc.filename ? (
                                                                                <div className="mb-2">
                                                                                    <input
                                                                                        type="text"
                                                                                        value={editingDocNameValue}
                                                                                        onChange={(e) => setEditingDocNameValue(e.target.value)}
                                                                                        onKeyDown={(e) => {
                                                                                            if (e.key === 'Enter') {
                                                                                                updateDocumentDisplayName(doc.filename, editingDocNameValue.trim());
                                                                                            } else if (e.key === 'Escape') {
                                                                                                cancelEditingDocName();
                                                                                            }
                                                                                        }}
                                                                                        className="w-full px-2 py-1 bg-white/5 border border-teal-500 rounded text-sm text-slate-200 focus:outline-none focus:ring-1 focus:ring-teal-500"
                                                                                        autoFocus
                                                                                        placeholder="Enter document name..."
                                                                                    />
                                                                                    <div className="flex gap-2 mt-1">
                                                                                        <button
                                                                                            onClick={() => updateDocumentDisplayName(doc.filename, editingDocNameValue.trim())}
                                                                                            className="px-2 py-0.5 text-xs bg-teal-600 hover:bg-teal-500 text-white rounded"
                                                                                        >
                                                                                            Save
                                                                                        </button>
                                                                                        <button
                                                                                            onClick={cancelEditingDocName}
                                                                                            className="px-2 py-0.5 text-xs bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 text-slate-300 rounded"
                                                                                        >
                                                                                            Cancel
                                                                                        </button>
                                                                                        {doc.displayName && (
                                                                                            <button
                                                                                                onClick={() => updateDocumentDisplayName(doc.filename, null)}
                                                                                                className="px-2 py-0.5 text-xs bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 text-slate-400 rounded"
                                                                                                title="Reset to auto-generated name"
                                                                                            >
                                                                                                Reset
                                                                                            </button>
                                                                                        )}
                                                                                    </div>
                                                                                </div>
                                                                            ) : (
                                                                                <div className="mb-1">
                                                                                    <span className="font-medium text-slate-200 text-sm leading-relaxed">
                                                                                        {getSmartDocumentName(doc)}
                                                                                    </span>
                                                                                    {doc.displayName && (
                                                                                        <span className="text-xs text-teal-500 ml-1" title="Custom name">‚úèÔ∏è</span>
                                                                                    )}
                                                                                </div>
                                                                            )}
                                                                            
                                                                            {/* Badge, metadata, and action buttons row */}
                                                                            <div className="flex flex-wrap items-center gap-2 text-xs">
                                                                                {doc.stored || storedDocuments.some(sd => sd.filename === doc.filename) ? (
                                                                                    <span className="px-1.5 py-0.5 bg-teal-500/20 text-teal-400 rounded" title="Stored in database">
                                                                                        üíæ Stored
                                                                                    </span>
                                                                                ) : (
                                                                                    <span className="px-1.5 py-0.5 bg-amber-500/20 text-amber-400 rounded" title="Metadata only">
                                                                                        üìã Metadata
                                                                                    </span>
                                                                                )}
                                                                                <span className="text-slate-500">{safeStr(doc.type, 'doc')} ‚Ä¢ {safeStr(doc.date, '')}</span>
                                                                                
                                                                                {doc.includeInContext === false && (
                                                                                    <span className="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded">
                                                                                        Excluded
                                                                                    </span>
                                                                                )}
                                                                                
                                                                                {/* Action buttons - inline with badges */}
                                                                                <div className="flex items-center gap-1 ml-auto">
                                                                                    <button
                                                                                        onClick={() => startEditingDocName(doc)}
                                                                                        className="p-1 text-slate-500 hover:text-teal-400 hover:bg-white/10 rounded"
                                                                                        title="Edit name"
                                                                                    >
                                                                                        <Edit2 className="w-3.5 h-3.5" />
                                                                                    </button>
                                                                                    {(doc.stored || storedDocuments.some(sd => sd.filename === doc.filename)) && (
                                                                                        <>
                                                                                            <button
                                                                                                onClick={(e) => { e.stopPropagation(); e.preventDefault(); viewStoredTickerFile(currentTicker, doc.filename); }}
                                                                                                className="p-1 text-teal-400 hover:bg-teal-600/20 rounded"
                                                                                                title="View PDF"
                                                                                            >
                                                                                                <ExternalLink className="w-3.5 h-3.5" />
                                                                                            </button>
                                                                                            <button
                                                                                                onClick={async () => {
                                                                                                    if (confirm(`Delete stored file "${doc.filename}"? This frees up storage but you'll need to re-upload to re-analyze.`)) {
                                                                                                        await deleteStoredDocument(currentTicker, doc.filename);
                                                                                                    }
                                                                                                }}
                                                                                                className="p-1 text-slate-500 hover:text-red-400 hover:bg-red-950/30 rounded"
                                                                                                title="Delete from storage"
                                                                                            >
                                                                                                <Trash className="w-3.5 h-3.5" />
                                                                                            </button>
                                                                                        </>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Weight slider */}
                                                                    {doc.includeInContext !== false && (
                                                                        <div className="flex items-center gap-3 pl-7 mt-2">
                                                                            <span className="text-xs text-slate-500">Weight:</span>
                                                                            <input 
                                                                                type="range" 
                                                                                min="5" 
                                                                                max="95" 
                                                                                step="5" 
                                                                                value={combinedPercentages.historical[doc.filename] || 0} 
                                                                                onChange={e => updateCombinedPercentage(doc.filename, 'historical', parseInt(e.target.value))} 
                                                                                className="flex-1 h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-teal-500" 
                                                                            />
                                                                            <span className="text-xs font-mono font-semibold text-teal-400 w-10">{String(combinedPercentages.historical[doc.filename] || 0)}%</span>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <div className="mt-3 flex items-center justify-between">
                                                            <div className="text-xs text-slate-400">
                                                                üíæ <strong>Stored</strong> = can re-analyze with different weights<br/>
                                                                üìã <strong>Metadata</strong> = re-upload to enable re-weighting
                                                            </div>
                                                            {storedDocuments.length > 0 && (
                                                                <button
                                                                    onClick={async () => {
                                                                        if (confirm(`Delete ALL stored documents for ${currentTicker}? This frees up ${formatBytes(storedDocuments.reduce((sum, d) => sum + (d.fileSize || 0), 0))} of storage.`)) {
                                                                            await deleteAllStoredDocuments(currentTicker);
                                                                        }
                                                                    }}
                                                                    className="text-xs px-2 py-1 text-red-400 hover:bg-red-950/30 rounded"
                                                                >
                                                                    Delete All Stored
                                                                </button>
                                                            )}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        )}

                                        <div className="flex justify-between items-start mb-6 gap-3">
                                            <div>
                                                <h2 className="text-xl sm:text-2xl font-bold">Document Manager</h2>
                                                <p className="text-sm sm:text-base text-slate-400">Configure and analyze</p>
                                            </div>
                                            <div className="flex gap-2 flex-shrink-0">
                                                {currentTicker && (
                                                    <button onClick={() => setShowDocumentManager(false)} className="px-3 sm:px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm flex items-center gap-2 whitespace-nowrap">
                                                        <span className="hidden sm:inline">‚Üê Back to Results</span>
                                                        <span className="sm:hidden">‚Üê Back</span>
                                                    </button>
                                                )}
                                                <button onClick={() => fileInputRef.current?.click()} className="px-3 sm:px-4 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm flex items-center gap-2">
                                                    <Plus className="w-4 h-4" />
                                                    <span className="hidden sm:inline">Add</span>
                                                </button>
                                            </div>
                                            <input ref={fileInputRef} type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.gif,.webp,.eml,.msg,.txt,.html" multiple onChange={handleFileUpload} className="hidden" />
                                        </div>

                                        {renderDriveSearch(currentTicker || '', handleDriveImportPortfolio)}

                                        {/* Desktop table header - hidden on mobile */}
                                        <div className="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-xs font-semibold text-slate-400 uppercase mb-3">
                                            <div className="col-span-1"></div>
                                            <div className="col-span-4">Document</div>
                                            <div className="col-span-2">Type</div>
                                            <div className="col-span-3">Weight</div>
                                            <div className="col-span-2"></div>
                                        </div>

                                        {/* Grouping toolbar */}
                                        {documents.length > 1 && (
                                            <div className="mb-4 p-3 bg-white/[0.04] backdrop-blur-lg rounded-lg border border-white/10">
                                                <div className="flex flex-wrap items-center gap-3">
                                                    <span className="text-sm text-slate-400">
                                                        {selectedForGrouping.length > 0 
                                                            ? `${selectedForGrouping.length} selected` 
                                                            : 'Select files to group them as one document'}
                                                    </span>
                                                    {selectedForGrouping.length >= 2 && (
                                                        <button
                                                            onClick={() => {
                                                                const name = prompt('Name this group (e.g., "CVS Email Screenshots"):');
                                                                if (name) createDocumentGroup(name);
                                                            }}
                                                            className="px-3 py-1.5 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm font-medium flex items-center gap-2"
                                                        >
                                                            <Folder className="w-4 h-4" />
                                                            Group Selected
                                                        </button>
                                                    )}
                                                    {/* Select All / Deselect All button */}
                                                    {selectedForGrouping.length < documents.length ? (
                                                        <button
                                                            onClick={() => setSelectedForGrouping(documents.map(d => d.id))}
                                                            className="px-3 py-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm"
                                                        >
                                                            Select All
                                                        </button>
                                                    ) : (
                                                        <button
                                                            onClick={() => setSelectedForGrouping([])}
                                                            className="px-3 py-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm"
                                                        >
                                                            Deselect All
                                                        </button>
                                                    )}
                                                    {selectedForGrouping.length > 0 && selectedForGrouping.length < documents.length && (
                                                        <button
                                                            onClick={() => setSelectedForGrouping([])}
                                                            className="px-3 py-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm"
                                                        >
                                                            Clear
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        )}

                                        {/* Document Groups */}
                                        {documentGroups.length > 0 && (
                                            <div className="space-y-3 mb-4">
                                                {documentGroups.map(group => {
                                                    const groupDocs = getGroupDocuments(group.id);
                                                    return (
                                                        <div key={group.id} className={`rounded-xl border ${group.enabled ? 'bg-gradient-to-r from-teal-900/20 to-white/5 backdrop-blur-lg border-teal-500/30' : 'bg-white/[0.03] border-white/[0.08] opacity-50'}`}>
                                                            <div className="p-4">
                                                                <div className="flex items-center gap-3 mb-3">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={group.enabled} 
                                                                        onChange={() => toggleGroupEnabled(group.id)} 
                                                                        className="w-5 h-5" 
                                                                    />
                                                                    <Folder className="w-5 h-5 text-teal-400" />
                                                                    <div className="flex-1">
                                                                        <div className="font-medium text-teal-300">{safeStr(group.name, 'Unnamed Group')}</div>
                                                                        <div className="text-xs text-slate-400">{groupDocs.length} files grouped as one document</div>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => ungroupDocuments(group.id)}
                                                                        className="px-2 py-1 text-xs text-slate-400 hover:text-red-400 hover:bg-red-950/30 rounded"
                                                                    >
                                                                        Ungroup
                                                                    </button>
                                                                </div>
                                                                
                                                                {/* Group weight slider */}
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-xs text-slate-400 w-14">Weight:</span>
                                                                    {weightingMode === 'simple' && analysis?.documentHistory?.length > 0 ? (
                                                                        <div className="flex-1 text-xs text-slate-400">
                                                                            <span className="text-teal-400 font-mono font-semibold">
                                                                                {String(100 - existingAnalysisWeight)}% (shared)
                                                                            </span>
                                                                        </div>
                                                                    ) : (
                                                                        <>
                                                                            <input 
                                                                                type="range" 
                                                                                min="5" 
                                                                                max="95" 
                                                                                step="5" 
                                                                                value={combinedPercentages.groups[group.id] || 0} 
                                                                                onChange={e => updateCombinedPercentage(group.id, 'group', parseInt(e.target.value))} 
                                                                                className="flex-1 h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-teal-500" 
                                                                                disabled={!group.enabled}
                                                                            />
                                                                            <span className="text-sm font-mono font-semibold text-teal-400 w-12">
                                                                                {String(combinedPercentages.groups[group.id] || 0)}%
                                                                            </span>
                                                                        </>
                                                                    )}
                                                                </div>
                                                                
                                                                {/* Expandable file list */}
                                                                <details className="mt-3">
                                                                    <summary className="text-xs text-slate-500 cursor-pointer hover:text-slate-300">
                                                                        Show {groupDocs.length} files in group
                                                                    </summary>
                                                                    <div className="mt-2 pl-4 border-l border-white/10 space-y-1">
                                                                        {groupDocs.map(doc => (
                                                                            <div key={doc.id} className="text-xs text-slate-400 py-1">
                                                                                üìÑ {safeStr(doc.filename, 'Unknown file')}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </details>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}

                                        {/* Ungrouped Documents */}
                                        <div className="space-y-4 mb-6">{getUngroupedDocuments().filter(doc => doc && doc.id).map((doc, idx) => (
                                                <div key={doc.id} draggable onDragStart={e => handleDragStart(e, idx)} onDragOver={handleDragOver} onDrop={e => handleDrop(e, idx)} className={`p-4 sm:p-5 rounded-xl border ${selectedForGrouping.includes(doc.id) ? 'ring-2 ring-teal-500' : ''} ${doc.enabled ? 'bg-white/[0.07] backdrop-blur-lg border-white/10' : 'bg-white/[0.03] border-white/[0.08] opacity-50'}`}>
                                                    {/* Mobile layout - stacked */}
                                                    <div className="md:hidden space-y-4">
                                                        <div className="flex items-start gap-3">
                                                            <div className="flex items-center gap-2 flex-shrink-0">
                                                                {/* Selection checkbox for grouping */}
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={selectedForGrouping.includes(doc.id)}
                                                                    onChange={() => toggleDocumentSelection(doc.id)}
                                                                    className="w-4 h-4 accent-teal-500"
                                                                    title="Select for grouping"
                                                                />
                                                                <GripVertical className="text-slate-600 cursor-move" />
                                                                <span className="text-sm font-mono text-slate-500">#{idx + 1}</span>
                                                            </div>
                                                            <div className="flex items-center gap-3 flex-1 min-w-0">
                                                                <input type="checkbox" checked={doc.enabled} onChange={e => updateDocument(doc.id, { enabled: e.target.checked })} className="w-5 h-5 flex-shrink-0" title="Include in analysis" />
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="font-medium text-base text-slate-100 break-words">{safeStr(doc.filename, 'Unknown file')}</div>
                                                                    <div className="text-sm text-slate-400 mt-1">
                                                                        {(((doc.fileData || doc.pdfData || '').length * 0.75) / 1024 / 1024).toFixed(2)} MB
                                                                        {doc.fileType && <span className="ml-2 px-1.5 py-0.5 bg-white/10 rounded text-xs">{safeStr(doc.fileType).toUpperCase()}</span>}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="text-xs text-slate-400 mb-1 block">Document Type</label>
                                                            <select value={doc.metadata?.type || 'broker_report'} onChange={e => updateMetadata(doc.id, 'type', e.target.value)} className="w-full px-4 py-3 text-base bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-white">
                                                                <option value="broker_report">Broker Report</option>
                                                                <option value="earnings_call">Earnings Call</option>
                                                                <option value="10k">10-K Filing</option>
                                                                <option value="presentation">Presentation</option>
                                                                <option value="email">Email / Correspondence</option>
                                                                <option value="screenshot">Screenshot</option>
                                                                <option value="news">News Article</option>
                                                                <option value="internal_note">Internal Note</option>
                                                                <option value="other">Other</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div>
                                                            {/* In Simple mode with existing analysis, show fixed share instead of slider */}
                                                            {weightingMode === 'simple' && analysis?.documentHistory?.length > 0 ? (
                                                                <>
                                                                    <label className="text-xs text-slate-400 mb-2 block">
                                                                        Analysis Weight: <span className="text-teal-400 font-mono font-semibold">
                                                                            {String(100 - existingAnalysisWeight)}% (shared)
                                                                        </span>
                                                                    </label>
                                                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-lg p-2 text-xs text-slate-400">
                                                                        New documents share weight equally.
                                                                        <button onClick={() => setWeightingMode('advanced')} className="text-teal-400 underline ml-1">Switch to Advanced</button>
                                                                    </div>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <label className="text-xs text-slate-400 mb-2 block">Analysis Weight: <span className="text-teal-400 font-mono font-semibold">{String(combinedPercentages.new[doc.id] || 0)}%</span></label>
                                                                    <input type="range" min="5" max="95" step="5" value={combinedPercentages.new[doc.id] || 0} onChange={e => updateCombinedPercentage(doc.id, 'new', parseInt(e.target.value))} className="w-full h-3 bg-white/10 rounded-lg appearance-none cursor-pointer accent-teal-500" disabled={!doc.enabled} />
                                                                    <div className="flex justify-between text-xs text-slate-500 mt-1">
                                                                        <span>5% (Less weight)</span>
                                                                        <span>95% (More weight)</span>
                                                                    </div>
                                                                </>
                                                            )}
                                                        </div>
                                                        
                                                        <div className="flex flex-col sm:flex-row gap-3">
                                                            <div className="w-48">
                                                                <label className="text-xs text-slate-400 mb-1 block">Date</label>
                                                                <input type="date" value={doc.metadata?.date || ''} onChange={e => updateMetadata(doc.id, 'date', e.target.value)} className="w-full px-3 py-3 text-sm bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-white" style={{ fontSize: '16px' }} />
                                                            </div>
                                                            <div className="flex items-end">
                                                                <button onClick={() => deleteDocument(doc.id)} className="w-full sm:w-auto px-4 py-3 text-red-400 bg-red-950/30 hover:bg-red-950/50 rounded-lg flex items-center justify-center gap-2">
                                                                    <Trash className="w-5 h-5" />
                                                                    <span className="text-sm">Delete</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Desktop layout - grid */}
                                                    <div className="hidden md:grid grid-cols-12 gap-4 items-center">
                                                        <div className="col-span-1 flex items-center gap-2">
                                                            <GripVertical className="text-slate-600 cursor-move" />
                                                            <span className="text-xs font-mono text-slate-500">#{idx + 1}</span>
                                                        </div>
                                                        <div className="col-span-4 flex items-center gap-3">
                                                            <input type="checkbox" checked={doc.enabled} onChange={e => updateDocument(doc.id, { enabled: e.target.checked })} className="w-4 h-4" />
                                                            <div className="flex-1 min-w-0">
                                                                <div className="font-medium text-sm truncate text-slate-100">{safeStr(doc.filename, 'Unknown file')}</div>
                                                                <div className="text-xs text-slate-500">
                                                                    {(((doc.fileData || doc.pdfData || '').length * 0.75) / 1024 / 1024).toFixed(2)} MB
                                                                    {doc.fileType && <span className="ml-1 px-1 py-0.5 bg-white/10 rounded text-xs">{safeStr(doc.fileType).toUpperCase()}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="col-span-2">
                                                            <select value={doc.metadata?.type || 'broker_report'} onChange={e => updateMetadata(doc.id, 'type', e.target.value)} className="w-full px-3 py-1.5 text-xs bg-white/5 border border-white/10 backdrop-blur-md rounded text-white">
                                                                <option value="broker_report">Broker Report</option>
                                                                <option value="earnings_call">Earnings Call</option>
                                                                <option value="10k">10-K</option>
                                                                <option value="presentation">Presentation</option>
                                                                <option value="email">Email</option>
                                                                <option value="screenshot">Screenshot</option>
                                                                <option value="news">News</option>
                                                                <option value="internal_note">Note</option>
                                                                <option value="other">Other</option>
                                                            </select>
                                                        </div>
                                                        <div className="col-span-3">
                                                            {weightingMode === 'simple' && analysis?.documentHistory?.length > 0 ? (
                                                                <div className="text-xs text-slate-400">
                                                                    <span className="text-teal-400 font-mono font-semibold">
                                                                        {String(100 - existingAnalysisWeight)}% (shared)
                                                                    </span>
                                                                </div>
                                                            ) : (
                                                                <div className="flex items-center gap-2">
                                                                    <input type="range" min="5" max="95" step="5" value={combinedPercentages.new[doc.id] || 0} onChange={e => updateCombinedPercentage(doc.id, 'new', parseInt(e.target.value))} className="flex-1 h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-teal-500" disabled={!doc.enabled} />
                                                                    <span className="text-xs font-mono font-semibold text-teal-400 w-12">{String(combinedPercentages.new[doc.id] || 0)}%</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="col-span-2 flex justify-end gap-2">
                                                            <input type="date" value={doc.metadata?.date || ''} onChange={e => updateMetadata(doc.id, 'date', e.target.value)} className="px-2 py-1 text-xs bg-white/5 border border-white/10 backdrop-blur-md rounded text-white" />
                                                            <button onClick={() => deleteDocument(doc.id)} className="p-2 text-slate-500 hover:text-red-400 hover:bg-red-950/30 rounded">
                                                                <Trash className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="text-center mt-6">
                                            <button 
                                                onClick={analyze} 
                                                disabled={loading || !enabled} 
                                                className={`
                                                    relative px-10 py-4 rounded-2xl font-semibold text-base
                                                    flex items-center gap-3 mx-auto
                                                    transition-all duration-300 ease-out
                                                    ${loading 
                                                        ? 'bg-gradient-to-r from-white/10 via-white/15 to-white/10 text-slate-300 cursor-wait animate-pulse shadow-lg shadow-black/30' 
                                                        : enabled
                                                            ? 'bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500 hover:from-emerald-400 hover:via-teal-400 hover:to-cyan-400 text-white shadow-xl shadow-teal-500/30 hover:shadow-teal-400/40 hover:scale-[1.02] active:scale-[0.98]'
                                                            : 'bg-white/10 text-slate-500 cursor-not-allowed'
                                                    }
                                                `}
                                            >
                                                {loading ? (
                                                    <>
                                                        <div className="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin" />
                                                        <span>Analyzing<span className="animate-pulse">...</span></span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <TrendingUp className="w-5 h-5" />
                                                        <span>{currentTicker ? `Update ${currentTicker} Analysis` : 'Analyze Documents'}</span>
                                                    </>
                                                )}
                                            </button>
                                            {loading && (
                                                <p className="text-xs text-slate-500 mt-3 animate-pulse">This may take 1-2 minutes</p>
                                            )}
                                        </div>

                                        {error && (
                                            <div className={`mt-4 p-3 ${error.includes('Retry') ? 'bg-amber-950/30 border-amber-800 text-amber-400' : 'bg-red-950/30 border-red-800 text-red-400'} border rounded-lg text-sm`}>
                                                <div className="flex items-start gap-2">
                                                    <AlertTriangle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                                    <div className="flex-1">
                                                        <div>{error}</div>
                                                        {error.includes('failed') && !loading && (
                                                            <button 
                                                                onClick={analyze}
                                                                className="mt-2 px-4 py-1.5 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 text-white rounded text-sm font-medium"
                                                            >
                                                                Try Again
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {analysis && !showDocumentManager && !showHistory && (
                                    <div className="space-y-6">
                                        <div className="bg-gradient-to-br from-white/[0.07] to-white/[0.04] backdrop-blur-xl border border-white/10 rounded-xl p-6">
                                            <div className="flex justify-between items-start">
                                                {editingItem?.type === 'analysisHeader' ? (
                                                    <div className="space-y-3 flex-1 mr-4">
                                                        <input
                                                            type="text"
                                                            defaultValue={analysis.company}
                                                            id="edit-analysis-company"
                                                            placeholder="Company Name"
                                                            className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-2xl font-bold"
                                                            style={{ fontSize: '16px' }}
                                                        />
                                                        <input
                                                            type="text"
                                                            defaultValue={analysis.ticker}
                                                            id="edit-analysis-ticker"
                                                            placeholder="TICKER"
                                                            className="px-3 py-1.5 bg-white/5 border border-white/10 rounded-lg font-mono w-32"
                                                            style={{ fontSize: '16px' }}
                                                        />
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setEditingItem(null)} className="px-3 py-1.5 bg-white/10 rounded text-sm">Cancel</button>
                                                            <button 
                                                                onClick={() => {
                                                                    const newCompany = document.getElementById('edit-analysis-company').value;
                                                                    const newTicker = document.getElementById('edit-analysis-ticker').value.toUpperCase();
                                                                    setAnalysis(prev => ({ ...prev, company: newCompany, ticker: newTicker }));
                                                                    setEditingItem(null);
                                                                }}
                                                                className="px-3 py-1.5 bg-teal-600 rounded text-sm"
                                                            >
                                                                Save
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div 
                                                        className="cursor-pointer group"
                                                        onClick={() => setEditingItem({ type: 'analysisHeader' })}
                                                    >
                                                        <h2 className="text-2xl sm:text-3xl font-bold mb-2 flex items-center gap-2">
                                                            {safeStr(analysis.company, 'Unknown Company')}
                                                            <Edit className="w-4 h-4 text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                        </h2>
                                                        <div className="flex flex-wrap gap-2 text-sm items-center">
                                                            <span className="px-3 py-1 bg-teal-500/20 text-teal-300 rounded-full font-mono">{safeStr(analysis.ticker, 'N/A')}</span>
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    if (analysis.documentHistory?.length > 0) {
                                                                        alert(`Documents used in ${analysis.ticker} analysis:\n\n${analysis.documentHistory.map((d, i) => `${i+1}. ${d.filename} (${d.type}, ${d.date})`).join('\n')}`);
                                                                    }
                                                                }}
                                                                className={`text-slate-400 hover:text-teal-400 transition ${analysis.documentHistory?.length > 0 ? 'cursor-pointer underline' : ''}`}
                                                            >
                                                                {analysis.documentHistory?.length || 0} docs
                                                            </button>
                                                        </div>
                                                        <p className="text-xs text-slate-500 mt-1">
                                                            Updated {formatNYTime(analysis.updatedAt)}
                                                            {analysis.history?.length > 0 && ` ‚Ä¢ ${analysis.history.length} version${analysis.history.length > 1 ? 's' : ''}`}
                                                        </p>
                                                    </div>
                                                )}
                                                <div className="flex items-center gap-1">
                                                    {analysis.history?.length > 0 && !editingItem?.type && (
                                                        <button 
                                                            onClick={() => setShowHistory(true)}
                                                            className="p-2 text-slate-400 hover:text-teal-400 hover:bg-white/10 rounded-lg"
                                                            title="View version history"
                                                        >
                                                            <History className="w-5 h-5" />
                                                        </button>
                                                    )}
                                                    {!editingItem?.type && (
                                                        <button
                                                            onClick={toggleAllPortfolioSections}
                                                            className="p-2 text-slate-400 hover:text-teal-400 hover:bg-white/10 rounded-lg"
                                                            title={allPortfolioSectionsExpanded ? "Collapse All" : "Expand All"}
                                                        >
                                                            {allPortfolioSectionsExpanded ? <ChevronsUp className="w-5 h-5" /> : <ChevronsDown className="w-5 h-5" />}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {changes.length > 0 && (
                                            <div className="bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-xl overflow-hidden">
                                                <button onClick={() => setExpanded(e => ({...e, changes: !e.changes}))} className="w-full px-6 py-4 flex justify-between hover:bg-white/[0.04]">
                                                    <div className="flex gap-3">
                                                        <AlertTriangle className="text-amber-400" />
                                                        <div className="text-left">
                                                            <h3 className="font-bold">Changes</h3>
                                                            <p className="text-xs text-slate-400">{changes.length} updates</p>
                                                        </div>
                                                    </div>
                                                    <ChevronDown className={`w-5 h-5 transition ${expanded.changes ? 'rotate-180' : ''}`} />
                                                </button>
                                                {expanded.changes && (
                                                    <div className="px-6 pb-6">
                                                        <ul className="space-y-3">
                                                            {safeArray(changes).map((c, i) => (
                                                                <li key={i} className="text-sm flex gap-2">
                                                                    <span className="text-amber-400 flex-shrink-0">‚Üí</span>
                                                                    <div>
                                                                        {typeof c === 'object' && c !== null ? (
                                                                            <>
                                                                                <span className="font-medium text-amber-300">{safeStr(c.category, 'Update')}: </span>
                                                                                <span className="text-slate-300">{safeStr(c.description, safeStr(c))}</span>
                                                                            </>
                                                                        ) : (
                                                                            <span className="text-slate-300">{safeStr(c)}</span>
                                                                        )}
                                                                    </div>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        <div className="bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-xl overflow-hidden">
                                            <button onClick={() => setExpanded(e => ({...e, thesis: !e.thesis}))} className="w-full px-6 py-4 flex justify-between hover:bg-white/[0.04]">
                                                <div className="flex gap-3">
                                                    <Target className="text-teal-400" />
                                                    <h3 className="font-bold">Investment Thesis</h3>
                                                </div>
                                                <ChevronDown className={`w-5 h-5 transition ${expanded.thesis ? 'rotate-180' : ''}`} />
                                            </button>
                                            {expanded.thesis && (
                                                <div className="px-4 sm:px-6 pb-6">
                                                    <div className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-3 sm:p-4 mb-4 border-l-4 border-teal-500 relative group">
                                                        {editingItem?.type === 'thesis-summary' ? (
                                                            <div className="space-y-3">
                                                                <textarea 
                                                                    defaultValue={analysis.thesis?.summary}
                                                                    onBlur={e => editAnalysisField('thesis-summary', null, null, e.target.value)}
                                                                    rows="8"
                                                                    className="w-full text-sm sm:text-base bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 rounded-lg px-3 py-2 resize-none leading-relaxed"
                                                                    autoFocus
                                                                    placeholder="Describe the core investment thesis..."
                                                                />
                                                                <button 
                                                                    onClick={() => setEditingItem(null)} 
                                                                    className="w-full px-4 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-base font-medium"
                                                                >
                                                                    Done
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <div className="pr-10 sm:pr-0">
                                                                <p className="text-xs sm:text-sm text-slate-200 leading-relaxed">{safeStr(analysis.thesis?.summary, 'No summary available')}</p>
                                                                <button 
                                                                    onClick={() => setEditingItem({type: 'thesis-summary'})}
                                                                    className="absolute top-2 right-2 p-1.5 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded transition"
                                                                >
                                                                    <Edit className="w-3 h-3" />
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    {safeArray(analysis.thesis?.pillars).map((p, i) => (
                                                        <div key={i} className="bg-white/[0.07] backdrop-blur-lg rounded-lg p-3 sm:p-4 mb-3 border border-white/10 relative group">
                                                            {/* Absolute positioned edit/delete buttons */}
                                                            {!(editingItem?.type === 'thesis-pillar' && editingItem?.index === i) && (
                                                                <div className="absolute top-2 right-2 flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition z-10">
                                                                    <button onClick={() => setEditingItem({type: 'thesis-pillar', index: i})} className="p-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded">
                                                                        <Edit className="w-3 h-3" />
                                                                    </button>
                                                                    <button onClick={() => deleteAnalysisItem('pillar', i)} className="p-1.5 bg-red-950/50 hover:bg-red-950 rounded text-red-400">
                                                                        <X className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                            )}
                                                            <div className="flex gap-2 sm:gap-3">
                                                                <div className="w-7 h-7 sm:w-8 sm:h-8 bg-emerald-500/20 text-teal-400 rounded-full flex items-center justify-center font-bold text-xs sm:text-sm flex-shrink-0">{i+1}</div>
                                                                <div className="flex-1 min-w-0 pr-12 sm:pr-0">
                                                                    {editingItem?.type === 'thesis-pillar' && editingItem?.index === i ? (
                                                                        <div className="space-y-3">
                                                                            <textarea 
                                                                                defaultValue={p.title}
                                                                                placeholder="Pillar Title"
                                                                                onBlur={e => editAnalysisField('thesis-pillar', i, 'title', e.target.value)}
                                                                                rows="2"
                                                                                className="w-full text-base sm:text-lg bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-100 font-semibold focus:outline-none focus:ring-2 focus:ring-emerald-500 rounded-lg px-3 py-2 resize-none"
                                                                            />
                                                                            <textarea 
                                                                                defaultValue={p.description}
                                                                                placeholder="Description"
                                                                                onBlur={e => editAnalysisField('thesis-pillar', i, 'description', e.target.value)}
                                                                                rows="6"
                                                                                className="w-full text-sm sm:text-base bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 rounded-lg px-3 py-2 resize-none leading-relaxed"
                                                                            />
                                                                            <button 
                                                                                onClick={() => setEditingItem(null)} 
                                                                                className="w-full px-4 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-base font-medium"
                                                                            >
                                                                                Done
                                                                            </button>
                                                                        </div>
                                                                    ) : (
                                                                        <>
                                                                            <h5 className="font-semibold mb-1 sm:mb-2 text-sm sm:text-base">{safeStr(p.title, 'Untitled Pillar')}</h5>
                                                                            <p className="text-xs sm:text-sm text-slate-300 mb-2 sm:mb-3 leading-relaxed">{safeStr(p.description)}</p>
                                                                            <div className="flex flex-wrap gap-2 text-xs">
                                                                                {p.confidence && <span className="px-2 py-0.5 bg-white/[0.04] rounded">Confidence: <span className={safeStr(p.confidence) === 'High' ? 'text-teal-400' : safeStr(p.confidence) === 'Medium' ? 'text-amber-400' : 'text-slate-400'}>{safeStr(p.confidence)}</span></span>}
                                                                                <button 
                                                                                    onClick={() => setShowSourcesPopup({type: 'pillar', index: i, sources: p.sources || [], title: p.title})}
                                                                                    className="px-2 py-0.5 bg-white/[0.04] hover:bg-white/10 rounded cursor-pointer transition"
                                                                                >
                                                                                    Sources: {p.sources?.length || p.source_count || 1}
                                                                                </button>
                                                                            </div>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-xl overflow-hidden">
                                            <button onClick={() => setExpanded(e => ({...e, signposts: !e.signposts}))} className="w-full px-6 py-4 flex justify-between hover:bg-white/[0.04]">
                                                <div className="flex gap-3">
                                                    <TrendingUp className="text-teal-400" />
                                                    <h3 className="font-bold">Signposts</h3>
                                                </div>
                                                <ChevronDown className={`w-5 h-5 transition ${expanded.signposts ? 'rotate-180' : ''}`} />
                                            </button>
                                            {expanded.signposts && (
                                                <div className="px-4 sm:px-6 pb-6">
                                                    {safeArray(analysis.signposts).map((s, i) => (
                                                        <div key={i} className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-3 sm:p-4 mb-3 border-l-4 border-blue-500 relative group">
                                                            {/* Absolute buttons - only show when not editing */}
                                                            {!(editingItem?.type === 'signpost' && editingItem?.index === i) && (
                                                                <div className="absolute top-2 right-2 flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition z-10">
                                                                    <button onClick={() => setEditingItem({type: 'signpost', index: i})} className="p-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded">
                                                                        <Edit className="w-3 h-3" />
                                                                    </button>
                                                                    <button onClick={() => deleteAnalysisItem('signpost', i)} className="p-1.5 bg-red-950/50 hover:bg-red-950 rounded text-red-400">
                                                                        <X className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                            )}
                                                            {editingItem?.type === 'signpost' && editingItem?.index === i ? (
                                                                <div className="space-y-3">
                                                                    <textarea 
                                                                        defaultValue={s.metric || s.signpost}
                                                                        placeholder="Metric/KPI" 
                                                                        onBlur={e => editAnalysisField('signpost', i, 'metric', e.target.value)} 
                                                                        rows="2"
                                                                        className="w-full text-base sm:text-lg bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-200 font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg px-3 py-2 resize-none" 
                                                                    />
                                                                    <div>
                                                                        <div className="text-xs text-slate-400 mb-1">Target:</div>
                                                                        <textarea 
                                                                            defaultValue={s.target}
                                                                            placeholder="Target value..." 
                                                                            onBlur={e => editAnalysisField('signpost', i, 'target', e.target.value)} 
                                                                            rows="3"
                                                                            className="w-full text-sm bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg px-3 py-2 resize-none"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-slate-400 mb-1">Timeframe:</div>
                                                                        <textarea 
                                                                            defaultValue={s.timeframe}
                                                                            placeholder="When..." 
                                                                            onBlur={e => editAnalysisField('signpost', i, 'timeframe', e.target.value)} 
                                                                            rows="1"
                                                                            className="w-full text-sm bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg px-3 py-2 resize-none" 
                                                                        />
                                                                    </div>
                                                                    <button 
                                                                        onClick={() => setEditingItem(null)} 
                                                                        className="w-full px-4 py-3 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-base font-medium"
                                                                    >
                                                                        Done
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <div className="pr-12 sm:pr-0">
                                                                    <div className="flex flex-wrap items-start justify-between gap-2 mb-2">
                                                                        <h5 className="font-semibold text-sm sm:text-base flex-1">{safeStr(s.metric || s.signpost, 'Untitled Signpost')}</h5>
                                                                        <span className="text-xs px-2 py-0.5 bg-teal-500/20 text-teal-300 rounded">{safeStr(s.category, 'Other')}</span>
                                                                    </div>
                                                                    <p className="text-xs sm:text-sm text-slate-300 mb-1"><strong>Target:</strong> {safeStr(s.target)}</p>
                                                                    <p className="text-xs sm:text-sm text-slate-300 mb-2"><strong>Timeframe:</strong> {safeStr(s.timeframe)}</p>
                                                                    <div className="flex flex-wrap gap-2 text-xs">
                                                                        {s.confidence && <span className="px-2 py-0.5 bg-white/[0.04] rounded">Confidence: <span className={safeStr(s.confidence) === 'High' ? 'text-teal-400' : safeStr(s.confidence) === 'Medium' ? 'text-amber-400' : 'text-slate-400'}>{safeStr(s.confidence)}</span></span>}
                                                                        <button 
                                                                            onClick={() => setShowSourcesPopup({type: 'signpost', index: i, sources: s.sources || [], title: s.metric || s.signpost})}
                                                                            className="px-2 py-0.5 bg-white/[0.04] hover:bg-white/10 rounded cursor-pointer transition"
                                                                        >
                                                                            Sources: {s.sources?.length || s.source_count || 1}
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-xl overflow-hidden">
                                            <button onClick={() => setExpanded(e => ({...e, threats: !e.threats}))} className="w-full px-6 py-4 flex justify-between hover:bg-white/[0.04]">
                                                <div className="flex gap-3">
                                                    <AlertTriangle className="text-red-400" />
                                                    <h3 className="font-bold">Thesis Threats</h3>
                                                </div>
                                                <ChevronDown className={`w-5 h-5 transition ${expanded.threats ? 'rotate-180' : ''}`} />
                                            </button>
                                            {expanded.threats && (
                                                <div className="px-4 sm:px-6 pb-6">
                                                    {safeArray(analysis.threats).map((t, i) => (
                                                        <div key={i} className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-3 sm:p-4 mb-3 border-l-4 border-red-500 relative group">
                                                            {/* Absolute buttons - only show when not editing */}
                                                            {!(editingItem?.type === 'threat' && editingItem?.index === i) && (
                                                                <div className="absolute top-2 right-2 flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition z-10">
                                                                    <button onClick={() => setEditingItem({type: 'threat', index: i})} className="p-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded">
                                                                        <Edit className="w-3 h-3" />
                                                                    </button>
                                                                    <button onClick={() => deleteAnalysisItem('threat', i)} className="p-1.5 bg-red-950/50 hover:bg-red-950 rounded text-red-400">
                                                                        <X className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                            )}
                                                            {editingItem?.type === 'threat' && editingItem?.index === i ? (
                                                                <div className="space-y-3">
                                                                    <textarea 
                                                                        defaultValue={t.threat} 
                                                                        placeholder="Threat description..." 
                                                                        onBlur={e => editAnalysisField('threat', i, 'threat', e.target.value)} 
                                                                        rows="2"
                                                                        className="w-full text-base sm:text-lg bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-200 font-semibold focus:outline-none focus:ring-2 focus:ring-red-500 rounded-lg px-3 py-2 resize-none" 
                                                                    />
                                                                    <div className="grid grid-cols-2 gap-3">
                                                                        <div>
                                                                            <div className="text-xs text-slate-400 mb-1">Likelihood:</div>
                                                                            <select 
                                                                                defaultValue={t.likelihood} 
                                                                                onChange={e => editAnalysisField('threat', i, 'likelihood', e.target.value)} 
                                                                                className="w-full px-3 py-2 text-sm bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-lg text-slate-200 focus:border-red-500 outline-none"
                                                                            >
                                                                                <option value="Low">Low</option>
                                                                                <option value="Medium">Medium</option>
                                                                                <option value="High">High</option>
                                                                            </select>
                                                                        </div>
                                                                        <div>
                                                                            <div className="text-xs text-slate-400 mb-1">Impact:</div>
                                                                            <select 
                                                                                defaultValue={t.impact} 
                                                                                onChange={e => editAnalysisField('threat', i, 'impact', e.target.value)} 
                                                                                className="w-full px-3 py-2 text-sm bg-white/[0.04] backdrop-blur-lg border border-white/10 rounded-lg text-slate-200 focus:border-red-500 outline-none"
                                                                            >
                                                                                <option value="Low">Low</option>
                                                                                <option value="Medium">Medium</option>
                                                                                <option value="High">High</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <textarea 
                                                                        defaultValue={t.triggerPoints} 
                                                                        placeholder="What to watch for..." 
                                                                        onBlur={e => editAnalysisField('threat', i, 'triggerPoints', e.target.value)} 
                                                                        rows="4"
                                                                        className="w-full text-sm bg-white/[0.04] backdrop-blur-lg border border-white/10 text-slate-300 focus:outline-none focus:ring-2 focus:ring-red-500 rounded-lg px-3 py-2 resize-none" 
                                                                    />
                                                                    <button 
                                                                        onClick={() => setEditingItem(null)} 
                                                                        className="w-full px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg text-base font-medium"
                                                                    >
                                                                        Done
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <div className="pr-12 sm:pr-0">
                                                                    <h5 className="font-semibold mb-2 text-sm sm:text-base">{safeStr(t.threat, 'Untitled Threat')}</h5>
                                                                    {(t.likelihood || t.impact) && (
                                                                        <div className="flex flex-wrap gap-x-4 gap-y-1 mb-2 text-xs sm:text-sm">
                                                                            {t.likelihood && <div><span className="text-slate-400">Likelihood:</span> <span className={safeStr(t.likelihood) === 'High' ? 'text-red-400' : 'text-amber-400'}>{safeStr(t.likelihood)}</span></div>}
                                                                            {t.impact && <div><span className="text-slate-400">Impact:</span> <span className={safeStr(t.impact) === 'High' ? 'text-red-400' : 'text-amber-400'}>{safeStr(t.impact)}</span></div>}
                                                                        </div>
                                                                    )}
                                                                    {t.triggerPoints && <p className="text-xs sm:text-sm text-slate-300 leading-relaxed mb-2"><span className="text-slate-400">Watch for:</span> {safeStr(t.triggerPoints)}</p>}
                                                                    {t.mitigation && !t.triggerPoints && <p className="text-xs sm:text-sm text-slate-300 leading-relaxed mb-2"><span className="text-slate-400">Mitigation:</span> {safeStr(t.mitigation)}</p>}
                                                                    <div className="flex flex-wrap gap-2 text-xs">
                                                                        <button 
                                                                            onClick={() => setShowSourcesPopup({type: 'threat', index: i, sources: t.sources || [], title: t.threat})}
                                                                            className="px-2 py-0.5 bg-white/[0.04] hover:bg-white/10 rounded cursor-pointer transition"
                                                                        >
                                                                            Sources: {t.sources?.length || t.source_count || 1}
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {showSaveDialog && analysis && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-slate-900/90 backdrop-blur-2xl border border-white/10 rounded-xl p-6 max-w-md w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Save Analysis</h3>
                                <p className="text-sm text-slate-300 mb-4">Save <span className="font-mono font-bold text-teal-400">{analysis.ticker}</span> to portfolio?</p>
                                <div className="flex gap-3">
                                    <button onClick={saveCurrentAnalysis} className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 rounded-lg font-medium">Save</button>
                                    <button onClick={() => setShowSaveDialog(false)} className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg font-medium">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Sources Popup */}
                    {showSourcesPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowSourcesPopup(null)}>
                            <div className="bg-slate-900/90 backdrop-blur-2xl border border-white/10 rounded-xl w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-white/10 flex justify-between items-center">
                                    <h3 className="text-lg font-bold flex items-center gap-2">
                                        <FileText className="text-teal-400 w-5 h-5" />
                                        Sources
                                    </h3>
                                    <button 
                                        onClick={() => setShowSourcesPopup(null)}
                                        className="p-2 hover:bg-white/10 rounded"
                                    >
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="p-4 overflow-y-auto">
                                    <p className="text-sm text-slate-400 mb-3">{safeStr(showSourcesPopup.title, 'Source')}</p>
                                    {showSourcesPopup.sources && showSourcesPopup.sources.length > 0 ? (
                                        <div className="space-y-3">
                                            {safeArray(showSourcesPopup.sources).map((source, idx) => {
                                                // Generate display name for source - show full name without truncation
                                                let sourceFilename = '';
                                                if (typeof source === 'string') {
                                                    sourceFilename = source;
                                                } else if (source) {
                                                    sourceFilename = String(source.filename || source.name || source.document || '');
                                                }
                                                
                                                // Build full display name without truncation for Sources popup
                                                let displayName = '';
                                                if (source?.displayName && typeof source.displayName === 'string') {
                                                    displayName = source.displayName;
                                                } else if (sourceFilename) {
                                                    // Clean up filename
                                                    displayName = sourceFilename
                                                        .replace(/\.(pdf|docx?|xlsx?|png|jpe?g|gif|webp|eml|msg|txt|html)$/i, '')
                                                        .replace(/[-_]?[a-f0-9]{24,}$/i, '')
                                                        .replace(/[-_]?SSRFS[-_]?\d*[-_]?[a-f0-9-]+$/i, '')
                                                        .replace(/[-_]?ASR[-_][A-Z]+[-_][a-f0-9]+$/i, '')
                                                        .replace(/[-_][a-f0-9]{12,}$/i, '')
                                                        .replace(/\s*[-‚Äì]+\s*/g, ' - ')
                                                        .replace(/\s+/g, ' ')
                                                        .trim();
                                                }
                                                
                                                // Add source/date suffix if available
                                                const sourceInfo = source?.source || source?.broker || '';
                                                const dateInfo = source?.date || '';
                                                if (sourceInfo || dateInfo) {
                                                    const suffix = [sourceInfo, dateInfo].filter(Boolean).join(', ');
                                                    if (suffix && !displayName.includes(suffix)) {
                                                        displayName = displayName ? `${displayName} (${suffix})` : suffix;
                                                    }
                                                }
                                                
                                                return (
                                                <div key={idx} className="bg-white/[0.07] backdrop-blur-lg border border-white/10 rounded-lg p-4">
                                                    <div className="flex items-start gap-3">
                                                        <div className="w-7 h-7 bg-teal-500/20 text-teal-400 rounded flex items-center justify-center text-sm font-bold flex-shrink-0">
                                                            {idx + 1}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm font-medium text-slate-200 leading-relaxed">
                                                                {displayName || `Document ${idx + 1}`}
                                                            </p>
                                                            {source.excerpt && typeof source.excerpt === 'string' && (
                                                                <p className="text-xs text-slate-400 mt-2 leading-relaxed italic">"{source.excerpt}"</p>
                                                            )}
                                                            {source.page && (
                                                                <p className="text-xs text-slate-500 mt-1">Page {String(source.page)}</p>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            )})}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8">
                                            <FileText className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                                            <p className="text-slate-400 text-sm">Source details not available</p>
                                            <p className="text-slate-500 text-xs mt-1">This point was synthesized from the uploaded documents</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Version History Panel */}
                    {showHistory && analysis && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-900/90 backdrop-blur-2xl border border-white/10 rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                                <div className="p-4 border-b border-white/10 flex justify-between items-center">
                                    <h3 className="text-lg font-bold flex items-center gap-2">
                                        <History className="text-teal-400" />
                                        Version History - {analysis.ticker}
                                    </h3>
                                    <button 
                                        onClick={() => { setShowHistory(false); setSelectedHistoryVersion(null); }}
                                        className="p-2 hover:bg-white/10 rounded"
                                    >
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-hidden flex flex-col sm:flex-row">
                                    {/* Version List */}
                                    <div className="w-full sm:w-64 border-b sm:border-b-0 sm:border-r border-white/10 overflow-y-auto max-h-48 sm:max-h-none">
                                        <div className="p-2">
                                            <div className="text-xs text-slate-500 px-3 py-2 uppercase font-medium">Past Versions</div>
                                            {(!analysis.history || analysis.history.length === 0) ? (
                                                <div className="text-sm text-slate-500 text-center py-8 px-4">
                                                    No history yet. History is saved when you update an existing analysis.
                                                </div>
                                            ) : (
                                                analysis.history.slice().reverse().map((v, i) => (
                                                    <button
                                                        key={i}
                                                        onClick={() => setSelectedHistoryVersion(v)}
                                                        className={`w-full text-left p-3 rounded-lg mb-1 transition ${
                                                            selectedHistoryVersion === v 
                                                                ? 'bg-teal-600' 
                                                                : 'hover:bg-white/10'
                                                        }`}
                                                    >
                                                        <div className="font-medium text-sm">
                                                            {formatNYTime(v.timestamp)}
                                                        </div>
                                                        <div className="text-xs text-slate-500 mt-1">
                                                            {v.thesis?.pillars?.length || 0} pillars, {v.signposts?.length || 0} signposts
                                                        </div>
                                                    </button>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Version Detail */}
                                    <div className="flex-1 overflow-y-auto p-4">
                                        {selectedHistoryVersion ? (
                                            <div className="space-y-4">
                                                <div className="flex justify-between items-center mb-4">
                                                    <div>
                                                        <div className="font-bold">
                                                            {formatNYTime(selectedHistoryVersion.timestamp)}
                                                        </div>
                                                        <div className="text-xs text-slate-400">
                                                            Saved {Math.round((Date.now() - new Date(selectedHistoryVersion.timestamp)) / (1000 * 60 * 60 * 24))} days ago
                                                        </div>
                                                    </div>
                                                    <button 
                                                        onClick={() => restoreHistoryVersion(selectedHistoryVersion)}
                                                        className="px-4 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm font-medium flex items-center gap-2"
                                                    >
                                                        <RotateCcw className="w-4 h-4" />
                                                        Restore This Version
                                                    </button>
                                                </div>
                                                
                                                {/* Thesis Summary */}
                                                <div className="bg-white/[0.07] backdrop-blur-lg rounded-lg p-4 border-l-4 border-teal-500">
                                                    <h4 className="font-semibold text-teal-400 mb-2 text-sm">Thesis Summary</h4>
                                                    <p className="text-sm text-slate-300">{safeStr(selectedHistoryVersion.thesis?.summary)}</p>
                                                </div>
                                                
                                                {/* Pillars */}
                                                <div>
                                                    <h4 className="font-semibold text-teal-400 mb-2 text-sm">Thesis Pillars ({selectedHistoryVersion.thesis?.pillars?.length || 0})</h4>
                                                    <div className="space-y-2">
                                                        {safeArray(selectedHistoryVersion.thesis?.pillars).map((p, i) => (
                                                            <div key={i} className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-3 border border-white/10">
                                                                <div className="font-medium text-sm">{i+1}. {safeStr(p.title)}</div>
                                                                <div className="text-xs text-slate-400 mt-1 line-clamp-2">{safeStr(p.description)}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                {/* Signposts */}
                                                <div>
                                                    <h4 className="font-semibold text-teal-400 mb-2 text-sm">Signposts ({selectedHistoryVersion.signposts?.length || 0})</h4>
                                                    <div className="space-y-2">
                                                        {safeArray(selectedHistoryVersion.signposts).map((s, i) => (
                                                            <div key={i} className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-3 border-l-4 border-blue-500">
                                                                <div className="font-medium text-sm">{safeStr(s.metric)}</div>
                                                                <div className="text-xs text-slate-400">Target: {safeStr(s.target)}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                {/* Threats */}
                                                <div>
                                                    <h4 className="font-semibold text-red-400 mb-2 text-sm">Threats ({selectedHistoryVersion.threats?.length || 0})</h4>
                                                    <div className="space-y-2">
                                                        {safeArray(selectedHistoryVersion.threats).map((t, i) => (
                                                            <div key={i} className="bg-white/[0.04] backdrop-blur-lg rounded-lg p-3 border-l-4 border-red-500">
                                                                <div className="font-medium text-sm">{safeStr(t.threat)}</div>
                                                                <div className="text-xs text-slate-400">
                                                                    Likelihood: {safeStr(t.likelihood)} | Impact: {safeStr(t.impact)}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex items-center justify-center h-full text-slate-500">
                                                <div className="text-center">
                                                    <History className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                                    <p>Select a version to view details</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showEmailDialog && analysis && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-slate-900/90 backdrop-blur-2xl border border-white/10 rounded-xl p-6 max-w-lg w-full mx-4">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                                    <Mail className="text-purple-400" />
                                    Email Investment Summary
                                </h3>
                                <p className="text-sm text-slate-300 mb-4">
                                    Send formatted report for <span className="font-mono font-bold text-purple-400">{analysis.ticker}</span>
                                </p>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Recipient Email</label>
                                        <input 
                                            type="email"
                                            value={emailData.email}
                                            onChange={e => setEmailData({...emailData, email: e.target.value})}
                                            placeholder="you@example.com"
                                            className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-white focus:border-purple-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-2">
                                            Subject Line 
                                            <span className="text-xs text-slate-400 font-normal ml-2">(optional - default: Investment Summary: {analysis.ticker} - {analysis.company})</span>
                                        </label>
                                        <input 
                                            type="text"
                                            value={emailData.customSubject}
                                            onChange={e => setEmailData({...emailData, customSubject: e.target.value})}
                                            placeholder={`Investment Summary: ${analysis.ticker} - ${analysis.company}`}
                                            className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-white focus:border-purple-500 outline-none"
                                        />
                                    </div>

                                    <div className="border-t border-white/10 pt-4">
                                        <label className="flex items-center gap-2 text-sm mb-3">
                                            <input 
                                                type="checkbox"
                                                checked={emailData.useGmail}
                                                onChange={e => setEmailData({...emailData, useGmail: e.target.checked})}
                                                className="w-4 h-4"
                                            />
                                            <span>Use Gmail SMTP (requires app password)</span>
                                        </label>
                                        
                                        {emailData.useGmail && (
                                            <div className="space-y-3 ml-6">
                                                <div>
                                                    <label className="block text-xs text-slate-400 mb-1">Gmail Address</label>
                                                    <input 
                                                        type="email"
                                                        value={emailData.gmailUser}
                                                        onChange={e => setEmailData({...emailData, gmailUser: e.target.value})}
                                                        placeholder="your.gmail@gmail.com"
                                                        className="w-full px-3 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded text-sm text-white focus:border-purple-500 outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-slate-400 mb-1">App Password</label>
                                                    <input 
                                                        type="password"
                                                        value={emailData.gmailPassword}
                                                        onChange={e => setEmailData({...emailData, gmailPassword: e.target.value})}
                                                        placeholder="16-character app password"
                                                        className="w-full px-3 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded text-sm text-white focus:border-purple-500 outline-none"
                                                    />
                                                    <p className="text-xs text-slate-500 mt-1">
                                                        Get app password at: <a href="https://myaccount.google.com/apppasswords" target="_blank" className="text-purple-400 hover:underline">myaccount.google.com/apppasswords</a>
                                                    </p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {error && (
                                        <div className="p-3 bg-red-950/30 border border-red-800 rounded-lg text-red-400 text-sm">
                                            {error}
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={sendEmail} 
                                        disabled={loading || !emailData.email}
                                        className="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-white/10 rounded-lg font-medium flex items-center justify-center gap-2"
                                    >
                                        {loading ? <><Loader />Sending...</> : <><Mail />Send Email</>}
                                    </button>
                                    <button 
                                        onClick={() => {setShowEmailDialog(false); setError(null);}} 
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>

                                <div className="mt-4 p-3 bg-white/[0.07] backdrop-blur-lg rounded-lg text-xs text-slate-400">
                                    <p className="font-semibold mb-1">Email Format:</p>
                                    <ul className="list-disc ml-4 space-y-0.5">
                                        <li>Investment Thesis (4-5 bullets)</li>
                                        <li>Signposts (4-5 forward-looking KPIs)</li>
                                        <li>Thesis Threats (4-5 bear case scenarios)</li>
                                    </ul>
                                </div>

                                {(emailData.gmailUser || emailData.email) && (
                                    <div className="mt-3 flex items-center justify-between text-xs">
                                        <span className="text-amber-400">‚úì Credentials saved for next time</span>
                                        <button 
                                            onClick={() => {
                                                localStorage.removeItem('emailCredentials');
                                                setEmailData({ email: '', useGmail: false, gmailUser: '', gmailPassword: '', customSubject: '' });
                                            }}
                                            className="text-slate-400 hover:text-red-400 underline"
                                        >
                                            Clear saved credentials
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                            </div>
                        )}

                        {/* CHAT TAB */}
                        {activeTab === 'chat' && (
                            <div className="flex-1 flex overflow-hidden pb-24 md:pb-0 relative">
                                {/* Chat History Sidebar Overlay */}
                                {showChatSidebar && (
                                    <div 
                                        className="fixed inset-0 bg-black/50 z-40 md:hidden" 
                                        onClick={() => setShowChatSidebar(false)}
                                    />
                                )}
                                
                                {/* Chat History Sidebar */}
                                <div className={`${showChatSidebar ? 'fixed left-0 top-0 bottom-0 z-50 w-72 flex' : 'hidden'} md:relative md:flex md:w-64 bg-white/5 backdrop-blur-xl border-r border-white/10 flex-col flex-shrink-0 h-full`}>
                                    <div className="p-4 border-b border-white/[0.08] flex items-center justify-between flex-shrink-0">
                                        <span className="font-semibold">Chat History</span>
                                        <button onClick={() => setShowChatSidebar(false)} className="md:hidden p-1 hover:bg-white/10 rounded">
                                            <X className="w-5 h-5" />
                                        </button>
                                    </div>
                                    
                                    {/* New Chat Button */}
                                    <div className="p-3 border-b border-white/[0.08] flex-shrink-0">
                                        <button
                                            onClick={startNewChat}
                                            className="w-full px-4 py-2.5 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 rounded-lg font-medium flex items-center justify-center gap-2 shadow-lg shadow-teal-500/30"
                                        >
                                            <Plus className="w-4 h-4" />
                                            New Chat
                                        </button>
                                    </div>
                                    
                                    {/* Chat History List */}
                                    <div className="flex-1 overflow-y-auto p-3 min-h-0">
                                        {chatHistories.length === 0 ? (
                                            <div className="text-sm text-slate-500 text-center py-4">
                                                No chat history yet
                                            </div>
                                        ) : (
                                            <div className="space-y-1">
                                                {chatHistories.map(chat => (
                                                    <div
                                                        key={chat.id}
                                                        onClick={() => loadChatFromHistory(chat)}
                                                        className={`p-3 rounded-lg cursor-pointer transition-all group ${
                                                            currentChatId === chat.id
                                                                ? 'bg-teal-600/20 border border-teal-500/50'
                                                                : 'bg-white/[0.04] hover:bg-white/[0.08]'
                                                        }`}
                                                    >
                                                        <div className="flex items-start justify-between gap-2">
                                                            <div className="flex-1 min-w-0">
                                                                <div className="text-sm font-medium truncate">{safeStr(chat.title, 'Untitled Chat')}</div>
                                                                <div className="text-xs text-slate-500">
                                                                    {formatNYTime(chat.updatedAt)}
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={(e) => deleteChatFromHistory(chat.id, e)}
                                                                className="p-1 opacity-0 group-hover:opacity-100 hover:text-red-400 transition-opacity"
                                                            >
                                                                <Trash className="w-3.5 h-3.5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Main Chat Area */}
                                <div className="flex-1 flex flex-col bg-white/[0.02]">
                                    {/* Chat Header */}
                                    <div className="p-3 border-b border-white/[0.08] flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => setShowChatSidebar(true)}
                                                className="p-2 hover:bg-white/10 rounded-lg md:hidden"
                                            >
                                                <Menu className="w-5 h-5" />
                                            </button>
                                            <MessageCircle className="w-5 h-5 text-teal-400" />
                                            <span className="font-semibold">Charlie</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={startNewChat}
                                                className="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-teal-400"
                                                title="New Chat"
                                            >
                                                <Plus className="w-5 h-5" />
                                            </button>
                                            <button
                                                onClick={() => window.open(CHAT_URL, '_blank')}
                                                className="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-teal-400"
                                                title="Open in new window"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <ChatInterface 
                                        chatUrl={CHAT_URL} 
                                        messages={chatMessages}
                                        setMessages={setChatMessages}
                                        sessionId={currentChatId}
                                        onSaveToOverview={saveToOverview}
                                    />
                                </div>
                            </div>
                        )}

                        {/* OVERVIEW TAB */}
                        {activeTab === 'overview' && (
                            <div className="flex-1 flex flex-col overflow-hidden pb-24 md:pb-0">
                                {/* Horizontal Stock Tabs */}
                                <div className="bg-white/[0.04] backdrop-blur-lg border-b border-white/[0.08] flex-shrink-0 p-3 space-y-2">
                                    {/* Search Box - show if more than 5 stocks */}
                                    {savedOverviews.length > 5 && (
                                        <div className="flex items-center gap-2">
                                            <FileText className="w-5 h-5 text-teal-400 flex-shrink-0" />
                                            <div className="flex-1 relative">
                                                <div className="relative">
                                                    <input
                                                        type="text"
                                                        value={stockSearch}
                                                        onChange={(e) => setStockSearch(e.target.value)}
                                                        placeholder="Search overviews..."
                                                        className="w-full pl-9 pr-8 py-2 bg-white/[0.07] border border-white/10 rounded-xl text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500/50 focus:border-teal-500"
                                                        style={{ fontSize: '16px' }}
                                                    />
                                                    <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                                                        <circle cx="11" cy="11" r="8"/>
                                                        <path d="m21 21-4.35-4.35"/>
                                                    </svg>
                                                    {stockSearch && (
                                                        <button
                                                            onMouseDown={(e) => {
                                                                e.preventDefault();
                                                                setStockSearch('');
                                                            }}
                                                            className="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-white/10 rounded"
                                                        >
                                                            <X className="w-3 h-3 text-slate-500" />
                                                        </button>
                                                    )}
                                                </div>
                                                
                                                {/* Dropdown */}
                                                {stockSearch.length > 0 && getFilteredStocks(stockSearch, savedOverviews).length > 0 && (
                                                    <div className="absolute top-full left-0 right-0 mt-1 bg-white/5 border border-white/10 backdrop-blur-md rounded-xl shadow-xl z-50 overflow-hidden">
                                                        {getFilteredStocks(stockSearch, savedOverviews).map((s, idx) => (
                                                            <button
                                                                key={safeStr(s.ticker, idx)}
                                                                onMouseDown={(e) => {
                                                                    e.preventDefault();
                                                                    handleStockSearchSelect(s.ticker, true);
                                                                }}
                                                                className="w-full px-4 py-2.5 text-left hover:bg-white/10 flex items-center gap-3 transition-colors"
                                                            >
                                                                <span className="font-mono font-bold text-teal-400">{safeStr(s.ticker)}</span>
                                                                <span className="text-sm text-slate-400 truncate">{safeStr(s.company || s.companyName, '')}</span>
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                                
                                                {/* No results */}
                                                {stockSearch.length > 0 && getFilteredStocks(stockSearch, savedOverviews).length === 0 && (
                                                    <div className="absolute top-full left-0 right-0 mt-1 bg-white/5 border border-white/10 backdrop-blur-md rounded-xl shadow-xl z-50 p-3 text-center text-sm text-slate-500">
                                                        No matching stocks
                                                    </div>
                                                )}
                                            </div>
                                            <button 
                                                onClick={loadOverviews}
                                                className="p-1.5 hover:bg-white/10 rounded flex-shrink-0"
                                                title="Refresh overviews from cloud"
                                            >
                                                <RefreshCw className="w-4 h-4 text-slate-400" />
                                            </button>
                                        </div>
                                    )}
                                    
                                    {/* Stock Pills Row */}
                                    <div className="flex items-center gap-2">
                                        {savedOverviews.length <= 5 && (
                                            <>
                                                <FileText className="w-5 h-5 text-teal-400 flex-shrink-0" />
                                                <button 
                                                    onClick={loadOverviews}
                                                    className="p-1.5 hover:bg-white/10 rounded flex-shrink-0"
                                                    title="Refresh overviews from cloud"
                                                >
                                                    <RefreshCw className="w-4 h-4 text-slate-400" />
                                                </button>
                                            </>
                                        )}
                                        <div className="flex-1 overflow-x-auto scrollbar-hide">
                                            <div className="flex gap-2">
                                                {savedOverviews.length === 0 ? (
                                                    <div className="text-sm text-slate-500 py-2 px-3">No overviews - use Chat to analyze stocks</div>
                                                ) : (
                                                    [...savedOverviews].sort((a, b) => safeStr(a.ticker).localeCompare(safeStr(b.ticker))).map(overview => (
                                                        <button
                                                            key={safeStr(overview.ticker, `ov-${Math.random()}`)}
                                                            onClick={() => setCurrentOverviewTicker(overview.ticker)}
                                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all flex-shrink-0 ${
                                                                currentOverviewTicker === overview.ticker
                                                                    ? 'bg-teal-600 shadow-lg shadow-teal-500/30'
                                                                    : 'bg-white/5 hover:bg-white/10'
                                                            }`}
                                                        >
                                                            {safeStr(overview.ticker)}
                                                        </button>
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Overview Content */}
                                <div className="flex-1 overflow-y-auto" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                                    {currentOverviewTicker && savedOverviews.find(o => o.ticker === currentOverviewTicker) ? (
                                        (() => {
                                            const overview = savedOverviews.find(o => o.ticker === currentOverviewTicker);
                                            const hasHistory = overview.history && overview.history.length > 0;
                                            
                                            // Editable Section Component
                                            const EditableSection = ({ title, icon, color, field, content }) => {
                                                const isEditing = editingOverviewField?.ticker === overview.ticker && editingOverviewField?.field === field;
                                                const [editValue, setEditValue] = useState(content || '');
                                                
                                                return (
                                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 overflow-hidden">
                                                        <button
                                                            onClick={() => setOverviewExpanded(prev => ({...prev, [field]: !prev[field]}))}
                                                            className="w-full p-4 flex items-center justify-between hover:bg-white/10 transition-colors"
                                                        >
                                                            <div className="flex items-center gap-2">
                                                                <span className={color}>{icon}</span>
                                                                <span className={`font-semibold ${color}`}>{title}</span>
                                                            </div>
                                                            <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${overviewExpanded[field] ? '' : '-rotate-90'}`} />
                                                        </button>
                                                        {overviewExpanded[field] && (
                                                            <div className="px-4 pb-4 border-t border-white/10">
                                                                {isEditing ? (
                                                                    <div className="mt-3 space-y-2">
                                                                        <textarea
                                                                            value={editValue}
                                                                            onChange={(e) => setEditValue(e.target.value)}
                                                                            className="w-full px-3 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm min-h-[150px]"
                                                                            style={{ fontSize: '16px' }}
                                                                            placeholder="Add content here..."
                                                                        />
                                                                        <div className="flex gap-2">
                                                                            <button
                                                                                onClick={() => setEditingOverviewField(null)}
                                                                                className="px-3 py-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded text-sm"
                                                                            >
                                                                                Cancel
                                                                            </button>
                                                                            <button
                                                                                onClick={() => updateOverviewField(overview.ticker, field, editValue)}
                                                                                className="px-3 py-1.5 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded text-sm"
                                                                            >
                                                                                Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <div className="mt-3">
                                                                        {content ? (
                                                                            <div 
                                                                                className="text-sm text-slate-300 leading-relaxed"
                                                                                dangerouslySetInnerHTML={{ __html: renderMarkdown(content) }}
                                                                            />
                                                                        ) : (
                                                                            <p className="text-sm text-slate-500 italic">No content yet - click Edit to add</p>
                                                                        )}
                                                                        <button
                                                                            onClick={() => {
                                                                                setEditValue(content || '');
                                                                                setEditingOverviewField({ ticker: overview.ticker, field });
                                                                            }}
                                                                            className="mt-3 text-xs text-slate-500 hover:text-teal-400 flex items-center gap-1"
                                                                        >
                                                                            <Edit className="w-3 h-3" />
                                                                            Edit
                                                                        </button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            };
                                            
                                            return (
                                                <div className="p-4 sm:p-6">
                                                    {/* Header */}
                                                    <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-6">
                                                        <div className="flex-1 min-w-0">
                                                            {editingOverviewField?.ticker === overview.ticker && editingOverviewField?.field === 'meta' ? (
                                                                <div className="space-y-2">
                                                                    <input
                                                                        type="text"
                                                                        defaultValue={overview.ticker}
                                                                        id="edit-overview-ticker"
                                                                        placeholder="Ticker"
                                                                        className="px-3 py-1.5 bg-white/5 border border-white/10 rounded text-xl font-bold w-32"
                                                                        style={{ fontSize: '16px' }}
                                                                    />
                                                                    <input
                                                                        type="text"
                                                                        defaultValue={overview.companyName}
                                                                        id="edit-overview-company"
                                                                        placeholder="Company Name"
                                                                        className="px-3 py-1.5 bg-white/5 border border-white/10 rounded w-full"
                                                                        style={{ fontSize: '16px' }}
                                                                    />
                                                                    <div className="flex gap-2">
                                                                        <button onClick={() => setEditingOverviewField(null)} className="px-3 py-1 bg-white/10 rounded text-sm">Cancel</button>
                                                                        <button 
                                                                            onClick={() => {
                                                                                const newTicker = document.getElementById('edit-overview-ticker').value;
                                                                                const newCompany = document.getElementById('edit-overview-company').value;
                                                                                updateOverviewMeta(overview.ticker, newTicker, newCompany);
                                                                                setEditingOverviewField(null);
                                                                            }}
                                                                            className="px-3 py-1 bg-teal-600 rounded text-sm"
                                                                        >
                                                                            Save
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div className="flex items-start justify-between w-full">
                                                                    <div 
                                                                        className="cursor-pointer group"
                                                                        onClick={() => setEditingOverviewField({ ticker: overview.ticker, field: 'meta' })}
                                                                    >
                                                                        <h1 className="text-2xl font-bold flex items-center gap-2">
                                                                            {overview.ticker}
                                                                            <Edit className="w-4 h-4 text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                                        </h1>
                                                                        <p className="text-slate-400">{overview.companyName}</p>
                                                                        <p className="text-xs text-slate-500 mt-1">
                                                                            Updated {formatNYTime(overview.updatedAt)}
                                                                            {hasHistory && ` ‚Ä¢ ${overview.history.length} version${overview.history.length > 1 ? 's' : ''}`}
                                                                        </p>
                                                                    </div>
                                                                    <div className="flex items-center gap-1">
                                                                        {hasHistory && (
                                                                            <button
                                                                                onClick={() => setShowOverviewHistory(true)}
                                                                                className="p-2 text-slate-400 hover:text-teal-400 hover:bg-white/10 rounded-lg"
                                                                                title="View history"
                                                                            >
                                                                                <History className="w-5 h-5" />
                                                                            </button>
                                                                        )}
                                                                        <button
                                                                            onClick={() => deleteOverview(overview.ticker)}
                                                                            className="p-2 text-slate-400 hover:text-red-400 hover:bg-white/10 rounded-lg"
                                                                            title="Delete"
                                                                        >
                                                                            <Trash className="w-5 h-5" />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* Action Buttons */}
                                                        <div className="flex items-center gap-2 flex-shrink-0">
                                                            <button
                                                                onClick={quickSendOverviewEmail}
                                                                className="px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg font-medium flex items-center gap-2 shadow-lg shadow-amber-500/20"
                                                                title="Quick Email"
                                                            >
                                                                <Mail className="w-4 h-4" />
                                                                <span className="hidden sm:inline">Email</span>
                                                            </button>
                                                            <button
                                                                onClick={() => setShowOverviewEmailDialog(true)}
                                                                className="p-2 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg shadow-lg shadow-yellow-500/20"
                                                                title="Email Options"
                                                            >
                                                                <Mails className="w-4 h-4" />
                                                            </button>
                                                            <button
                                                                onClick={toggleAllOverviewSections}
                                                                className="p-2 text-slate-400 hover:text-teal-400 hover:bg-white/10 rounded-lg"
                                                                title={allOverviewSectionsExpanded ? "Collapse All" : "Expand All"}
                                                            >
                                                                {allOverviewSectionsExpanded ? <ChevronsUp className="w-5 h-5" /> : <ChevronsDown className="w-5 h-5" />}
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Sections */}
                                                    <div className="space-y-4">
                                                        <EditableSection 
                                                            title="Company Overview" 
                                                            icon={<Target className="w-4 h-4" />}
                                                            color="text-teal-400"
                                                            field="companyOverview"
                                                            content={overview.companyOverview}
                                                        />
                                                        <EditableSection 
                                                            title="Business Model" 
                                                            icon={<BarChart2 className="w-4 h-4" />}
                                                            color="text-teal-400"
                                                            field="businessModel"
                                                            content={overview.businessModel}
                                                        />
                                                        <EditableSection 
                                                            title="Business Mix" 
                                                            icon={<PieChart className="w-4 h-4" />}
                                                            color="text-purple-400"
                                                            field="businessMix"
                                                            content={overview.businessMix}
                                                        />
                                                        <EditableSection 
                                                            title="Key Opportunities" 
                                                            icon={<TrendingUp className="w-4 h-4" />}
                                                            color="text-amber-400"
                                                            field="opportunities"
                                                            content={overview.opportunities}
                                                        />
                                                        <EditableSection 
                                                            title="Key Risks" 
                                                            icon={<AlertTriangle className="w-4 h-4" />}
                                                            color="text-red-400"
                                                            field="risks"
                                                            content={overview.risks}
                                                        />
                                                        <EditableSection 
                                                            title="Conclusion" 
                                                            icon={<Check className="w-4 h-4" />}
                                                            color="text-teal-400"
                                                            field="conclusion"
                                                            content={overview.conclusion}
                                                        />
                                                        
                                                        {/* Show raw content if no sections parsed */}
                                                        {!overview.companyOverview && !overview.businessModel && !overview.businessMix && overview.rawContent && (
                                                            <EditableSection 
                                                                title="Analysis" 
                                                                icon={<FileText className="w-4 h-4" />}
                                                                color="text-teal-400"
                                                                field="rawContent"
                                                                content={overview.rawContent}
                                                            />
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })()
                                    ) : (
                                        <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
                                            <FileText className="w-16 h-16 text-slate-700 mb-4" />
                                            <h2 className="text-xl font-semibold text-slate-400 mb-2">Stock Overviews</h2>
                                            <p className="text-slate-500 max-w-md">
                                                {savedOverviews.length === 0 
                                                    ? "Chat with Charlie to analyze a stock, then save the response here for quick reference."
                                                    : "Select a stock from the tabs to view its overview."}
                                            </p>
                                            {savedOverviews.length === 0 && (
                                                <button
                                                    onClick={() => setActiveTab('chat')}
                                                    className="mt-4 px-6 py-3 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 rounded-xl font-medium flex items-center gap-2 shadow-lg shadow-teal-500/30"
                                                >
                                                    <MessageCircle className="w-5 h-5" />
                                                    Start Chatting
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Overview Email Dialog */}
                                {showOverviewEmailDialog && currentOverviewTicker && (
                                    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                        <div className="bg-slate-900/90 backdrop-blur-2xl border border-white/10 rounded-xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-lg font-semibold">Email Overview</h3>
                                                <button onClick={() => setShowOverviewEmailDialog(false)} className="p-1 hover:bg-white/10 rounded">
                                                    <X className="w-5 h-5" />
                                                </button>
                                            </div>
                                            
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm text-slate-400 mb-1">Send to Email</label>
                                                    <input
                                                        type="email"
                                                        value={emailData.email}
                                                        onChange={(e) => setEmailData({...emailData, email: e.target.value})}
                                                        placeholder="recipient@email.com"
                                                        className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg"
                                                        style={{ fontSize: '16px' }}
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm text-slate-400 mb-1">Subject (optional)</label>
                                                    <input
                                                        type="text"
                                                        value={emailData.customSubject}
                                                        onChange={(e) => setEmailData({...emailData, customSubject: e.target.value})}
                                                        placeholder={`${currentOverviewTicker} - Stock Overview`}
                                                        className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg"
                                                        style={{ fontSize: '16px' }}
                                                    />
                                                </div>
                                                
                                                <div className="border-t border-white/10 pt-4">
                                                    <label className="flex items-center gap-2 text-sm">
                                                        <input
                                                            type="checkbox"
                                                            checked={emailData.useGmail}
                                                            onChange={(e) => setEmailData({...emailData, useGmail: e.target.checked})}
                                                            className="rounded"
                                                        />
                                                        Use Gmail SMTP
                                                    </label>
                                                </div>
                                                
                                                {emailData.useGmail && (
                                                    <div className="space-y-3 pl-4 border-l-2 border-teal-600">
                                                        <input
                                                            type="email"
                                                            value={emailData.gmailUser}
                                                            onChange={(e) => setEmailData({...emailData, gmailUser: e.target.value})}
                                                            placeholder="your.gmail@gmail.com"
                                                            className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                                            style={{ fontSize: '16px' }}
                                                        />
                                                        <input
                                                            type="password"
                                                            value={emailData.gmailPassword}
                                                            onChange={(e) => setEmailData({...emailData, gmailPassword: e.target.value})}
                                                            placeholder="Gmail App Password"
                                                            className="w-full px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                                            style={{ fontSize: '16px' }}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="flex gap-3 mt-6">
                                                <button
                                                    onClick={() => setShowOverviewEmailDialog(false)}
                                                    className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg"
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    onClick={sendOverviewEmail}
                                                    disabled={loading || !emailData.email}
                                                    className="flex-1 px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:from-white/10 disabled:to-white/10 rounded-lg font-medium flex items-center justify-center gap-2 shadow-lg shadow-amber-500/20"
                                                >
                                                    {loading ? <Loader className="w-4 h-4" /> : <Mail className="w-4 h-4" />}
                                                    Send
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Overview History Modal */}
                                {showOverviewHistory && currentOverviewTicker && (() => {
                                    const overview = savedOverviews.find(o => o.ticker === currentOverviewTicker);
                                    if (!overview || !overview.history || overview.history.length === 0) return null;
                                    
                                    return (
                                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                            <div className="bg-slate-900/90 backdrop-blur-2xl border border-white/10 rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                                                <div className="flex items-center justify-between p-4 border-b border-white/10">
                                                    <h3 className="text-lg font-semibold">Version History - {overview.ticker}</h3>
                                                    <button 
                                                        onClick={() => { setShowOverviewHistory(false); setSelectedOverviewHistoryVersion(null); }} 
                                                        className="p-1 hover:bg-white/10 rounded"
                                                    >
                                                        <X className="w-5 h-5" />
                                                    </button>
                                                </div>
                                                
                                                <div className="flex-1 flex overflow-hidden">
                                                    {/* Version List */}
                                                    <div className="w-48 border-r border-white/10 overflow-y-auto p-3">
                                                        <div className="text-xs text-slate-500 mb-2">Past Versions</div>
                                                        <div className="space-y-1">
                                                            {[...overview.history].reverse().map((version, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    onClick={() => setSelectedOverviewHistoryVersion(version)}
                                                                    className={`w-full text-left p-2 rounded-lg text-sm transition-all ${
                                                                        selectedOverviewHistoryVersion === version
                                                                            ? 'bg-teal-600'
                                                                            : 'bg-white/[0.07] hover:bg-white/10'
                                                                    }`}
                                                                >
                                                                    <div className="font-medium">
                                                                        {formatNYTime(version.timestamp)}
                                                                    </div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Version Details */}
                                                    <div className="flex-1 overflow-y-auto p-4">
                                                        {selectedOverviewHistoryVersion ? (
                                                            <div className="space-y-4">
                                                                <div className="flex items-center justify-between">
                                                                    <div>
                                                                        <div className="font-semibold">
                                                                            {formatNYTime(selectedOverviewHistoryVersion.timestamp)}
                                                                        </div>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => restoreOverviewHistoryVersion(selectedOverviewHistoryVersion)}
                                                                        className="px-4 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm font-medium flex items-center gap-2"
                                                                    >
                                                                        <RotateCcw className="w-4 h-4" />
                                                                        Restore This Version
                                                                    </button>
                                                                </div>
                                                                
                                                                {selectedOverviewHistoryVersion.companyOverview && (
                                                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-lg p-3">
                                                                        <div className="text-xs text-teal-400 mb-1">Company Overview</div>
                                                                        <div 
                                                                            className="text-sm text-slate-300"
                                                                            dangerouslySetInnerHTML={{ __html: renderMarkdown(selectedOverviewHistoryVersion.companyOverview.substring(0, 500) + (selectedOverviewHistoryVersion.companyOverview.length > 500 ? '...' : '')) }}
                                                                        />
                                                                    </div>
                                                                )}
                                                                
                                                                {selectedOverviewHistoryVersion.opportunities && (
                                                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-lg p-3">
                                                                        <div className="text-xs text-amber-400 mb-1">Key Opportunities</div>
                                                                        <div 
                                                                            className="text-sm text-slate-300"
                                                                            dangerouslySetInnerHTML={{ __html: renderMarkdown(selectedOverviewHistoryVersion.opportunities.substring(0, 300) + (selectedOverviewHistoryVersion.opportunities.length > 300 ? '...' : '')) }}
                                                                        />
                                                                    </div>
                                                                )}
                                                                
                                                                {selectedOverviewHistoryVersion.risks && (
                                                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-lg p-3">
                                                                        <div className="text-xs text-red-400 mb-1">Key Risks</div>
                                                                        <div 
                                                                            className="text-sm text-slate-300"
                                                                            dangerouslySetInnerHTML={{ __html: renderMarkdown(selectedOverviewHistoryVersion.risks.substring(0, 300) + (selectedOverviewHistoryVersion.risks.length > 300 ? '...' : '')) }}
                                                                        />
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ) : (
                                                            <div className="flex items-center justify-center h-full text-slate-500">
                                                                Select a version to view details
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        )}

                        {/* SUMMARY TAB */}
                        {activeTab === 'summary' && (
                            <div className="flex-1 flex flex-col overflow-hidden pb-24 md:pb-0">
                                {/* Horizontal Topic Navigation Bar */}
                                <div className="bg-white/[0.04] backdrop-blur-lg border-b border-white/[0.08] flex-shrink-0">
                                    <div className="flex items-center gap-2 p-3">
                                        <ClipboardList className="w-5 h-5 text-teal-400 flex-shrink-0" />
                                        <div className="flex-1 overflow-x-auto scrollbar-hide">
                                            <div className="flex gap-2">
                                                {/* Add Topic Button - First */}
                                                <button
                                                    onClick={() => setShowAddTopicModal(true)}
                                                    className="px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap bg-white/[0.04] hover:bg-white/10 text-teal-400 hover:text-teal-300 flex-shrink-0 flex items-center gap-1"
                                                >
                                                    <Plus className="w-4 h-4" />
                                                    New
                                                </button>
                                                
                                                {/* All Summaries button */}
                                                <button
                                                    onClick={() => { setCurrentSummaryTopic(null); backToSummaryList(); }}
                                                    className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all flex-shrink-0 ${
                                                        currentSummaryTopic === null
                                                            ? 'bg-teal-600 shadow-lg shadow-teal-500/30'
                                                            : 'bg-white/5 hover:bg-white/10'
                                                    }`}
                                                >
                                                    All
                                                </button>
                                                
                                                {/* Topic buttons */}
                                                {getSummaryTopics().map(topic => (
                                                    <button
                                                        key={topic.name}
                                                        onClick={() => { setCurrentSummaryTopic(topic.name); backToSummaryList(); }}
                                                        className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all flex-shrink-0 flex items-center gap-2 ${
                                                            currentSummaryTopic === topic.name
                                                                ? 'bg-teal-600 shadow-lg shadow-teal-500/30'
                                                                : 'bg-white/5 hover:bg-white/10'
                                                        }`}
                                                    >
                                                        {topic.type === 'ticker' && <span className="text-xs">üìà</span>}
                                                        {topic.type === 'macro' && <span className="text-xs">üåç</span>}
                                                        {topic.type === 'industry' && <span className="text-xs">üè≠</span>}
                                                        {topic.type === 'other' && <span className="text-xs">üìã</span>}
                                                        {topic.name}
                                                        <span className="text-xs opacity-60">({topic.count})</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Main Content Area */}
                                <div className="flex-1 overflow-y-auto" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                                    <div className="p-4 pb-8 max-w-4xl mx-auto">
                                        
                                        {/* Search Bar */}
                                        <div className="relative mb-4" ref={summarySearchRef}>
                                            <div className="relative">
                                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                                                <input
                                                    type="text"
                                                    value={summarySearchQuery}
                                                    onChange={(e) => {
                                                        setSummarySearchQuery(e.target.value);
                                                        setShowSummarySearchResults(true);
                                                    }}
                                                    onFocus={() => setShowSummarySearchResults(true)}
                                                    placeholder="Search summaries by title, topic, or content..."
                                                    className="w-full pl-10 pr-10 py-3 bg-white/[0.07] backdrop-blur-lg border border-white/10 rounded-xl text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                                />
                                                {summarySearchQuery && (
                                                    <button
                                                        onClick={() => { setSummarySearchQuery(''); setShowSummarySearchResults(false); }}
                                                        className="absolute right-3 top-1/2 -translate-y-1/2 p-1 hover:bg-white/10 rounded"
                                                    >
                                                        <X className="w-4 h-4 text-slate-400" />
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {/* Search Autocomplete Dropdown */}
                                            {showSummarySearchResults && summarySearchQuery && getSummarySearchSuggestions().length > 0 && (
                                                <div className="absolute top-full left-0 right-0 mt-1 bg-white/5 border border-white/10 backdrop-blur-md rounded-xl shadow-xl z-20 max-h-64 overflow-y-auto">
                                                    {getSummarySearchSuggestions().map((suggestion, idx) => (
                                                        <button
                                                            key={idx}
                                                            onClick={() => {
                                                                if (suggestion.type === 'title' && suggestion.summary) {
                                                                    openSummaryDetail(suggestion.summary);
                                                                } else if (suggestion.type === 'topic') {
                                                                    setCurrentSummaryTopic(suggestion.text);
                                                                    backToSummaryList();
                                                                }
                                                                setSummarySearchQuery('');
                                                                setShowSummarySearchResults(false);
                                                            }}
                                                            className="w-full px-4 py-3 text-left hover:bg-white/10 flex items-center gap-3 border-b border-white/10 last:border-0"
                                                        >
                                                            {suggestion.type === 'title' ? (
                                                                <FileText className="w-4 h-4 text-teal-400 flex-shrink-0" />
                                                            ) : (
                                                                <span className="text-sm flex-shrink-0">
                                                                    {suggestion.topicType === 'ticker' && 'üìà'}
                                                                    {suggestion.topicType === 'macro' && 'üåç'}
                                                                    {suggestion.topicType === 'industry' && 'üè≠'}
                                                                    {suggestion.topicType === 'other' && 'üìã'}
                                                                </span>
                                                            )}
                                                            <div className="flex-1 min-w-0">
                                                                <p className="font-medium truncate">{suggestion.text}</p>
                                                                <p className="text-xs text-slate-500">
                                                                    {suggestion.type === 'title' ? 'Document' : 'Topic'}
                                                                </p>
                                                            </div>
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Document Type Filter */}
                                        <div className="mb-4">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-slate-500 flex-shrink-0">Filter:</span>
                                                <div className="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
                                                    {SUMMARY_DOC_TYPES.map(dtype => (
                                                        <button
                                                            key={dtype.id}
                                                            onClick={() => {
                                                                setSummaryDocTypeFilter(prev => 
                                                                    prev.includes(dtype.id) 
                                                                        ? prev.filter(t => t !== dtype.id)
                                                                        : [...prev, dtype.id]
                                                                );
                                                            }}
                                                            className={`px-2 py-1 rounded text-xs transition-all flex items-center gap-1 whitespace-nowrap flex-shrink-0 ${
                                                                summaryDocTypeFilter.includes(dtype.id)
                                                                    ? 'bg-teal-600 text-white'
                                                                    : 'bg-white/5 text-slate-400 hover:bg-white/10'
                                                            }`}
                                                        >
                                                            <span>{dtype.icon}</span>
                                                            {dtype.label}
                                                        </button>
                                                    ))}
                                                    {summaryDocTypeFilter.length > 0 && (
                                                        <button
                                                            onClick={() => setSummaryDocTypeFilter([])}
                                                            className="px-2 py-1 rounded text-xs bg-white/10 text-slate-300 hover:bg-white/15 flex items-center gap-1 whitespace-nowrap flex-shrink-0"
                                                        >
                                                            <X className="w-3 h-3" />
                                                            Clear
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Header with Add button */}
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h2 className="text-xl font-bold flex items-center gap-2">
                                                    {currentSummary && summaryViewMode === 'detail' && (
                                                        <button onClick={backToSummaryList} className="p-1 hover:bg-white/10 rounded-lg mr-1">
                                                            <ChevronLeft className="w-5 h-5" />
                                                        </button>
                                                    )}
                                                    {summarySearchQuery ? `Search: "${summarySearchQuery}"` : (currentSummaryTopic || 'All Summaries')}
                                                </h2>
                                                <p className="text-sm text-slate-400">
                                                    {getFilteredSummaries().length} document{getFilteredSummaries().length !== 1 ? 's' : ''}
                                                </p>
                                            </div>
                                            <button
                                                onClick={openNewSummaryInput}
                                                className="px-4 py-2 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 rounded-lg text-sm font-medium flex items-center gap-2 shadow-lg shadow-teal-500/30"
                                            >
                                                <Plus className="w-4 h-4" />
                                                Add Document
                                            </button>
                                        </div>

                                        {/* LIST VIEW - Show document cards */}
                                        {(!currentSummary || summaryViewMode === 'list') && (
                                            <div className="space-y-3">
                                                {getFilteredSummaries().length === 0 ? (
                                                    <div className="text-center py-16">
                                                        <ClipboardList className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                                                        <h3 className="text-lg font-medium text-slate-400 mb-2">
                                                            {summarySearchQuery ? 'No matching documents' : 'No documents yet'}
                                                        </h3>
                                                        <p className="text-sm text-slate-500 mb-6">
                                                            {summarySearchQuery ? 'Try a different search term' : 'Add meeting notes or upload files to generate summaries'}
                                                        </p>
                                                        {!summarySearchQuery && (
                                                            <button
                                                                onClick={openNewSummaryInput}
                                                                className="px-6 py-3 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg font-medium inline-flex items-center gap-2"
                                                            >
                                                                <Plus className="w-5 h-5" />
                                                                Add First Document
                                                            </button>
                                                        )}
                                                    </div>
                                                ) : (
                                                    getFilteredSummaries().map(summary => (
                                                        <div
                                                            key={summary.id}
                                                            onClick={() => openSummaryDetail(summary)}
                                                            className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 p-4 hover:bg-white/[0.12] hover:border-white/15 cursor-pointer transition-all group relative"
                                                        >
                                                            {/* Title row with icon */}
                                                            <div className="flex items-start gap-2 mb-1 pr-8">
                                                                {summary.sourceType === 'audio' ? (
                                                                    <Mic className="w-4 h-4 text-purple-400 flex-shrink-0 mt-0.5" />
                                                                ) : summary.sourceType === 'upload' ? (
                                                                    <Upload className="w-4 h-4 text-amber-400 flex-shrink-0 mt-0.5" />
                                                                ) : (
                                                                    <FileText className="w-4 h-4 text-teal-400 flex-shrink-0 mt-0.5" />
                                                                )}
                                                                <h3 className="font-semibold line-clamp-2 group-hover:text-teal-400 transition-colors leading-snug">
                                                                    {summary.title}
                                                                </h3>
                                                            </div>
                                                            
                                                            {/* Preview - full width */}
                                                            <p className="text-sm text-slate-400 line-clamp-2 mb-2 leading-relaxed ml-6 pr-8">
                                                                {getSummaryPreview(summary)}
                                                            </p>
                                                            
                                                            {/* Badges row */}
                                                            <div className="flex items-center gap-2 flex-wrap ml-6">
                                                                <span className="text-xs px-2 py-0.5 bg-white/10 rounded">
                                                                    {summary.topic || 'General'}
                                                                </span>
                                                                {summary.docType && (
                                                                    <span className="text-xs px-2 py-0.5 bg-white/[0.07] rounded flex items-center gap-1">
                                                                        {SUMMARY_DOC_TYPES.find(t => t.id === summary.docType)?.icon || 'üìÑ'}
                                                                        {SUMMARY_DOC_TYPES.find(t => t.id === summary.docType)?.label || summary.docType}
                                                                    </span>
                                                                )}
                                                                <span className="text-xs text-slate-500">
                                                                    {formatNYTime(summary.createdAt)}
                                                                </span>
                                                                {summary.sourceFiles && summary.sourceFiles.length > 0 && (
                                                                    <span className="text-xs text-slate-500">
                                                                        ‚Ä¢ {summary.sourceFiles.length} file{summary.sourceFiles.length > 1 ? 's' : ''}
                                                                    </span>
                                                                )}
                                                                {summary.hasStoredFiles && (
                                                                    <span className="text-xs px-1.5 py-0.5 bg-teal-500/20 text-teal-400 rounded" title="PDF stored">
                                                                        üíæ
                                                                    </span>
                                                                )}
                                                            </div>
                                                            
                                                            {/* Chevron - always visible, positioned right */}
                                                            <ChevronRight className="w-5 h-5 text-slate-500 group-hover:text-teal-400 transition-colors absolute right-4 top-1/2 -translate-y-1/2" />
                                                            
                                                            {/* Action buttons - appear on hover */}
                                                            <div className="absolute right-10 top-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                {summary.hasStoredFiles && (
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); openStoredSummaryPdf(summary.id); }}
                                                                        className="p-1.5 text-teal-400 hover:bg-teal-600/20 rounded-lg bg-white/[0.07]"
                                                                        title="View PDF"
                                                                    >
                                                                        <FileText className="w-4 h-4" />
                                                                    </button>
                                                                )}
                                                                <button
                                                                    onClick={(e) => deleteSummary(summary.id, e)}
                                                                    className="p-1.5 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg bg-white/[0.07]"
                                                                >
                                                                    <Trash className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        )}

                                        {/* DETAIL VIEW - Show selected summary content */}
                                        {currentSummary && summaryViewMode === 'detail' && (
                                            <div className="space-y-6">
                                                {/* Summary Header */}
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            {currentSummary.sourceType === 'audio' ? (
                                                                <Mic className="w-5 h-5 text-purple-400 flex-shrink-0" />
                                                            ) : currentSummary.sourceType === 'upload' ? (
                                                                <Upload className="w-5 h-5 text-amber-400 flex-shrink-0" />
                                                            ) : (
                                                                <FileText className="w-5 h-5 text-teal-400 flex-shrink-0" />
                                                            )}
                                                            {editingSummaryTitle ? (
                                                                <div className="flex items-center gap-2 flex-1">
                                                                    <input
                                                                        type="text"
                                                                        value={editingSummaryTitleValue}
                                                                        onChange={(e) => setEditingSummaryTitleValue(e.target.value)}
                                                                        onKeyDown={(e) => {
                                                                            if (e.key === 'Enter') {
                                                                                updateSummaryTitle(currentSummary.id, editingSummaryTitleValue);
                                                                            } else if (e.key === 'Escape') {
                                                                                setEditingSummaryTitle(false);
                                                                                setEditingSummaryTitleValue('');
                                                                            }
                                                                        }}
                                                                        autoFocus
                                                                        className="flex-1 px-3 py-1 bg-white/5 backdrop-blur-md border border-teal-500 rounded-lg text-lg font-semibold focus:outline-none"
                                                                    />
                                                                    <button
                                                                        onClick={() => updateSummaryTitle(currentSummary.id, editingSummaryTitleValue)}
                                                                        className="p-1.5 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg"
                                                                        title="Save"
                                                                    >
                                                                        <Check className="w-4 h-4" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => { setEditingSummaryTitle(false); setEditingSummaryTitleValue(''); }}
                                                                        className="p-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg"
                                                                        title="Cancel"
                                                                    >
                                                                        <X className="w-4 h-4" />
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <button
                                                                    onClick={startEditingSummaryTitle}
                                                                    className="group flex items-center gap-2 hover:text-teal-400 transition-colors"
                                                                    title="Click to edit title"
                                                                >
                                                                    <h3 className="font-semibold text-lg">{currentSummary.title}</h3>
                                                                    <Edit2 className="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                                </button>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-2 mt-2 flex-wrap">
                                                            {/* Editable Topic Badge */}
                                                            {editingSummaryTopic ? (
                                                                <div className="flex items-center gap-2 flex-wrap">
                                                                    {getSummaryTopics().map(topic => (
                                                                        <button
                                                                            key={topic.name}
                                                                            onClick={() => updateSummaryTopic(currentSummary.id, topic.name, topic.type)}
                                                                            className={`px-3 py-1 rounded-lg text-xs font-medium transition-all ${
                                                                                currentSummary.topic === topic.name
                                                                                    ? 'bg-teal-600 text-white'
                                                                                    : 'bg-white/10 text-slate-300 hover:bg-white/15'
                                                                            }`}
                                                                        >
                                                                            {topic.type === 'ticker' && 'üìà '}
                                                                            {topic.type === 'macro' && 'üåç '}
                                                                            {topic.type === 'industry' && 'üè≠ '}
                                                                            {topic.type === 'other' && 'üìã '}
                                                                            {topic.name}
                                                                        </button>
                                                                    ))}
                                                                    <button
                                                                        onClick={() => setEditingSummaryTopic(false)}
                                                                        className="p-1 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg"
                                                                        title="Cancel"
                                                                    >
                                                                        <X className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <button
                                                                    onClick={() => setEditingSummaryTopic(true)}
                                                                    className="group text-xs px-2 py-0.5 bg-teal-600/20 text-teal-400 rounded hover:bg-teal-600/30 transition-colors flex items-center gap-1"
                                                                    title="Click to change topic"
                                                                >
                                                                    {currentSummary.topic || 'General'}
                                                                    <Edit2 className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                                </button>
                                                            )}
                                                            
                                                            {/* Editable Doc Type Badge */}
                                                            {editingSummaryDocType ? (
                                                                <div className="flex items-center gap-1 flex-wrap">
                                                                    {SUMMARY_DOC_TYPES.map(dtype => (
                                                                        <button
                                                                            key={dtype.id}
                                                                            onClick={() => updateSummaryDocType(currentSummary.id, dtype.id)}
                                                                            className={`px-2 py-0.5 rounded text-xs font-medium transition-all flex items-center gap-1 ${
                                                                                currentSummary.docType === dtype.id
                                                                                    ? 'bg-amber-600 text-white'
                                                                                    : 'bg-white/10 text-slate-300 hover:bg-white/15'
                                                                            }`}
                                                                        >
                                                                            {dtype.icon} {dtype.label}
                                                                        </button>
                                                                    ))}
                                                                    <button
                                                                        onClick={() => setEditingSummaryDocType(false)}
                                                                        className="p-1 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg"
                                                                        title="Cancel"
                                                                    >
                                                                        <X className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <button
                                                                    onClick={() => setEditingSummaryDocType(true)}
                                                                    className="group text-xs px-2 py-0.5 bg-amber-600/20 text-amber-400 rounded hover:bg-amber-600/30 transition-colors flex items-center gap-1"
                                                                    title="Click to change document type"
                                                                >
                                                                    {SUMMARY_DOC_TYPES.find(t => t.id === currentSummary.docType)?.icon || 'üìÑ'}
                                                                    {SUMMARY_DOC_TYPES.find(t => t.id === currentSummary.docType)?.label || 'Set Type'}
                                                                    <Edit2 className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                                </button>
                                                            )}
                                                            
                                                            <span className="text-sm text-slate-500">
                                                                {formatNYTime(currentSummary.createdAt)}
                                                            </span>
                                                            {currentSummary.sourceFiles && (
                                                                <span className="text-xs text-slate-500">
                                                                    ‚Ä¢ From: {currentSummary.sourceFiles.join(', ')}
                                                                </span>
                                                            )}
                                                            {currentSummary.hasStoredFiles && (
                                                                <button
                                                                    onClick={() => openStoredSummaryPdf(currentSummary.id)}
                                                                    className={`text-xs px-2 py-1 rounded-lg flex items-center gap-1.5 transition-colors ${
                                                                        currentSummary.sourceType === 'audio'
                                                                            ? 'bg-purple-600/30 hover:bg-purple-600/50 text-purple-400'
                                                                            : 'bg-teal-600/30 hover:bg-teal-600/50 text-teal-400'
                                                                    }`}
                                                                    title={currentSummary.sourceType === 'audio' ? 'View Transcript File' : 'View original PDF'}
                                                                >
                                                                    <FileText className="w-3.5 h-3.5" />
                                                                    {currentSummary.sourceType === 'audio' ? 'View Transcript' : 'View PDF'}
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Expand/Collapse All Toggle */}
                                                <div className="flex justify-end">
                                                    <button
                                                        onClick={() => {
                                                            const allExpanded = takeawaysExpanded && questionsExpanded && (currentSummary.sourceType !== 'audio' || transcriptExpanded);
                                                            setTakeawaysExpanded(!allExpanded);
                                                            setQuestionsExpanded(!allExpanded);
                                                            if (currentSummary.sourceType === 'audio') setTranscriptExpanded(!allExpanded);
                                                        }}
                                                        className="text-xs px-2 py-1 text-slate-400 hover:text-slate-200 hover:bg-white/10 rounded transition-colors flex items-center gap-1"
                                                    >
                                                        {takeawaysExpanded && questionsExpanded && (currentSummary.sourceType !== 'audio' || transcriptExpanded) ? (
                                                            <>
                                                                <ChevronsUp className="w-3.5 h-3.5" />
                                                                Collapse All
                                                            </>
                                                        ) : (
                                                            <>
                                                                <ChevronsDown className="w-3.5 h-3.5" />
                                                                Expand All
                                                            </>
                                                        )}
                                                    </button>
                                                </div>

                                                {/* KEY TAKEAWAYS Section - Collapsible */}
                                                <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 overflow-hidden">
                                                    <div className="bg-teal-500/15 backdrop-blur-lg border-b border-teal-400/20 px-4 py-3 flex items-center gap-2">
                                                        <button
                                                            onClick={() => setTakeawaysExpanded(!takeawaysExpanded)}
                                                            className="flex items-center gap-2 hover:opacity-80 transition-opacity flex-1 min-w-0"
                                                        >
                                                            <span className="text-lg flex-shrink-0">üìã</span>
                                                            <h3 className="font-semibold text-teal-400 whitespace-nowrap">Key Takeaways</h3>
                                                            <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform flex-shrink-0 ${takeawaysExpanded ? 'rotate-180' : ''}`} />
                                                        </button>
                                                        <div className="flex items-center gap-1 flex-shrink-0">
                                                            {!editingTakeaways && (
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); startEditingTakeaways(); }}
                                                                    className="p-1.5 text-slate-400 hover:text-teal-400 hover:bg-white/10 rounded-lg transition-colors"
                                                                    title="Edit"
                                                                >
                                                                    <Edit2 className="w-4 h-4" />
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); copyTakeaways(); }}
                                                                className="p-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg transition-colors"
                                                                title="Copy All"
                                                            >
                                                                <Copy className="w-4 h-4" />
                                                            </button>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); emailTakeaways(); }}
                                                                className="p-1.5 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg transition-colors shadow-lg shadow-amber-500/20"
                                                                title="Quick Email"
                                                            >
                                                                <Mail className="w-4 h-4" />
                                                            </button>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); openSummaryEmailWithOptions('takeaways'); }}
                                                                className="p-1.5 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg transition-colors shadow-lg shadow-yellow-500/20"
                                                                title="Email with Options"
                                                            >
                                                                <Mails className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {takeawaysExpanded && (
                                                        <>
                                                            {editingTakeaways ? (
                                                                <div className="p-4">
                                                                    <textarea
                                                                        value={editTakeawaysValue}
                                                                        onChange={(e) => setEditTakeawaysValue(e.target.value)}
                                                                        className="w-full min-h-[300px] p-4 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-slate-200 text-sm leading-relaxed resize-y focus:outline-none focus:border-teal-500"
                                                                        style={{ fontSize: '16px' }}
                                                                        placeholder="Edit key takeaways..."
                                                                    />
                                                                    <div className="flex justify-end gap-2 mt-3">
                                                                        <button
                                                                            onClick={cancelEditingTakeaways}
                                                                            className="px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium"
                                                                        >
                                                                            Cancel
                                                                        </button>
                                                                        <button
                                                                            onClick={() => setShowSaveConfirmModal('takeaways')}
                                                                            className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm font-medium flex items-center gap-2"
                                                                        >
                                                                            <Save className="w-4 h-4" />
                                                                            Save Changes
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <>
                                                                    <div 
                                                                        className="p-6 summary-content"
                                                                        dangerouslySetInnerHTML={{ __html: typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(currentSummary.summary) : currentSummary.summary }}
                                                                    />
                                                                    <div className="border-t border-white/10 px-4 py-3 flex gap-2">
                                                                        <button
                                                                            onClick={copyTakeaways}
                                                                            className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                                        >
                                                                            <Copy className="w-4 h-4" />
                                                                            Copy All
                                                                        </button>
                                                                        <button
                                                                            onClick={emailTakeaways}
                                                                            className="flex-1 px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-amber-500/20"
                                                                            title="Quick Email"
                                                                        >
                                                                            <Mail className="w-4 h-4" />
                                                                            Email
                                                                        </button>
                                                                        <button
                                                                            onClick={() => openSummaryEmailWithOptions('takeaways')}
                                                                            className="px-4 py-2 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-yellow-500/20"
                                                                            title="Email with Options"
                                                                        >
                                                                            <Mails className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                </>
                                                            )}
                                                        </>
                                                    )}
                                                </div>

                                                {/* FOLLOW-UP QUESTIONS Section - Collapsible */}
                                                <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 overflow-hidden">
                                                    <div className="bg-amber-500/15 backdrop-blur-lg border-b border-amber-400/20 px-4 py-3 flex items-center gap-2">
                                                        <button
                                                            onClick={() => setQuestionsExpanded(!questionsExpanded)}
                                                            className="flex items-center gap-2 hover:opacity-80 transition-opacity flex-1 min-w-0"
                                                        >
                                                            <span className="text-lg flex-shrink-0">‚ùì</span>
                                                            <h3 className="font-semibold text-amber-400 whitespace-nowrap">Follow-up Questions</h3>
                                                            <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform flex-shrink-0 ${questionsExpanded ? 'rotate-180' : ''}`} />
                                                        </button>
                                                        <div className="flex items-center gap-1 flex-shrink-0">
                                                            {!editingQuestions && (
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); startEditingQuestions(); }}
                                                                    className="p-1.5 text-slate-400 hover:text-amber-400 hover:bg-white/10 rounded-lg transition-colors"
                                                                    title="Edit"
                                                                >
                                                                    <Edit2 className="w-4 h-4" />
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); copyQuestions(); }}
                                                                className="p-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg transition-colors"
                                                                title="Copy All"
                                                            >
                                                                <Copy className="w-4 h-4" />
                                                            </button>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); emailQuestions(); }}
                                                                className="p-1.5 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg transition-colors shadow-lg shadow-amber-500/20"
                                                                title="Quick Email"
                                                            >
                                                                <Mail className="w-4 h-4" />
                                                            </button>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); openSummaryEmailWithOptions('questions'); }}
                                                                className="p-1.5 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg transition-colors shadow-lg shadow-yellow-500/20"
                                                                title="Email with Options"
                                                            >
                                                                <Mails className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {questionsExpanded && (
                                                        <>
                                                            {editingQuestions ? (
                                                                <div className="p-4">
                                                                    <textarea
                                                                        value={editQuestionsValue}
                                                                        onChange={(e) => setEditQuestionsValue(e.target.value)}
                                                                        className="w-full min-h-[300px] p-4 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-slate-200 text-sm leading-relaxed resize-y focus:outline-none focus:border-amber-500"
                                                                        style={{ fontSize: '16px' }}
                                                                        placeholder="Edit follow-up questions..."
                                                                    />
                                                                    <div className="flex justify-end gap-2 mt-3">
                                                                        <button
                                                                            onClick={cancelEditingQuestions}
                                                                            className="px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium"
                                                                        >
                                                                            Cancel
                                                                        </button>
                                                                        <button
                                                                            onClick={() => setShowSaveConfirmModal('questions')}
                                                                            className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium flex items-center gap-2"
                                                                        >
                                                                            <Save className="w-4 h-4" />
                                                                            Save Changes
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <>
                                                                    <div 
                                                                        className="p-6 summary-content"
                                                                        dangerouslySetInnerHTML={{ __html: typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(currentSummary.questions) : currentSummary.questions }}
                                                                    />
                                                                    <div className="border-t border-white/10 px-4 py-3 flex gap-2">
                                                                        <button
                                                                            onClick={copyQuestions}
                                                                            className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                                        >
                                                                            <Copy className="w-4 h-4" />
                                                                            Copy All
                                                                        </button>
                                                                        <button
                                                                            onClick={emailQuestions}
                                                                            className="flex-1 px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-amber-500/20"
                                                                            title="Quick Email"
                                                                        >
                                                                            <Mail className="w-4 h-4" />
                                                                            Email
                                                                        </button>
                                                                        <button
                                                                            onClick={() => openSummaryEmailWithOptions('questions')}
                                                                            className="px-4 py-2 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-yellow-500/20"
                                                                            title="Email with Options"
                                                                        >
                                                                            <Mails className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                </>
                                                            )}
                                                        </>
                                                    )}
                                                </div>

                                                {/* FULL TRANSCRIPT Section - Only for audio summaries */}
                                                {currentSummary.sourceType === 'audio' && currentSummary.rawNotes && (
                                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 overflow-hidden">
                                                        <div className="bg-purple-500/15 backdrop-blur-lg border-b border-purple-400/20 px-4 py-3 flex items-center gap-2">
                                                            <button
                                                                onClick={() => setTranscriptExpanded(!transcriptExpanded)}
                                                                className="flex items-center gap-2 hover:opacity-80 transition-opacity flex-1 min-w-0"
                                                            >
                                                                <span className="text-lg flex-shrink-0">üéôÔ∏è</span>
                                                                <h3 className="font-semibold text-purple-400 whitespace-nowrap">Full Transcript</h3>
                                                                <span className="text-xs text-slate-500 ml-1">
                                                                    ({currentSummary.rawNotes.length.toLocaleString()} chars)
                                                                </span>
                                                                <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform flex-shrink-0 ${transcriptExpanded ? 'rotate-180' : ''}`} />
                                                            </button>
                                                            <div className="flex items-center gap-1 flex-shrink-0">
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); navigator.clipboard.writeText(currentSummary.rawNotes); alert('Transcript copied!'); }}
                                                                    className="p-1.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg transition-colors"
                                                                    title="Copy All"
                                                                >
                                                                    <Copy className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); emailTranscript(); }}
                                                                    className="p-1.5 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg transition-colors shadow-lg shadow-amber-500/20"
                                                                    title="Quick Email"
                                                                >
                                                                    <Mail className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); openSummaryEmailWithOptions('transcript'); }}
                                                                    className="p-1.5 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg transition-colors shadow-lg shadow-yellow-500/20"
                                                                    title="Email with Options"
                                                                >
                                                                    <Mails className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {transcriptExpanded && (
                                                            <>
                                                                <div className="p-6 max-h-96 overflow-y-auto">
                                                                    <pre className="text-sm text-slate-300 whitespace-pre-wrap font-sans leading-relaxed">
                                                                        {currentSummary.rawNotes}
                                                                    </pre>
                                                                </div>
                                                                <div className="border-t border-white/10 px-4 py-3 flex gap-2">
                                                                    <button
                                                                        onClick={() => { navigator.clipboard.writeText(currentSummary.rawNotes); alert('Transcript copied!'); }}
                                                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                                    >
                                                                        <Copy className="w-4 h-4" />
                                                                        Copy All
                                                                    </button>
                                                                    <button
                                                                        onClick={emailTranscript}
                                                                        className="flex-1 px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-amber-500/20"
                                                                        title="Quick Email"
                                                                    >
                                                                        <Mail className="w-4 h-4" />
                                                                        Email
                                                                    </button>
                                                                    <button
                                                                        onClick={() => openSummaryEmailWithOptions('transcript')}
                                                                        className="px-4 py-2 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-yellow-500/20"
                                                                        title="Email with Options"
                                                                    >
                                                                        <Mails className="w-4 h-4" />
                                                                    </button>
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                )}

                                                {/* Overall Actions */}
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => {
                                                            const text = 'KEY TAKEAWAYS\n\n' + currentSummary.summary.replace(/<[^>]*>/g, '') + '\n\n---\n\nFOLLOW-UP QUESTIONS\n\n' + currentSummary.questions.replace(/<[^>]*>/g, '');
                                                            navigator.clipboard.writeText(text);
                                                            alert('Full summary copied!');
                                                        }}
                                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                    >
                                                        <Copy className="w-4 h-4" />
                                                        Copy Full Summary
                                                    </button>
                                                    <button
                                                        onClick={() => { deleteSummary(currentSummary.id); backToSummaryList(); }}
                                                        className="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                    >
                                                        <Trash className="w-4 h-4" />
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* ADD DOCUMENT MODAL - Paste or Upload */}
                                {showSummaryInputModal && (
                                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                                        <div className="absolute inset-0 bg-black/60" onClick={() => setShowSummaryInputModal(false)} />
                                        <div className="relative bg-slate-900/90 backdrop-blur-2xl rounded-2xl border border-white/15 w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
                                            {/* Modal Header */}
                                            <div className="p-4 border-b border-white/10 flex items-center justify-between">
                                                <h3 className="text-lg font-semibold">Add New Document</h3>
                                                <button onClick={() => setShowSummaryInputModal(false)} className="p-1 hover:bg-white/10 rounded">
                                                    <X className="w-5 h-5" />
                                                </button>
                                            </div>
                                            
                                            {/* Modal Body */}
                                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                                {/* Topic Selection */}
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-300 mb-2">
                                                        Assign to Topic
                                                    </label>
                                                    <div className="overflow-x-auto scrollbar-hide -mx-1 px-1 pb-1">
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => setShowAddTopicModal(true)}
                                                                className="px-3 py-1.5 rounded-lg text-sm bg-white/[0.07] text-teal-400 hover:bg-white/10 flex items-center gap-1 whitespace-nowrap flex-shrink-0"
                                                            >
                                                                <Plus className="w-3 h-3" />
                                                                New
                                                            </button>
                                                            {getSummaryTopics().map(topic => (
                                                                <button
                                                                    key={topic.name}
                                                                    onClick={() => setNewTopicName(topic.name)}
                                                                    className={`px-3 py-1.5 rounded-lg text-sm transition-all whitespace-nowrap flex-shrink-0 ${
                                                                        newTopicName === topic.name
                                                                            ? 'bg-teal-600 text-white'
                                                                            : 'bg-white/10 text-slate-300 hover:bg-white/15'
                                                                    }`}
                                                                >
                                                                    {topic.name}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Document Title */}
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-300 mb-2">
                                                        Document Title <span className="text-slate-500 font-normal">(optional)</span>
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={summaryTitleInput}
                                                        onChange={(e) => setSummaryTitleInput(e.target.value)}
                                                        placeholder="e.g., UNH Q3 Earnings Call, Fed Policy Meeting..."
                                                        className="w-full px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                    />
                                                    <p className="text-xs text-slate-500 mt-1">
                                                        Leave empty to auto-generate from content
                                                    </p>
                                                </div>

                                                {/* Document Type */}
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-300 mb-2">
                                                        Document Type
                                                    </label>
                                                    <div className="overflow-x-auto scrollbar-hide -mx-1 px-1 pb-1">
                                                        <div className="flex gap-2">
                                                            {SUMMARY_DOC_TYPES.map(dtype => (
                                                                <button
                                                                    key={dtype.id}
                                                                    onClick={() => setSummaryDocType(dtype.id)}
                                                                    className={`px-3 py-1.5 rounded-lg text-sm transition-all whitespace-nowrap flex-shrink-0 flex items-center gap-1.5 ${
                                                                        summaryDocType === dtype.id
                                                                            ? 'bg-teal-600 text-white'
                                                                            : 'bg-white/10 text-slate-300 hover:bg-white/15'
                                                                    }`}
                                                                >
                                                                    <span>{dtype.icon}</span>
                                                                    {dtype.label}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Input Type Toggle */}
                                                <div className="flex gap-2 p-1 bg-white/5 backdrop-blur-lg rounded-lg">
                                                    <button
                                                        onClick={() => { setSummaryInputType('paste'); setSummaryFiles([]); }}
                                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-1.5 transition-all ${
                                                            summaryInputType === 'paste'
                                                                ? 'bg-teal-600 text-white'
                                                                : 'text-slate-400 hover:text-white'
                                                        }`}
                                                    >
                                                        <FileText className="w-4 h-4" />
                                                        Paste
                                                    </button>
                                                    <button
                                                        onClick={() => { setSummaryInputType('upload'); setSummaryFiles([]); }}
                                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-1.5 transition-all ${
                                                            summaryInputType === 'upload'
                                                                ? 'bg-teal-600 text-white'
                                                                : 'text-slate-400 hover:text-white'
                                                        }`}
                                                    >
                                                        <Upload className="w-4 h-4" />
                                                        Upload
                                                    </button>
                                                    <button
                                                        onClick={() => { setSummaryInputType('audio'); setSummaryFiles([]); }}
                                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-1.5 transition-all ${
                                                            summaryInputType === 'audio'
                                                                ? 'bg-purple-600 text-white'
                                                                : 'text-slate-400 hover:text-white'
                                                        }`}
                                                    >
                                                        <Mic className="w-4 h-4" />
                                                        Audio
                                                    </button>
                                                </div>

                                                {/* PASTE INPUT */}
                                                {summaryInputType === 'paste' && (
                                                    <div>
                                                        <textarea
                                                            value={summaryInput}
                                                            onChange={(e) => setSummaryInput(e.target.value)}
                                                            placeholder="Paste your raw meeting notes, transcript, or discussion points here..."
                                                            className="w-full h-64 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg p-4 text-slate-200 placeholder-slate-500 resize-none focus:outline-none focus:ring-2 focus:ring-teal-500 font-mono text-sm leading-relaxed"
                                                        />
                                                        <p className="text-xs text-slate-500 mt-1">{summaryInput.length} characters</p>
                                                    </div>
                                                )}

                                                {/* FILE UPLOAD */}
                                                {summaryInputType === 'upload' && (
                                                    <div>
                                                        <input
                                                            type="file"
                                                            ref={summaryFileInputRef}
                                                            onChange={handleSummaryFileSelect}
                                                            accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg"
                                                            multiple
                                                            className="hidden"
                                                        />
                                                        <div
                                                            onClick={() => summaryFileInputRef.current?.click()}
                                                            onDrop={handleSummaryDrop}
                                                            onDragOver={(e) => e.preventDefault()}
                                                            className="border-2 border-dashed border-white/10 rounded-xl p-8 text-center hover:border-teal-500 hover:bg-teal-500/5 transition-all cursor-pointer"
                                                        >
                                                            <Upload className="w-12 h-12 text-slate-500 mx-auto mb-4" />
                                                            <p className="text-slate-300 font-medium mb-2">
                                                                Drop files here or click to browse
                                                            </p>
                                                            <p className="text-sm text-slate-500 mb-2">
                                                                Supports: PDF, Word (DOCX), Images (PNG, JPG), Text files
                                                            </p>
                                                            <p className="text-xs text-teal-400">
                                                                üí° Select multiple files to combine into one summary
                                                            </p>
                                                        </div>

                                                        {renderDriveSearch(null, handleDriveImportSummary)}

                                                        {/* Selected Files */}
                                                        {summaryFiles.length > 0 && (
                                                            <div className="mt-4 space-y-2">
                                                                <div className="flex items-center justify-between">
                                                                    <p className="text-sm font-medium text-slate-300">
                                                                        {summaryFiles.length} file{summaryFiles.length > 1 ? 's' : ''} selected
                                                                        {summaryFiles.length > 1 && <span className="text-teal-400 ml-2">(will be combined)</span>}
                                                                    </p>
                                                                    <button
                                                                        onClick={() => summaryFileInputRef.current?.click()}
                                                                        className="text-xs text-teal-400 hover:text-teal-300"
                                                                    >
                                                                        + Add more
                                                                    </button>
                                                                </div>
                                                                {summaryFiles.map((file, index) => (
                                                                    <div key={index} className="flex items-center justify-between bg-white/5 backdrop-blur-lg rounded-lg px-3 py-2">
                                                                        <div className="flex items-center gap-2">
                                                                            <FileText className="w-4 h-4 text-teal-400" />
                                                                            <span className="text-sm truncate">{file.name}</span>
                                                                            <span className="text-xs text-slate-500">
                                                                                ({(file.size / 1024).toFixed(1)} KB)
                                                                            </span>
                                                                        </div>
                                                                        <button
                                                                            onClick={() => setSummaryFiles(prev => prev.filter((_, i) => i !== index))}
                                                                            className="p-1 text-slate-400 hover:text-red-400"
                                                                        >
                                                                            <X className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}

                                                {/* AUDIO UPLOAD */}
                                                {summaryInputType === 'audio' && (
                                                    <div>
                                                        <input
                                                            type="file"
                                                            ref={summaryFileInputRef}
                                                            onChange={handleSummaryFileSelect}
                                                            accept=".mp3,.mp4,.mpeg,.mpga,.m4a,.wav,.webm"
                                                            multiple
                                                            className="hidden"
                                                        />
                                                        <div
                                                            onClick={() => summaryFileInputRef.current?.click()}
                                                            onDrop={handleSummaryDrop}
                                                            onDragOver={(e) => e.preventDefault()}
                                                            className="border-2 border-dashed border-purple-500/40 rounded-xl p-8 text-center hover:border-purple-400 hover:bg-purple-500/5 transition-all cursor-pointer"
                                                        >
                                                            <Mic className="w-12 h-12 text-purple-400 mx-auto mb-4" />
                                                            <p className="text-slate-300 font-medium mb-2">
                                                                Drop audio file(s) here or click to browse
                                                            </p>
                                                            <p className="text-sm text-slate-500 mb-2">
                                                                Supports: MP3, M4A, WAV, MP4, MPEG, WebM
                                                            </p>
                                                            <p className="text-xs text-purple-400">
                                                                Multiple files will be combined into one transcript
                                                            </p>
                                                        </div>

                                                        {summaryFiles.length > 0 && (
                                                            <div className="mt-4 space-y-2">
                                                                {summaryFiles.map((file, index) => (
                                                                    <div key={index} className="flex items-center justify-between bg-white/5 backdrop-blur-lg rounded-lg px-3 py-2">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="text-xs text-slate-500 w-5 text-center shrink-0">{index + 1}.</span>
                                                                            <Mic className="w-4 h-4 text-purple-400 shrink-0" />
                                                                            <span className="text-sm truncate">{file.name}</span>
                                                                            <span className="text-xs text-slate-500 shrink-0">
                                                                                ({(file.size / (1024 * 1024)).toFixed(1)} MB)
                                                                            </span>
                                                                        </div>
                                                                        <button
                                                                            onClick={() => setSummaryFiles(prev => prev.filter((_, i) => i !== index))}
                                                                            className="p-1 text-slate-400 hover:text-red-400 shrink-0"
                                                                        >
                                                                            <X className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                                <button
                                                                    onClick={() => summaryFileInputRef.current?.click()}
                                                                    className="w-full py-2 border border-dashed border-purple-500/30 rounded-lg text-xs text-purple-400 hover:bg-purple-500/10 transition-all"
                                                                >
                                                                    + Add more audio files
                                                                </button>
                                                            </div>
                                                        )}

                                                        {!loadGeminiKeyFromStorage() && (
                                                            <div className="mt-3 p-3 bg-amber-600/10 border border-amber-600/30 rounded-lg">
                                                                <p className="text-sm text-amber-400">
                                                                    Gemini API key required for audio transcription. Add it in Settings.
                                                                </p>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}

                                                {/* Progress indicator */}
                                                {(summaryLoading || summaryFileUploading) && (
                                                    <div className="flex items-center gap-3 p-3 bg-teal-600/20 rounded-lg">
                                                        <RefreshCw className="w-5 h-5 text-teal-400 animate-spin" />
                                                        <span className="text-sm text-teal-400">
                                                            {summaryUploadProgress || 'Generating summary...'}
                                                        </span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* Modal Footer */}
                                            <div className="p-4 border-t border-white/10 flex gap-3">
                                                <button
                                                    onClick={() => setShowSummaryInputModal(false)}
                                                    className="flex-1 px-4 py-3 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg font-medium"
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    onClick={generateSummaryFromModal}
                                                    disabled={
                                                        summaryLoading ||
                                                        summaryFileUploading ||
                                                        (summaryInputType === 'paste' && !summaryInput.trim()) ||
                                                        (summaryInputType === 'upload' && summaryFiles.length === 0) ||
                                                        (summaryInputType === 'audio' && (summaryFiles.length === 0 || !loadGeminiKeyFromStorage()))
                                                    }
                                                    className={`flex-1 px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all ${
                                                        summaryLoading || summaryFileUploading ||
                                                        (summaryInputType === 'paste' && !summaryInput.trim()) ||
                                                        (summaryInputType === 'upload' && summaryFiles.length === 0) ||
                                                        (summaryInputType === 'audio' && (summaryFiles.length === 0 || !loadGeminiKeyFromStorage()))
                                                            ? 'bg-white/10 text-slate-500 cursor-not-allowed'
                                                            : 'bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700'
                                                    }`}
                                                >
                                                    {summaryLoading || summaryFileUploading ? (
                                                        <>
                                                            <RefreshCw className="w-4 h-4 animate-spin" />
                                                            Processing...
                                                        </>
                                                    ) : (
                                                        <>
                                                            <Send className="w-4 h-4" />
                                                            Generate Summary
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Add Topic Modal */}
                                {showAddTopicModal && (
                                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                                        <div className="absolute inset-0 bg-black/60" onClick={() => setShowAddTopicModal(false)} />
                                        <div className="relative bg-slate-900/90 backdrop-blur-2xl rounded-2xl border border-white/15 p-6 w-full max-w-md">
                                            <h3 className="text-lg font-semibold mb-4">Add New Topic</h3>
                                            
                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-slate-300 mb-2">Topic Type</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button
                                                        onClick={() => setNewTopicType('ticker')}
                                                        className={`px-4 py-3 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${
                                                            newTopicType === 'ticker' ? 'bg-teal-600' : 'bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10'
                                                        }`}
                                                    >
                                                        <span>üìà</span> Ticker
                                                    </button>
                                                    <button
                                                        onClick={() => setNewTopicType('macro')}
                                                        className={`px-4 py-3 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${
                                                            newTopicType === 'macro' ? 'bg-teal-600' : 'bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10'
                                                        }`}
                                                    >
                                                        <span>üåç</span> Macro
                                                    </button>
                                                    <button
                                                        onClick={() => setNewTopicType('industry')}
                                                        className={`px-4 py-3 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${
                                                            newTopicType === 'industry' ? 'bg-teal-600' : 'bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10'
                                                        }`}
                                                    >
                                                        <span>üè≠</span> Industry
                                                    </button>
                                                    <button
                                                        onClick={() => setNewTopicType('other')}
                                                        className={`px-4 py-3 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${
                                                            newTopicType === 'other' ? 'bg-teal-600' : 'bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10'
                                                        }`}
                                                    >
                                                        <span>üìã</span> Other
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div className="mb-6">
                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                    {newTopicType === 'ticker' ? 'Ticker Symbol' : 'Topic Name'}
                                                </label>
                                                <input
                                                    type="text"
                                                    value={newTopicName}
                                                    onChange={(e) => setNewTopicName(newTopicType === 'ticker' ? e.target.value.toUpperCase() : e.target.value)}
                                                    placeholder={newTopicType === 'ticker' ? 'e.g., AAPL' : 'e.g., Fed Policy, Healthcare'}
                                                    className="w-full px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                />
                                            </div>
                                            
                                            <div className="flex gap-3">
                                                <button
                                                    onClick={() => {
                                                        setShowAddTopicModal(false);
                                                    }}
                                                    className="flex-1 px-4 py-3 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg font-medium"
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        if (newTopicName.trim()) {
                                                            setShowAddTopicModal(false);
                                                        }
                                                    }}
                                                    disabled={!newTopicName.trim()}
                                                    className={`flex-1 px-4 py-3 rounded-lg font-medium transition-colors ${
                                                        newTopicName.trim()
                                                            ? 'bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20'
                                                            : 'bg-white/10 text-slate-500 cursor-not-allowed'
                                                    }`}
                                                >
                                                    Add Topic
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Email with Options Modal */}
                                {showSummaryEmailModal && (
                                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                                        <div className="absolute inset-0 bg-black/60" onClick={() => setShowSummaryEmailModal(false)} />
                                        <div className="relative bg-slate-900/90 backdrop-blur-2xl rounded-2xl border border-white/15 p-6 w-full max-w-md">
                                            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                                <Mail className="w-5 h-5 text-amber-400" />
                                                Email {summaryEmailSection === 'takeaways' ? 'Key Takeaways' : summaryEmailSection === 'questions' ? 'Follow-up Questions' : 'Summary'}
                                            </h3>
                                            
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-300 mb-2">Recipient Email</label>
                                                    <input
                                                        type="email"
                                                        value={summaryEmailRecipient}
                                                        onChange={(e) => setSummaryEmailRecipient(e.target.value)}
                                                        placeholder="recipient@example.com"
                                                        className="w-full px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-300 mb-2">Subject</label>
                                                    <input
                                                        type="text"
                                                        value={summaryEmailSubject}
                                                        onChange={(e) => setSummaryEmailSubject(e.target.value)}
                                                        placeholder="Email subject..."
                                                        className="w-full px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                    />
                                                </div>
                                            </div>
                                            
                                            <div className="flex gap-3 mt-6">
                                                <button
                                                    onClick={() => setShowSummaryEmailModal(false)}
                                                    className="flex-1 px-4 py-3 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg font-medium"
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    onClick={sendSummaryEmailWithOptions}
                                                    disabled={!summaryEmailRecipient.trim()}
                                                    className={`flex-1 px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors ${
                                                        summaryEmailRecipient.trim()
                                                            ? 'bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600'
                                                            : 'bg-white/10 text-slate-500 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Send className="w-4 h-4" />
                                                    Send Email
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Save Confirmation Modal */}
                                {showSaveConfirmModal && (
                                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                                        <div className="absolute inset-0 bg-black/60" onClick={() => setShowSaveConfirmModal(null)} />
                                        <div className="relative bg-slate-900/90 backdrop-blur-2xl rounded-2xl border border-white/15 p-6 w-full max-w-sm">
                                            <h3 className="text-lg font-semibold mb-3 flex items-center gap-2">
                                                <Save className="w-5 h-5 text-teal-400" />
                                                Save Changes?
                                            </h3>
                                            <p className="text-slate-400 text-sm mb-6">
                                                Are you sure you want to save changes to {showSaveConfirmModal === 'takeaways' ? 'Key Takeaways' : 'Follow-up Questions'}?
                                            </p>
                                            
                                            <div className="flex gap-3">
                                                <button
                                                    onClick={() => setShowSaveConfirmModal(null)}
                                                    className="flex-1 px-4 py-3 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg font-medium"
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        if (showSaveConfirmModal === 'takeaways') {
                                                            saveEditedTakeaways();
                                                        } else {
                                                            saveEditedQuestions();
                                                        }
                                                    }}
                                                    className="flex-1 px-4 py-3 bg-teal-600 hover:bg-teal-500 rounded-lg font-medium flex items-center justify-center gap-2"
                                                >
                                                    <Check className="w-4 h-4" />
                                                    Save
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* RESEARCH TAB */}
                        {activeTab === 'research' && (
                            <div className="flex-1 flex flex-col overflow-hidden pb-24 md:pb-0">
                                {/* Analysis Detail View */}
                                {currentResearchAnalysis ? (
                                    <div className="flex-1 flex flex-col overflow-hidden">
                                        {/* Header */}
                                        <div className="bg-white/[0.04] backdrop-blur-lg border-b border-white/[0.08] p-4">
                                            <div className="flex items-center justify-between mb-2">
                                                <button
                                                    onClick={() => {
                                                        setCurrentResearchAnalysis(null);
                                                        setEditingResearchAnalysis(false);
                                                    }}
                                                    className="flex items-center gap-2 text-slate-400 hover:text-white"
                                                >
                                                    <ChevronLeft className="w-5 h-5" />
                                                    Back
                                                </button>
                                                <div className="flex gap-2">
                                                    <button onClick={() => copyAnalysisResult(currentResearchAnalysis)} className="p-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg" title="Copy">
                                                        <Copy className="w-4 h-4" />
                                                    </button>
                                                    {!editingResearchAnalysis && (
                                                        <button onClick={startEditingAnalysis} className="p-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg" title="Edit">
                                                            <Edit2 className="w-4 h-4" />
                                                        </button>
                                                    )}
                                                    <button onClick={quickEmailAnalysis} className="p-2 bg-amber-600/80 hover:bg-amber-600 rounded-lg" title="Quick Email">
                                                        <Send className="w-4 h-4" />
                                                    </button>
                                                    <button onClick={openAnalysisEmailModal} className="p-2 bg-amber-600/80 hover:bg-amber-600 rounded-lg" title="Email Options">
                                                        <Mail className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xl">{currentResearchAnalysis.promptIcon}</span>
                                                <h2 className="font-semibold text-lg text-teal-400">{currentResearchAnalysis.promptName}</h2>
                                            </div>
                                            <p className="text-xs text-slate-500 mt-1">{formatNYTime(currentResearchAnalysis.createdAt)}</p>
                                        </div>
                                        
                                        {/* Content */}
                                        <div className="flex-1 overflow-y-auto p-4">
                                            {editingResearchAnalysis ? (
                                                <div className="space-y-3">
                                                    <textarea
                                                        value={editedAnalysisContent}
                                                        onChange={(e) => setEditedAnalysisContent(e.target.value)}
                                                        className="w-full min-h-[400px] px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-slate-200 focus:outline-none focus:ring-2 focus:ring-teal-500 resize-y"
                                                        style={{ fontSize: '14px' }}
                                                    />
                                                    <div className="flex gap-2 justify-end">
                                                        <button onClick={() => setEditingResearchAnalysis(false)} className="px-4 py-2 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm">Cancel</button>
                                                        <button onClick={saveEditedAnalysis} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm flex items-center gap-2">
                                                            <Save className="w-4 h-4" /> Save
                                                        </button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 p-4">
                                                    <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: renderMarkdown(currentResearchAnalysis.result) }} />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    /* Main Research View */
                                    <>
                                        {/* Header with horizontal category nav */}
                                        <div className="bg-white/[0.04] backdrop-blur-lg border-b border-white/[0.08] flex-shrink-0">
                                            <div className="p-4 pb-2">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="flex items-center gap-3">
                                                        <Microscope className="w-6 h-6 text-teal-400" />
                                                        <h1 className="text-xl font-bold">Research</h1>
                                                    </div>
                                                    {getCurrentCategoryDocs().length > 0 && (
                                                        <button
                                                            onClick={toggleExpandAllDocs}
                                                            className="px-3 py-1.5 bg-white/10 hover:bg-white/15 rounded-lg text-xs flex items-center gap-2"
                                                        >
                                                            {expandAllResearchDocs ? <ChevronsUp className="w-4 h-4" /> : <ChevronsDown className="w-4 h-4" />}
                                                            {expandAllResearchDocs ? 'Collapse All' : 'Expand All'}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Horizontal Category Navigation */}
                                            <div className="flex items-center gap-2 px-4 pb-3 overflow-x-auto scrollbar-hide">
                                                <button
                                                    onClick={() => setShowAddResearchCategory(true)}
                                                    className="flex-shrink-0 px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-full text-sm font-medium text-white transition-all"
                                                >
                                                    + New
                                                </button>
                                                <button
                                                    onClick={() => setSelectedResearchCategory(null)}
                                                    className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                                        selectedResearchCategory === null
                                                            ? 'bg-teal-600 text-white'
                                                            : 'bg-white/10 text-slate-300 hover:bg-white/10'
                                                    }`}
                                                >
                                                    All
                                                </button>
                                                {[...researchCategories].sort((a, b) => {
                                                    // Sort by type first (ticker before topic), then alphabetically
                                                    if (a.type !== b.type) {
                                                        return a.type === 'ticker' ? -1 : 1;
                                                    }
                                                    return a.name.localeCompare(b.name);
                                                }).map(cat => (
                                                    <button
                                                        key={cat.id}
                                                        onClick={() => setSelectedResearchCategory(cat.id)}
                                                        className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                                            selectedResearchCategory === cat.id
                                                                ? 'bg-teal-600 text-white'
                                                                : 'bg-white/10 text-slate-300 hover:bg-white/10'
                                                        }`}
                                                    >
                                                        {cat.type === 'ticker' ? 'üìà' : 'üìÅ'} {cat.name}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {/* Document Type Filter */}
                                            <div className="px-4 pb-3">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs text-slate-500 flex-shrink-0">Filter:</span>
                                                    <div className="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
                                                        {RESEARCH_DOC_TYPES.map(dtype => (
                                                            <button
                                                                key={dtype.id}
                                                                onClick={() => {
                                                                    setResearchDocTypeFilter(prev => 
                                                                        prev.includes(dtype.id) 
                                                                            ? prev.filter(t => t !== dtype.id)
                                                                            : [...prev, dtype.id]
                                                                    );
                                                                }}
                                                                className={`px-2 py-1 rounded text-xs transition-all flex items-center gap-1 whitespace-nowrap flex-shrink-0 ${
                                                                    researchDocTypeFilter.includes(dtype.id)
                                                                        ? 'bg-teal-600 text-white'
                                                                        : 'bg-white/5 text-slate-400 hover:bg-white/10'
                                                                }`}
                                                            >
                                                                <span>{dtype.icon}</span>
                                                                {dtype.label}
                                                            </button>
                                                        ))}
                                                        {researchDocTypeFilter.length > 0 && (
                                                            <button
                                                                onClick={() => setResearchDocTypeFilter([])}
                                                                className="px-2 py-1 rounded text-xs bg-white/10 text-slate-300 hover:bg-white/15 flex items-center gap-1 whitespace-nowrap flex-shrink-0"
                                                            >
                                                                <X className="w-3 h-3" />
                                                                Clear
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Main Content Area */}
                                        <div className="flex-1 overflow-y-auto p-4" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                                            {researchCategories.length === 0 && researchDocuments.length === 0 ? (
                                                /* No Categories or Documents - Get Started */
                                                <div className="text-center py-12">
                                                    <Microscope className="w-16 h-16 mx-auto mb-4 text-slate-600" />
                                                    <h2 className="text-xl font-semibold mb-2">Get Started</h2>
                                                    <p className="text-slate-400 mb-6">Create a category to organize your research</p>
                                                    <button
                                                        onClick={() => setShowAddResearchCategory(true)}
                                                        className="px-6 py-3 bg-teal-600 hover:bg-teal-500 rounded-xl font-medium"
                                                    >
                                                        + Add Ticker or Topic
                                                    </button>
                                                </div>
                                            ) : showAddResearchDoc || runMoreFrameworksDocId ? (
                                                /* Add Document / Run More Frameworks View */
                                                <div className="max-w-2xl mx-auto space-y-6">
                                                    <div className="flex items-center justify-between">
                                                        <h2 className="text-lg font-semibold">
                                                            {runMoreFrameworksDocId ? 'Run Additional Frameworks' : 'Add New Document'}
                                                        </h2>
                                                        <button
                                                            onClick={() => { setShowAddResearchDoc(false); setRunMoreFrameworksDocId(null); setSelectedFrameworks([]); setStoreResearchDocument(false); setNewBrokerName(''); setNewResearchDocType(''); }}
                                                            className="p-2 hover:bg-white/10 rounded-lg"
                                                        >
                                                            <X className="w-5 h-5" />
                                                        </button>
                                                    </div>
                                                    
                                                    {!runMoreFrameworksDocId && (
                                                        <>
                                                            {/* Document Name */}
                                                            <div>
                                                                <label className="block text-sm font-medium text-slate-300 mb-2">Document Name</label>
                                                                <input
                                                                    type="text"
                                                                    value={newDocumentName}
                                                                    onChange={(e) => setNewDocumentName(e.target.value)}
                                                                    placeholder="e.g., Industrials 2026 Outlook (auto-fills from file)"
                                                                    className="w-full px-4 py-3 bg-white/5 backdrop-blur-md border border-white/10 rounded-xl text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                                    style={{ fontSize: '16px' }}
                                                                />
                                                            </div>
                                                            
                                                            {/* Broker Name (Optional) */}
                                                            <div>
                                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                                    Broker Name <span className="text-slate-500 font-normal">(optional)</span>
                                                                </label>
                                                                <input
                                                                    type="text"
                                                                    value={newBrokerName}
                                                                    onChange={(e) => setNewBrokerName(e.target.value)}
                                                                    placeholder="e.g., BofA, Goldman Sachs, Morgan Stanley"
                                                                    className="w-full px-4 py-3 bg-white/5 backdrop-blur-md border border-white/10 rounded-xl text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                                    style={{ fontSize: '16px' }}
                                                                />
                                                                {newBrokerName && newDocumentName && (
                                                                    <p className="text-xs text-slate-500 mt-2">
                                                                        Final name: <span className="text-teal-400">{newBrokerName} - {newDocumentName}</span>
                                                                    </p>
                                                                )}
                                                            </div>
                                                            
                                                            {/* Document Type (Optional) */}
                                                            <div>
                                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                                    Document Type <span className="text-slate-500 font-normal">(optional)</span>
                                                                </label>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {RESEARCH_DOC_TYPES.map(dtype => (
                                                                        <button
                                                                            key={dtype.id}
                                                                            type="button"
                                                                            onClick={() => setNewResearchDocType(newResearchDocType === dtype.id ? '' : dtype.id)}
                                                                            className={`px-3 py-1.5 rounded-lg text-sm transition-all flex items-center gap-1.5 ${
                                                                                newResearchDocType === dtype.id
                                                                                    ? 'bg-teal-600 text-white'
                                                                                    : 'bg-white/10 text-slate-300 hover:bg-white/10'
                                                                            }`}
                                                                        >
                                                                            <span>{dtype.icon}</span>
                                                                            {dtype.label}
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                            
                                                            {/* File Upload */}
                                                            <div>
                                                                <label className="block text-sm font-medium text-slate-300 mb-2">Upload Document(s)</label>
                                                                <div 
                                                                    className="border-2 border-dashed border-white/10 rounded-xl p-6 text-center hover:border-teal-500/50 transition-colors cursor-pointer"
                                                                    onClick={() => researchFileInputRef.current?.click()}
                                                                >
                                                                    <input ref={researchFileInputRef} type="file" multiple accept=".pdf,.doc,.docx,.txt,.md,.png,.jpg,.jpeg" onChange={handleResearchFileUpload} className="hidden" />
                                                                    <FileUp className="w-8 h-8 mx-auto mb-2 text-slate-500" />
                                                                    <p className="text-sm text-slate-400">Click to upload</p>
                                                                </div>
                                                                {renderDriveSearch(
                                                                    selectedResearchCategory ? (researchCategories.find(c => c.id === selectedResearchCategory)?.name || '') : '',
                                                                    handleDriveImportResearch
                                                                )}
                                                                {researchFiles.length > 0 && (
                                                                    <div className="mt-3 space-y-2">
                                                                        {researchFiles.map(file => (
                                                                            <div key={file.id} className="flex items-center justify-between bg-white/[0.07] backdrop-blur-lg rounded-lg px-3 py-2">
                                                                                <span className="text-sm truncate">{file.name}</span>
                                                                                <button onClick={() => removeResearchFile(file.id)} className="p-1 hover:bg-white/10 rounded">
                                                                                    <X className="w-4 h-4" />
                                                                                </button>
                                                                            </div>
                                                                        ))}
                                                                        
                                                                        {/* Store Document Checkbox */}
                                                                        <label className="flex items-center gap-3 mt-3 p-3 bg-white/[0.04] backdrop-blur-lg rounded-lg border border-white/10 cursor-pointer hover:bg-white/10 transition-colors">
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={storeResearchDocument}
                                                                                onChange={(e) => setStoreResearchDocument(e.target.checked)}
                                                                                className="w-4 h-4 rounded border-white/10 text-teal-500 focus:ring-teal-500 focus:ring-offset-0 bg-white/10"
                                                                            />
                                                                            <div className="flex-1">
                                                                                <span className="text-sm font-medium text-slate-200">Store document for later</span>
                                                                                <p className="text-xs text-slate-500 mt-0.5">Keep original file to re-analyze with different frameworks</p>
                                                                            </div>
                                                                            <Database className="w-4 h-4 text-slate-500" />
                                                                        </label>
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            {/* Or Paste */}
                                                            <div className="flex items-center gap-3">
                                                                <div className="flex-1 h-px bg-white/10" />
                                                                <span className="text-xs text-slate-500">OR PASTE</span>
                                                                <div className="flex-1 h-px bg-white/10" />
                                                            </div>
                                                            
                                                            <textarea
                                                                value={researchInput}
                                                                onChange={(e) => setResearchInput(e.target.value)}
                                                                placeholder="Paste content here..."
                                                                className="w-full px-4 py-3 bg-white/5 backdrop-blur-md border border-white/10 rounded-xl text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500 min-h-[120px] resize-y"
                                                                style={{ fontSize: '16px' }}
                                                            />
                                                        </>
                                                    )}
                                                    
                                                    {/* Framework Selection */}
                                                    <div>
                                                        <div className="flex items-center justify-between mb-3">
                                                            <label className="text-sm font-medium text-slate-300">Select Analysis Framework(s)</label>
                                                            <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    selectAllFrameworks();
                                                                }}
                                                                className="text-xs text-teal-400 hover:text-teal-300"
                                                            >
                                                                {selectedFrameworks.length === RESEARCH_PROMPTS.length ? 'Deselect All' : 'Select All'}
                                                            </button>
                                                        </div>
                                                        <div className="space-y-1.5">
                                                            {RESEARCH_PROMPTS.map(prompt => {
                                                                const isSelected = selectedFrameworks.includes(prompt.id);
                                                                const alreadyRun = runMoreFrameworksDocId && 
                                                                    researchAnalyses.some(a => a.documentId === runMoreFrameworksDocId && a.promptId === prompt.id);
                                                                
                                                                return (
                                                                    <div key={prompt.id} className="relative">
                                                                        <button
                                                                            type="button"
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                if (!alreadyRun) {
                                                                                    toggleFrameworkSelection(prompt.id);
                                                                                }
                                                                            }}
                                                                            disabled={alreadyRun}
                                                                            className={`w-full px-3 py-2 rounded-lg border text-left transition-all ${
                                                                                alreadyRun
                                                                                    ? 'bg-white/[0.04] border-white/10 opacity-50 cursor-not-allowed'
                                                                                    : isSelected
                                                                                        ? 'bg-teal-600/20 border-teal-500'
                                                                                        : 'bg-white/[0.07] backdrop-blur-lg border-white/10 hover:border-white/10'
                                                                            }`}
                                                                        >
                                                                            <div className="flex items-center gap-2.5">
                                                                                <div className={`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ${
                                                                                    alreadyRun
                                                                                        ? 'border-green-500 bg-green-500/20'
                                                                                        : isSelected 
                                                                                            ? 'border-teal-400 bg-teal-500' 
                                                                                            : 'border-white/20'
                                                                                }`}>
                                                                                    {(isSelected || alreadyRun) && <Check className="w-3 h-3 text-white" />}
                                                                                </div>
                                                                                <span className="text-base flex-shrink-0">{prompt.icon}</span>
                                                                                <div className="flex-1 min-w-0">
                                                                                    <div className="font-medium text-sm text-slate-200">{prompt.shortName}</div>
                                                                                    <p className="text-xs text-slate-500 truncate">{prompt.description}</p>
                                                                                </div>
                                                                                <button
                                                                                    type="button"
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        setShowFrameworkInfo(showFrameworkInfo === prompt.id ? null : prompt.id);
                                                                                    }}
                                                                                    className="p-1 opacity-30 hover:opacity-100 active:opacity-100 transition-opacity flex-shrink-0"
                                                                                >
                                                                                    <Info className="w-3.5 h-3.5" />
                                                                                </button>
                                                                            </div>
                                                                        </button>
                                                                        {showFrameworkInfo === prompt.id && (
                                                                            <div className="absolute left-0 right-0 top-full mt-1 p-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-xs text-slate-300 z-50 shadow-xl">
                                                                                <div className="flex justify-between items-start gap-2 mb-1">
                                                                                    <span className="font-medium text-teal-400">{prompt.name}</span>
                                                                                    <button 
                                                                                        onClick={(e) => { e.stopPropagation(); setShowFrameworkInfo(null); }}
                                                                                        className="p-0.5 hover:bg-white/10 rounded"
                                                                                    >
                                                                                        <X className="w-3 h-3" />
                                                                                    </button>
                                                                                </div>
                                                                                {prompt.description}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Run Button */}
                                                    <button
                                                        onClick={() => runMoreFrameworksDocId ? runMoreFrameworks(runMoreFrameworksDocId) : createDocumentAndAnalyze()}
                                                        disabled={isResearchLoading || selectedFrameworks.length === 0 || (!runMoreFrameworksDocId && !researchInput.trim() && researchFiles.length === 0)}
                                                        className="w-full py-4 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 disabled:from-white/10 disabled:to-white/10 disabled:cursor-not-allowed rounded-xl font-semibold text-lg flex items-center justify-center gap-3 shadow-lg"
                                                    >
                                                        {isResearchLoading ? (
                                                            <>
                                                                <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                                                                <span>Running {researchLoadingFrameworks.length} framework(s)<span className="animate-pulse">...</span></span>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <Microscope className="w-5 h-5" />
                                                                Run {selectedFrameworks.length} Framework{selectedFrameworks.length !== 1 ? 's' : ''}
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                            ) : (
                                                /* Document List View */
                                                <div className="space-y-4">
                                                    {getCurrentCategoryDocs().length === 0 ? (
                                                        <div className="text-center py-12">
                                                            <FileText className="w-12 h-12 mx-auto mb-4 text-slate-600" />
                                                            <p className="text-slate-400 mb-4">
                                                                {selectedResearchCategory ? 'No documents in this category yet' : 'No research documents yet'}
                                                            </p>
                                                            {selectedResearchCategory && (
                                                                <button
                                                                    onClick={() => setShowAddResearchDoc(true)}
                                                                    className="px-6 py-3 bg-teal-600 hover:bg-teal-500 rounded-xl font-medium"
                                                                >
                                                                    + Add Document
                                                                </button>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <>
                                                            {/* Document Cards */}
                                                            {getCurrentCategoryDocs().map(doc => {
                                                                const docAnalyses = getDocAnalyses(doc.id);
                                                                const isExpanded = expandedResearchDocs.has(doc.id);
                                                                const isDocLoading = researchLoadingDocId === doc.id;
                                                                
                                                                // Get current category to check if broker matches ticker
                                                                const currentCategory = researchCategories.find(c => c.id === selectedResearchCategory);
                                                                const categoryTicker = currentCategory?.name?.toUpperCase() || '';
                                                                
                                                                // Map tickers to their company/broker names to avoid false matches
                                                                const tickerToBrokerMap = {
                                                                    'GS': ['Goldman Sachs', 'Goldman'],
                                                                    'MS': ['Morgan Stanley'],
                                                                    'JPM': ['JPMorgan', 'JP Morgan'],
                                                                    'BAC': ['BofA', 'Bank of America', 'BAML'],
                                                                    'C': ['Citi', 'Citigroup'],
                                                                    'UBS': ['UBS'],
                                                                    'RBC': ['RBC'],
                                                                    'DB': ['Deutsche Bank'],
                                                                    'HSBC': ['HSBC'],
                                                                    'BCS': ['Barclays'],
                                                                    'EVR': ['Evercore'],
                                                                    'JEF': ['Jefferies'],
                                                                    'SF': ['Stifel'],
                                                                    'PIPR': ['Piper', 'Piper Sandler'],
                                                                    'MIZ': ['Mizuho'],
                                                                    'TFC': ['Truist'],
                                                                    'KEY': ['KeyBanc'],
                                                                    'WFC': ['Wells Fargo'],
                                                                    'RJF': ['Raymond James'],
                                                                    'SCHW': ['Schwab']
                                                                };
                                                                
                                                                // Get broker names to exclude if analyzing that stock
                                                                const excludedBrokers = tickerToBrokerMap[categoryTicker] || [];
                                                                
                                                                // Extract source from filename patterns
                                                                const extractSource = (name) => {
                                                                    if (!name) return null;
                                                                    
                                                                    // Map abbreviations to display names
                                                                    const abbrevMap = {
                                                                        'GS': 'Goldman Sachs', 'Goldman': 'Goldman Sachs',
                                                                        'MS': 'Morgan Stanley',
                                                                        'BAML': 'BofA', 'BofA Securities': 'BofA', 'Bank of America': 'BofA',
                                                                        'DB': 'Deutsche Bank',
                                                                        'CS': 'Credit Suisse',
                                                                        'Citigroup': 'Citi',
                                                                        'JP Morgan': 'JPMorgan', 'JPM': 'JPMorgan',
                                                                        'Wolfe Research': 'Wolfe',
                                                                        'TD Cowen': 'Cowen',
                                                                        'Cantor Fitzgerald': 'Cantor',
                                                                        'RJ': 'Raymond James',
                                                                        'Leerink Partners': 'Leerink',
                                                                        'Piper Sandler': 'Piper',
                                                                        'KeyBanc Capital': 'KeyBanc',
                                                                        'William Blair': 'Blair'
                                                                    };
                                                                    
                                                                    const brokerPatterns = [
                                                                        // Abbreviations at start of filename
                                                                        /^(GS|MS|BAML|BofA|Citi|JPM|UBS|RBC|DB|CS|HSBC|RJ)\s/i,
                                                                        // Full/partial names - comprehensive list
                                                                        /(?:^|\s|_|-)(Goldman Sachs|Goldman|Morgan Stanley|BofA Securities|BofA|Bank of America|Citi|Citigroup|JPMorgan|JP Morgan|Barclays|UBS|RBC|TD Securities|TD Cowen|Cowen|Wolfe Research|Wolfe|Bernstein|Jefferies|Wells Fargo|Raymond James|Stifel|Baird|Piper Sandler|Piper|Evercore|William Blair|Credit Suisse|Deutsche Bank|HSBC|Nephron Research|Nephron|Cantor Fitzgerald|Cantor|Mizuho|KeyBanc Capital|KeyBanc|Truist|Leerink Partners|Leerink|Oppenheimer|Wedbush|Needham|Craig-Hallum|Stephens|BMO|Scotia|CIBC|National Bank|Redburn|Berenberg|Exane|Kepler|SocGen|BNP|Macquarie)(?:\s|$|-|_|,)/i
                                                                    ];
                                                                    
                                                                    for (const pattern of brokerPatterns) {
                                                                        const match = name.match(pattern);
                                                                        if (match) {
                                                                            const found = match[1];
                                                                            const displayName = abbrevMap[found] || found;
                                                                            
                                                                            // Check if this broker should be excluded (matches the stock being analyzed)
                                                                            if (excludedBrokers.some(eb => eb.toLowerCase() === displayName.toLowerCase() || eb.toLowerCase() === found.toLowerCase())) {
                                                                                continue; // Skip this match, try next pattern
                                                                            }
                                                                            
                                                                            return displayName;
                                                                        }
                                                                    }
                                                                    return null;
                                                                };
                                                                
                                                                // Extract and format publish date - prioritize stored date
                                                                const extractAndFormatDate = (storedDate) => {
                                                                    // Use stored publishedDate which was extracted from document content at upload
                                                                    if (storedDate) {
                                                                        try {
                                                                            // Handle various date formats
                                                                            const d = new Date(storedDate);
                                                                            if (!isNaN(d.getTime())) {
                                                                                return `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
                                                                            }
                                                                            // If it's already in M/D/YY format, return as-is
                                                                            if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(storedDate)) {
                                                                                return storedDate;
                                                                            }
                                                                        } catch(e) {}
                                                                    }
                                                                    return null;
                                                                };
                                                                
                                                                const displayName = showResearchSmartNames ? (doc.smartName || doc.name) : doc.name;
                                                                const source = extractSource(doc.name) || extractSource(doc.originalFilename) || extractSource(displayName);
                                                                const pubDate = extractAndFormatDate(doc.publishedDate);
                                                                
                                                                // Build suffix like Portfolio tab
                                                                let nameSuffix = '';
                                                                if (source && pubDate) nameSuffix = ` (${source}, ${pubDate})`;
                                                                else if (source) nameSuffix = ` (${source})`;
                                                                else if (pubDate) nameSuffix = ` (${pubDate})`;
                                                                
                                                                // Remove any existing parenthetical suffix from displayName to avoid duplication
                                                                let cleanDisplayName = displayName.replace(/\s*\([^)]*\)\s*$/, '').trim();
                                                                
                                                                return (
                                                                    <div key={doc.id} className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 overflow-hidden">
                                                                        {/* Document Header */}
                                                                        <button
                                                                            onClick={() => toggleDocExpansion(doc.id)}
                                                                            className="w-full p-3 text-left flex items-start justify-between hover:bg-white/[0.04] transition-colors"
                                                                        >
                                                                            <div className="flex items-start gap-2.5 min-w-0 flex-1">
                                                                                <FileText className="w-4 h-4 text-slate-400 flex-shrink-0 mt-0.5" />
                                                                                <div className="min-w-0 flex-1">
                                                                                    {/* Document title - 3 lines max */}
                                                                                    <h3 className="font-medium text-[13px] leading-snug line-clamp-3">
                                                                                        {cleanDisplayName}{nameSuffix}
                                                                                    </h3>
                                                                                    
                                                                                    {/* Metadata and action buttons row */}
                                                                                    <div className="flex items-center gap-2 mt-1.5 text-xs text-slate-500 flex-wrap">
                                                                                        {!selectedResearchCategory && (() => {
                                                                                            const docCategory = researchCategories.find(c => c.id === doc.categoryId);
                                                                                            return docCategory ? (
                                                                                                <span className="px-1.5 py-0.5 bg-white/10 rounded text-slate-300">
                                                                                                    {docCategory.type === 'ticker' ? 'üìà' : 'üìÅ'} {docCategory.name}
                                                                                                </span>
                                                                                            ) : null;
                                                                                        })()}
                                                                                        <span>{formatNYTime(doc.createdAt)}</span>
                                                                                        <span>‚Ä¢ {docAnalyses.length} {docAnalyses.length === 1 ? 'analysis' : 'analyses'}</span>
                                                                                        {doc.hasStoredFiles && (
                                                                                            <span className="text-teal-400" title="Original file stored">üíæ</span>
                                                                                        )}
                                                                                        {/* Doc Type Badge */}
                                                                                        {doc.docType && doc.docType !== 'other' && (
                                                                                            <span className="px-1.5 py-0.5 bg-amber-600/20 text-amber-400 rounded text-[10px]">
                                                                                                {RESEARCH_DOC_TYPES.find(t => t.id === doc.docType)?.icon} {RESEARCH_DOC_TYPES.find(t => t.id === doc.docType)?.label}
                                                                                            </span>
                                                                                        )}
                                                                                        
                                                                                        {/* Info and Toggle buttons */}
                                                                                        <button
                                                                                            onClick={(e) => {
                                                                                                e.stopPropagation();
                                                                                                setExpandedDocTitle(expandedDocTitle === doc.id ? null : doc.id);
                                                                                            }}
                                                                                            className="p-0.5 opacity-40 hover:opacity-100 transition-opacity"
                                                                                            title="View full title"
                                                                                        >
                                                                                            <Info className="w-3 h-3" />
                                                                                        </button>
                                                                                        {doc.smartName && doc.smartName !== doc.name && (
                                                                                            <button
                                                                                                onClick={(e) => {
                                                                                                    e.stopPropagation();
                                                                                                    setShowResearchSmartNames(!showResearchSmartNames);
                                                                                                }}
                                                                                                className={`p-0.5 transition-opacity ${showResearchSmartNames ? 'opacity-60 hover:opacity-100 text-teal-400' : 'opacity-40 hover:opacity-100'}`}
                                                                                                title={showResearchSmartNames ? "Show assigned name" : "Show smart name"}
                                                                                            >
                                                                                                <Repeat2 className="w-3 h-3" />
                                                                                            </button>
                                                                                        )}
                                                                                    </div>
                                                                                    
                                                                                    {/* Expanded title details */}
                                                                                    {expandedDocTitle === doc.id && (
                                                                                        <div className="mt-2 p-2 bg-white/5 backdrop-blur-lg rounded-lg text-xs text-slate-300 break-words space-y-2" onClick={(e) => e.stopPropagation()}>
                                                                                            {doc.smartName && <div><span className="text-slate-500">Smart:</span> {doc.smartName}</div>}
                                                                                            
                                                                                            {/* Editable Name */}
                                                                                            {editingResearchDocName === doc.id ? (
                                                                                                <div className="space-y-2">
                                                                                                    <div><span className="text-slate-500">Name:</span></div>
                                                                                                    <input
                                                                                                        type="text"
                                                                                                        value={editingResearchDocNameValue}
                                                                                                        onChange={(e) => setEditingResearchDocNameValue(e.target.value)}
                                                                                                        onKeyDown={(e) => {
                                                                                                            if (e.key === 'Enter') saveResearchDocNameEdit(doc.id);
                                                                                                            if (e.key === 'Escape') cancelResearchDocNameEdit();
                                                                                                        }}
                                                                                                        className="w-full px-2 py-1 bg-white/5 border border-teal-500 rounded text-sm text-slate-200 focus:outline-none focus:ring-1 focus:ring-teal-500"
                                                                                                        autoFocus
                                                                                                        placeholder="Enter document name..."
                                                                                                    />
                                                                                                    <div className="flex gap-2">
                                                                                                        <button
                                                                                                            onClick={() => saveResearchDocNameEdit(doc.id)}
                                                                                                            className="px-2 py-1 text-xs bg-teal-600 hover:bg-teal-500 text-white rounded"
                                                                                                        >
                                                                                                            Save
                                                                                                        </button>
                                                                                                        <button
                                                                                                            onClick={cancelResearchDocNameEdit}
                                                                                                            className="px-2 py-1 text-xs bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 text-slate-300 rounded"
                                                                                                        >
                                                                                                            Cancel
                                                                                                        </button>
                                                                                                    </div>
                                                                                                </div>
                                                                                            ) : (
                                                                                                <div className="flex items-center gap-2">
                                                                                                    <span className="text-slate-500">Name:</span>
                                                                                                    <span className="flex-1">{doc.name}</span>
                                                                                                    <button
                                                                                                        onClick={() => startEditingResearchDocName(doc)}
                                                                                                        className="p-1 text-slate-400 hover:text-teal-400 hover:bg-white/10 rounded"
                                                                                                        title="Edit name"
                                                                                                    >
                                                                                                        <Edit2 className="w-3 h-3" />
                                                                                                    </button>
                                                                                                </div>
                                                                                            )}
                                                                                            
                                                                                            {/* Editable Doc Type */}
                                                                                            <div className="pt-2 border-t border-white/10">
                                                                                                <div className="flex items-center gap-2 mb-2">
                                                                                                    <span className="text-slate-500">Type:</span>
                                                                                                    {editingResearchDocType === doc.id ? (
                                                                                                        <button
                                                                                                            onClick={() => setEditingResearchDocType(null)}
                                                                                                            className="p-1 text-slate-400 hover:text-slate-200 hover:bg-white/10 rounded"
                                                                                                        >
                                                                                                            <X className="w-3 h-3" />
                                                                                                        </button>
                                                                                                    ) : (
                                                                                                        <>
                                                                                                            <span className="px-1.5 py-0.5 bg-amber-600/20 text-amber-400 rounded text-xs">
                                                                                                                {RESEARCH_DOC_TYPES.find(t => t.id === (doc.docType || 'other'))?.icon} {RESEARCH_DOC_TYPES.find(t => t.id === (doc.docType || 'other'))?.label || 'Other'}
                                                                                                            </span>
                                                                                                            <button
                                                                                                                onClick={() => setEditingResearchDocType(doc.id)}
                                                                                                                className="p-1 text-slate-400 hover:text-teal-400 hover:bg-white/10 rounded"
                                                                                                                title="Edit type"
                                                                                                            >
                                                                                                                <Edit2 className="w-3 h-3" />
                                                                                                            </button>
                                                                                                        </>
                                                                                                    )}
                                                                                                </div>
                                                                                                {editingResearchDocType === doc.id && (
                                                                                                    <div className="flex flex-wrap gap-1.5">
                                                                                                        {RESEARCH_DOC_TYPES.map(dtype => (
                                                                                                            <button
                                                                                                                key={dtype.id}
                                                                                                                onClick={() => updateResearchDocType(doc.id, dtype.id)}
                                                                                                                className={`px-2 py-1 rounded text-xs transition-all flex items-center gap-1 ${
                                                                                                                    (doc.docType || 'other') === dtype.id
                                                                                                                        ? 'bg-amber-600 text-white'
                                                                                                                        : 'bg-white/10 text-slate-300 hover:bg-white/15'
                                                                                                                }`}
                                                                                                            >
                                                                                                                {dtype.icon} {dtype.label}
                                                                                                            </button>
                                                                                                        ))}
                                                                                                    </div>
                                                                                                )}
                                                                                            </div>
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                            <div className="flex items-center gap-1.5 flex-shrink-0 ml-2">
                                                                                {isDocLoading && <div className="w-5 h-5 border-2 border-white/10 border-t-teal-400 rounded-full animate-spin" />}
                                                                                {isExpanded ? <ChevronUp className="w-4 h-4 text-slate-400" /> : <ChevronDown className="w-4 h-4 text-slate-400" />}
                                                                            </div>
                                                                        </button>
                                                                        
                                                                        {/* Expanded Content - Analyses */}
                                                                        {isExpanded && (
                                                                            <div className="border-t border-white/10 p-4 space-y-3">
                                                                                {/* Loading indicators for in-progress analyses */}
                                                                                {isDocLoading && researchLoadingFrameworks.map(fwId => {
                                                                                    const prompt = RESEARCH_PROMPTS.find(p => p.id === fwId);
                                                                                    if (!prompt) return null;
                                                                                    return (
                                                                                        <div key={fwId} className="flex items-center gap-3 p-3 bg-white/[0.04] rounded-lg border border-white/10">
                                                                                            <div className="w-5 h-5 border-2 border-white/10 border-t-teal-400 rounded-full animate-spin" />
                                                                                            <span className="text-lg">{prompt.icon}</span>
                                                                                            <span className="text-sm text-slate-400">Running {prompt.shortName}<span className="animate-pulse">...</span></span>
                                                                                        </div>
                                                                                    );
                                                                                })}
                                                                                
                                                                                {/* Completed Analyses */}
                                                                                {docAnalyses.map(analysis => (
                                                                                    <div
                                                                                        key={analysis.id}
                                                                                        onClick={() => setCurrentResearchAnalysis(analysis)}
                                                                                        className="p-3 bg-white/[0.04] rounded-lg border border-white/10 hover:border-white/10 transition-colors cursor-pointer"
                                                                                    >
                                                                                        {/* Row 1: Icon + Name */}
                                                                                        <div className="flex items-center gap-2 mb-1">
                                                                                            <span className="text-base">{analysis.promptIcon}</span>
                                                                                            <span className="font-medium text-teal-400 text-sm">{analysis.promptName}</span>
                                                                                        </div>
                                                                                        {/* Row 2: Date + Actions */}
                                                                                        <div className="flex items-center justify-between pl-6">
                                                                                            <span className="text-xs text-slate-500">{formatNYTime(analysis.createdAt)}</span>
                                                                                            <div className="flex gap-1" onClick={(e) => e.stopPropagation()}>
                                                                                                <button onClick={() => copyAnalysisResult(analysis)} className="p-1 hover:bg-white/10 rounded" title="Copy">
                                                                                                    <Copy className="w-3.5 h-3.5 text-slate-400" />
                                                                                                </button>
                                                                                                <button onClick={() => deleteResearchAnalysis(analysis.id)} className="p-1 hover:bg-red-600/20 rounded" title="Delete">
                                                                                                    <Trash className="w-3.5 h-3.5 text-red-400" />
                                                                                                </button>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                ))}
                                                                                
                                                                                {/* Run More / Document Actions */}
                                                                                <div className="flex items-center gap-2 pt-2">
                                                                                    {/* View PDF button if stored */}
                                                                                    {doc.hasStoredFiles && (
                                                                                        <button
                                                                                            onClick={() => openStoredPdf(doc.id)}
                                                                                            className="py-2 px-3 bg-teal-600/30 hover:bg-teal-600/50 text-teal-400 rounded-lg text-sm flex items-center justify-center gap-2"
                                                                                        >
                                                                                            <FileText className="w-4 h-4" /> View PDF
                                                                                        </button>
                                                                                    )}
                                                                                    <button
                                                                                        onClick={() => { setRunMoreFrameworksDocId(doc.id); setSelectedFrameworks([]); }}
                                                                                        className="flex-1 py-2 px-3 bg-white/[0.07] hover:bg-white/10 rounded-lg text-sm flex items-center justify-center gap-2"
                                                                                    >
                                                                                        <Plus className="w-4 h-4" /> Run More Frameworks
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => deleteResearchDocument(doc.id)}
                                                                                        className="p-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg"
                                                                                        title="Delete Document"
                                                                                    >
                                                                                        <Trash className="w-4 h-4" />
                                                                                    </button>
                                                                                </div>
                                                                                
                                                                                {/* Stored Files Section */}
                                                                                {doc.hasStoredFiles && (
                                                                                    <StoredFilesSection docId={doc.id} onDelete={() => deleteStoredFilesForDocument(doc.id)} />
                                                                                )}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                                            
                                                            {/* Add Document Button - only show when a category is selected */}
                                                            {selectedResearchCategory && (
                                                                <button
                                                                    onClick={() => setShowAddResearchDoc(true)}
                                                                    className="w-full py-4 border-2 border-dashed border-white/10 hover:border-teal-500/50 rounded-xl text-slate-400 hover:text-white transition-colors flex items-center justify-center gap-2"
                                                                >
                                                                    <Plus className="w-5 h-5" /> Add Document
                                                                </button>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                                
                                {/* Add Category Modal */}
                                {showAddResearchCategory && (
                                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                                        <div className="absolute inset-0 bg-black/60" onClick={() => setShowAddResearchCategory(false)} />
                                        <div className="relative bg-slate-900/90 backdrop-blur-2xl rounded-2xl border border-white/15 p-6 w-full max-w-md">
                                            <h3 className="text-lg font-semibold mb-4">Add Category</h3>
                                            <div className="space-y-4">
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => setNewCategoryType('ticker')}
                                                        className={`flex-1 py-3 rounded-lg font-medium ${newCategoryType === 'ticker' ? 'bg-teal-600' : 'bg-white/10'}`}
                                                    >
                                                        üìà Ticker
                                                    </button>
                                                    <button
                                                        onClick={() => setNewCategoryType('topic')}
                                                        className={`flex-1 py-3 rounded-lg font-medium ${newCategoryType === 'topic' ? 'bg-teal-600' : 'bg-white/10'}`}
                                                    >
                                                        üìÅ Topic
                                                    </button>
                                                </div>
                                                <input
                                                    type="text"
                                                    value={newCategoryName}
                                                    onChange={(e) => setNewCategoryName(newCategoryType === 'ticker' ? e.target.value.toUpperCase() : e.target.value)}
                                                    placeholder={newCategoryType === 'ticker' ? 'e.g., BMY' : 'e.g., Macro Research'}
                                                    className="w-full px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg"
                                                    autoFocus
                                                />
                                            </div>
                                            <div className="flex gap-3 mt-6">
                                                <button onClick={() => setShowAddResearchCategory(false)} className="flex-1 px-4 py-3 bg-white/10 rounded-lg">Cancel</button>
                                                <button
                                                    onClick={addResearchCategory}
                                                    disabled={!newCategoryName.trim()}
                                                    className="flex-1 px-4 py-3 bg-teal-600 hover:bg-teal-500 disabled:bg-white/10 rounded-lg"
                                                >
                                                    Add
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Email Modal */}
                                {showResearchEmailModal && (
                                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                                        <div className="absolute inset-0 bg-black/60" onClick={() => setShowResearchEmailModal(false)} />
                                        <div className="relative bg-slate-900/90 backdrop-blur-2xl rounded-2xl border border-white/15 p-6 w-full max-w-md">
                                            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                                <Mail className="w-5 h-5 text-amber-400" /> Email Analysis
                                            </h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-300 mb-2">Recipient</label>
                                                    <input
                                                        type="email"
                                                        value={researchEmailRecipient}
                                                        onChange={(e) => setResearchEmailRecipient(e.target.value)}
                                                        placeholder="recipient@example.com"
                                                        className="w-full px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-300 mb-2">Subject</label>
                                                    <input
                                                        type="text"
                                                        value={researchEmailSubject}
                                                        onChange={(e) => setResearchEmailSubject(e.target.value)}
                                                        className="w-full px-4 py-3 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg"
                                                    />
                                                </div>
                                            </div>
                                            <div className="flex gap-3 mt-6">
                                                <button onClick={() => setShowResearchEmailModal(false)} className="flex-1 px-4 py-3 bg-white/10 rounded-lg">Cancel</button>
                                                <button
                                                    onClick={sendResearchEmail}
                                                    disabled={!researchEmailRecipient.trim()}
                                                    className="flex-1 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 rounded-lg flex items-center justify-center gap-2"
                                                >
                                                    <Send className="w-4 h-4" /> Send
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* MEETING PREP TAB */}
                        {activeTab === 'meetingprep' && (
                            <div className="flex-1 flex flex-col overflow-hidden pb-24 md:pb-0">
                                {mpSelectedMeeting ? (
                                    /* Meeting Detail View */
                                    <div className="flex-1 flex flex-col overflow-hidden">
                                        <div className="bg-white/[0.04] backdrop-blur-lg border-b border-white/[0.08] p-4">
                                            <button onClick={() => { setMpSelectedMeeting(null); setMpDocuments([]); setMpQuestionSet(null); setMpPipelineError(null); }} className="text-sm text-slate-400 hover:text-teal-400 mb-2">&larr; All Meetings</button>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <h1 className="text-xl font-bold">
                                                        <span className="text-teal-400">{mpSelectedMeeting.ticker}</span>
                                                        {mpSelectedMeeting.company_name && <span className="text-slate-400 font-normal ml-2">{mpSelectedMeeting.company_name}</span>}
                                                    </h1>
                                                    <div className="flex gap-2 items-center mt-1 text-sm text-slate-300">
                                                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                                            mpSelectedMeeting.status === 'ready' ? 'bg-green-500/20 text-green-400' :
                                                            mpSelectedMeeting.status === 'generating' ? 'bg-amber-500/20 text-amber-400' :
                                                            'bg-slate-500/20 text-slate-400'
                                                        }`}>{mpSelectedMeeting.status}</span>
                                                        <span>{mpSelectedMeeting.meeting_type}</span>
                                                        {mpSelectedMeeting.meeting_date && <span>{mpSelectedMeeting.meeting_date}</span>}
                                                    </div>
                                                </div>
                                                <button onClick={() => deleteMpMeeting(mpSelectedMeeting.id)} className="text-slate-400 hover:text-red-400 text-xs">Delete</button>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-4" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>

                                            {/* Documents Section */}
                                            <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 p-4">
                                                <h2 className="font-semibold mb-3">Documents</h2>
                                                <div
                                                    onClick={() => mpFileInputRef.current?.click()}
                                                    onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-teal-500'); }}
                                                    onDragLeave={(e) => e.currentTarget.classList.remove('border-teal-500')}
                                                    onDrop={(e) => {
                                                        e.preventDefault();
                                                        e.currentTarget.classList.remove('border-teal-500');
                                                        if (e.dataTransfer.files.length) {
                                                            const input = mpFileInputRef.current;
                                                            const dt = new DataTransfer();
                                                            for (const f of e.dataTransfer.files) dt.items.add(f);
                                                            input.files = dt.files;
                                                            input.dispatchEvent(new Event('change', { bubbles: true }));
                                                        }
                                                    }}
                                                    className="border-2 border-dashed border-white/20 rounded-xl p-6 text-center cursor-pointer hover:border-teal-500/50 transition-all mb-3"
                                                >
                                                    <p className="text-slate-400">{mpUploading ? 'Uploading...' : 'Drag & drop PDF files here'}</p>
                                                    <p className="text-xs text-slate-400 mt-1">or click to select</p>
                                                    <input ref={mpFileInputRef} type="file" multiple accept=".pdf" onChange={handleMpFileUpload} className="hidden" />
                                                </div>

                                                {/* Google Drive Search */}
                                                {renderDriveSearch(mpSelectedMeeting?.ticker, handleDriveImportMp)}

                                                {mpDocuments.length > 0 ? (
                                                    <div className="space-y-2">
                                                        {mpDocuments.map(doc => (
                                                            <div key={doc.id} className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                                                <div className="flex items-center gap-2 flex-wrap min-w-0">
                                                                    <span className="text-sm font-medium truncate">{doc.filename}</span>
                                                                    <span className="px-1.5 py-0.5 rounded text-xs bg-white/10 text-slate-400">{doc.doc_type}</span>
                                                                    {doc.page_count && <span className="text-xs text-slate-300">{doc.page_count}p</span>}
                                                                    {doc.token_estimate && <span className="text-xs text-slate-400">~{(doc.token_estimate / 1000).toFixed(1)}K tokens</span>}
                                                                </div>
                                                                <button onClick={() => deleteMpDocument(doc.id)} className="text-slate-400 hover:text-red-400 ml-2 flex-shrink-0">&times;</button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p className="text-center text-slate-400 text-sm py-2">No documents yet</p>
                                                )}
                                            </div>

                                            {/* Generate Section */}
                                            <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 p-4">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h2 className="font-semibold">Questions</h2>
                                                    <div className="flex items-center gap-2">
                                                        {mpQuestionSet && mpQuestionSet.topics && mpQuestionSet.topics.length > 0 && (<>
                                                            <button onClick={() => quickEmailMpQuestions('clean')}
                                                                className="p-2 rounded-lg bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 shadow-lg shadow-amber-500/20 transition-all"
                                                                title="Email questions only">
                                                                <Mail className="w-4 h-4 text-white" />
                                                            </button>
                                                            <button onClick={() => quickEmailMpQuestions('detailed')}
                                                                className="p-2 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 shadow-lg shadow-purple-500/20 transition-all"
                                                                title="Email with context & sources">
                                                                <FileText className="w-4 h-4 text-white" />
                                                            </button>
                                                        </>)}
                                                        {mpDocuments.length > 0 && !mpPipelineRunning && (
                                                            <button onClick={runMpPipeline} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm font-medium transition-all">
                                                                {mpQuestionSet && mpQuestionSet.status === 'ready' ? 'Regenerate Questions' : 'Generate Questions'}
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Pipeline Progress */}
                                                {mpPipelineRunning && (
                                                    <div className="p-4 bg-white/5 rounded-xl border border-teal-500/30 mb-3">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-5 h-5 border-2 border-teal-400 border-t-transparent rounded-full animate-spin flex-shrink-0" />
                                                            <div>
                                                                <p className="text-sm font-medium text-teal-400">
                                                                    {mpPipelineStep === 'analyzing' ? 'Step 1/3: Analyzing Documents' :
                                                                     mpPipelineStep === 'synthesizing' ? 'Step 2/3: Synthesizing Insights' :
                                                                     mpPipelineStep === 'generating' ? 'Step 3/3: Generating Questions' :
                                                                     'Saving Results...'}
                                                                </p>
                                                                <p className="text-xs text-slate-300 mt-0.5">{mpPipelineProgress}</p>
                                                            </div>
                                                        </div>
                                                        <div className="mt-3 h-1.5 bg-white/10 rounded-full overflow-hidden">
                                                            <div className={`h-full bg-teal-500 rounded-full transition-all duration-500 ${
                                                                mpPipelineStep === 'analyzing' ? 'w-1/4' :
                                                                mpPipelineStep === 'synthesizing' ? 'w-2/4' :
                                                                mpPipelineStep === 'generating' ? 'w-3/4' : 'w-full'
                                                            }`} />
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Pipeline Error */}
                                                {mpPipelineError && (
                                                    <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg mb-3">
                                                        <p className="text-sm text-red-400">Error: {mpPipelineError}</p>
                                                    </div>
                                                )}

                                                {/* Questions Display */}
                                                {mpQuestionSet && mpQuestionSet.status === 'ready' && mpQuestionSet.topics && mpQuestionSet.topics.length > 0 ? (
                                                    <div>
                                                        {/* Filters */}
                                                        <div className="flex gap-2 flex-wrap mb-3">
                                                            {['all', 'high', 'medium', 'low'].map(p => (
                                                                <button key={p} onClick={() => setMpPriorityFilter(p)}
                                                                    className={`px-3 py-1 rounded-full text-xs font-medium transition-all ${
                                                                        mpPriorityFilter === p ? 'bg-teal-600 text-white' : 'bg-white/10 text-slate-400 hover:bg-white/15'
                                                                    }`}
                                                                >{p === 'all' ? 'All' : p.charAt(0).toUpperCase() + p.slice(1)}</button>
                                                            ))}
                                                            <button onClick={() => setMpShowContext(!mpShowContext)}
                                                                className={`ml-auto px-3 py-1 rounded-full text-xs font-medium ${
                                                                    mpShowContext ? 'bg-amber-600/50 text-amber-300' : 'bg-white/10 text-slate-400'
                                                                }`}
                                                            >{mpShowContext ? 'Hide Sources' : 'Show Sources'}</button>
                                                        </div>

                                                        {/* Topic Groups */}
                                                        <div className="space-y-2">
                                                            {mpQuestionSet.topics.map((topic, ti) => {
                                                                const questions = (topic.questions || []).filter(q => mpPriorityFilter === 'all' || q.priority === mpPriorityFilter);
                                                                return (
                                                                    <div key={ti} className="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                                                                        <button onClick={() => toggleMpTopic(ti)} className="w-full p-3 flex items-center justify-between hover:bg-white/5 text-left">
                                                                            <div>
                                                                                <h3 className="font-semibold text-teal-400 text-sm">{topic.topic}</h3>
                                                                                {topic.description && <p className="text-xs text-slate-300 mt-0.5">{topic.description}</p>}
                                                                            </div>
                                                                            <span className="text-xs text-slate-300 flex-shrink-0 ml-2">{questions.length}q</span>
                                                                        </button>
                                                                        {mpExpandedTopics.has(ti) && (
                                                                            <div className="border-t border-white/10 p-3 space-y-2">
                                                                                {questions.map((q, qi) => (
                                                                                    <div key={qi} className={`p-3 rounded-lg border-l-4 ${
                                                                                        q.priority === 'high' ? 'border-red-500 bg-red-500/5' :
                                                                                        q.priority === 'medium' ? 'border-amber-500 bg-amber-500/5' :
                                                                                        'border-slate-500 bg-slate-500/5'
                                                                                    }`}>
                                                                                        <p className="text-sm text-slate-200">{q.question}</p>
                                                                                        <div className="flex items-center gap-2 mt-2">
                                                                                            <span className={`px-2 py-0.5 rounded text-xs ${
                                                                                                q.priority === 'high' ? 'bg-red-500/20 text-red-400' :
                                                                                                q.priority === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                                                                                                'bg-slate-500/20 text-slate-400'
                                                                                            }`}>{q.priority}</span>
                                                                                        </div>
                                                                                        {mpShowContext && q.context && (
                                                                                            <div className="mt-2 p-2 bg-white/5 rounded text-xs text-slate-300 italic">{q.context}</div>
                                                                                        )}
                                                                                        {mpShowContext && q.source && (
                                                                                            <div className="mt-1 text-xs text-slate-400">Source: {q.source}</div>
                                                                                        )}
                                                                                        {q.follow_up_angle && (
                                                                                            <details className="mt-2">
                                                                                                <summary className="text-xs text-teal-500 cursor-pointer">Follow-up angle</summary>
                                                                                                <p className="mt-1 text-xs text-slate-400 pl-3">{q.follow_up_angle}</p>
                                                                                            </details>
                                                                                        )}
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        {mpQuestionSet.generation_tokens && (
                                                            <div className="mt-3 text-xs text-slate-400 text-right">
                                                                v{mpQuestionSet.version} &middot; {(mpQuestionSet.generation_tokens / 1000).toFixed(1)}K tokens
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : !mpPipelineRunning && (
                                                    <p className="text-center text-slate-400 text-sm py-4">
                                                        {mpDocuments.length === 0 ? 'Upload documents first, then generate questions.' : 'Click "Generate Questions" to start.'}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    /* Meeting List View */
                                    <div className="flex-1 flex flex-col overflow-hidden">
                                        <div className="bg-white/[0.04] backdrop-blur-lg border-b border-white/[0.08] p-4">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <Target className="w-6 h-6 text-teal-400" />
                                                    <h1 className="text-xl font-bold">Meeting Prep</h1>
                                                </div>
                                                <button onClick={() => setShowMpCreateForm(true)} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm font-medium transition-all">+ New Meeting</button>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-3" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                                            {/* Create Meeting Modal */}
                                            {showMpCreateForm && (
                                                <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl border border-teal-500/30 p-4 mb-3">
                                                    <h2 className="font-semibold mb-3">New Meeting</h2>
                                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                                        <input value={mpNewTicker} onChange={e => setMpNewTicker(e.target.value.toUpperCase())} placeholder="Ticker *" className="px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm" />
                                                        <input value={mpNewCompanyName} onChange={e => setMpNewCompanyName(e.target.value)} placeholder="Company Name" className="px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm" />
                                                        <select value={mpNewSector} onChange={e => setMpNewSector(e.target.value)} className="px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-300">
                                                            <option value="">Sector</option>
                                                            <option>Technology</option><option>Healthcare</option><option>Financials</option>
                                                            <option>Consumer Discretionary</option><option>Consumer Staples</option><option>Industrials</option>
                                                            <option>Energy</option><option>Materials</option><option>Utilities</option>
                                                            <option>Real Estate</option><option>Communication Services</option>
                                                        </select>
                                                        <input type="date" value={mpNewMeetingDate} onChange={e => setMpNewMeetingDate(e.target.value)} className="px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-300" />
                                                        <select value={mpNewMeetingType} onChange={e => setMpNewMeetingType(e.target.value)} className="px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-300">
                                                            <option value="earnings">Earnings Call</option><option value="ndr">NDR / Roadshow</option>
                                                            <option value="conference">Conference</option><option value="site_visit">Site Visit</option>
                                                            <option value="other">Other</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex gap-2 justify-end">
                                                        <button onClick={() => setShowMpCreateForm(false)} className="px-3 py-1.5 text-sm text-slate-400 hover:text-white">Cancel</button>
                                                        <button onClick={createMpMeeting} className="px-4 py-1.5 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm font-medium">Create</button>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Meeting Cards */}
                                            {mpMeetings.map(m => (
                                                <div key={m.id} onClick={() => loadMpMeeting(m.id)}
                                                    className="p-4 bg-white/[0.07] backdrop-blur-lg rounded-xl border border-white/10 hover:border-teal-500/40 cursor-pointer transition-all"
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <span className="font-bold text-teal-400 text-lg">{m.ticker}</span>
                                                            {m.company_name && <span className="ml-2 text-slate-400 text-sm">{m.company_name}</span>}
                                                        </div>
                                                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                                            m.status === 'ready' ? 'bg-green-500/20 text-green-400' :
                                                            m.status === 'error' ? 'bg-red-500/20 text-red-400' :
                                                            'bg-slate-500/20 text-slate-400'
                                                        }`}>{m.status}</span>
                                                    </div>
                                                    <div className="flex gap-3 mt-1.5 text-xs text-slate-300">
                                                        <span>{m.meeting_type}</span>
                                                        {m.meeting_date && <span>{m.meeting_date}</span>}
                                                        <span>{m.doc_count || 0} doc{m.doc_count !== 1 ? 's' : ''}</span>
                                                    </div>
                                                </div>
                                            ))}
                                            {mpMeetings.length === 0 && !showMpCreateForm && (
                                                <div className="text-center text-slate-400 py-12">
                                                    <Target className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                    <p>No meetings yet. Create one to get started.</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* SLIDES TAB */}
                        {activeTab === 'slides' && (
                            <div className="flex-1 flex flex-col bg-white/[0.02] overflow-y-auto pb-24 md:pb-0" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                                <div className="p-4 pb-8">
                                    {/* Header */}
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3">
                                            {slideSelectedProject && (
                                                <button onClick={() => { setSlideSelectedProject(null); setSlideSelectedSlide(null); }} className="p-2 hover:bg-white/10 rounded-lg">
                                                    <ChevronLeft className="w-5 h-5" />
                                                </button>
                                            )}
                                            <Layers className="w-6 h-6 text-teal-400" />
                                            <h1 className="text-xl font-bold">{slideSelectedProject ? slideSelectedProject.title : 'Slide Projects'}</h1>
                                            {slideSelectedProject && (
                                                <span className={`text-xs px-2 py-0.5 rounded-full ${
                                                    slideSelectedProject.status === 'ready' ? 'bg-green-600/30 text-green-300' :
                                                    (slideSelectedProject.status === 'generating' || slideSelectedProject.status?.startsWith('generating:')) ? 'bg-yellow-600/30 text-yellow-300' :
                                                    'bg-slate-600/30 text-slate-300'
                                                }`}>{slideSelectedProject.status?.startsWith('generating:') ? 'generating' : slideSelectedProject.status}</span>
                                            )}
                                        </div>
                                        {!slideSelectedProject && (
                                            <button onClick={() => setShowSlideCreateForm(!showSlideCreateForm)} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm font-medium">
                                                + New Project
                                            </button>
                                        )}
                                        {slideSelectedProject && (
                                            <div className="flex gap-2 items-center flex-wrap">
                                                {/* Auto-Generate Outline from ticker data (original behavior) */}
                                                {slideSelectedProject.ticker && (
                                                    <button onClick={generateSlideOutline} disabled={slideOutlineGenerating}
                                                        className="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 rounded-lg text-xs font-medium">
                                                        {slideOutlineGenerating ? 'Generating...' : 'Auto-Generate Outline'}
                                                    </button>
                                                )}
                                                {/* Generate Outline from custom sources (modal) */}
                                                <button onClick={openOutlineSourceModal} disabled={slideOutlineGenerating}
                                                    className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 rounded-lg text-xs font-medium">
                                                    Outline from Sources...
                                                </button>
                                                {/* Progress indicator during generation */}
                                                {slideGenerating && slideGenProgress && (
                                                    <span className="text-xs text-yellow-300 bg-yellow-600/20 px-2 py-1 rounded-full">
                                                        Generating {slideGenProgress.current}/{slideGenProgress.total}...
                                                    </span>
                                                )}
                                                {slideGenerating && !slideGenProgress && (
                                                    <span className="text-xs text-yellow-300 bg-yellow-600/20 px-2 py-1 rounded-full">
                                                        Starting generation...
                                                    </span>
                                                )}
                                                {/* Bulk generation buttons */}
                                                <button onClick={() => generateAllSlides(false)} disabled={slideGenerating}
                                                    className="px-3 py-1.5 bg-teal-600 hover:bg-teal-500 disabled:opacity-50 rounded-lg text-xs font-medium">
                                                    Generate All
                                                </button>
                                                <button onClick={() => generateAllSlides(true)} disabled={slideGenerating}
                                                    className="px-3 py-1.5 bg-teal-700 hover:bg-teal-600 disabled:opacity-50 rounded-lg text-xs font-medium">
                                                    Generate Changed
                                                </button>
                                                <button onClick={exportSlidePdf} className="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-xs font-medium">
                                                    Export PDF
                                                </button>
                                                <button onClick={() => deleteSlideProject(slideSelectedProject.id)} className="px-3 py-1.5 bg-red-600/30 hover:bg-red-600/50 rounded-lg text-xs font-medium text-red-300">
                                                    Delete
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    {/* Outline Source Selection Modal */}
                                    {showOutlineSourceModal && (
                                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={() => setShowOutlineSourceModal(false)}>
                                            <div className="bg-slate-800 rounded-2xl border border-white/10 w-full max-w-2xl max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                                <div className="p-4 border-b border-white/10 flex justify-between items-center">
                                                    <h2 className="text-lg font-semibold">Generate Outline from Sources</h2>
                                                    <button onClick={() => setShowOutlineSourceModal(false)} className="text-slate-400 hover:text-white text-xl">&times;</button>
                                                </div>
                                                {/* Source Type Tabs */}
                                                <div className="flex border-b border-white/10 px-4">
                                                    {[
                                                        { key: 'ticker', label: 'Ticker Data', show: !!slideSelectedProject?.ticker },
                                                        { key: 'research', label: 'Research Docs', show: true },
                                                        { key: 'summary', label: 'Meeting Notes', show: true },
                                                        { key: 'meetingprep', label: 'Meeting Prep', show: true },
                                                        { key: 'custom', label: 'Custom Text', show: true },
                                                    ].filter(t => t.show).map(tab => (
                                                        <button key={tab.key}
                                                            onClick={() => { setOutlineSourceType(tab.key); if (['research','summary','meetingprep'].includes(tab.key)) loadOutlineSources(tab.key); }}
                                                            className={`px-4 py-2.5 text-sm font-medium border-b-2 transition-all ${
                                                                outlineSourceType === tab.key ? 'border-teal-500 text-teal-400' : 'border-transparent text-slate-400 hover:text-white'
                                                            }`}>
                                                            {tab.label}
                                                        </button>
                                                    ))}
                                                </div>
                                                {/* Source Content Area */}
                                                <div className="flex-1 overflow-y-auto p-4" style={{minHeight: '300px', maxHeight: '50vh'}}>
                                                    {outlineSourceType === 'ticker' && (
                                                        <div className="text-center py-8">
                                                            <div className="text-4xl mb-3">üìä</div>
                                                            <p className="text-slate-300 mb-2">Generate from <span className="text-teal-400 font-semibold">{slideSelectedProject?.ticker}</span> data</p>
                                                            <p className="text-sm text-slate-500">Uses existing stock overview and portfolio analysis for this ticker.</p>
                                                        </div>
                                                    )}
                                                    {outlineSourceType === 'custom' && (
                                                        <div>
                                                            <p className="text-sm text-slate-400 mb-2">Paste or type your content below. The outline will be generated from this text.</p>
                                                            <textarea value={outlineCustomText} onChange={e => setOutlineCustomText(e.target.value)}
                                                                placeholder="Paste your notes, research, article text, or any content you want to turn into slides..."
                                                                className="w-full bg-white/5 rounded-lg px-3 py-2 text-sm border border-white/10 focus:border-teal-500 focus:outline-none font-mono"
                                                                rows={12} />
                                                            <div className="text-xs text-slate-500 mt-1">{outlineCustomText.length.toLocaleString()} characters</div>
                                                        </div>
                                                    )}
                                                    {['research', 'summary', 'meetingprep'].includes(outlineSourceType) && (
                                                        <div>
                                                            {outlineSourceLoading ? (
                                                                <div className="flex items-center justify-center py-12 text-slate-400">
                                                                    <div className="animate-spin w-5 h-5 border-2 border-teal-500 border-t-transparent rounded-full mr-3" />
                                                                    Loading sources...
                                                                </div>
                                                            ) : outlineSourceItems.length === 0 ? (
                                                                <div className="text-center py-12 text-slate-500">
                                                                    No {outlineSourceType === 'research' ? 'research documents' : outlineSourceType === 'summary' ? 'meeting summaries' : 'meeting prep sessions'} found.
                                                                </div>
                                                            ) : (
                                                                <div className="space-y-1">
                                                                    <div className="text-xs text-slate-500 mb-2">{outlineSelectedIds.size} of {outlineSourceItems.length} selected</div>
                                                                    {outlineSourceItems.map(item => (
                                                                        <button key={item.id} onClick={() => toggleOutlineSource(item.id)}
                                                                            className={`w-full text-left p-3 rounded-lg border transition-all ${
                                                                                outlineSelectedIds.has(item.id)
                                                                                    ? 'bg-teal-600/20 border-teal-500/50'
                                                                                    : 'bg-white/5 border-white/5 hover:bg-white/10'
                                                                            }`}>
                                                                            <div className="flex items-center gap-3">
                                                                                <input type="checkbox" checked={outlineSelectedIds.has(item.id)} readOnly
                                                                                    className="w-4 h-4 rounded accent-teal-500 flex-shrink-0" />
                                                                                <div className="flex-1 min-w-0">
                                                                                    <div className="font-medium text-sm truncate">{item.name}</div>
                                                                                    <div className="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                                                                        {item.topic && <span className="text-teal-400">{item.topic}</span>}
                                                                                        {item.doc_type && <span>{item.doc_type}</span>}
                                                                                        {item.doc_count != null && <span>{item.doc_count} docs</span>}
                                                                                        {item.date && <span>{item.date}</span>}
                                                                                    </div>
                                                                                    {item.snippet && <div className="text-xs text-slate-500 mt-1 line-clamp-2">{item.snippet}</div>}
                                                                                </div>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                                {/* Footer with Generate button */}
                                                <div className="p-4 border-t border-white/10 flex justify-between items-center">
                                                    <button onClick={() => setShowOutlineSourceModal(false)} className="px-4 py-2 text-sm text-slate-400 hover:text-white">Cancel</button>
                                                    <button onClick={generateOutlineFromSources}
                                                        disabled={
                                                            slideOutlineGenerating ||
                                                            (outlineSourceType === 'custom' && !outlineCustomText.trim()) ||
                                                            (['research','summary','meetingprep'].includes(outlineSourceType) && outlineSelectedIds.size === 0)
                                                        }
                                                        className="px-5 py-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm font-medium">
                                                        {slideOutlineGenerating ? 'Generating...' : `Generate Outline${
                                                            ['research','summary','meetingprep'].includes(outlineSourceType) && outlineSelectedIds.size > 0
                                                                ? ` from ${outlineSelectedIds.size} source${outlineSelectedIds.size > 1 ? 's' : ''}`
                                                                : ''
                                                        }`}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Create Project Form */}
                                    {showSlideCreateForm && !slideSelectedProject && (
                                        <div className="bg-white/5 rounded-xl p-4 mb-6 border border-white/10">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                                <input value={slideNewTitle} onChange={e => setSlideNewTitle(e.target.value)}
                                                    placeholder="Project title (e.g. AAPL Analysis)"
                                                    className="bg-white/10 rounded-lg px-3 py-2 text-sm border border-white/10 focus:border-teal-500 focus:outline-none" />
                                                <input value={slideNewTicker} onChange={e => setSlideNewTicker(e.target.value)}
                                                    placeholder="Ticker (optional, e.g. AAPL)"
                                                    className="bg-white/10 rounded-lg px-3 py-2 text-sm border border-white/10 focus:border-teal-500 focus:outline-none" />
                                                <select value={slideNewTheme} onChange={e => setSlideNewTheme(e.target.value)}
                                                    className="bg-white/10 rounded-lg px-3 py-2 text-sm border border-white/10 focus:border-teal-500 focus:outline-none">
                                                    {slideThemes.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                                    {slideThemes.length === 0 && <option value="sketchnote">Sketchnote</option>}
                                                </select>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={createSlideProject} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm font-medium">Create</button>
                                                <button onClick={() => setShowSlideCreateForm(false)} className="px-4 py-2 bg-white/10 hover:bg-white/15 rounded-lg text-sm">Cancel</button>
                                            </div>
                                        </div>
                                    )}

                                    {/* Project List */}
                                    {!slideSelectedProject && (
                                        <div className="space-y-2">
                                            {slideProjects.map(proj => (
                                                <button key={proj.id} onClick={() => loadSlideProject(proj.id)}
                                                    className="w-full flex items-center gap-4 p-4 bg-white/5 hover:bg-white/10 rounded-xl border border-white/5 transition-all text-left">
                                                    <div className="w-10 h-10 rounded-lg bg-teal-600/20 flex items-center justify-center">
                                                        <Layers className="w-5 h-5 text-teal-400" />
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-semibold truncate">{proj.title}</div>
                                                        <div className="text-xs text-slate-400">
                                                            {proj.ticker && <span className="text-teal-400 mr-2">{proj.ticker}</span>}
                                                            {proj.total_slides} slides &middot; {proj.theme} theme
                                                        </div>
                                                    </div>
                                                    <span className={`text-xs px-2 py-0.5 rounded-full ${
                                                        proj.status === 'ready' ? 'bg-green-600/30 text-green-300' :
                                                        (proj.status === 'generating' || proj.status?.startsWith('generating:')) ? 'bg-yellow-600/30 text-yellow-300' :
                                                        'bg-slate-600/30 text-slate-300'
                                                    }`}>{proj.status?.startsWith('generating:') ? 'generating' : proj.status}</span>
                                                    <ChevronRight className="w-5 h-5 text-slate-500" />
                                                </button>
                                            ))}
                                            {slideProjects.length === 0 && (
                                                <div className="text-center text-slate-400 py-12">
                                                    <Layers className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                    <p>No slide projects yet. Create one to get started.</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Slide Editor (Two-Panel) */}
                                    {slideSelectedProject && (
                                        <div className="flex flex-col md:flex-row gap-4" style={{minHeight: '70vh'}}>
                                            {/* Left Panel: Slide List */}
                                            <div className="w-full md:w-72 flex-shrink-0 bg-white/5 rounded-xl border border-white/10 overflow-y-auto" style={{maxHeight: '70vh'}}>
                                                <div className="p-3 border-b border-white/10">
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex items-center gap-2">
                                                            <input type="checkbox"
                                                                checked={slideSelectedProject.slides && slideSelectedSlides.size === slideSelectedProject.slides.length && slideSelectedProject.slides.length > 0}
                                                                onChange={selectAllSlides}
                                                                className="w-3.5 h-3.5 rounded accent-teal-500" title="Select all" />
                                                            <span className="text-sm font-medium text-slate-300">{slideSelectedProject.slides ? slideSelectedProject.slides.length : 0} slides</span>
                                                        </div>
                                                        <button onClick={() => addSlide(slideSelectedProject.slides ? slideSelectedProject.slides.length : 0)}
                                                            className="text-xs px-2 py-1 bg-teal-600/30 hover:bg-teal-600/50 rounded text-teal-300">+ Add</button>
                                                    </div>
                                                    {slideSelectedSlides.size > 0 && (
                                                        <button onClick={generateSelectedSlides} disabled={slideGenerating}
                                                            className="mt-2 w-full px-2 py-1.5 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 rounded-lg text-xs font-medium">
                                                            Generate Selected ({slideSelectedSlides.size})
                                                        </button>
                                                    )}
                                                </div>
                                                <div className="divide-y divide-white/5">
                                                    {(slideSelectedProject.slides || []).map(s => (
                                                        <div key={s.slide_number}
                                                            className={`flex items-center hover:bg-white/5 transition-all ${
                                                                slideSelectedSlide && slideSelectedSlide.slide_number === s.slide_number ? 'bg-teal-600/20 border-l-2 border-teal-500' : ''
                                                            }`}>
                                                            <div className="pl-3 py-3 flex items-center" onClick={e => e.stopPropagation()}>
                                                                <input type="checkbox" checked={slideSelectedSlides.has(s.slide_number)}
                                                                    onChange={() => toggleSlideSelect(s.slide_number)}
                                                                    className="w-3.5 h-3.5 rounded accent-teal-500" />
                                                            </div>
                                                            <button onClick={() => selectSlide(s)} className="flex-1 text-left p-3 pl-2">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-xs text-slate-500 w-5 text-right">{s.slide_number}</span>
                                                                    <span className={`w-2 h-2 rounded-full flex-shrink-0 ${
                                                                        s.status === 'generated' ? 'bg-green-500' :
                                                                        s.status === 'edited' ? 'bg-yellow-500' : 'bg-slate-500'
                                                                    }`} />
                                                                    <span className="text-sm truncate flex-1">{s.title}</span>
                                                                </div>
                                                                <div className="text-xs text-slate-500 ml-7">{s.type}</div>
                                                            </button>
                                                            <button onClick={() => generateOneSlide(s.slide_number)}
                                                                disabled={slideGeneratingNum === s.slide_number || slideGenerating}
                                                                className="pr-2 py-3 text-slate-500 hover:text-purple-400 disabled:opacity-30"
                                                                title="Generate image for this slide">
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Right Panel: Editor + Preview */}
                                            <div className="flex-1 flex flex-col gap-4">
                                                {slideSelectedSlide ? (
                                                    <>
                                                        {/* Editor Section */}
                                                        <div className="bg-white/5 rounded-xl border border-white/10 p-4">
                                                            <div className="flex items-center justify-between mb-3">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-xs bg-white/10 px-2 py-0.5 rounded">#{slideSelectedSlide.slide_number}</span>
                                                                    <span className="text-xs bg-white/10 px-2 py-0.5 rounded">{slideSelectedSlide.type}</span>
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button onClick={() => addSlide(slideSelectedSlide.slide_number)}
                                                                        className="text-xs px-2 py-1 bg-white/10 hover:bg-white/15 rounded">+ After</button>
                                                                    <button onClick={() => deleteSlide(slideSelectedSlide.slide_number)}
                                                                        className="text-xs px-2 py-1 bg-red-600/20 hover:bg-red-600/30 rounded text-red-300">Delete</button>
                                                                </div>
                                                            </div>
                                                            <input value={slideEditTitle} onChange={e => setSlideEditTitle(e.target.value)}
                                                                placeholder="Slide title"
                                                                className="w-full bg-white/10 rounded-lg px-3 py-2 text-sm mb-2 border border-white/10 focus:border-teal-500 focus:outline-none font-semibold" />
                                                            <textarea value={slideEditContent} onChange={e => setSlideEditContent(e.target.value)}
                                                                placeholder="Slide content - describe what should appear on this slide..."
                                                                className="w-full bg-white/10 rounded-lg px-3 py-2 text-sm mb-2 border border-white/10 focus:border-teal-500 focus:outline-none font-mono"
                                                                rows={10} />
                                                            <div className="flex gap-2 mb-3">
                                                                <input value={slideEditHints} onChange={e => setSlideEditHints(e.target.value)}
                                                                    placeholder="Illustration hints (comma-separated, e.g. company, growth, money)"
                                                                    className="flex-1 bg-white/10 rounded-lg px-3 py-2 text-sm border border-white/10 focus:border-teal-500 focus:outline-none" />
                                                                <label className="flex items-center gap-2 text-xs text-slate-400">
                                                                    <input type="checkbox" checked={slideEditNoHeader} onChange={e => setSlideEditNoHeader(e.target.checked)} />
                                                                    No header
                                                                </label>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={saveSlideEdit} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-sm font-medium">Save</button>
                                                                <button onClick={() => generateOneSlide(slideSelectedSlide.slide_number)}
                                                                    disabled={slideGeneratingNum === slideSelectedSlide.slide_number}
                                                                    className="px-4 py-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 rounded-lg text-sm font-medium">
                                                                    {slideGeneratingNum === slideSelectedSlide.slide_number ? 'Generating...' : 'Generate Image'}
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {/* Preview Section */}
                                                        <div className="bg-white/5 rounded-xl border border-white/10 p-4 flex-1">
                                                            <div className="text-xs text-slate-400 mb-2">Preview</div>
                                                            {slidePreviewImage ? (
                                                                <img src={`data:image/png;base64,${slidePreviewImage}`} alt={`Slide ${slideSelectedSlide.slide_number}`}
                                                                    className="w-full rounded-lg shadow-lg" />
                                                            ) : (
                                                                <div className="flex items-center justify-center h-48 text-slate-500 text-sm">
                                                                    {slideSelectedSlide.has_image ? 'Loading preview...' : 'No image generated yet. Click "Generate Image" to create one.'}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div className="flex-1 flex items-center justify-center text-slate-500">
                                                        <div className="text-center">
                                                            <Layers className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                            <p>Select a slide from the list to edit</p>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* STUDIO TAB */}
                        {activeTab === 'studio' && (
                            <div className="flex-1 flex flex-col bg-white/[0.02] overflow-y-auto pb-24 md:pb-0" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                                {studioView === 'grid' ? (
                                    <div className="p-4 md:p-6">
                                        {/* Header */}
                                        <div className="flex items-center justify-between mb-6">
                                            <div className="flex items-center gap-3">
                                                <Wand className="w-6 h-6 text-purple-400" />
                                                <h1 className="text-xl font-bold">Studio</h1>
                                            </div>
                                            <button onClick={() => { setStudioCreateType('report'); setStudioCreateTitle(''); setStudioSourceType('research'); setStudioSelectedSourceIds(new Set()); setStudioCustomText(''); setShowStudioCreateModal(true); }}
                                                className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-xl text-sm font-medium transition-all">
                                                <Plus className="w-4 h-4" /> Create
                                            </button>
                                        </div>

                                        {/* Type Tiles Grid */}
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
                                            {[
                                                { type: 'slides', label: 'Slides', icon: <Layers className="w-6 h-6" />, gradient: 'from-purple-600 to-purple-800', desc: 'Presentation decks' },
                                                { type: 'infographic', label: 'Infographic', icon: <ImageIcon className="w-6 h-6" />, gradient: 'from-blue-600 to-blue-800', desc: 'Visual summaries' },
                                                { type: 'mindmap', label: 'Mind Map', icon: <GitBranch className="w-6 h-6" />, gradient: 'from-green-600 to-green-800', desc: 'Topic mapping' },
                                                { type: 'report', label: 'Report', icon: <FileText className="w-6 h-6" />, gradient: 'from-orange-600 to-orange-800', desc: 'Written analysis' },
                                                { type: 'quiz', label: 'Quiz', icon: <CheckCircle2 className="w-6 h-6" />, gradient: 'from-red-600 to-red-800', desc: 'Test knowledge' },
                                                { type: 'flashcard', label: 'Flashcards', icon: <RotateCw className="w-6 h-6" />, gradient: 'from-teal-600 to-teal-800', desc: 'Study cards' },
                                            ].map(tile => (
                                                <button key={tile.type} onClick={() => { setStudioCreateType(tile.type); setStudioCreateTitle(''); setStudioSourceType('research'); setStudioSelectedSourceIds(new Set()); setStudioCustomText(''); setShowStudioCreateModal(true); }}
                                                    className={`bg-gradient-to-br ${tile.gradient} rounded-2xl p-4 text-left hover:scale-[1.02] transition-all shadow-lg`}>
                                                    <div className="mb-2 opacity-80">{tile.icon}</div>
                                                    <div className="font-semibold text-sm">{tile.label}</div>
                                                    <div className="text-xs opacity-60 mt-0.5">{tile.desc}</div>
                                                </button>
                                            ))}
                                        </div>

                                        {/* Generating indicator */}
                                        {studioGenerating && (
                                            <div className="mb-4 bg-purple-900/30 border border-purple-500/30 rounded-xl p-4 flex items-center gap-3">
                                                <div className="animate-spin rounded-full h-5 w-5 border-2 border-purple-400 border-t-transparent" />
                                                <span className="text-sm">Generating{studioGenProgress ? ` (${studioGenProgress.current}/${studioGenProgress.total})` : '...'}</span>
                                            </div>
                                        )}

                                        {/* Recent Outputs */}
                                        <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Recent Outputs</h2>
                                        {studioOutputs.length === 0 ? (
                                            <div className="text-center py-12 text-slate-500">
                                                <Wand className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                <p>No outputs yet. Click a tile above to create your first one!</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                {studioOutputs.map(output => {
                                                    const typeBadgeColors = { slides: 'bg-purple-500/20 text-purple-300', infographic: 'bg-blue-500/20 text-blue-300', mindmap: 'bg-green-500/20 text-green-300', report: 'bg-orange-500/20 text-orange-300', quiz: 'bg-red-500/20 text-red-300', flashcard: 'bg-teal-500/20 text-teal-300' };
                                                    const statusColors = { pending: 'text-slate-400', generating: 'text-yellow-400', ready: 'text-green-400', error: 'text-red-400' };
                                                    const statusLabel = output.status?.startsWith('generating:') ? `Generating ${output.status.split(':')[1]}/${output.status.split(':')[2]}` : output.status;
                                                    return (
                                                        <div key={output.id} className="bg-white/[0.05] hover:bg-white/[0.08] rounded-xl p-4 border border-white/10 cursor-pointer transition-all flex items-center gap-3"
                                                            onClick={() => { if (output.status === 'ready') loadStudioOutput(output.id); else if (output.status?.startsWith('generating')) pollStudioProgress(output.id); }}>
                                                            <div className="flex-1 min-w-0">
                                                                <div className="font-medium text-sm truncate">{output.title}</div>
                                                                <div className="flex items-center gap-2 mt-1">
                                                                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${typeBadgeColors[output.type] || 'bg-slate-500/20 text-slate-300'}`}>{output.type}</span>
                                                                    <span className={`text-[10px] font-medium ${statusColors[output.status?.split(':')[0]] || 'text-slate-400'}`}>{statusLabel}</span>
                                                                    <span className="text-[10px] text-slate-500">{output.created_at ? new Date(output.created_at).toLocaleDateString() : ''}</span>
                                                                </div>
                                                            </div>
                                                            <button onClick={(e) => { e.stopPropagation(); deleteStudioOutput(output.id); }} className="text-slate-500 hover:text-red-400 p-1 transition-colors">
                                                                <Trash className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    /* DETAIL VIEW */
                                    <div className="flex-1 flex flex-col">
                                        {/* Detail Header */}
                                        <div className="p-4 border-b border-white/10 flex items-center gap-3">
                                            <button onClick={() => { setStudioView('grid'); setStudioSelectedOutput(null); }} className="text-slate-400 hover:text-white p-1">
                                                <ChevronLeft className="w-5 h-5" />
                                            </button>
                                            <div className="flex-1 min-w-0">
                                                <h2 className="font-semibold text-sm truncate">{studioSelectedOutput?.title}</h2>
                                                <span className="text-xs text-slate-400 capitalize">{studioSelectedOutput?.type}</span>
                                            </div>
                                            {studioSelectedOutput?.type === 'slides' && (
                                                <button onClick={() => exportStudioOutput(studioSelectedOutput.id, 'pdf')} className="text-xs bg-purple-600 hover:bg-purple-500 px-3 py-1.5 rounded-lg">Export PDF</button>
                                            )}
                                            {studioSelectedOutput?.type === 'report' && (
                                                <button onClick={() => exportStudioOutput(studioSelectedOutput.id, 'md')} className="text-xs bg-orange-600 hover:bg-orange-500 px-3 py-1.5 rounded-lg">Download</button>
                                            )}
                                            {studioSelectedOutput?.type === 'infographic' && (
                                                <button onClick={() => { if(studioSelectedOutput.has_image) { loadStudioImage(studioSelectedOutput.id).then(() => { const img = studioSlidePreviewImage; if(img){const a=document.createElement('a');a.href='data:image/png;base64,'+img;a.download=studioSelectedOutput.title+'.png';a.click();}}); }}} className="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg">Download</button>
                                            )}
                                        </div>

                                        {/* Content Viewers */}
                                        <div className="flex-1 overflow-y-auto p-4">
                                            {/* SLIDES VIEWER */}
                                            {studioSelectedOutput?.type === 'slides' && (() => {
                                                const slides = studioSelectedOutput?.content?.slides || [];
                                                const slideImages = studioSelectedOutput?.slide_images || [];
                                                return (
                                                    <div className="flex gap-4 h-full">
                                                        {/* Slide list */}
                                                        <div className="w-48 shrink-0 overflow-y-auto space-y-1">
                                                            {slides.map(s => {
                                                                const imgInfo = slideImages.find(si => si.slide_number === s.slide_number);
                                                                return (
                                                                    <button key={s.slide_number} onClick={() => { setStudioSelectedSlideNum(s.slide_number); loadStudioImage(studioSelectedOutput.id, s.slide_number); setStudioEditSlideTitle(s.title || ''); setStudioEditSlideContent(s.content || ''); setStudioEditSlideHints((s.illustration_hints || []).join(', ')); }}
                                                                        className={`w-full text-left p-2 rounded-lg text-xs transition-all flex items-center gap-2 ${studioSelectedSlideNum === s.slide_number ? 'bg-purple-600/30 border border-purple-500/50' : 'bg-white/5 hover:bg-white/10 border border-transparent'}`}>
                                                                        <span className={`w-2 h-2 rounded-full shrink-0 ${imgInfo?.has_image ? 'bg-green-400' : 'bg-slate-500'}`} />
                                                                        <span className="truncate">{s.slide_number}. {s.title}</span>
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                        {/* Slide preview */}
                                                        <div className="flex-1">
                                                            {studioSelectedSlideNum ? (
                                                                <div>
                                                                    {studioSlidePreviewImage ? (
                                                                        <img src={`data:image/png;base64,${studioSlidePreviewImage}`} className="w-full rounded-xl shadow-lg mb-4" alt="Slide preview" />
                                                                    ) : (
                                                                        <div className="aspect-video bg-slate-800 rounded-xl flex items-center justify-center text-slate-500 mb-4">
                                                                            <span>No image generated yet</span>
                                                                        </div>
                                                                    )}
                                                                    <div className="flex gap-2">
                                                                        <button onClick={() => regenerateStudioSlide(studioSelectedOutput.id, studioSelectedSlideNum)}
                                                                            className="text-xs bg-purple-600 hover:bg-purple-500 px-3 py-1.5 rounded-lg flex items-center gap-1" disabled={studioGenerating}>
                                                                            <RotateCw className="w-3 h-3" /> Regenerate
                                                                        </button>
                                                                    </div>
                                                                    <div className="mt-4 bg-white/5 rounded-xl p-3 text-xs space-y-2">
                                                                        <div>
                                                                            <label className="text-slate-400 block mb-1">Title</label>
                                                                            <input type="text" value={studioEditSlideTitle} onChange={e => setStudioEditSlideTitle(e.target.value)}
                                                                                className="w-full bg-white/10 border border-white/10 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:border-purple-500" />
                                                                        </div>
                                                                        <div>
                                                                            <label className="text-slate-400 block mb-1">Content</label>
                                                                            <textarea value={studioEditSlideContent} onChange={e => setStudioEditSlideContent(e.target.value)} rows={4}
                                                                                className="w-full bg-white/10 border border-white/10 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:border-purple-500 resize-none" />
                                                                        </div>
                                                                        <div>
                                                                            <label className="text-slate-400 block mb-1">Illustration Hints (comma-separated)</label>
                                                                            <input type="text" value={studioEditSlideHints} onChange={e => setStudioEditSlideHints(e.target.value)}
                                                                                placeholder="company, growth, chart..."
                                                                                className="w-full bg-white/10 border border-white/10 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:border-purple-500" />
                                                                        </div>
                                                                        <div className="flex gap-2 pt-1">
                                                                            <button onClick={() => saveStudioSlide(studioSelectedOutput.id, studioSelectedSlideNum)}
                                                                                className="text-xs bg-teal-600 hover:bg-teal-500 px-3 py-1.5 rounded-lg font-medium">Save Changes</button>
                                                                            <button onClick={() => { saveStudioSlide(studioSelectedOutput.id, studioSelectedSlideNum).then(() => regenerateStudioSlide(studioSelectedOutput.id, studioSelectedSlideNum)); }}
                                                                                className="text-xs bg-purple-600 hover:bg-purple-500 px-3 py-1.5 rounded-lg font-medium" disabled={studioGenerating}>Save & Regenerate Image</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div className="flex items-center justify-center h-full text-slate-500">
                                                                    <div className="text-center">
                                                                        <Layers className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                                        <p>Select a slide from the list</p>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })()}

                                            {/* INFOGRAPHIC VIEWER */}
                                            {studioSelectedOutput?.type === 'infographic' && (
                                                <div className="text-center">
                                                    {studioSelectedOutput.has_image ? (
                                                        <div>
                                                            {studioSlidePreviewImage ? (
                                                                <img src={`data:image/png;base64,${studioSlidePreviewImage}`} className="max-w-full mx-auto rounded-xl shadow-lg" alt="Infographic" />
                                                            ) : (
                                                                <button onClick={() => loadStudioImage(studioSelectedOutput.id)} className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-medium">
                                                                    Load Infographic Image
                                                                </button>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <div className="py-12 text-slate-500">
                                                            <ImageIcon className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                            <p>No infographic image available</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* MIND MAP VIEWER */}
                                            {studioSelectedOutput?.type === 'mindmap' && (() => {
                                                const depthColors = ['text-teal-400 border-teal-500/50 bg-teal-900/30', 'text-purple-400 border-purple-500/50 bg-purple-900/30', 'text-blue-400 border-blue-500/50 bg-blue-900/30', 'text-green-400 border-green-500/50 bg-green-900/30', 'text-orange-400 border-orange-500/50 bg-orange-900/30'];
                                                const renderNode = (node, depth = 0) => {
                                                    if (!node) return null;
                                                    const colorClass = depthColors[depth % depthColors.length];
                                                    return (
                                                        <div key={node.label} className={`${depth > 0 ? 'ml-6 border-l-2 border-white/10 pl-4' : ''}`}>
                                                            <div className={`inline-block px-3 py-1.5 rounded-full border text-sm font-medium my-1 ${colorClass}`}>
                                                                {node.label}
                                                            </div>
                                                            {node.children && node.children.length > 0 && (
                                                                <div className="mt-1">
                                                                    {node.children.map((child, i) => (
                                                                        <div key={i}>{renderNode(child, depth + 1)}</div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                };
                                                const root = studioSelectedOutput?.content?.root;
                                                return root ? renderNode(root) : <div className="text-slate-500 text-center py-12">No mind map data</div>;
                                            })()}

                                            {/* REPORT VIEWER */}
                                            {studioSelectedOutput?.type === 'report' && (() => {
                                                const markdown = studioSelectedOutput?.content?.markdown || '';
                                                // Simple markdown to HTML conversion
                                                const renderMarkdown = (md) => {
                                                    let html = md
                                                        .replace(/^### (.+)$/gm, '<h3 class="text-base font-semibold mt-4 mb-2 text-purple-300">$1</h3>')
                                                        .replace(/^## (.+)$/gm, '<h2 class="text-lg font-bold mt-6 mb-3 text-teal-300">$1</h2>')
                                                        .replace(/^# (.+)$/gm, '<h1 class="text-xl font-bold mt-6 mb-4 text-white">$1</h1>')
                                                        .replace(/\*\*(.+?)\*\*/g, '<strong class="text-white">$1</strong>')
                                                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                                                        .replace(/^- (.+)$/gm, '<li class="ml-4 list-disc text-slate-300">$1</li>')
                                                        .replace(/^(\d+)\. (.+)$/gm, '<li class="ml-4 list-decimal text-slate-300">$2</li>')
                                                        .replace(/\n\n/g, '<br/><br/>');
                                                    return html;
                                                };
                                                return (
                                                    <div>
                                                        <div className="flex gap-2 mb-4">
                                                            <button onClick={() => { navigator.clipboard.writeText(markdown); }} className="text-xs bg-white/10 hover:bg-white/15 px-3 py-1.5 rounded-lg">Copy to Clipboard</button>
                                                        </div>
                                                        <div className="bg-white/[0.03] rounded-xl p-6 border border-white/10 prose prose-invert max-w-none text-sm text-slate-300 leading-relaxed"
                                                            dangerouslySetInnerHTML={{ __html: renderMarkdown(markdown) }} />
                                                    </div>
                                                );
                                            })()}

                                            {/* QUIZ VIEWER */}
                                            {studioSelectedOutput?.type === 'quiz' && (() => {
                                                const questions = studioSelectedOutput?.content?.questions || [];
                                                const answered = Object.keys(studioQuizAnswers).length;
                                                return (
                                                    <div>
                                                        {/* Score banner */}
                                                        {studioQuizSubmitted && studioQuizScore && (
                                                            <div className={`mb-4 p-4 rounded-xl text-center font-bold ${studioQuizScore.correct / studioQuizScore.total >= 0.7 ? 'bg-green-900/30 border border-green-500/50 text-green-300' : 'bg-red-900/30 border border-red-500/50 text-red-300'}`}>
                                                                Score: {studioQuizScore.correct}/{studioQuizScore.total} ({Math.round(studioQuizScore.correct / studioQuizScore.total * 100)}%)
                                                                <button onClick={resetQuiz} className="ml-4 text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg font-normal">Retake</button>
                                                            </div>
                                                        )}
                                                        {/* Progress */}
                                                        {!studioQuizSubmitted && (
                                                            <div className="mb-4 flex items-center gap-3">
                                                                <div className="flex-1 bg-white/10 rounded-full h-2">
                                                                    <div className="bg-purple-500 h-2 rounded-full transition-all" style={{ width: `${questions.length ? (answered / questions.length) * 100 : 0}%` }} />
                                                                </div>
                                                                <span className="text-xs text-slate-400">{answered} of {questions.length} answered</span>
                                                            </div>
                                                        )}
                                                        {/* Questions */}
                                                        <div className="space-y-4">
                                                            {questions.map((q, qi) => (
                                                                <div key={q.id} className="bg-white/[0.05] rounded-xl p-4 border border-white/10">
                                                                    <div className="font-medium text-sm mb-3">{qi + 1}. {q.question}</div>
                                                                    <div className="space-y-2">
                                                                        {(q.options || []).map((opt, oi) => {
                                                                            const selected = studioQuizAnswers[q.id] === oi;
                                                                            const isCorrect = q.correct === oi;
                                                                            let optClass = 'bg-white/5 hover:bg-white/10 border-transparent';
                                                                            if (studioQuizSubmitted) {
                                                                                if (isCorrect) optClass = 'bg-green-900/30 border-green-500/50 text-green-300';
                                                                                else if (selected && !isCorrect) optClass = 'bg-red-900/30 border-red-500/50 text-red-300';
                                                                            } else if (selected) {
                                                                                optClass = 'bg-purple-900/30 border-purple-500/50';
                                                                            }
                                                                            return (
                                                                                <button key={oi} onClick={() => selectQuizAnswer(q.id, oi)}
                                                                                    className={`w-full text-left p-2.5 rounded-lg text-xs border transition-all ${optClass}`}>
                                                                                    <span className="font-medium mr-2">{String.fromCharCode(65 + oi)}.</span>{opt}
                                                                                </button>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                    {studioQuizSubmitted && q.explanation && (
                                                                        <div className="mt-2 text-xs text-slate-400 bg-white/5 rounded-lg p-2">{q.explanation}</div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                        {!studioQuizSubmitted && questions.length > 0 && (
                                                            <button onClick={submitQuiz} className="w-full mt-4 bg-purple-600 hover:bg-purple-500 py-3 rounded-xl font-medium" disabled={answered < questions.length}>
                                                                Submit Quiz ({answered}/{questions.length})
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })()}

                                            {/* FLASHCARD VIEWER */}
                                            {studioSelectedOutput?.type === 'flashcard' && (() => {
                                                const cards = studioSelectedOutput?.content?.cards || [];
                                                const card = cards[studioFlashcardIndex];
                                                if (!card) return <div className="text-slate-500 text-center py-12">No flashcards</div>;
                                                return (
                                                    <div className="max-w-lg mx-auto">
                                                        <div className="text-center text-xs text-slate-400 mb-4">{studioFlashcardIndex + 1} / {cards.length}</div>
                                                        {/* Card with flip animation */}
                                                        <div className="cursor-pointer" onClick={flipFlashcard} style={{ perspective: '1000px' }}>
                                                            <div className="relative w-full transition-transform duration-500" style={{ transformStyle: 'preserve-3d', transform: studioFlashcardFlipped ? 'rotateY(180deg)' : '' }}>
                                                                {/* Front */}
                                                                <div className="bg-gradient-to-br from-purple-900/50 to-slate-800 rounded-2xl p-8 border border-purple-500/30 min-h-[200px] flex flex-col items-center justify-center text-center"
                                                                    style={{ backfaceVisibility: 'hidden' }}>
                                                                    <div className="text-lg font-medium mb-2">{card.front}</div>
                                                                    <div className="text-xs text-slate-400 mt-4">Tap to flip</div>
                                                                </div>
                                                                {/* Back */}
                                                                <div className="absolute inset-0 bg-gradient-to-br from-teal-900/50 to-slate-800 rounded-2xl p-8 border border-teal-500/30 min-h-[200px] flex flex-col items-center justify-center text-center"
                                                                    style={{ backfaceVisibility: 'hidden', transform: 'rotateY(180deg)' }}>
                                                                    <div className="text-sm text-slate-200 mb-3">{card.back}</div>
                                                                    {card.category && <span className="text-[10px] px-2 py-0.5 rounded-full bg-teal-500/20 text-teal-300">{card.category}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {/* Navigation */}
                                                        <div className="flex items-center justify-center gap-4 mt-6">
                                                            <button onClick={prevFlashcard} disabled={studioFlashcardIndex === 0}
                                                                className="p-2 rounded-full bg-white/10 hover:bg-white/20 disabled:opacity-30 transition-all">
                                                                <ChevronLeft className="w-5 h-5" />
                                                            </button>
                                                            <button onClick={flipFlashcard} className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-xs font-medium">
                                                                Space to Flip
                                                            </button>
                                                            <button onClick={nextFlashcard} disabled={studioFlashcardIndex >= cards.length - 1}
                                                                className="p-2 rounded-full bg-white/10 hover:bg-white/20 disabled:opacity-30 transition-all">
                                                                <ChevronRight className="w-5 h-5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                )}

                                {/* CREATION MODAL */}
                                {showStudioCreateModal && (
                                    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={() => setShowStudioCreateModal(false)}>
                                        <div className="bg-slate-800 rounded-2xl border border-white/10 w-full max-w-2xl max-h-[85vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                            <div className="p-4 border-b border-white/10 flex justify-between items-center">
                                                <h2 className="text-lg font-semibold flex items-center gap-2">
                                                    <Wand className="w-5 h-5 text-purple-400" />
                                                    Create {studioCreateType.charAt(0).toUpperCase() + studioCreateType.slice(1)}
                                                </h2>
                                                <button onClick={() => setShowStudioCreateModal(false)} className="text-slate-400 hover:text-white text-xl">&times;</button>
                                            </div>

                                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                                {/* Output type selector */}
                                                <div>
                                                    <label className="text-xs font-medium text-slate-400 mb-1 block">Output Type</label>
                                                    <div className="flex flex-wrap gap-2">
                                                        {['slides', 'infographic', 'mindmap', 'report', 'quiz', 'flashcard'].map(t => (
                                                            <button key={t} onClick={() => setStudioCreateType(t)}
                                                                className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${studioCreateType === t ? 'bg-purple-600 text-white' : 'bg-white/10 text-slate-300 hover:bg-white/15'}`}>
                                                                {t === 'mindmap' ? 'Mind Map' : t.charAt(0).toUpperCase() + t.slice(1)}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* Title */}
                                                <div>
                                                    <label className="text-xs font-medium text-slate-400 mb-1 block">Title</label>
                                                    <input type="text" value={studioCreateTitle} onChange={e => setStudioCreateTitle(e.target.value)}
                                                        placeholder="Enter a title for your output..."
                                                        className="w-full bg-white/10 border border-white/10 rounded-xl px-3 py-2.5 text-sm placeholder-slate-500 focus:outline-none focus:border-purple-500" />
                                                </div>

                                                {/* Source selection tabs */}
                                                <div>
                                                    <label className="text-xs font-medium text-slate-400 mb-1 block">Source Content</label>
                                                    <div className="flex border-b border-white/10 overflow-x-auto" style={{scrollbarWidth:'none'}}>
                                                        {[
                                                            { key: 'none', label: 'None (Auto)' },
                                                            { key: 'research', label: 'Research Docs' },
                                                            { key: 'summary', label: 'Meeting Notes' },
                                                            { key: 'meetingprep', label: 'Meeting Prep' },
                                                            { key: 'custom', label: 'Custom Text' },
                                                        ].map(tab => (
                                                            <button key={tab.key}
                                                                onClick={() => { setStudioSourceType(tab.key); setStudioSourceSearch(''); if (['research','summary','meetingprep'].includes(tab.key)) loadStudioSources(tab.key); }}
                                                                className={`px-3 py-2 text-xs font-medium border-b-2 transition-all whitespace-nowrap ${
                                                                    studioSourceType === tab.key ? 'border-purple-500 text-purple-400' : 'border-transparent text-slate-400 hover:text-white'
                                                                }`}>
                                                                {tab.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                    {/* Source content area */}
                                                    <div className="mt-3" style={{ minHeight: '150px', maxHeight: '200px', overflowY: 'auto' }}>
                                                        {studioSourceType === 'none' ? (
                                                            <div className="flex items-center justify-center py-8 text-slate-400 text-xs">
                                                                <div className="text-center">
                                                                    <Wand className="w-6 h-6 mx-auto mb-2 text-purple-400" />
                                                                    <div>Content will be auto-generated from the title alone.</div>
                                                                    <div className="text-slate-500 mt-1">No source documents needed.</div>
                                                                </div>
                                                            </div>
                                                        ) : studioSourceType === 'custom' ? (
                                                            <textarea value={studioCustomText} onChange={e => setStudioCustomText(e.target.value)}
                                                                placeholder="Paste your content here..."
                                                                className="w-full h-40 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm placeholder-slate-500 focus:outline-none focus:border-purple-500 resize-none" />
                                                        ) : studioSourceLoading ? (
                                                            <div className="flex items-center justify-center py-8 text-slate-400 text-sm">Loading sources...</div>
                                                        ) : studioSourceItems.length === 0 ? (
                                                            <div className="text-center py-8 text-slate-500 text-xs">
                                                                {studioSourceType === 'research' ? 'No research documents found. Upload some in the Research tab.' :
                                                                 studioSourceType === 'summary' ? 'No meeting summaries found.' : 'No meeting prep sessions found.'}
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-1">
                                                                {studioSourceItems.length > 5 && (
                                                                    <input type="text" value={studioSourceSearch} onChange={e => setStudioSourceSearch(e.target.value)}
                                                                        placeholder="Search sources..."
                                                                        className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-xs mb-2 placeholder-slate-500 focus:outline-none focus:border-purple-500 sticky top-0 z-10" />
                                                                )}
                                                                {(() => {
                                                                    const q = studioSourceSearch.trim().toLowerCase();
                                                                    const filtered = q ? studioSourceItems.filter(item =>
                                                                        item.name.toLowerCase().includes(q) ||
                                                                        (item.snippet && item.snippet.toLowerCase().includes(q)) ||
                                                                        (item.topic && item.topic.toLowerCase().includes(q)) ||
                                                                        (item.ticker && item.ticker.toLowerCase().includes(q))
                                                                    ) : studioSourceItems;
                                                                    return filtered.length === 0 ? (
                                                                        <div className="text-center py-6 text-slate-500 text-xs">No sources match "{studioSourceSearch}"</div>
                                                                    ) : filtered.map(item => (
                                                                        <button key={item.id} onClick={() => toggleStudioSource(item.id)}
                                                                            className={`w-full text-left p-2.5 rounded-lg text-xs transition-all border ${
                                                                                studioSelectedSourceIds.has(item.id) ? 'bg-purple-900/30 border-purple-500/50' : 'bg-white/5 hover:bg-white/10 border-transparent'
                                                                            }`}>
                                                                            <div className="flex items-center gap-2">
                                                                                <div className={`w-4 h-4 rounded border-2 flex items-center justify-center shrink-0 ${studioSelectedSourceIds.has(item.id) ? 'bg-purple-500 border-purple-500' : 'border-slate-500'}`}>
                                                                                    {studioSelectedSourceIds.has(item.id) && <Check className="w-3 h-3" />}
                                                                                </div>
                                                                                <div className="flex-1 min-w-0">
                                                                                    <div className="font-medium truncate">{item.name}</div>
                                                                                    {item.snippet && <div className="text-slate-500 truncate mt-0.5">{item.snippet}</div>}
                                                                                </div>
                                                                            </div>
                                                                        </button>
                                                                    ));
                                                                })()}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Type-specific options */}
                                                <div className="bg-white/5 rounded-xl p-3 border border-white/10">
                                                    <label className="text-xs font-medium text-slate-400 mb-2 block">Options</label>
                                                    {studioCreateType === 'slides' && (
                                                        <div>
                                                            <label className="text-xs text-slate-300">Slide Count: {studioSlideCount}</label>
                                                            <input type="range" min="3" max="50" value={studioSlideCount} onChange={e => setStudioSlideCount(parseInt(e.target.value))}
                                                                className="w-full mt-1 accent-purple-500" />
                                                        </div>
                                                    )}
                                                    {studioCreateType === 'infographic' && (
                                                        <div className="flex gap-2">
                                                            {['landscape', 'portrait', 'square'].map(o => (
                                                                <button key={o} onClick={() => setStudioInfographicOrientation(o)}
                                                                    className={`px-3 py-1.5 rounded-lg text-xs ${studioInfographicOrientation === o ? 'bg-blue-600' : 'bg-white/10 hover:bg-white/15'}`}>
                                                                    {o.charAt(0).toUpperCase() + o.slice(1)}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {studioCreateType === 'report' && (
                                                        <div className="flex gap-2">
                                                            {['brief', 'standard', 'detailed'].map(l => (
                                                                <button key={l} onClick={() => setStudioReportLength(l)}
                                                                    className={`px-3 py-1.5 rounded-lg text-xs ${studioReportLength === l ? 'bg-orange-600' : 'bg-white/10 hover:bg-white/15'}`}>
                                                                    {l.charAt(0).toUpperCase() + l.slice(1)}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {studioCreateType === 'quiz' && (
                                                        <div>
                                                            <label className="text-xs text-slate-300">Questions: {studioQuizCount}</label>
                                                            <input type="range" min="5" max="30" value={studioQuizCount} onChange={e => setStudioQuizCount(parseInt(e.target.value))}
                                                                className="w-full mt-1 accent-red-500" />
                                                        </div>
                                                    )}
                                                    {studioCreateType === 'flashcard' && (
                                                        <div>
                                                            <label className="text-xs text-slate-300">Cards: {studioFlashcardCount}</label>
                                                            <input type="range" min="10" max="50" value={studioFlashcardCount} onChange={e => setStudioFlashcardCount(parseInt(e.target.value))}
                                                                className="w-full mt-1 accent-teal-500" />
                                                        </div>
                                                    )}
                                                    {studioCreateType === 'mindmap' && (
                                                        <div className="text-xs text-slate-400">Mind maps are generated automatically from your source content.</div>
                                                    )}
                                                </div>

                                                {/* Theme selection */}
                                                {(studioCreateType === 'slides' || studioCreateType === 'infographic') && studioThemes.length > 0 && (
                                                    <div>
                                                        <label className="text-xs font-medium text-slate-400 mb-2 block">Theme (optional)</label>
                                                        <div className="grid grid-cols-3 sm:grid-cols-4 gap-2 max-h-64 overflow-y-auto pr-1" style={{scrollbarWidth:'thin'}}>
                                                            {/* Auto option */}
                                                            <button onClick={() => setStudioCreateTheme(null)}
                                                                className={`relative rounded-xl p-2 text-center transition-all ${!studioCreateTheme ? 'ring-2 ring-purple-500 bg-white/10' : 'bg-white/5 hover:bg-white/10'}`}>
                                                                <div className="w-full h-8 rounded-lg mb-1.5 flex items-center justify-center" style={{background:'linear-gradient(135deg, #8b5cf6, #06b6d4, #f59e0b)'}}>
                                                                    <Wand className="w-4 h-4 text-white" />
                                                                </div>
                                                                <span className="text-[10px] font-medium text-slate-300 leading-tight block">Auto</span>
                                                            </button>
                                                            {/* Theme tiles */}
                                                            {studioThemes.map(t => {
                                                                const colors = (t.colors || '').split(',').map(c => c.trim()).filter(Boolean);
                                                                const bg = colors.length >= 2
                                                                    ? `linear-gradient(135deg, ${colors.join(', ')})`
                                                                    : colors.length === 1 ? colors[0] : '#6366f1';
                                                                return (
                                                                    <button key={t.id} onClick={() => setStudioCreateTheme(t.id)}
                                                                        className={`relative rounded-xl p-2 text-center transition-all ${studioCreateTheme === t.id ? 'ring-2 ring-purple-500 bg-white/10' : 'bg-white/5 hover:bg-white/10'}`}>
                                                                        <div className="w-full h-8 rounded-lg mb-1.5" style={{background: bg}} />
                                                                        <span className="text-[10px] font-medium text-slate-300 leading-tight block truncate">{t.name}</span>
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Style Instructions */}
                                                {(studioCreateType === 'slides' || studioCreateType === 'infographic') && (
                                                    <div>
                                                        <label className="text-xs font-medium text-slate-400 mb-1 block">Style Instructions (optional)</label>
                                                        <textarea value={studioStyleInstructions} onChange={e => setStudioStyleInstructions(e.target.value)}
                                                            placeholder="e.g. Use blue and white color palette, include emojis, modern clean style, dark background, hand-drawn illustrations..."
                                                            rows={2}
                                                            className="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm placeholder-slate-500 focus:outline-none focus:border-purple-500 resize-none" />
                                                    </div>
                                                )}
                                            </div>

                                            {/* Generate button */}
                                            <div className="p-4 border-t border-white/10">
                                                <button onClick={createAndGenerateStudioOutput} disabled={studioGenerating}
                                                    className="w-full bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 py-3 rounded-xl font-medium flex items-center justify-center gap-2 transition-all">
                                                    {studioGenerating ? (
                                                        <><div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent" /> Generating...</>
                                                    ) : (
                                                        <><Wand className="w-4 h-4" /> Generate</>
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* SETTINGS TAB */}
                        {activeTab === 'settings' && (
                            <div className="flex-1 flex flex-col bg-white/[0.02] overflow-y-auto pb-24 md:pb-0" onScroll={(e) => { setShowScrollTop(e.target.scrollTop > 300); scrollContainerRef.current = e.target; }}>
                                <div className="p-6 pb-8">
                                    <div className="flex items-center gap-3 mb-6">
                                        <Settings className="w-6 h-6 text-teal-400" />
                                        <h1 className="text-xl font-bold">Settings</h1>
                                    </div>
                                
                                    <div className="space-y-6 max-w-lg">
                                    {/* API Key Section */}
                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl p-4 border border-white/10">
                                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                                            <Key className="w-4 h-4 text-teal-400" />
                                            Claude API Key
                                        </h3>
                                        <div className="flex gap-2">
                                            <input
                                                type="password"
                                                value={apiKeySaved}
                                                onChange={(e) => setApiKeySaved(e.target.value)}
                                                placeholder="sk-ant-..."
                                                className="flex-1 px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                            />
                                            <button 
                                                onClick={() => {
                                                    saveApiKeyToStorage(apiKeySaved);
                                                    alert('API Key saved!');
                                                }}
                                                className="px-4 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm font-medium"
                                            >
                                                Save
                                            </button>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-2">Your API key is stored locally on this device only.</p>
                                    </div>

                                    {/* Gemini API Key Section */}
                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl p-4 border border-white/10">
                                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                                            <Key className="w-4 h-4 text-purple-400" />
                                            Gemini API Key
                                        </h3>
                                        <div className="flex gap-2">
                                            <input
                                                type="password"
                                                value={geminiApiKey}
                                                onChange={(e) => setGeminiApiKey(e.target.value)}
                                                placeholder="AIza..."
                                                className="flex-1 px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                            />
                                            <button
                                                onClick={() => {
                                                    saveGeminiKeyToStorage(geminiApiKey);
                                                    alert('Gemini API Key saved!');
                                                }}
                                                className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium"
                                            >
                                                Save
                                            </button>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-2">Required for audio transcription. Stored locally only.</p>
                                    </div>

                                    {/* Google Drive OAuth Client ID Section */}
                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl p-4 border border-white/10">
                                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                                            <Search className="w-4 h-4 text-indigo-400" />
                                            Google Drive (Meeting Prep)
                                        </h3>
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={googleClientId}
                                                onChange={(e) => setGoogleClientId(e.target.value)}
                                                placeholder="OAuth Client ID (e.g., 123456789.apps.googleusercontent.com)"
                                                className="flex-1 px-4 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                            />
                                            <button
                                                onClick={() => {
                                                    localStorage.setItem('google_oauth_client_id', googleClientId);
                                                    alert('Google Client ID saved!');
                                                }}
                                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-medium"
                                            >
                                                Save
                                            </button>
                                        </div>
                                        <p className="text-xs text-slate-400 mt-2">Required for auto-finding research documents from Google Drive. Stored locally only.</p>
                                    </div>

                                    {/* Email Credentials Section */}
                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl p-4 border border-white/10">
                                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                                            <Mail className="w-4 h-4 text-teal-400" />
                                            Email Settings
                                        </h3>
                                        {emailData.useGmail && emailData.gmailUser ? (
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-slate-300">
                                                        Connected: <span className="text-teal-400">{emailData.gmailUser}</span>
                                                    </span>
                                                    <button 
                                                        onClick={() => {
                                                            localStorage.removeItem('emailCredentials');
                                                            setEmailData({ email: '', useGmail: false, gmailUser: '', gmailPassword: '', customSubject: '' });
                                                        }}
                                                        className="text-sm text-red-400 hover:text-red-300"
                                                    >
                                                        Disconnect
                                                    </button>
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-slate-400 mb-1">Recipient Email</label>
                                                    <input
                                                        type="email"
                                                        value={emailData.email}
                                                        onChange={(e) => {
                                                            const updated = { ...emailData, email: e.target.value };
                                                            setEmailData(updated);
                                                            localStorage.setItem('emailCredentials', JSON.stringify(updated));
                                                        }}
                                                        placeholder="recipient@example.com"
                                                        className="w-full px-3 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                                        style={{ fontSize: '16px' }}
                                                    />
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <p className="text-sm text-slate-400">Configure Gmail to send emails from Charlie.</p>
                                                <div>
                                                    <label className="block text-xs text-slate-400 mb-1">Gmail Address</label>
                                                    <input
                                                        type="email"
                                                        value={emailData.gmailUser || ''}
                                                        onChange={(e) => setEmailData(prev => ({ ...prev, gmailUser: e.target.value }))}
                                                        placeholder="your.email@gmail.com"
                                                        className="w-full px-3 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                                        style={{ fontSize: '16px' }}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-slate-400 mb-1">App Password</label>
                                                    <input
                                                        type="password"
                                                        value={emailData.gmailPassword || ''}
                                                        onChange={(e) => setEmailData(prev => ({ ...prev, gmailPassword: e.target.value }))}
                                                        placeholder="xxxx xxxx xxxx xxxx"
                                                        className="w-full px-3 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                                        style={{ fontSize: '16px' }}
                                                    />
                                                    <p className="text-xs text-slate-500 mt-1">
                                                        <a href="https://myaccount.google.com/apppasswords" target="_blank" rel="noopener noreferrer" className="text-teal-400 hover:underline">
                                                            Generate app password ‚Üí
                                                        </a>
                                                    </p>
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-slate-400 mb-1">Recipient Email</label>
                                                    <input
                                                        type="email"
                                                        value={emailData.email || ''}
                                                        onChange={(e) => setEmailData(prev => ({ ...prev, email: e.target.value }))}
                                                        placeholder="recipient@example.com"
                                                        className="w-full px-3 py-2 bg-white/5 border border-white/10 backdrop-blur-md rounded-lg text-sm"
                                                        style={{ fontSize: '16px' }}
                                                    />
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        if (!emailData.gmailUser || !emailData.gmailPassword || !emailData.email) {
                                                            alert('Please fill in all fields');
                                                            return;
                                                        }
                                                        const creds = { ...emailData, useGmail: true };
                                                        localStorage.setItem('emailCredentials', JSON.stringify(creds));
                                                        setEmailData(creds);
                                                        alert('Email configured successfully!');
                                                    }}
                                                    className="w-full px-4 py-2 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm font-medium"
                                                >
                                                    Save Email Settings
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Backup & Restore Section */}
                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl p-4 border border-white/10">
                                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                                            <Save className="w-4 h-4 text-teal-400" />
                                            Backup & Restore
                                        </h3>
                                        <p className="text-sm text-slate-400 mb-3">
                                            Export your data to prevent loss. Import to restore on any device.
                                        </p>
                                        
                                        {/* Import Status Banner */}
                                        {backupImportStatus && (
                                            <div className={`mb-3 p-2 rounded-lg text-sm ${backupImportStatus.type === 'success' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                                {backupImportStatus.message}
                                            </div>
                                        )}
                                        
                                        <div className="space-y-2">
                                            <button
                                                onClick={exportAllData}
                                                className="w-full px-4 py-2.5 bg-teal-500/80 hover:bg-teal-500/90 backdrop-blur-sm border border-teal-400/30 shadow-lg shadow-teal-500/20 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                            >
                                                <Download className="w-4 h-4" />
                                                Export All Data
                                            </button>
                                            <input
                                                type="file"
                                                ref={backupFileInputRef}
                                                onChange={importBackupData}
                                                accept=".json"
                                                className="hidden"
                                            />
                                            <button
                                                onClick={() => backupFileInputRef.current?.click()}
                                                className="w-full px-4 py-2.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                            >
                                                <Folder className="w-4 h-4" />
                                                Import Backup
                                            </button>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-2">
                                            Current: {savedAnalyses.length} portfolio, {savedOverviews.length} overviews, {chatHistories.length} chats
                                        </p>
                                    </div>
                                    
                                    {/* About Section */}
                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl p-4 border border-white/10">
                                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                                            <Database className="w-4 h-4 text-teal-400" />
                                            Document Storage
                                        </h3>
                                        <p className="text-sm text-slate-400 mb-3">
                                            Stored documents allow re-analysis with different weights.
                                        </p>
                                        <button
                                            onClick={async () => {
                                                await loadStorageStats();
                                            }}
                                            className="w-full px-4 py-2.5 bg-white/10 hover:bg-white/15 backdrop-blur-md border border-white/10 rounded-lg text-sm font-medium flex items-center justify-center gap-2 mb-3"
                                        >
                                            <RefreshCw className="w-4 h-4" />
                                            Check Storage Usage
                                        </button>
                                        {storageStats && (
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-slate-400">Total Storage:</span>
                                                    <span className="text-teal-400 font-medium">{formatBytes(storageStats.totalSize)}</span>
                                                </div>
                                                {storageStats.byTicker?.length > 0 && (
                                                    <div className="mt-2 space-y-1">
                                                        <div className="text-xs text-slate-500 mb-1">By Ticker:</div>
                                                        {storageStats.byTicker.map((t, i) => (
                                                            <div key={i} className="flex justify-between text-xs">
                                                                <span className="text-slate-400">{t.ticker} ({t.docCount} docs)</span>
                                                                <span className="text-slate-300">{formatBytes(t.totalSize)}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                {storageStats.totalSize > 0 && (
                                                    <p className="text-xs text-slate-500 mt-2">
                                                        Delete stored documents from individual analysis pages to free space.
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* App Info Section */}
                                    <div className="bg-white/[0.07] backdrop-blur-lg rounded-xl p-4 border border-white/10">
                                        <h3 className="font-semibold mb-3">About</h3>
                                        <p className="text-sm text-slate-400">Charlie - Equity Analyzer</p>
                                        <p className="text-xs text-slate-500 mt-1">Powered by Claude Sonnet 4</p>
                                    </div>
                                </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Scroll to Top Button */}
                    {showScrollTop && (
                        <button
                            onClick={scrollToTop}
                            className="fixed right-4 bottom-24 md:bottom-8 z-40 p-2 bg-white/[0.07] hover:bg-white/10 backdrop-blur-sm rounded-full shadow-lg border border-white/10 text-slate-400 hover:text-teal-400 transition-all"
                            title="Scroll to top"
                        >
                            <ChevronUp className="w-5 h-5" />
                        </button>
                    )}

                    {/* BOTTOM NAVIGATION BAR - Mobile only */}
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 z-50 px-4 pb-[calc(env(safe-area-inset-bottom)+8px)] pointer-events-none">
                        {/* Floating pill container - elevated like CVS/Bloomberg */}
                        <div className="mb-4 bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-2xl shadow-black/50 border border-white/10 pointer-events-auto">
                            <div className="flex justify-around items-center h-16 px-2">
                                <button 
                                    onClick={() => switchTab('portfolio')}
                                    className={`flex flex-col items-center justify-center gap-1 min-w-[56px] py-2 rounded-xl transition-all ${
                                        activeTab === 'portfolio' 
                                            ? 'text-teal-400' 
                                            : 'text-slate-400 active:text-slate-200'
                                    }`}
                                >
                                    <BarChart2 className={`w-5 h-5 ${activeTab === 'portfolio' ? 'stroke-[2.5]' : 'stroke-[1.5]'}`} />
                                    <span className={`text-[9px] ${activeTab === 'portfolio' ? 'font-semibold' : 'font-medium'}`}>Thesis</span>
                                </button>
                                
                                <button 
                                    onClick={() => switchTab('overview')}
                                    className={`flex flex-col items-center justify-center gap-1 min-w-[56px] py-2 rounded-xl transition-all ${
                                        activeTab === 'overview' 
                                            ? 'text-teal-400' 
                                            : 'text-slate-400 active:text-slate-200'
                                    }`}
                                >
                                    <FileText className={`w-5 h-5 ${activeTab === 'overview' ? 'stroke-[2.5]' : 'stroke-[1.5]'}`} />
                                    <span className={`text-[9px] ${activeTab === 'overview' ? 'font-semibold' : 'font-medium'}`}>Overview</span>
                                </button>
                                
                                <button 
                                    onClick={() => switchTab('chat')}
                                    className={`flex flex-col items-center justify-center gap-1 min-w-[56px] py-2 rounded-xl transition-all ${
                                        activeTab === 'chat' 
                                            ? 'text-teal-400' 
                                            : 'text-slate-400 active:text-slate-200'
                                    }`}
                                >
                                    <MessageCircle className={`w-5 h-5 ${activeTab === 'chat' ? 'stroke-[2.5]' : 'stroke-[1.5]'}`} />
                                    <span className={`text-[9px] ${activeTab === 'chat' ? 'font-semibold' : 'font-medium'}`}>Chat</span>
                                </button>
                                
                                <button 
                                    onClick={() => switchTab('summary')}
                                    className={`flex flex-col items-center justify-center gap-1 min-w-[56px] py-2 rounded-xl transition-all ${
                                        activeTab === 'summary' 
                                            ? 'text-teal-400' 
                                            : 'text-slate-400 active:text-slate-200'
                                    }`}
                                >
                                    <ClipboardList className={`w-5 h-5 ${activeTab === 'summary' ? 'stroke-[2.5]' : 'stroke-[1.5]'}`} />
                                    <span className={`text-[9px] ${activeTab === 'summary' ? 'font-semibold' : 'font-medium'}`}>Summary</span>
                                </button>
                                
                                <button 
                                    onClick={() => setShowMoreMenu(true)}
                                    className={`flex flex-col items-center justify-center gap-1 min-w-[56px] py-2 rounded-xl transition-all ${
                                        activeTab === 'research' || activeTab === 'settings' || activeTab === 'meetingprep' || activeTab === 'slides' || activeTab === 'studio'
                                            ? 'text-teal-400'
                                            : 'text-slate-400 active:text-slate-200'
                                    }`}
                                >
                                    <MoreHorizontal className={`w-5 h-5 ${activeTab === 'research' || activeTab === 'settings' || activeTab === 'meetingprep' || activeTab === 'slides' || activeTab === 'studio' ? 'stroke-[2.5]' : 'stroke-[1.5]'}`} />
                                    <span className={`text-[9px] ${activeTab === 'research' || activeTab === 'settings' || activeTab === 'meetingprep' || activeTab === 'slides' || activeTab === 'studio' ? 'font-semibold' : 'font-medium'}`}>More</span>
                                </button>
                            </div>
                        </div>
                    </nav>
                    
                    {/* MORE MENU - Bottom Sheet */}
                    {showMoreMenu && (
                        <>
                            <div 
                                className="fixed inset-0 bg-black/60 z-50 backdrop-blur-sm"
                                onClick={() => setShowMoreMenu(false)}
                            />
                            <div className="fixed bottom-0 left-0 right-0 z-50 bg-slate-900/95 backdrop-blur-2xl rounded-t-3xl border-t border-white/10 shadow-2xl animate-slide-up">
                                <div className="w-12 h-1 bg-white/20 rounded-full mx-auto mt-3 mb-2" />
                                <div className="p-4 pb-[calc(env(safe-area-inset-bottom)+16px)]">
                                    <h3 className="text-lg font-semibold mb-4 text-center">More Options</h3>
                                    <div className="space-y-2">
                                        <button
                                            onClick={() => {
                                                setShowMoreMenu(false);
                                                switchTab('research');
                                            }}
                                            className={`w-full flex items-center gap-4 p-4 rounded-xl transition-all ${
                                                activeTab === 'research' 
                                                    ? 'bg-teal-600/20 border border-teal-500/50' 
                                                    : 'bg-white/5 hover:bg-white/10 border border-transparent'
                                            }`}
                                        >
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${activeTab === 'research' ? 'bg-teal-600' : 'bg-white/10'}`}>
                                                <Microscope className="w-5 h-5" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold">Research</div>
                                                <div className="text-xs text-slate-400">Deep analysis with multiple frameworks</div>
                                            </div>
                                            <ChevronRight className="w-5 h-5 text-slate-500 ml-auto" />
                                        </button>

                                        <button
                                            onClick={() => {
                                                setShowMoreMenu(false);
                                                switchTab('meetingprep');
                                            }}
                                            className={`w-full flex items-center gap-4 p-4 rounded-xl transition-all ${
                                                activeTab === 'meetingprep'
                                                    ? 'bg-teal-600/20 border border-teal-500/50'
                                                    : 'bg-white/5 hover:bg-white/10 border border-transparent'
                                            }`}
                                        >
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${activeTab === 'meetingprep' ? 'bg-teal-600' : 'bg-white/10'}`}>
                                                <Target className="w-5 h-5" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold">Meeting Prep</div>
                                                <div className="text-xs text-slate-400">AI-generated questions for management meetings</div>
                                            </div>
                                            <ChevronRight className="w-5 h-5 text-slate-500 ml-auto" />
                                        </button>

                                        <button
                                            onClick={() => {
                                                setShowMoreMenu(false);
                                                switchTab('slides');
                                            }}
                                            className={`w-full flex items-center gap-4 p-4 rounded-xl transition-all ${
                                                activeTab === 'slides'
                                                    ? 'bg-teal-600/20 border border-teal-500/50'
                                                    : 'bg-white/5 hover:bg-white/10 border border-transparent'
                                            }`}
                                        >
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${activeTab === 'slides' ? 'bg-teal-600' : 'bg-white/10'}`}>
                                                <Layers className="w-5 h-5" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold">Slides</div>
                                                <div className="text-xs text-slate-400">AI-generated sketchnote presentations</div>
                                            </div>
                                            <ChevronRight className="w-5 h-5 text-slate-500 ml-auto" />
                                        </button>

                                        <button
                                            onClick={() => {
                                                setShowMoreMenu(false);
                                                switchTab('studio');
                                            }}
                                            className={`w-full flex items-center gap-4 p-4 rounded-xl transition-all ${
                                                activeTab === 'studio'
                                                    ? 'bg-purple-600/20 border border-purple-500/50'
                                                    : 'bg-white/5 hover:bg-white/10 border border-transparent'
                                            }`}
                                        >
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${activeTab === 'studio' ? 'bg-purple-600' : 'bg-white/10'}`}>
                                                <Wand className="w-5 h-5" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold">Studio</div>
                                                <div className="text-xs text-slate-400">AI content generation suite</div>
                                            </div>
                                            <ChevronRight className="w-5 h-5 text-slate-500 ml-auto" />
                                        </button>

                                        <button
                                            onClick={() => {
                                                setShowMoreMenu(false);
                                                switchTab('settings');
                                            }}
                                            className={`w-full flex items-center gap-4 p-4 rounded-xl transition-all ${
                                                activeTab === 'settings'
                                                    ? 'bg-teal-600/20 border border-teal-500/50'
                                                    : 'bg-white/5 hover:bg-white/10 border border-transparent'
                                            }`}
                                        >
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${activeTab === 'settings' ? 'bg-teal-600' : 'bg-white/10'}`}>
                                                <Settings className="w-5 h-5" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold">Settings</div>
                                                <div className="text-xs text-slate-400">API keys, email, storage</div>
                                            </div>
                                            <ChevronRight className="w-5 h-5 text-slate-500 ml-auto" />
                                        </button>
                                    </div>
                                    
                                    <button
                                        onClick={() => setShowMoreMenu(false)}
                                        className="w-full mt-4 p-3 bg-white/10 hover:bg-white/15 rounded-xl text-sm font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </>
                    )}
                </div>
                </>
            );
        };

        ReactDOM.render(<ErrorBoundary><App /></ErrorBoundary>, document.getElementById('root'));
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js', { updateViaCache: 'none' })
                    .then(registration => {
                        console.log('‚úÖ ServiceWorker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, prompt user to refresh
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('‚ùå ServiceWorker registration failed:', err);
                    });
            });
        }

        // Install prompt for iOS
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button (optional - you can add a button in UI later)
            console.log('üí° App can be installed');
        });

        // Track if app was installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ App installed successfully');
            deferredPrompt = null;
        });

        // Detect if running as PWA
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            console.log('üì± Running as PWA');
            document.body.classList.add('pwa-mode');
        }
    </script>
</body>
</html>
